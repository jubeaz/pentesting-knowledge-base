\section{NTLM Relay attack}
Other cool attacks:
\begin{itemize}
    \item \url{https://en.hackndo.com/ntlm-relay/}
    \item \href{https://www.fortalicesolutions.com/posts/keeping-up-with-the-ntlm-relay#substituting-initial-account-compromise-with-more-ntlm-relay}{Substituting Initial Account Compromise with More NTLM Relay}
    \item \url{https://github.com/CCob/lsarelayx}
    \item \url{https://github.com/mdsecactivebreach/Farmer}
    \item \url{https://www.blackhillsinfosec.com/wp-content/uploads/2022/10/SLIDES_CoercionsandRelays-TheFirstCredistheDeepest.pdf}

\end{itemize}
\subsection{Intro}
Regardless of the many security improvements that NTLMv2 received over NTLMv1 and LM, all of the NTLM family of authentication protocols are susceptible to relay attacks from spoofed servers because they lack the means of supporting mutual authentication, whereby the client verifies that it is authenticating against the legitimate server and that the server verifies that it is authenticating the legitimate client (remember that the session security SSPI provides tackles this problem using signing).



\subsubsection{Attack pattern}

 NTLM relay attack into three phases: 
 \begin{itemize}
     \item 
         Pre-relay: focuses on techniques that induce/coerce a client to initiate NTLM authentication for a service on a server.
         \begin{itemize}
             \item \href{https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications}{poisoning and spoofing} name resolution protocols (responder, inveigh, \href{https://github.com/RedTeamPentesting/pretender}{Pretender}):
                 \begin{itemize}
                     \item DNS
                     \item NBT-NS (NetBios Name Resolution)
                     \item LLMNR (Link-Local Multicast Name Resolution)
                     \item mDNS (multicast DNS)
                     \item PNR (Peer Name Resolution)
                     \item SNID (Server Network Information Discovery)
                 \end{itemize}
             \item coerce
         \end{itemize}

     \item
         Relay: focuses on relaying the NTLM authentication of the client to a relay target
     \item
         Post-relay: takes advantage of the authenticated session we obtained through relaying a victim's NTLM authentication. We can conduct specific post-relay attacks depending on the authenticated session's protocol.
 \end{itemize}
 

\subsubsection{Cross-protocol attacks}

It is essential to understand that NTLM authentication relaying is not limited to just the SMB protocol. We can relay NTLM authentication from various protocols, including SMB and HTTP over LDAP, SMB, HTTP, MSSQL, IMAP, RPC, or any other application protocol capable of transmitting NTLM authentication messages.

\verb+ntlmrelayx+:
\begin{itemize}
    \item as a client, can relay NTLM authentication over various protocols:
        \begin{itemize}
            \item HTTP(S)
            \item IMAP
            \item LDAP(S)
            \item MSSQL
            \item RPC
            \item SMBv/1/2/3
            \item SMTP
        \end{itemize}
    \item as a server can relay NTLM authentication from a limited number of protocols:
        \begin{itemize}
            \item 
            \item HTTP(S)
            \item RAW (as described in the Initial support for raw NTLM relay server for lsarelayx PR, this server is protocol agnostic, and it is designed to accept raw NTLM messages directly from third-party relay applications, especially lsarelayx.)
            \item SMBv/1/2/3
            \item WCF (Windows Communication Foundation)

        \end{itemize}
\end{itemize}

Because the NTLM security protocols are all embedded protocols, we can extract the NTLM authentication messages from one application protocol and embed them in another, a technique known as {\bf cross-protocol relaying}. 


\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{network/ntlm/images/cross-protocol.png}
  \caption{NTLM cross protocol table}
  \label{fig:ntlm-cross-protocol}
\end{figure}



\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{network/ntlm/images/ntlm_relay_attack_mindmap.png}
  \caption{NTLM relay attack mindmap}
  \label{fig:ntlm_relay_attack_mindmap}
\end{figure}


\subsubsection{Bypass Server side mitigations}

\href{https://www.crowdstrike.com/blog/active-directory-ntlm-attack-security-advisory/}{Drop The MIC 2 (CVE 2019-1166) and Exploiting LMv2 Clients (CVE-2019-1338)}

\begin{itemize}
    \item 
        {\bf Drop the MIC and Drop the MIC 2} \verb+--remove-mic+

    \item 
        {\bf Your Session Key is my Session Key} \verb+-remove-target+
\end{itemize}



\subsection{Hunting for relay targets}

\subsubsection{RunFinger}

\begin{verbatim}
python3 RunFinger.py -i 172.16.117.0/24
\end{verbatim}

\subsubsection{CrackMapExec}
\begin{verbatim}
# Signing Disabled - Host Enumeration
crackmapexec smb 192.168.1.0/24 --gen-relay-list relaylistOutputFilename.txt
\end{verbatim}

\subsubsection{LdapRelayScan}

\subsubsection{Windows PsMapExec}

\begin{verbatim}
PsMapExec -Targets all -GenRelayList
\end{verbatim}

\subsubsection{nmap}
\begin{verbatim}
nmap -Pn --script=smb2-security-mode.nse -p 445 172.16.117.0/24 --open
\end{verbatim}

\subsection{Obtaining traffic}

\subsubsection{Poison / spoof}

In case of Poison / spoof with responder ensure that the corresponding server are disabled.
\begin{verbatim}
$ sed -i "s/SMB = On/SMB = Off/; s/HTTP = On/HTTP = Off/" /usr/share/responder/Responder.conf
\end{verbatim}


\subsubsection{Farming hashes}
See~\ref{smb:farming-hashes} mssql fonction \verb+xp_dirtree+ can also be used.

\subsubsection{Authentication coercion}
See~\ref{ad:auth-coercion}

\subsection{Relaying}




\subsection{links}
\begin{itemize}
    \item \href{https://en.hackndo.com/ntlm-relay/}{hackndo NTLM Relay}
    \item
        \href{https://hunter2.gitbook.io/darthsidious/execution/responder-with-ntlm-relay-and-empire}{Responder
        with NTLM relay and Empire}
    \item
        \href{https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/}{Abusing
        Exchange: One API call away from Domain Admin }
    \item
        \href{https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/}{Combining
        NTLM Relaying and Kerberos delegation}
    \item
        \href{https://www.trustedsec.com/blog/a-comprehensive-guide-on-relaying-anno-2022/}{A
        comprehensive guide on relaying anno 2022}
\end{itemize}
