
\section{Mail spoofing}
Most of this section was extracted from the book {\bf Network Security
Assessment 3rd Edition.}

SMTP messages are easily spoofed, and so organizations use SPF, DKIM, and DMARC
features to prevent parties from sending unauthorised email.

A complete guide of these countermeasures can be found in
\url{https://seanthegeek.net/459/demystifying-dmarc/}

\subsection{Countermeasures}

\subsubsection{SPF}
Sender Policy Framework (SPF) provides a mechanism that allows MTAs to check if
a host sending an email is authorized. Then, the organisations can define a
list of authorised mail servers and the MTAs can query for this lists to check
if the email was spoofed or not. In order to define IP addresses/ranges,
domains and others that are allowed to send email on behalf a domain name,
different "Mechanism" cam appear in the SPF registry.

To check the SPF of a domain you can use online tools like:
\url{https://www.kitterman.com/spf/validate.html}

\begin{verbatim}
drill secure-startup.com txt
\end{verbatim}

\subsubsection{DKIM}
DomainKeys Identified Mail (DKIM) is a mechanism by which outbound email is
signed and validated by foreign MTAs upon retrieving a domainâ€™s public key via
DNS. The DKIM public key is held within a TXT record for a domain; however, you
must know both the selector and domain name to retrieve it.

Then, to ask for the key you need the domain name and the selector of the mail
from the mail header 
\begin{verbatim}
dig 20120113._domainkey.gmail.com TXT | grep p=
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCg
KCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
\end{verbatim}

\subsubsection{DMARC}
Domain-based Message Authentication, Reporting \& Conformance (DMARC) is a
method of mail authentication that expands upon SPF and DKIM. Policies instruct
mail servers how to process email for a given domain and report upon actions
performed.

\begin{verbatim}
drill _dmarc.secure-startup.com txt
\end{verbatim}


\subsection{Tools}

Check for SPF and DMARC misconfigurations:
\url{https://github.com/serain/mailspoof}

Automatically get SPF and DMARC configs:
\url{https://pypi.org/project/checkdmarc/}

You can attack some characteristics of mail clients to make the user think that
the mail is coming from any address, more info:
\url{https://www.mailsploit.com/index}

\url{https://emkei.cz/} can be used to send you an email spoofing an address
and check if reaches you email.
