
\section{Protocol}
WSUS uses SOAP XML calls to perform updates. The WSUS SOAP protocol is
virtually identical to the Windows Update protocol, with the exception of the
authorisation step.

When a computer first connects to a WSUS server it must perform some setup steps to
register itself and fetch cookies that are required for subsequent requests.
These SOAP calls are typically performed only once. A computer will only re-register
if its cookie expires, if the client or server are upgraded, or when trying to recover from
errors.

Once a client has registered itself, it can then check for updates. A client will normally
check for updates at regular intervals, or when a user manually triggers an update
check.

The SyncUpdates response contains a list of update IDs and metadata that allows the
client to decide whether each update should be installed. For example, the metadata
can specify dependencies on other updates or query file versions and registry values:

\begin{verbatim}
<UpdateIdentity UpdateID="53979536-176e-46c2-9f61-bcf68381c065"
RevisionNumber="206" />
<Properties UpdateType="Software" />
<Relationships>

   <Prerequisites>
       <UpdateIdentity UpdateID="59653007-e2e9-4f71-8525-2ff588527978" />
       <UpdateIdentity UpdateID="71c1e8bb-9a5d-4e56-a456-10b0624c7188" />

   </Prerequisites>
</Relationships>
<ApplicabilityRules>

   <IsInstalled>
       <b.FileVersion Version="6.1.7601.22045" Comparison="GreaterThanOrEqualTo"
                                  Path="\conhost.exe" Csidl="37" />

   </IsInstalled>
   <IsInstallable>

       <Not>
          <CbsPackageInstalledByIdentity
                PackageIdentity="InternetExplorer-Package~11.2.9600.16428" />

       </Not>
</IsInstallable>
\end{verbatim}

Once the client has processed the metadata for each update returned by SyncUpdates, it
passes a list of updates it wishes to install to \verb+GetExtendedUpdateInfo+

The \verb+GetExtendedUpdateInfo+ response contains the full details needed to download,
verify and install the update.
\begin{verbatim}
<soap:Envelope><soap:Body>
<GetExtendedUpdateInfoResponse><GetExtendedUpdateInfoResult>
   <Updates>
       <Update>
          <ID>17212691</ID>
          <Xml>&lt;ExtendedProperties...&lt;/HandlerSpecificData&gt;</Xml>
       </Update>
       <Update>
          <ID>17212692</ID>
          <Xml>&lt;ExtendedProperties...&lt;/HandlerSpecificData&gt;</Xml>
       </Update>
       ...
   </Updates>
   <FileLocations>
       <FileLocation>
          <FileDigest>tXa3bCw4XzkLd/Fyfs2ATZcYgh8=</FileDigest>
              <Url>http://wsus-server:8530/Content/1F/B576B76C2C385F39.cab</Url>
          </FileLocation>
          <FileLocation>
              <FileDigest>OzTUyOLCmjlK08U2VJNHw3rfpzQ=</FileDigest>
              <Url>http://wsus-server:8530/Content/34/3B34D4C8E2C29A39.cab</Url>
       </FileLocation>
   </FileLocations>

</GetExtendedUpdateInfoResult></GetExtendedUpdateInfoResponse>
</soap:Body></soap:Envelope>
\end{verbatim}

Shown below are the XML-decoded contents of an \verb+<Xml>+ tag.
\begin{verbatim}
<ExtendedProperties DefaultPropertiesLanguage="en"
   Handler="http://schemas.microsoft.com/msus/2002/12/UpdateHandlers/WindowsInstaller"
   MaxDownloadSize="3077548" MinDownloadSize="0">
   <InstallationBehavior RebootBehavior="CanRequestReboot" />

<UninstallationBehavior />
</ExtendedProperties>
<Files>

   <File Digest="OzTUyOLCmjlK08U2VJNHw3rfpzQ=" DigestAlgorithm="SHA1"
              FileName="infopath-x-none.cab"
              Size="3077548" Modified="2013-12-18T21:44:08.38Z"
              PatchingType="SelfContained">

       <AdditionalDigest Algorithm="SHA256">FS28fâ€¦ ohVcFKbaG4=</AdditionalDigest>
   </File>
</Files>
<HandlerSpecificData type="msp:WindowsInstaller">
   <MspData CommandLine="DISABLESRCPROMPT=1 LOCALCACHESRCRES=0 NOLOCALCACHEROLLBACK=1"

                    UninstallCommandLine="DISABLESRCPROMPT=1 LOCALCACHESRCRES=0
                                                            NOLOCALCACHEROLLBACK=1"

                    FullFilePatchCode="{39767eca-1731-45db-ab5b-6bf40e151d66}" />
</HandlerSpecificData>
\end{verbatim}

These details tell Windows Update how to apply the update to the system. The Digest
attribute of the File tag matches with the FileLocation tag (in the previous figure) to
allow the update file to be downloaded. Each update is processed by a particular
handler.

Windows Update supports the following handlers:
\begin{itemize}
    \item Cbs (Cab file)
    \item WindowsDriver
    \item WindowsInstaller
    \item WindowsPatch
    \item InfBasedInstallation
    \item CommandLineInstallation
\end{itemize}

The \verb+CommandLineInstallation+ update handler allows a single executable
file to be downloaded and run with arbitrary arguments. Below is shown example
metadata for the Malicious Software Removal tool:

\begin{verbatim}
<ExtendedProperties DefaultPropertiesLanguage="en"
Handler="http://schemas.microsoft.com/msus/2002/12/UpdateHandlers/CommandLineInst
allation"

   MaxDownloadSize="41837240" MinDownloadSize="0">
   <InstallationBehavior RebootBehavior="CanRequestReboot" />
</ExtendedProperties>
<Files>
   <File Digest="sJRqIvCrdbpZvP18wDS2HbwhFUE=" DigestAlgorithm="SHA1"
   FileName="Windows-KB890830-x64-V5.22.exe"
   Size="41837240" Modified="2015-02-27T15:54:52Z">

       <AdditionalDigest Algorithm="SHA256">robj...WY0=</AdditionalDigest>
   </File>
</Files>
<HandlerSpecificData type="cmd:CommandLineInstallation">
   <InstallCommand Arguments="/Q /W"

       Program="Windows-KB890830-x64-V5.22.exe"
       RebootByDefault="false" DefaultResult="Succeeded">
   <ReturnCode Reboot="true" Result="Succeeded" Code="3010" />
   <ReturnCode Reboot="false" Result="Failed" Code="1603" />
   <ReturnCode Reboot="false" Result="Failed" Code="-2147024894" />
</InstallCommand></HandlerSpecificData>
\end{verbatim}


\subsection{Security}
By default, WSUS does not use SSL for the SOAP web service. However, since SSL
is not enabled by default it is likely that a significant number of WSUS
deployments do not use SSL.

All update packages that are downloaded by Windows Update are signed with a
Microsoft signature.

Windows Update will verify this signature before installing the update, rejecting any
non-Microsoft-signed packages.