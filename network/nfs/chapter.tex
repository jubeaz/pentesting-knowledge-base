\chapter{NFS: Network File System}

\section{introdutction}
Network File System (NFS) is a network file system developed by Sun
Microsystems uses between Linux and Unix systems  to access file systems over a
network as if they were local. NFS is an Internet standard that governs the
procedures in a distributed file system.

\begin{itemize}
        \item NFSv2 	It is older but is supported by many systems and was initially operated entirely over UDP.
        \item NFSv3 	It has more features, including variable file size and better error reporting, but is not fully compatible with NFSv2 clients.
        \item NFSv4 	It includes Kerberos, works through firewalls and on the Internet, no longer requires portmappers, supports ACLs, applies state-based operations, and provides performance improvements and high security. It is also the first version to have a stateful protocol.
\end{itemize}

NFS version 4.1 (RFC 8881) aims to provide protocol support to leverage cluster
server deployments, including the ability to provide scalable parallel access
to files distributed across multiple servers (pNFS extension). In addition,
NFSv4.1 includes a session trunking mechanism, also known as NFS multipathing.
A significant advantage of NFSv4 over its predecessors is that only one UDP or
TCP port 2049 is used to run the service, which simplifies the use of the
protocol across firewalls.

NFS is based on the Open Network Computing Remote Procedure Call
(ONC-RPC/SUN-RPC) protocol exposed on TCP and UDP ports 111, which uses
External Data Representation (XDR) for the system-independent exchange of data.
The NFS protocol has no mechanism for authentication or authorization. Instead,
authentication is completely shifted to the RPC protocol's options. The
authorization is taken from the available information of the file system where
the server is responsible for translating the user information supplied by the
client to that of the file system and converting the corresponding
authorization information as correctly as possible into the syntax required by
UNIX.

The most common authentication is via UNIX UID/GID and group memberships, which
is why this syntax is most likely to be applied to the NFS protocol. One
problem is that the client and server do not necessarily have to have the same
mappings of UID/GID to users and groups, and the server does not need to do
anything further. No further checks can be made on the part of the server. This
is why NFS should only be used with this authentication method in trusted
networks.

\section{Footprint / enumeration}

\subsection{nmap}

\begin{verbatim}
sudo nmap  -p111,2049 -sV -sC
sudo nmap  -p111,2049 -sV --script nfs*
\end{verbatim}

The \verb+rpcinfo+ NSE script retrieves a list of all currently running RPC services,
their names and descriptions, and the ports they use.

\section{Interaction}

\begin{verbatim}
showmount -e IP
mount -t nfs IP:/ MOUNT-POINT -o nolock
umount ./target-NFS

\end{verbatim}

\section{NFS Imitation}

in case of problems with file owner resolution try:
\begin{verbatim}
$ ls -l html/
ls: cannot access 'html/index.html': Permission denied
ls: cannot access 'html/images': Permission denied
ls: cannot access 'html/css': Permission denied
ls: cannot access 'html/js': Permission denied
total 0
?????????? ? ? ? ?            ? css
?????????? ? ? ? ?            ? images
?????????? ? ? ? ?            ? index.html
?????????? ? ? ? ?            ? js

$ ls -la
total 32
drwxr-xr--  5       2017 http       4096 Jan 18 05:35 html
-rw-r-----  1 benmusashi root       9662 Jan 18 04:37 nmap.xml
-rw-r-----  1 benmusashi benmusashi 1365 Jan 18 04:59 Passwords.kdbx
drwxr-xr-x 14       1001 dotdotpwn  4096 Jan 18 04:35 ross

#OR

$ find html -ls
   133456      4 drwxr-xr--   5 2017     http         4096 Jan 18 05:35 html
\end{verbatim}

also try with creating a user corresponding to the id in order to exploit
\begin{verbatim}
$ sudo mount -t nfs 10.10.11.191:/var/www/html /mnt -nolock
$ cd /
$ sudo su dummy -c bash
bash: cannot set terminal process group (-1): Inappropriate ioctl for device
bash: no job control in this shell
[dummy@honbu /]$ cd mnt/
[dummy@honbu /]$ ls -l /mnt/
total 44
drwxr-xr-x 2 dummy http  4096 Jan 18 05:45 css
drwxr-xr-x 2 dummy http  4096 Jan 18 05:45 images
-rw-r----- 1 dummy http 32532 Jan 18 05:45 index.html
drwxr-xr-x 2 dummy http  4096 Jan 18 05:45 js

\end{verbatim}


\section{links}
\href{https://book.hacktricks.xyz/network-services-pentesting/pentesting-rpcbind}{HackTricks guide on Pentesting rpcbind}

