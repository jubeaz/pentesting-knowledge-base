\section{Introduction}
Port 445 is ‘SMB over IP’. 


SMB stands for ‘Server Message Blocks’. iSMB is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.


The SMB protocol  can be used on top of its TCP/IP protocol or other network protocols.  Using the SMB protocol, an application (or the user of an application)  can access files or other resources at a remote server. This allows  applications to read, create, and update files on the remote server. It  can also communicate with any server program that is set up to receive  an SMB client request

\subsection{Working with SMB}
SMB functions as a request-response or  client-server protocol. The only time that the protocol does not work in  a response-request framework is when a client requests an opportunistic  lock (oplock) and the server has to break an existing oplock because  the current mode is incompatible with the existing oplock. Client  computers using SMB connect to a supporting server using NetBIOS over  TCP/IP, IPX/SPX, or NetBUI. Once the connection is established, the  client computer or program can then open, read/write, and access files  similar to the file system on a local computer.

\subsection{Versions of Windows SMB}
\begin{itemize}
\item CIFS: The old version of SMB, which was included in Microsoft Windows NT 4.0 in 1996.
\item SMB 1.0 / SMB1: The version used in Windows 2000, Windows XP, Windows Server 2003 and Windows Server 2003 R2.
\item SMB 2.0 / SMB2: This version used in Windows Vista and Windows Server 2008.
\item SMB 2.1 / SMB2.1: This version used in Windows 7 and Windows Server 2008 R2.
\item SMB 3.0 / SMB3: This version used in Windows 8 and Windows Server 2012.
\item SMB 3.02 / SMB3: This version used in Windows 8.1 and Windows Server 2012 R2.
\item SMB 3.1: This version used in Windows Server 2016 and Windows 10.
Presently, the latest version of SMB is  the SMB 3.1.1 which was introduced with Windows 10 and Windows Server  2016. This version supports AES 128 GCM encryption in addition to AES  128 CCM encryption added in SMB3, and implements pre-authentication  integrity check using SHA-512 hash. SMB 3.1.1 also makes secure  negotiation mandatory when connecting to clients using SMB 2.x and  higher.
\end{itemize}

\subsection{SMB Protocol Security}
The SMB protocol supports two levels of  security: 
\begin{itemize}
    \item share level:  The server is protected at this  level and each share has a password. The client computer or user has to  enter the password to access data or files saved under the specific  share. This is the only security model available in the Core and Core  plus SMG protocol definitions. 
    \item User level: protection was later added to  the SMB protocol. It is applied to individual files and each share is  based on specific user access rights. Once a server authenticates the  client, he/she is given a unique identification (UID) that is presented  upon access to the server. The SMB protocol has supported individual  security since LAN Manager 1.0 was implemented.
\end{itemize}

\subsection{IPC\$ share}
With an anonymous null session you can access the IPC\$ share and interact with services exposed via named pipes. The enum4linux utility within Kali Linux is particularly useful; with it, you can obtain the following:
\begin{itemize}
\item Operating system information
\item Details of the parent domain
\item A list of local users and groups
\item Details of available SMB shares
\item The effective system security policy
\end{itemize}


\subsection{SMB NULL session}
SMB NULL session can be enumerated easily. For enumeration, we can use tools such as enum4linux, CrackMapExec, rpcclient, etc.

\subsection{SMB signing}

\href{https://docs.microsoft.com/en-us/troubleshoot/windows-server/networking/overview-server-message-block-signing}{SMB
signing} is a security mechanism in the SMB protocol. SMB signing means that
every SMB 3.1.1 message contains a signature that is generated by using the
session key and the Advanced Encryption Standard (AES) algorithm. The client
puts a hash of the entire message into the signature field of the SMB header.

If someone changes a message during transmission, the hash won't match, and SMB
will know that someone tampered with the data. The signature also confirms the
sender's and receiver's identities. This breaks relay attacks. Ideally, you are
using Kerberos instead of NTLMv2 so that your session key starts strong. Don't
connect to shares by using IP addresses, and
\href{https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/using-computer-name-aliases-in-place-of-dns-cname-records/ba-p/259064}{don't
    use CNAME records. Use Kerberos instead}.
