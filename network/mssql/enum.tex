
\section{Enum}

\subsection{DB, tables and other}

\begin{verbatim}
# DBs
SELECT a.name AS 'database', b.name AS 'owner', is_trustworthy_on
    FROM sys.databases a
    JOIN sys.server_principals b ON a.owner_sid = b.sid;

# Tables
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
\end{verbatim}

\subsection{Principals, logins, users, \ldots}

Logins and their server-level roles:
\begin{verbatim}
SELECT r.name, r.type_desc, r.is_disabled, sl.sysadmin, sl.securityadmin, 
    sl.serveradmin, sl.setupadmin, sl.processadmin, sl.diskadmin, 
    sl.dbcreator, sl.bulkadmin
FROM master.sys.server_principals r
    LEFT JOIN master.sys.syslogins sl ON sl.sid = r.sid
WHERE r.type IN ('S','E','X','U','G');
\end{verbatim}

\begin{verbatim}
select r.name as Role, m.name as Principal
from
    master.sys.server_role_members rm
    inner join
    master.sys.server_principals r on r.principal_id = rm.role_principal_id and r.type = 'R'
    inner join
    master.sys.server_principals m on m.principal_id = rm.member_principal_id
\end{verbatim}



Users and database-level roles:

Will show empty name in case the information requiere priviledges that the current user does not have
\begin{verbatim}
SELECT r.name AS role_principal_name, m.name AS member_principal_name
    FROM sys.database_role_members rm 
    JOIN sys.database_principals r  ON rm.role_principal_id = r.principal_id
    JOIN sys.database_principals m ON rm.member_principal_id = m.principal_id
\end{verbatim}

altenative (will not show lines in case of inssuficient privileges) 
\begin{verbatim}
USE <database_name>;
EXECUTE sp_helpuser;
EXECUTE sp_helpuser <user>;
EXECUTE sp_helpuser <role>;
\end{verbatim}




\subsection{Roles}

\begin{verbatim}
# check admin rights
IS_SRVROLEMEMBER('sysadmin');
\end{verbatim}



\subsection{Linked servers}

\begin{verbatim}
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
\end{verbatim}



\subsection{Create user}
\begin{verbatim}
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
sp_addsrvrolemember 'hacker', 'sysadmin'
\end{verbatim}
