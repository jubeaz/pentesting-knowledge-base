
\section{Enum}

\subsection{DB, tables and other}

\begin{verbatim}
# DBs
SELECT a.name AS 'database', b.name AS 'owner', is_trustworthy_on
    FROM sys.databases a
    JOIN sys.server_principals b ON a.owner_sid = b.sid;

# Tables
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
\end{verbatim}


\subsection{Principals, logins, users, \ldots}

whoami:
\begin{verbatim}
SELECT SUSER_NAME()
\end{verbatim}


Logins and their server-level roles:
\begin{verbatim}
SELECT r.name, r.type_desc, r.is_disabled, sl.sysadmin, sl.securityadmin, 
    sl.serveradmin, sl.setupadmin, sl.processadmin, sl.diskadmin, 
    sl.dbcreator, sl.bulkadmin
FROM master.sys.server_principals r
    LEFT JOIN master.sys.syslogins sl ON sl.sid = r.sid
WHERE r.type IN ('S','E','X','U','G');
\end{verbatim}

\begin{verbatim}
select r.name as Role, m.name as Principal
from
    master.sys.server_role_members rm
    inner join
    master.sys.server_principals r on r.principal_id = rm.role_principal_id and r.type = 'R'
    inner join
    master.sys.server_principals m on m.principal_id = rm.member_principal_id
\end{verbatim}



Users and database-level roles:

Will show empty name in case the information requiere priviledges that the current user does not have
\begin{verbatim}
SELECT r.name AS role_principal_name, m.name AS member_principal_name
    FROM sys.database_role_members rm 
    JOIN sys.database_principals r  ON rm.role_principal_id = r.principal_id
    JOIN sys.database_principals m ON rm.member_principal_id = m.principal_id
\end{verbatim}

altenative (will not show lines in case of inssuficient privileges) 
\begin{verbatim}
USE <database_name>;
EXECUTE sp_helpuser;
EXECUTE sp_helpuser <user>;
EXECUTE sp_helpuser <role>;
\end{verbatim}




\subsection{Roles}

\begin{verbatim}
# check admin rights
IS_SRVROLEMEMBER('sysadmin');
\end{verbatim}



\subsection{Linked servers}

\href{https://learn.microsoft.com/fr-fr/sql/relational-databases/system-stored-procedures/sp-linkedservers-transact-sql?view=sql-server-ver16}{sp\_linkedservers (T-SQL)}
\begin{verbatim}
EXEC sp_linkedservers
\end{verbatim}

using \href{https://learn.microsoft.com/en-us/sql/relational-databases/system-compatibility-views/sys-sysservers-transact-sql?view=sql-server-ver16}{sysservers (T-SQL)}
\begin{verbatim}
SELECT srvname, isremote FROM master.sys.sysservers
SELECT * FROM master.sys.sysservers
\end{verbatim}


using \verb+PowerUpSQL+
\begin{verbatim}
import-module .\PowerUpSQL.ps1
Get-SQLServerLink
Get-SQLQuery  -Query "EXEC sp_helplinkedsrvlogin"
\end{verbatim}
    
Using \verb+mssqlclient.py+
\begin{verbatim}
enum_links
\end{verbatim}

\subsection{Object definition}

\href{https://learn.microsoft.com/en-us/sql/t-sql/functions/object-definition-transact-sql?view=sql-server-ver16}{OBJECT\_DEFINITION} Returns the Transact-SQL source text of the definition of a specified object.

\begin{verbatim}
SELECT object_definition(OBJECT_ID('<name>'))
SELECT object_definition(OBJECT_ID('sp_linkedservers'))
SELECT object_definition(OBJECT_ID('sys.credentials'))
\end{verbatim}


\subsection{Audit}
\begin{verbatim}
    Import-Module .\PowerUpSQL.psm1
    Get-SQLInstanceDomain -Verbose
    Get-SQLServerInfo -Username "ws_dev" -Password "4X6cuvDLNer7nwYN5LBZ" -Instance "SQL01"
    Invoke-SQLAudit -Username "ws_dev" -Password "4X6cuvDLNer7nwYN5LBZ" -Instance "SQL01"
\end{verbatim}

