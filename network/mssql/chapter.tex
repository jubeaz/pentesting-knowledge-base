\chapter{MSSQL}

\section{introduction}
\href{https://www.microsoft.com/en-us/sql-server/sql-server-2019}{Microsoft
SQL (MSSQL)} is Microsoft's SQL-based relational database management system is
closed source and was initially written to run on Windows operating systems. It
is popular among database administrators and developers when building
applications that run on Microsoft's .NET framework due to its strong native
support for .NET. There are versions of MSSQL that will run on Linux and MacOS,
but we will more likely come across MSSQL instances on targets running
Windows.

\subsection{Default system databases}
MSSQL has default
\href{https://docs.microsoft.com/en-us/sql/relational-databases/databases/system-databases?view=sql-server-ver15}{system
databases} that can help to understand the structure of all the databases that
may be hosted on a target server. Here are the default databases and a brief
description of each:
\begin{itemize}
        \item {\bf master} Tracks all system information for an SQL server instance
        \item {\bf model} Template database that acts as a structure for every new database created. Any setting changed in the model database will be reflected in any new database created after changes to the model database
        \item {\bf msdb } The SQL Server Agent uses this database to schedule
            jobs and alerts
        \item {\bf tempdb} Stores temporary objects
        \item {\bf resource} Read-only database containing system objects
            included with SQL server
\end{itemize}

\subsection{Authentication mechanisms}
MSSQL supports two
\href{https://docs.microsoft.com/en-us/sql/connect/ado-net/sql/authentication-sql-server}{authentication
modes}, which means that users can be created in Windows or the SQL Server:
\begin{itemize}
    \item {\bf Windows authentication mode} 	This is the default, often
        referred to as integrated security because the SQL Server security
        model is tightly integrated with Windows/Active Directory. Specific
        Windows user and group accounts are trusted to log in to SQL Server.
        Windows users who have already been authenticated do not have to
        present additional credentials.
    \item {\bf Mixed mode} 	Mixed mode supports authentication by
        Windows/Active Directory accounts and SQL Server. Username and password
        pairs are maintained within SQL Server.
\end{itemize}

\section{Dangerous Settings}
This is not an extensive list because there are countless ways MSSQL databases
can be configured by admins based on the needs of their respective
organizations. We may benefit from looking into the following:
\begin{itemize}
    \item MSSQL clients not using encryption to connect to the MSSQL server
    \item The use of self-signed certificates when encryption is being used. It is possible to spoof self-signed certificates
    \item The use of
        \href{https://docs.microsoft.com/en-us/sql/tools/configuration-manager/named-pipes-properties?view=sql-server-ver15}{named
        pipes}
    \item Weak and default {\bf sa} credentials. Admins may forget to disable this account
\end{itemize}


\section{Interaction}
\href{https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15}{SQL
Server Management Studio (SSMS)} comes as a feature that can be installed with
the MSSQL install package or can be downloaded and installed separately.

Many other clients can be used to access a database running on MSSQL. Including
but not limited to:
\begin{itemize}
    \item mssql-cli
    \item SQL Server PowerShell
    \item HediSQL
    \item SQLPro
    \item Impacket's mssqlclient.py~\ref{tool:impacket:mssqlclient}
\end{itemize}

\begin{verbatim}
mssqlclient.py Administrator@IP -windows-auth
select name from sys.databases

\end{verbatim}


\section{Footprint / enumeration}

\subsection{nmap}
\begin{verbatim}
jubeaz@htb[/htb]$ sudo nmap --script \
    ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,\
    ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,\
    ms-sql-dump-hashes \
    --script-args \
        mssql.instance-port=1433,mssql.username=sa,\
        mssql.password=,mssql.instance-name=MSSQLSERVER
    -sV -p 1433
\end{verbatim}

\subsection{metasploit}
\begin{verbatim}
use scanner/mssql/mssql_ping
\end{verbatim}

\section{Interaction}

\subsection{sqsh}
Sqsh is much more than a friendly prompt. It is intended to provide much of the
functionality provided by a command shell, such as variables, aliasing,
redirection, pipes, back-grounding, job control, history, command substitution,
and dynamic configuration. 

\begin{verbatim}
sqsh -S IP -U LOGIN -P PASSWORD
\end{verbatim}


\subsection{sqlcmd}

Windows sqlcmd allow to enter ransact-SQL statements, system procedures, and script files through a variety of available modes:
\begin{itemize}
    \item  At the command prompt.
    \item  In Query Editor in SQLCMD mode.
    \item  In a Windows script file.
    \item  In an operating system (Cmd.exe) job step of a SQL Server Agent job.
\end{itemize}

\subsection{dbeaver}

\section{Command execution}


There are several methods to get command execution:
\begin{itemize}
    \item  \verb+xp_cmdshell+ 
    \item  adding
        \href{https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server}{extended
        stored procedures}, 
    \item
        \href{https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration}{CLR
        Assemblies}
    \item
        \href{https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15}{SQL Server Agent Jobs}
    \item
        \href{https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql}{external
        scripts}
\end{itemize}

With the appropriate privileges, SQL database can be used to execute system
commands or create the necessary elements to do it.

\subsection{xp\_cmdshell}
MSSQL has a
\href{https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/database-engine-extended-stored-procedures-programming?view=sql-server-ver15}{extended
stored procedures} called
\href{https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15}{xp\_cmdshell}
which allow us to execute system commands using SQL. \verb+xp_cmdshell+:
\begin{itemize}
        \item is a powerful feature and disabled by default. It can be enabled
            and disabled by using the
            \href{https://docs.microsoft.com/en-us/sql/relational-databases/security/surface-area-configuration}{Policy-Based
            Management} or by executing
            \href{https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option}{sp\_configure}
        \item spawn a  Windows process that  has the same security rights as the
            SQL Server service account
        \item  operates synchronously. Control is not returned to the caller until the command-shell command is completed
\end{itemize}

To Enable \verb+xp_cmdshell+ with \verb+sp_configure+
\begin{verbatim}
-- To allow advanced options to be changed.
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.
RECONFIGURE
GO

-- To enable the feature.
EXECUTE sp_configure 'xp_cmdshell', 1
GO

-- To update the currently configured value for this feature.
RECONFIGURE
GO
\end{verbatim}

to launch a command:
\begin{verbatim}
xp_cmdshell 'whoami'
GO
\end{verbatim}

\section{Read / Write local files}

\section{Capture MSSQL Service Hash}

\subsection{User impersonation}
