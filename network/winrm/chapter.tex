\chapter{WinRM: Windows Remote Management}

\url{https://www.hackingarticles.in/winrm-penetration-testing/}
\section{Introduction}

Windows Remote Management (WinRM) is the Microsoft implementation of the
network protocol Web Services Management Protocol (WS-Management). It is a
network protocol based on XML web services using the Simple Object Access
Protocol (SOAP) used for remote management of Windows systems. It takes care of
the communication between Web-Based Enterprise Management (WBEM) and the
Windows Management Instrumentation (WMI), which can call the Distributed
Component Object Model (DCOM).

However, for security reasons, WinRM must be activated and configured manually
in Windows 10. Therefore, it depends heavily on the environment security in a
domain or local network where we want to use WinRM. In most cases, one uses
certificates or only specific authentication mechanisms to increase its
security. WinRM uses the {\bf TCP ports 5985 (HTTP) and 5986 (HTTPS)}.

Another component that fits WinRM for administration is {\bf Windows Remote Shell
(WinRS)}, which lets us execute arbitrary commands on the remote system. The
program is even included on Windows 7 by default. Thus, with WinRM, it is
possible to execute a remote command on another server.

Services like remote sessions using PowerShell and event log merging require
WinRM. It is enabled by default starting with the Windows Server 2012 version,
but it must first be configured for older server versions and clients, and the
necessary firewall exceptions created.

A handy tool that we can use for our password attacks is CrackMapExec, which
can also be used for other protocols such as SMB, LDAP, MSSQL, and others. We
recommend reading the official documentation for this tool to become familiar
with it.

\section{Footprint / enumeration}

\subsection{nmap}
\begin{verbatim}
nmap -sV -sC  -p5985,5986 --disable-arp-ping -n
\end{verbatim}


\section{Interaction}

\begin{itemize}
    \item Powershell
        \href{https://docs.microsoft.com/en-us/powershell/module/microsoft.wsman.management/test-wsman?view=powershell-7.2}{Test-WsMan}
    \item \verb+evil-winrm+~\ref{tool:evil-winrm}
\end{itemize}

\section{Exploit}

\subsection{Metasploit}

Identify the WinRM Authentication Method: 

\begin{verbatim}
use auxiliary/scanner/winrm/winrm_auth_methods
\end{verbatim}

brute force : 

\begin{verbatim}
use auxiliary/scanner/winrm/winrm_login
set user_file /root/user.txt
set pass_file /root/pass.txt
set stop_on_success true
exploit
\end{verbatim}


\subsection{CrackMapExec}

bruteforce

\begin{verbatim}
crackmapexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>
\end{verbatim}

\subsection{Evil-WinRM}

\verb+evil-winrm -i <target-IP> -u <username> -p <password>+

\section{Links}
\begin{itemize}
    \item \url{https://docs.microsoft.com/en-us/windows/win32/winrm/portal}
    \item \url{https://docs.microsoft.com/en-us/windows/win32/winrm/ws-management-protocol}
    \item \url{https://en.wikipedia.org/wiki/Web-Based_Enterprise_Management}
    \item \url{https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page}
    \item \url{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0}
\end{itemize}

