\section{Introduction}
The Microsoft Intune family of products is an integrated solution for managing all of your devices.

The following Microsoft management solutions are all now part of the Microsoft Intune brand:
\begin{itemize}
    \item 
        Configuration Manager
    \item
        Intune
    \item
        Endpoint analytics
    \item
        Autopilot
\end{itemize}

the Configuration Manager console to configure sites and clients, and to run and monitor management tasks. This console is the main point of administration, and lets you manage multiple sites.

You can install the Configuration Manager console on additional computers, and restrict access and limit what administrative users can see in the console by using Configuration Manager role-based administration.

usage:
\begin{itemize}
    \item inventory management
    \item software deployment
    \item software updates management
    \item OS deployment
    \item compliance management
    \item reporting
\end{itemize}


\subsection{sites and hierarchies}
A Configuration Manager deployment must be installed in an Active Directory domain. The foundation of this deployment includes one or more Configuration Manager sites that form a hierarchy of sites. From a single site to a multi-site hierarchy, the type and location of sites you install provide the ability to scale up (expand) your deployment when necessary, and deliver key services to managed users and devices.

When you install Configuration Manager for the first time, the first Configuration Manager site that you install determines the scope of your hierarchy. The first Configuration Manager site is the foundation from which you will manage devices and users in your enterprise. This first site must be: 
\begin{itemize}
    \item 
        either a {\bf central administration site (CAS)}: allows to manage all the primary sites from one point, make some reporting, and is totally optional. CAS does not directly support management of devices. CAS needs one or more \href{https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/design-a-hierarchy-of-sites#BKMK_ChoosePriimary}{primary sites} as child sites which are in charge to manage devices.
    \item 
        or a stand-alone primary site
\end{itemize}

A \href{https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/design-a-hierarchy-of-sites#BKMK_ChooseSecondary}{secondary site} can only be installed as a child site below a primary site. This site type extends the reach of a primary site to manage devices in locations that have a slow network connection to the primary site. Even though a secondary site extends the primary site, {\bf the primary site manages all of the clients}.

In case of high availability in required, it is also possible to find a passive site server that will be used only if the active site server stop working

\subsection{site system servers and site system roles}


\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{network/mecm/images/archi.png}
  \caption{Archi MECM}
  \label{fig:mecm-archi}
\end{figure}



Each Configuration Manager site includes a site server that's a {\bf site system server}. The site can also include additional site system servers on computers that are remote from the site server. Site system servers (the site server or a remote site system server) support site system roles.

Different Configuration Manager sites (CAS, primary, secondary) can support different sets of site system roles. The supported set of site system roles depends on the type of site. For example, the service connection point is only supported at the top-tier site of the hierarchy. The top-tier site might be a central administration site or a standalone primary site. This role isn't supported at a child primary site or at secondary sites.

\subsubsection{Site database server}
The site assigns \href{https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/plan-for-the-site-database}{this role} to site system servers that hold an instance of the site database. This database is used by the site server to retrieve and store information about the managed devices and is also used by the management point to retrieve policies and configuration information needed by the SCCM clients.


\subsubsection{Systems Management Server (SMS)}

The \href{https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/plan-for-the-sms-provider#about}{SMS Provider} is a Windows Management Instrumentation (WMI) provider that assigns read and write access to the Configuration Manager database at a site.


\subsubsection{Management point}

A site system role that provides policy and service location information (configuration to communicate with the site server) to clients. It also receives configuration data from clients.

Primary sites support multiple instances of this role. Secondary sites support a single management point.

To help reduce the processing load placed on the site database server by management points as they service requests from clients, use Database replicas for management points.

\subsubsection{Distribution point}

A site system role that contains source files for clients to download, for example:
\begin{itemize}
    \item 
        Application content
    \item
        Software packages
    \item
        Software updates
    \item
        OS images
    \item
        Boot images
\end{itemize}

By default, this role installs on the site server when you install a new primary or secondary site. This role isn't supported at a central administration site.

\subsubsection{Software update point}
A site system role that integrates with Windows Server Update Services (WSUS) to provide software updates to Configuration Manager clients

\subsubsection{Other elements}
\begin{itemize}
    \item Asset Intelligence synchronization point
    \item Certificate registration point
    \item Cloud management gateway connection point
    \item Endpoint Protection point
    \item Enrollment point
    \item State migration point (stores user state data during  migration ofa computer to a new operating system)
    \item \ldots
\end{itemize}

\subsection{Boundary / Boundary group}

\href{https://learn.microsoft.com/en-us/mem/configmgr/core/servers/deploy/configure/boundaries}{Boundaries} are locations (AD site, IP range, IP subnet\ldots) on the network that contains devices to manage. boundaries can be created manually or using \href{https://learn.microsoft.com/en-us/mem/configmgr/core/servers/deploy/configure/about-discovery-methods#bkmk_aboutForest}{Active Directory forest discovery}

\href{https://learn.microsoft.com/en-us/mem/configmgr/core/servers/deploy/configure/boundary-groups}{Boundary groups}  organize boundaries. Clients use a boundary group for:
\begin{itemize}
    \item \href{https://learn.microsoft.com/en-us/mem/configmgr/core/clients/deploy/assign-clients-to-a-site#automatic-site-assignment}{Automatic site assignment}
    \item To find a site system server that can provide a service, including:
    \begin{itemize}
        \item \href{https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/plan-for-site-system-servers-and-site-system-roles#distribution-point}{Distribution points} for content location.
        \item \href{https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/plan-for-site-system-servers-and-site-system-roles#software-update-point}{Software update points}
        \item State migration points
        \item \href{https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/plan-for-site-system-servers-and-site-system-roles#management-point}{Management points}
        \item Preferred management points
        \item Cloud management gateway (CMG) for policy and content
    \end{itemize}
\end{itemize}

\subsection{Client agent}

When SCCM is installed in an Active Directory, the clients can be deployed on the workstations by six different ways:
\begin{itemize}
    \item 
        Client push installation (default)
    \item
        Software update-based installation
    \item
        Group Policy installation
    \item
        Manual installation
    \item
        Logon script installation
    \item
        Package and program installation
\end{itemize}

The first way of deploying SCCM is the Client push installation method, which is the default one and the least secure.

This installation will use "client push accounts". They are service accounts with local administrative rights on the assets where SCCM will have to deploy some stuff. The system administrator creates groups of endpoints and for each of those, one "client push account". For each group, only one "client push account" can authenticate with administrator rights on the assets of this group. Thus, if an account is compromised, only the members of the corresponding group can be compromised in turn.

When the SCCM deployment is launched, it will basically try to authenticate with each client push accounts on each asset, and if the authentication fails, SCCM will try the next account in line. When the authentication succeeds, it moves to the following asset, and so on until the deployment is complete.

SCCM deployment via Client push installation is service accounts credentials spraying in a nutshell.

Nota bene, there is a feature allowing for \href{https://learn.microsoft.com/en-us/mem/configmgr/core/clients/deploy/deploy-clients-to-windows-computers#configure-the-site-to-automatically-use-client-push-for-discovered-computers}{automatic client push installation} on all discovered clients in a boundary group in an SCCM site.

\subsection{Client WMI}

WMI stores data in the CIM repository located at \verb+C:\Windows\System32\wbem\Repository\OBJECTS.DATA+. This is a binary file that contains all CIM entities. This means that when the NAA policy is sent to the device and stored in a WMI class, the blobs are actually stored in this file on disk.

The DACL on the file makes it world-readable, so any unprivileged user can simply run strings (or open the file in notepad) to retrieve the DPAPI-protected blobs.

\href{https://github.com/davidpany/WMI_Forensics}{WMIi\_Forensics}


\subsection{Discovery}

\url{https://learn.microsoft.com/en-us/previous-versions/system-center/system-center-2012-R2/gg712308(v=technet.10)?redirectedfrom=MSDN}

\subsection{preboot execution environment (PXE)}


PXE is a set of standards that enables a computer to load an OS over a network connection.
To deploy operating systems to Configuration Manager clients that make PXE boot requests, one or more distribution points need to be configured to accept PXE requests (WDS role). Then the distribution point responds to PXE boot requests, and determines the appropriate deployment action

Configuration Manager relies on the Windows Deployment Services (WDS) server role via the WDS PXE provider. In ConfigMgr 2012 and later versions, the SMS PXE provider (SMSPXE) registers with the WDS service and supplies the logic for the PXE client requests.

The network must have a configured Dynamic Host Configuration Protocol (DHCP) server and a Trivial File Transfer Protocol (TFTP) server. There is generally also another imaging server.

The DHCP server uses:
\begin{itemize}
    \item Option 66: specifies which server to contact 
    \item Option 67: he name of the file to request
\end{itemize}

The client then contacts the boot server and downloads and boots the Network Bootstrap Program (NBP) using TFTP. The NBP is a small OS that contains just a kernel, basic drivers and basic programs that can download the remaining OS components. 

Using your DHCP server to store and serve this information looks like this:
\begin{itemize}
    \item 
        PXE client broadcasts DHCP DISCOVER packet over UDP port 67. It contains option 60 to identify itsef as PXE client. As this packet is broadcast it will reach PXE server and DHCP.
    \item 
        DHCP server will send DHCP OFFER over UDP port 68.
    \item 
        SCCM site server runs LOOKUPDEVICE stored process. If any deployment is present for PXE client(unknown device support is enabled in case if PXE client is not present in database), PXE server will send DHCP OFFER with option 60.
    \item 
        
        Client will not proceed if it will not receive OFFER from PXE server and will stop with PXE-MOF error. DISCOVER packet is retried 4 times on interval of 4, 8, 16, and 32 seconds.
    \item 
        
        3. PXE client will send DHCP REQUEST as acknowledgement to PXE server and for IP to DCHP server over UDP port 67.
    \item 
        
        4. DHCP server will send DHCP ACK i.e. IP address and lease over UDP port 68.
    \item 
        
        5. PXE client will send unicast DHCP REQUEST for option 66 (boot server) and option 67 (boot file) over UDP port 4011. Remember client already knows IP of PXE server from step 2.
    \item 
        
        6. PXE server will send DHCP ACK with option 66 and 67. Option 67 contains WDSNBP bootstrap file which does architecture detection of client. TFTP is used for downloading WDSNBP file over UDP port 69 and high level ports.
    \item 
        
        7. Client sends unicast DHCP REQUEST to PXE server with option 250 which includes its architecture.
    \item 
        
        8. SCCM Server runs GETBOOTACTION procedure. This is to check boot file response:
\end{itemize}

This method can work fine when your clients are on the same part of the network.

The ultimate answer and supported method is to use {\bf IP helpers} which tells the device where to go for the boot file then your PXE/WDS/SCCM server dynamically delivers the correct boot file for the device architecture/firmware

Installation is initiated by selecting the Enable PXE support for clients option on the PXE tab in Distribution point properties

The example boot process described here involves three machines: The DHCP server, the PXE-enabled DP, and the client is described \href{The example boot process described here involves three machines: The DHCP server, the PXE-enabled DP, and the client}{here}


\subsection{AdminService API}
\href{https://learn.microsoft.com/en-us/mem/configmgr/develop/adminservice/overview}{The AdminService API} is a REST API based on the Open Data v4 protocol that grants similar, however limited, administrative access to site data when compared to its WMI counterpart. There are currently two routes, shown below, available for the AdminService.
\begin{verbatim}
https://target.siteserver.domain/AdminService/wmi/
https://target.siteserver.domain/AdminService/v1.0/
\end{verbatim}

Each route provides its own functionality according to Microsoft:
\begin{verbatim}
    The WMI route supports both GET and POST commands to over 700 classes. [The] versioned route (v1.0) supports new Configuration Manager functionality.
\end{verbatim}


\subsection{CMPivot}

\href{https://learn.microsoft.com/en-us/mem/configmgr/core/servers/manage/cmpivot-overview}{CMPivot} allows you to quickly assess the state of devices in your environment and take action. When you enter a query, CMPivot will run a query in real time on all currently connected devices in the selected collection. 
