\chapter{Discovery and enumeration}
\begin{tabularx}{\linewidth}{|l|X|}
    \hline
Data Point &	Description \\
    \hline
AD Users &	try to enumerate valid user accounts that can target for password
spraying.\\
    \hline
AD Joined Computers &	Key Computers include Domain Controllers, file servers,
SQL servers, web servers, Exchange mail servers, database servers, \ldots.\\
    \hline
Key Services &	Kerberos, NetBIOS, LDAP, DNS\\
    \hline
Vulnerable Hosts and Services &	Anything that can be a quick win. (.k.a an
easy host to exploit and gain a foothold)\\
    \hline
\end{tabularx}

\begin{enumerate}
        \item passive identification of any hosts in the network,
        \item active validation of the results to find out more about each host
            (what services are running, names, potential vulnerabilities,
            \ldots.).
        \item Once hosts have been identifyed, they can be probed, looking for
            any interesting data. 
        \item Analyze hopefully a set of credentials or a user account to
            target for a foothold onto a domain-joined host have been found.
\end{enumerate}

\subsection{Hosts enumeration}
\subsubsection{Passive enumeration}

Using tools:
\begin{itemize}
    \item wireshark~\ref{tool:wireshark}, 
    \item tcpdump~\ref{tool:tcpdump},
    \item \href{https://github.com/DanMcInerney/net-creds}{net-creds}
    \item \href{http://www.netminer.com/main/main-read.do}{netminer}
    \item \verb+pktmon.exe+ (on windows)
    \item Responder~\ref{tool:responder:analyze} in analyze 
\end{itemize}

\subsubsection{Active enumeration}

Using tools:
\begin{itemize}
    \item {\bf \href{https://fping.org/}{fping}}: \verb+fping -asgq+
        172.16.5.0/23+ (\verb+a+ show alive, \verb+s+ state, \verb+g+ generate
        list and \verb+q+ per-target result)
    \item nmap~\ref{tool:nmap:enumeration}
    \item nmap~\ref{tool:nmap} (\verb+-v -A -iL hosts.txt -oA enum+) \verb+A+
        is to violent.
\end{itemize}

\subsection{Open Shares Enumeration}

See paragraph~\ref{network:smb:enum}
This enum may lead to SCF and URL file attack~\ref{smb:scf} against
writeable share which will help in sniffing hash enum.


\subsection{Identifying Potential Vulnerabilities}
The
\href{https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account}{local
system} account \verb+NT AUTHORITY\SYSTEM+ is a built-in account in Windows
operating systems. It has the highest level of access in the OS and is used to
run most Windows services. It is also very common for third-party services to
run in the context of this account by default. A \verb+SYSTEM+ account on a
domain-joined host will be able to enumerate Active Directory by impersonating
the computer account, which is essentially just another kind of user account.
Having SYSTEM-level access within a domain environment is nearly equivalent to
having a domain user account.

There are several ways to gain SYSTEM-level access on a host, including but not limited to:
\begin{itemize}
    \item  Remote Windows exploits such as MS08-067, EternalBlue, or BlueKeep.
    \item  Abusing a service running in the context of the \verb+SYSTEM account+, or abusing the service account \verb+SeImpersonate+ privileges using \href{https://github.com/ohpe/juicy-potato}{Juicy
        Potato}. This type of attack is possible on older Windows OS' but not
        always possible with Windows Server 2019.
    \item  Local privilege escalation flaws in Windows operating systems such as the Windows 10 Task Scheduler 0-day.
    \item  Gaining admin access on a domain-joined host with a local account and using Psexec to launch a SYSTEM cmd window
\end{itemize}

By gaining SYSTEM-level access on a domain-joined host, you will be able to perform actions such as, but not limited to:

\begin{itemize}
        \item Enumerate the domain using built-in tools or offensive tools such as BloodHound and PowerView.
        \item Perform Kerberoasting / ASREPRoasting attacks within the same domain.
        \item Run tools such as Inveigh to gather Net-NTLMv2 hashes or perform SMB relay attacks.
        \item Perform token impersonation to hijack a privileged domain user account.
        \item Carry out ACL attacks.
\end{itemize}


\subsection{A word of Caution}

\subsection{Login/password enumeration}
The aim is to find a list of valid users and their credentials.

\subsubsection{Hash sniffing}
\label{windows:ad:hash-sniff}

see~\ref{mitre:t1040}

\subsubsection{Retrieving Password Policies}
\verb+net accounts+

tools used:
\begin{itemize}
    \item On linux :
    \begin{itemize}
        \item with a domain account:
        \begin{itemize}
            \item CrackMapExec~\ref{tool:crackmapexec:smb:enum}
                (\verb+--pass-pol+)
            \item rpcclient~\ref{tool:rpcclient:password-policy}
                (\verb+getdompwinfo+)
        \end{itemize}
        \item SMB Null session:
        \begin{itemize}
            \item rpcclient~\ref{tool:rpcclient:password-policy}
            \item enum4linux(-ng)~\ref{tool:enum4linux:password-policy}
                (\verb+-P+) 
        \end{itemize}
        \item LDAP anonymous bind:
        \begin{itemize}
            \item ldapsearch~\ref{tool:ldapsearch:password-policy}
            \item windapseach.py
            \item ad-ldapdomaindump.py
        \end{itemize}
    \end{itemize}
    \item On Windows :
    \begin{itemize}
        \item with a domain account:
        \begin{itemize}
            \item \verb+net.exe+ (\verb+net accounts+) (built-in Windows binary)
            \item Powerview (\verb+import-module .\PowerView.ps1; Get-DomainPolicy+)
            \item SharpMapExec
            \item SharpView
            \item \ldots
        \end{itemize}
        \item LDAP anonymous bind:
        \begin{itemize}
            \item windapsearch     
        \end{itemize}
    \end{itemize}
\end{itemize}


\subsubsection{Building the user list}
tools used:
\begin{itemize}
    \item On linux with:
    \begin{itemize}
        \item   SMB NULL Session    
            \begin{itemize}
                \item rpcclient~\ref{tool:rpcclient:user-enum} (enumdomusers)
                \item enum4linux(-ng)~\ref{tool:enum4linux:user-enum} (\verb+-U+)
                \item CrackMapExec~\ref{tool:crackmapexec:user-enum} (\verb+--users+ Flag)
        \end{itemize}
        \item LDAP anonymous bind:
        \begin{itemize}
            \item  ldapsearch~\ref{tool:ldapsearch:user-enum}
            \item windapsearch~\ref{tool:windapsearch} 
        \end{itemize}
        \item with a domain account:    
            \begin{itemize}
                \item CrackMapExec~\ref{tool:crackmapexec:smb:enum}
                \item GetADUsers~\ref{tool:impacket:GetADUser}
        \end{itemize}
        \item  kerbrute~\ref{tool:kerbrute:user-enum}   
        \item nmap~\ref{tool:nmap} (\verb+krb5-enum-users+ script)
        \item metasploit~\ref{tool:metasploit}
            (\verb+auxiliary/gather/kerberos_enumusers+ module)
    \end{itemize}
\end{itemize}

\subsection{Password spraying}
While password spraying is useful, careless use may lock out hundreds of
accounts. It involves sending fewer login requests per username and is less likely to
lock out accounts than a brute force attack. However, password spraying still
presents a risk of lockouts, so it is essential to introduce a delay between
login attempts. Internal password spraying can be used to move laterally within
a network, and the same considerations regarding account lockouts apply.
However, it may be possible to obtain the domain password policy with internal
access, significantly lowering this risk.

Itâ€™s common to find a {\bf password
policy}~\ref{windows:ad:security:password_policy} that allows five bad attempts before
locking out the account, with a 30-minute auto-unlock threshold. 

Some organizations configure more extended account lockout thresholds, even
requiring an administrator to unlock the accounts manually. {\bf If the
password policy is unknown, a good rule is to wait a few hours between
attempts}, which should be long enough for the account lockout threshold to
reset. It is best to obtain the password policy before attempting the attack
, but this is not always possible. 

To mount a successful password spraying attack, A valid list of domain users is
needed to attempt to authenticate with. There are several ways to gather a
target list of valid users. 

No matter the method, it is also vital to consider
the domain password policy. Having this policy in hand is very useful because
the minimum password length and whether or not password complexity is enabled
can help formulate the list of passwords to try in the spray attempts. Knowing
the account lockout threshold and bad password timer will tell  how many spray
attempts can be done at a time without locking out any accounts and how many
minutes should waited between spray attempts.

Regardless of the method chosen, and if the password policy is available or not,
a log of activities must be keep, including, but not limited to: 

\begin{itemize}
        \item The accounts targeted
        \item Domain Controller used in the attack
        \item Time of the spray
        \item Date of the spray
        \item Password(s) attempted
\end{itemize}


{\bf From linux}:
\begin{itemize}
    \item On linux:
        \begin{itemize}
            \item kerbrute:~\ref{tool:kerbrute:password-spraying}
            \item CrackMapExec~\ref{tool:crackmapexec:smb:spraying}
            \item rpcclient~\ref{tool:rpcclient:password-spraying}
        \end{itemize}
    \item On Windows:
        \begin{itemize}
            \item kerbrute:~\ref{tool:kerbrute:password-spraying}
            \item DomainPasswordSpray:~\ref{tool:domainpasswordspray}
        \end{itemize}
\end{itemize}


\subsection{Local Administrator Password Reuse}
Internal password spraying is not only possible with domain user accounts. If
an  administrative access and the NTLM password hash or cleartext
password for the local administrator account (or another privileged local
account) is obtained, this can be attempted across multiple hosts in the network. Local
administrator account password reuse is widespread due to the use of gold
images in automated deployments and the perceived ease of management by
enforcing the same password across multiple hosts. 

CrackMapExec is a handy tool for attempting this attack. It is worth targeting
high-value hosts such as SQL or Microsoft Exchange servers, as they are more
likely to have a highly privileged user logged in or have their credentials
persistent in memory.

When working with local administrator accounts, one consideration is password re-use or common password formats across accounts. 
If a desktop host with the local administrator account password set to
something unique such as \verb+$desktop%@admin123+ is found, it might be worth
attempting \verb+$server%@admin123+ against servers. 

Also, if a non-standard local administrator accounts such as \verb+bsmith+ is
found, it is may happen that the password is reused for a similarly named
domain user account. The same principle may apply to domain accounts. If  the
password for a user named \verb+ajones+ is retreived , it is worth trying the
same password on their admin account (if the user has one), for example,
\verb+ajones_adm+, to see if they are reusing their passwords. This is also
common in domain trust situations. We may obtain valid credentials for a user
in domain A that are valid for a user with the same or similar username in
domain B or vice-versa.

If only the NTLM hash for the local administrator
account from the local SAM database is retreived, the NT hash can be spayed
across an entire subnet (or multiple subnets) to hunt for local administrator
accounts with the same password set. This can be done with
CrackMapExec~\ref{tool:crackmapexec:localadmin-spraying}

This technique, while effective, is quite noisy and does not work in case of
\href{https://www.microsoft.com/en-us/download/details.aspx?id=46899}{Local Administrator Password Solution (LAPS)}
