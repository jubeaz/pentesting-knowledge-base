\section{Login/password enumeration}
The aim is to find a list of valid users and their credentials.

\subsection{Hash sniffing}
\label{windows:ad:hash-sniff}

see~\ref{mitre:t1040}

\subsection{Building the user list}
tools used:
\begin{itemize}
    \item On linux with:
    \begin{itemize}
        \item   SMB NULL Session
            \begin{itemize}
                \item rpcclient~\ref{tool:rpcclient:user-enum} (enumdomusers)
                \item enum4linux(-ng)~\ref{tool:enum4linux:user-enum} (\verb+-U+)
                \item CrackMapExec~\ref{tool:crackmapexec:user-enum} (\verb+--users+ Flag)
        \end{itemize}
        \item LDAP anonymous bind:
        \begin{itemize}
            \item  ldapsearch~\ref{tool:ldapsearch:user-enum}
            \item windapsearch~\ref{tool:windapsearch}
        \end{itemize}
        \item with a domain account:
            \begin{itemize}
                \item CrackMapExec~\ref{tool:crackmapexec:smb:enum}
                \item GetADUsers~\ref{tool:impacket:GetADUser}
        \end{itemize}
        \item  kerbrute~\ref{tool:kerbrute:user-enum}
        \item nmap~\ref{tool:nmap} (\verb+krb5-enum-users+ script)
        \item metasploit~\ref{tool:metasploit}
            (\verb+auxiliary/gather/kerberos_enumusers+ module)
    \end{itemize}
\end{itemize}

\subsection{Password spraying}
While password spraying is useful, careless use may lock out hundreds of
accounts. It involves sending fewer login requests per username and is less likely to
lock out accounts than a brute force attack. However, password spraying still
presents a risk of lockouts, so it is essential to introduce a delay between
login attempts. Internal password spraying can be used to move laterally within
a network, and the same considerations regarding account lockouts apply.
However, it may be possible to obtain the domain password policy with internal
access, significantly lowering this risk.

Itâ€™s common to find a {\bf password
policy}~\ref{windows:ad:security:password_policy} that allows five bad attempts before
locking out the account, with a 30-minute auto-unlock threshold.

Some organizations configure more extended account lockout thresholds, even
requiring an administrator to unlock the accounts manually. {\bf If the
password policy is unknown, a good rule is to wait a few hours between
attempts}, which should be long enough for the account lockout threshold to
reset. It is best to obtain the password policy before attempting the attack
, but this is not always possible.

To mount a successful password spraying attack, A valid list of domain users is
needed to attempt to authenticate with. There are several ways to gather a
target list of valid users.

No matter the method, it is also vital to consider
the domain password policy. Having this policy in hand is very useful because
the minimum password length and whether or not password complexity is enabled
can help formulate the list of passwords to try in the spray attempts. Knowing
the account lockout threshold and bad password timer will tell  how many spray
attempts can be done at a time without locking out any accounts and how many
minutes should waited between spray attempts.

Regardless of the method chosen, and if the password policy is available or not,
a log of activities must be keep, including, but not limited to:
\begin{itemize}
        \item The accounts targeted
        \item Domain Controller used in the attack
        \item Time of the spray
        \item Date of the spray
        \item Password(s) attempted
\end{itemize}


{\bf From linux}:
\begin{itemize}
    \item On linux:
        \begin{itemize}
            \item kerbrute:~\ref{tool:kerbrute:password-spraying}
            \item CrackMapExec~\ref{tool:crackmapexec:smb:spraying}
            \item rpcclient~\ref{tool:rpcclient:password-spraying}
        \end{itemize}
    \item On Windows:
        \begin{itemize}
            \item kerbrute:~\ref{tool:kerbrute:password-spraying}
            \item DomainPasswordSpray:~\ref{tool:domainpasswordspray}
        \end{itemize}
\end{itemize}
