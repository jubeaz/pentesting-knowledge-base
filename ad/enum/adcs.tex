\section{Enumeration}

\subsection{Domain group}
An initial indicator is the "Cert Publishers" built-in group whose members
usually are the servers where AD CS is installed 

\begin{itemize}
    \item From linux: 
    \verb+rpc net group members "Cert Publishers" -U "DOMAIN"/"User"%"Password" -S "DomainController"+
    \item From window: \verb+net group "Cert Publishers" /domain+

\end{itemize}

\subsection{pKIEnrollmentService}

\subsubsection{Ldap}

Enterprise CAs and their settings can queried using the
\verb+(objectCategory=pKIEnrollmentService)+ LDAP filter on the
\verb+CN=Configuration,DC=<DOMAIN>,DC=<COM>+  search base

\begin{verbatim}
$ ldapsearch  -H ldaps://10.10.11.202 \
    -D sql_svc@sequel.htb -w REGGIE1234ronnie  \
    -b 'CN=Configuration,DC=sequel,DC=htb' \
    '(objectCategory=pKIEnrollmentService)'
\end{verbatim}

Templates:
\begin{verbatim}
$ ldapsearch  -H ldaps://10.10.11.202 \
    -D sql_svc@sequel.htb -w REGGIE1234ronnie  \
    -b 'CN=Configuration,DC=sequel,DC=htb' \
    '(objectCategory=pKICertificateTemplate)'
\end{verbatim}


\subsubsection{windows tools}
\begin{verbatim}
certutil.exe -TCAInfo
certutil -v -dstemplate
\end{verbatim}

\subsubsection{linux tools}
\begin{verbatim}
# CME
crackmapexec ldap 'domaincontroller' -d 'domain' -u 'user' -p 'password' \
    -M adcs

# impacket ntlmrelayx
ntlmrelayx -t "ldap://domaincontroller" --dump-adcs
\end{verbatim}


\subsection{Attack paths}

\subsubsection{certify}
\begin{itemize}
    \item Enumerate trusted root CA certificates, certificates defined by the
        NTAuthCertificates object, and various information about Enterprise
        CAs:
\begin{verbatim}
certyfy.exe cas
\end{verbatim}
    \item enumerate Enterprise CAs and return detailed information about the
certificate templates each one publishes:
\begin{verbatim}
certify.exe find
\end{verbatim}

\end{itemize}

\subsubsection{certipy -find}

By default, Certipy uses LDAPS, which is not always supported by the domain controllers. 
The \verb+-scheme+ flag can be used to set whether to use LDAP or LDAPS.


\begin{verbatim}
$ certipy find \
    -u Ryan.Cooper -p NuclearMosquito3 \
    -dc-ip 10.10.11.202 \
    -old-bloodhound 

$ certipy find \
    -u Ryan.Cooper -p NuclearMosquito3 \
    -dc-ip 10.10.11.202 \
    -vulnerable -stdout

\end{verbatim}





\subsubsection{bloodhound}

use \verb+certipy+ with \verb+-old-bloodhound+ to export and use \href{https://github.com/ly4k/Certipy/blob/main/customqueries.json}{custome requests}
