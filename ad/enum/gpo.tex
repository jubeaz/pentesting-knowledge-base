\section{GPO}

\subsection{pyperview}

list gpo:
\begin{verbatim}
pywerview.py get-netgpo -l DEBUG  -t <dc_ip> -w <domain_fqdn> -u <user> -p <password> 
\end{verbatim}

list ou with gpo linked:
\begin{verbatim}

# to sites
pywerview.py get-netsite -t <dc_ip> -w <domain_fqdn> -u <user> -p <password>  --full-data --json 
    | jq '.results | map(select(.gplink | contains("policies")))'
    
# to OU
pywerview.py get-netou -t <dc_ip> -w <domain_fqdn> -u <user> -p <password>  --full-data --json 
    | jq '.results | map(select(.gplink | contains("policies")))'
\end{verbatim}

\subsection{Get-GPOEnumeration}
\href{https://github.com/juliourena/plaintext/blob/master/Powershell/Get-GPOEnumeration.ps1}{Get-GPOEnumeration} is a wrapper that use PowerView to automate the GPO enumeration

\subsection{Powerview}

\begin{verbatim}
Import-Module .\PowerView.ps1
Get-DomainGPO | Select-Object -First 1
\end{verbatim}


\begin{verbatim}
Get-DomainObject -SearchScope Base -Properties gplink
\end{verbatim}
\begin{itemize}
    \item 
    0 - The GPO is enabled.
    \item 
    1 - The GPO is disabled.
    \item 
    2 - The GPO link is enforced.
    \item 
    3 - The GPO link is enforced, but the GPO is disabled.
\end{itemize}

\begin{verbatim}
Get-DomainGPO | 
    Select-Object -First 1 | 
    Get-DomainObjectAcl -ResolveGUIDs | 
    where { 
        $_.ActiveDirectoryRights -match "CreateChild|WriteProperty|DeleteChild|DeleteTree|WriteDacl|WriteOwner" \
        -and $_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$' }

ConvertFrom-SID
\end{verbatim}

\begin{verbatim}
Get-DomainOU | select name, gplink
\end{verbatim}

Searching for users with rights to Create GPOs:
\begin{verbatim}
$identity = (Get-DomainGPO).distinguishedname -replace 'CN=\{[A-F0-9-]+\},',''; 
    Get-DomainObjectACL -Identity $identity -ResolveGUIDs | 
    where { $_.ActiveDirectoryRights -contains "CreateChild" -and 
        $_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$' } |
        foreach { ConvertFrom-SID $_.SecurityIdentifier }
\end{verbatim}

Searching for users with rights to Link GPOs:
\begin{verbatim}
Get-DomainSite -Properties distinguishedname | 
    foreach { Get-DomainObjectAcl -SearchBase $_.distinguishedname -ResolveGUIDs |
        where { $_.ObjectAceType -eq "GP-Link" -and 
                $_.ActiveDirectoryRights -match "WriteProperty" } |
        select ObjectDN, @{Name='ResolvedSID';Expression={ConvertFrom-SID $_.SecurityIdentifier}} | 
        Format-List }

Get-DomainObjectAcl -SearchScope Base -ResolveGUIDs |
    where { $_.ObjectAceType -eq "GP-Link" -and
            $_.ActiveDirectoryRights -match "WriteProperty" } |
    select ObjectDN, @{Name='ResolvedSID';Expression={ConvertFrom-SID $_.SecurityIdentifier}} |
    Format-List

Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs |
     where { $_.ObjectAceType -eq "GP-Link" -and
             $_.ActiveDirectoryRights -match "WriteProperty" } |
    select ObjectDN, @{Name='ResolvedSID';Expression={ConvertFrom-SID $_.SecurityIdentifier}} |
    Format-List
\end{verbatim}



\subsection{GPOwned}
list gpo:
\begin{verbatim}
GPOwned.py -u <user> -p <password> -d <domain_fqdn> -dc-ip <dc_fqdn> -gpcuser -listgpo
GPOwned.py -u <user> -p <password> -d <domain_fqdn> -dc-ip <dc_fqdn> -gpcmachine -listgpo
\end{verbatim}

list gp-link:
\begin{verbatim}
GPOwned.py -u <user> -p <password> -d <domain_fqdn> -dc-ip <dc_fqdn> -gpcuser -listgplink
GPOwned.py -u <user> -p <password> -d <domain_fqdn> -dc-ip <dc_fqdn> -gpcmachine -listgplink
\end{verbatim}

\subsection{dacledit}
\begin{verbatim}
dacledit.py inlanefreight.local/gabriel:Godisgood001 \
    -target-dn "CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=inlanefreight,DC=local" \
    -dc-ip 172.16.92.10
\end{verbatim}


\subsection{sharpview}


\subsection{Usefull GPO}


\subsubsection{GPO Refresh Frequency}
\begin{verbatim}
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
GroupPolicyRefreshTime 
Data type 	Range 	Default value
REG_DWORD 	0 - 64800 minutes 	90
\end{verbatim}

The Group Policy refresh interval for computers policy also includes an time offset to prevent clients with the same update interval from requesting updates simultaneously. The offset is stored in the value of GroupPolicyRefreshTimeOffset.

If background updates are disabled (that is, the value of DisableBkGndGroupPolicy entry is 1, this entry is ignored.

This entry can appear in both \verb+HKEY_LOCAL_MACHINE+ and \verb+HKEY_CURRENT_USER+. If this entry appears in both subtrees, the value in \verb+HKEY_LOCAL_MACHINE+ takes precedence over the value in \verb+HKEY_CURRENT_USER+.

Tip

Consider notifying users that their policy is updated periodically so that they recognize the signs of a policy update. When Group Policy is updated, the Windows desktop is refreshed; it flickers briefly and closes open menus. Also, restrictions imposed by Group Policies, such as those that limit the programs users can run, might interfere with tasks in progress.

To specify that Group Policy should never be updated while the computer is in use, enable the Disable background refresh of Group Policy policy (see DisableBkGndGroupPolicy).

For detailed information about particular Group Policy settings, see the Group Policy Reference (Gp.chm) on the Windows 2000 Resource Kit companion CD.

For general information about Group Policy, see Group Policy in Windows 2000 Help.

To see a table associating policies with their corresponding registry entries, see the Group Policy Reference Table.


\begin{verbatim}
Get-WindowsFeature | Where-Object {$_.installstate -eq "installed"}
Get-WindowsFeature | Where-Object {$_.name -eq "GPMC"}
Install-WindowsFeature GPMC
Install-WindowsFeature -Name RSAT-ADDS-Tools
Add-WindowsFeature -Name "RSAT-AD-PowerShell" â€“IncludeAllSubFeature

Get-ADComputer -Filter * | % {Invoke-GPUpdate -Computer $_.name -Force -RandomDelayInMinutes 0}
proxychains -q nxc smb workstations -u rweston_da -p 'W0lv3rh@mpt0n!!'  --exec-method smbexec   -x 'gpupdate /force'

\end{verbatim}

\subsubsection{Other GPO}
\begin{itemize}
    \item \href{https://admx.help/?Category=Windows_10_2016&Policy=Microsoft.Policies.GroupPolicy::GroupPolicyRefreshRate}{enable winrm}

    \item diable defender:
        \begin{itemize}
            \item \verb+Computer Configuration/Policies/Administrative Templates/Windows Components/Windows Defender/+
                \begin{itemize}
                    \item Turn off Windows Defender
                \end{itemize}
            \item \verb+Computer Configuration/Policies/Administrative Templates/Windows Components/Windows Defender/Real-time Protection+
                \begin{itemize}
                    \item Scan all downloaded files and attachments
                    \item Turn off real-time protection
                    \item Turn on behavior monitoring
                \end{itemize}
            \item \verb+Computer Configuration/Policies/Administrative Templates/Windows Components/Windows Defender/MAPS+
                \begin{itemize}
                    \item Join Microsoft MAPS disabled
                    \item Send file samples when further analysis is required: disabled
                \end{itemize}
            \item \verb+Computer Configuration/Policies/Administrative Templates/Windows Components/Windows Defender/Exclusions+
                \begin{itemize}
                    \item Path Exclusions 
                \end{itemize}

        \end{itemize}\verb+Computer Configuration\Policies\Windows Settings\Security Settings\Local Policies\Security Options+
    \item disable firewall:\verb+Computer Configuration/Policies\Windows Settings\Security Settings\Windows Firewall with Advanced Security+
    \item disable uac \verb+Preferences/Windows Settings/Registry/LocalAccountTokenFilterPolicy/+
        \begin{itemize}
            \item \verb+Hive HKEY_LOCAL_MACHINE+ 
            \item \verb+Key path SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System+
            \item \verb+Value name LocalAccountTokenFilterPolicy+
            \item \verb+Value type REG_DWORD+
            \item \verb+Value data 0x1 (1)+
        \end{itemize}
    \item refresh cycle: \verb+Policies/Administrative Templates/System/Group Policy/+
        \begin{itemize}
            \item Configure registry policy processing (Do not apply during periodic background processing Disabled, Process even if the Group Policy objects have not changed Enabled)

            \item Set Group Policy refresh interval for computers
            \item Set Group Policy refresh interval for domain controllers
        \end{itemize}
    \item refresh cycle user \verb+User Configuration/Policies/Administrative Templates/System/Group Policy/Set Group Policy refresh interval for users+
    \item start/stop services: \verb+Preferences/Control Panel Settings/Services/winrm+ start automatic

    \item rdp: \verb+Computer Configuration/Policies/Administrative Templates/Windows Components/Remote Desktop Services/Remote Desktop Session Host/Connections+
        \begin{itemize}
            \item Allow users to connect remotely by using Remote Desktop Services
            \item Limit number of connections
            \item Restrict Remote Desktop Services users to a single Remote Desktop Services session
        \end{itemize}

    \item winrm: \verb+Computer Configuration/Policies/Administrative Templates/Windows Components/Windows Remote Management (WinRM)/WinRM Service+
        \begin{itemize}
            \item Allow remote server management through WinRM (no filtr)
        \end{itemize}
    \item applocker:
        \begin{itemize}
            \item \verb+Policies/Windows Settings/Security Settings/System Services/Application Identity (Startup Mode: Automatic)+
            \item \item \verb+Policies/Windows Settings/Security Settings/Application Control Policies+
        \end{itemize}
    \item login restrictions:
        \begin{itemize}
            \item \verb+Policies/Windows Settings/Security Settings/Local Policies/User Rights Assignment+
        \end{itemize}
    \item user / group mgp:
        \begin{itemize}
            \item \verb+Policies/Preferences/control Panel Settings/Local users and Groups+
        \end{itemize}
\end{itemize}

\subsection{Links}

\begin{itemize}
    \item \href{https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/gpo-abuse}{Hunt for GPOs}

    \item \href{https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn789195(v=ws.11)}{Delegate Permissions for Group Policy}   
\end{itemize}