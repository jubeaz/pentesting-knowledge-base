
\section{Golden SAML}

\href{https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#adfs---golden-saml}{PayloadsAllTheThings}


\href{https://www.secureworks.com/blog/going-for-the-gold-penetration-testing-tools-exploit-golden-saml}{Penetration Testing Tools Exploit Golden SAML}

\subsection{Remote extraction of AD FS configuration}
An attacker only needs three components to remotely extract an AD FS server’s configuration setting:
\begin{itemize}
    \item 
        The IP address or fully qualified domain name (FQDN) of any AD FS server
    \item
        The NTHash of the AD FS service account
    \item
        The security identifier (SID) of the AD FS service account
\end{itemize}

The threat actor can use the NTHash and SID to build a Kerberos ticket that provides authentication for the target AD FS server.
\begin{enumerate}
    \item 
    Obtain the AD FS service account’s NTHash and SID.
    \item 
    Craft a custom Kerberos ticket that is wrapped in an \verb+AP_REQ+ message, which is then wrapped in a SPNEGO message.
    \item 
    Pass the custom Base64-encoded Kerberos ticket in a RequestSecurityToken (RST) SOAP envelope to the AD FS server over HTTP. The server validates the RST SOAP envelope format and the authentication via the custom Kerberos ticket and returns the requested security token to the attacker.
    \item 
    Parse and validate the RST response envelope and extract the Key, Context, and KeyIdentifier values.
    \item 
    Use these RST response values to create and sign a SecurityTokenContext (SCT) envelope that is passed to the AD FS server over HTTP.
    \item 
    Parse and validate the SCT response envelope and extract the Key, Context, and KeyIdentifier values.
    \item 
    Use these SCT response values to create and sign a final SOAP envelope requesting the ‘ServiceSettings’ database entry from the AD FS server.
    \item 
    Parse and validate the final SOAP response envelope and extract all of the AD FS configuration settings from the ServiceSettings entry in XML format.
    \item 
    Parse the XML data to obtain the EncryptedPfx and the Trust Issuer Address.
\end{enumerate}
