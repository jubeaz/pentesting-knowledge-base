\chapter{DCSync attack}
\label{kerberos:DCSync}

\begin{itemize}
    \item
        \href{https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#dumping-ad-domain-credentials}{PayloadsAllTheThings}
    \item
        \href{https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/dcsync}{Hacktricks}
\end{itemize}

DCSync is a technique for stealing the Active Directory password database by
using the built-in  \emph{Directory Replication Service Remote Protocol}, which
is used by Domain Controllers to replicate domain data. This allows an attacker
to mimic a Domain Controller to retrieve user NTLM password hashes. 

The crux of the attack is requesting a Domain Controller to replicate passwords
via the \verb+DS-Replication-Get-Changes-All+ extended right. This is an
extended access control right within AD, which allows for the replication of
secret data.


\section{Cheking rights}
To perform this attack, an account that has the rights to perform domain
replication (a user with the \emph{Replicating Directory Changes} and \emph{Replicating
Directory Changes All} permissions set) must be controled. 

To check who is able to perform this attack use a filter \\( 
\verb+| ? { ($_.ObjectAceType -match 'Replication-Get')}+ ) on ojects resturn by
either  a
\verb+Get-ObjectAcl+~\ref{tool:wlol:ad:get-ObjectACL} or
\verb+Get-DomainObjectACL+~\ref{tool:powerview:Get-DomainObjectACL} from
PowerView. 

{\bf Note:} \verb+WriteDacl+ will allow to add the right with
\verb+Add-DomainObjectACL+


\section{Performing the attack}

\begin{verbatim}
$ cmd $target $ident --ntds --user administrator
\end{verbatim}

Extracting NTLM Hashes and Kerberos Keys Using
secretsdump.py~\ref{tool:impacket:secretsdump:remote:NTDS}.

Performing the Attack with Mimikatz~\ref{tool:mimikatz:DCSync}


{\bf Note:} 
\begin{itemize}
    \item Read-Only Domain Controllers are not allowed to pull password data for users by default.
    \item Some user may have reversible encryption (revers key is stored in
        system registry hive). Such users can be enumerated
\end{itemize}


