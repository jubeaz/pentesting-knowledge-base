\section{Security in Active Directory}

\url{https://docs.microsoft.com/en-us/security/compass/compass}

\url{https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/best-practices-for-securing-active-directory}

Active Directory can be considered insecure by design because of  many features and functionalities are built around the premise of central management and the ability to share information quickly, at will, to a large userbase. 


A default Active Directory installation will be missing many hardening measures, settings, and tools that can be used to secure an AD implementation. 

Finding a balanced CIA Triad is hard and AD leans heavily toward Availability and Confidentiality at its core.

We can help balance the scales by utilizing Microsoft's built-in features that
can be enabled/tweaked to harden AD against common attacks. 

The list below is not exhaustive. Many other general security hardening principles must be in place within an organization to ensure a proper defense-in-depth approach (having an accurate asset inventory, vulnerability patches, configuration management, endpoint protection, security awareness training, network segmentation, etc.).

\subsection{Kerberos encryption types allowed}

It is possible to edit the encryption types used by Kerberos. This can be done
by opening Group Policy, editing the Default Domain Policy, and choosing:
Computer Configuration > Policies > Windows Settings > Security Settings >
Local Policies > Security Options, then double-clicking on Network security:
Configure encryption types allowed for Kerberos.

\subsection{Local Administrator Password Solution (LAPS)}
\label{windows_knowledge:ad:security:laps}
\href{https://www.microsoft.com/en-us/download/details.aspx?id=46899}{LAPS} is
used to randomize and rotate local administrator passwords on Windows hosts and prevent lateral movement.



{\bf How does LAPS work?}
The core of the LAPS solution is a GPO client-side extension (CSE) that
performs the following tasks and can enforce the following actions during a GPO
update:
\begin{itemize}
\item  Checks whether the password of the local Administrator account has expired.
\item  Generates a new password when the old password is either expired or is required to be changed prior to expiration.
\item  Validates the new password against the password policy.
\item  Reports the password to Active Directory, storing it with a confidential attribute with the computer account in Active Directory.
\item  Reports the next expiration time for the password to Active Directory, storing it with an attribute with the computer account in Active Directory.
\item  Changes the password of the Administrator account.
\end{itemize}
The password then can be read from Active Directory \verb+ms-Mcs-AdmPwd+  by
users who are allowed to do so. Eligible users can request a password change
for a computer.


{\bf What are the features of LAPS?}
LAPS includes the following features:
\begin{itemize}
\item  Security that provides the ability to:
    \begin{itemize}
            \item Randomly generate passwords that are automatically changed on managed machines.
            \item Effectively mitigate PtH attacks that rely on identical local account passwords.
            \item Enforced password protection during transport via encryption using the Kerberos version 5 protocol.
            \item Use access control lists (ACLs) to protect passwords in Active Directory and easily implement a detailed security model.
    \end{itemize}
\item Manageability that provides the ability to:
\begin{itemize}
        \item Configure password parameters, including age, complexity, and length.
        \item Force password reset on a per-machine basis.
        \item Use a security model that is integrated with ACLs in Active Directory.
        \item Use any Active Directory management tool of choice; custom tools, such as Windows PowerShell, are provided.
        \item Protect against computer account deletion.
        \item Easily implement the solution with a minimal footprint.
    \end{itemize}
\end{itemize}

to retreive the plain text password :
\begin{verbatim}
Get-AdmPwdPassword â€“ComputerName <ComputerName>
\end{verbatim}

\subsection{Audit Policy Settings (Logging and Monitoring)}

\subsection{Group Policy Security Settings}
\url{https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/security-policy-settings}

The following is a non-exhaustive list of the types of security policies that can be applied:
\begin{itemize}
    \item Account Policies - Manage how user accounts interact with the domain. These include the password policy, account lockout policy, and Kerberos-related settings such as the lifetime of Kerberos tickets

    \item Local Policies - These apply to a specific computer and include the security event audit policy, user rights assignments (user privileges on a host), and specific security settings such as the ability to install drivers, whether the administrator and guest accounts are enabled, renaming the guest and administrator accounts, preventing users from installing printers or using removable media, and a variety of network access and network security controls.

    \item Software Restriction Policies - Settings to control what software can be run on a host.

    \item Application Control Policies - Settings to control which applications can be run by certain users/groups. This may include blocking certain users from running all executables, Windows Installer files, scripts, etc. Administrators use AppLocker to restrict access to certain types of applications and files. It is not uncommon to see organizations block access to CMD and PowerShell (among other executables) for users that do not require them for their day-to-day job. These policies are imperfect and can often be bypassed but necessary for a defense-in-depth strategy.

    \item Advanced Audit Policy Configuration - A variety of settings that can be adjusted to audit activities such as file access or modification, account logon/logoff, policy changes, privilege usage, and more.
\end{itemize}

\subsection{Advanced Audit Policy}

\subsection{Update Management (SCCM/WSUS)}

\subsection{Protected Users Group}
\label{windows_knowledge:ad:security:protected-users-group}

The
\href{https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/protected-users-security-group}{Protected
Users group} first appeared with Window Server 2012 R2. This group can be used
to restrict what members of these privileged groups can do in a domain. Adding
users to Protected Users prevents user credentials from being abused if left in
memory on a host.
The group provides the following Domain Controller and device protections:
\begin{itemize}
    \item  Group members can not be delegated with constrained or unconstrained delegation.
    \item  CredSSP will not cache plaintext credentials in memory even if Allow delegating default credentials is set within Group Policy.
    \item  Windows Digest will not cache the user's plaintext password, even if Windows Digest is enabled.
    \item  Members cannot authenticate using NTLM authentication or use DES or RC4 keys.
    \item  After acquiring a TGT, the user's long-term keys or plaintext credentials are not cached.
    \item  Members cannot renew a TGT longer than the original 4-hour TTL.
\end{itemize}


\subsection{Group Managed Service Accounts (gMSA)}
\label{windows_knowledge:ad:security:gMSA}
 
\href{https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview}{gMSA} is an account managed by the domain that offers a higher level of security than other types of service accounts for use with non-interactive applications, services, processes, and tasks that are run automatically but require credentials to run. They provide automatic password management with a 120 character password generated by the domain controller. The password is changed at a regular interval and does not need to be known by any user. It allows for credentials to be used across multiple hosts.

 \subsection{Account Separation}

Administrators must have two separate accounts. One for their day-to-day work and a second for any administrative tasks they must perform. For example, a user could log into their machine using their account to send/receive an email, create documents, etc. They should have a separate account to access a secure administrative host used to perform administrative tasks. This can help ensure that if a user's host is compromised (through a phishing attack, for example), the attacker would be limited to that host and would not obtain credentials for a highly privileged user with considerable access within the domain. It is also essential for the individual to use different passwords for each account to mitigate the risk of password reuse attacks if their non-admin account is compromised.

\subsection{Password Complexity Policies + Passphrases + 2FA}

\subsubsection{Password Policy}
\label{windows:ad:security:password_policy} 

The default password policy when a new domain is created is as follows, and
there have been plenty of organizations that never changed this policy:

\begin{tabular}{|l|c|}
    \hline
Policy &	Default Value\\
    \hline
Enforce password history &	24 days\\
    \hline
Maximum password age &	42 days\\
    \hline
Minimum password age &	1 day\\
    \hline
Minimum password length &	7\\
    \hline
Password must meet complexity requirements &	Enabled\\
    \hline
Store passwords using reversible encryption &	Disabled\\
    \hline
Account lockout duration &	Not set\\
    \hline
Account lockout threshold &	0\\
    \hline
Reset account lockout counter after &	Not set\\
    \hline
\end{tabular}

\subsection{Limiting Domain Admin Account Usage}
All-powerful Domain Admin accounts should only be used to log in to Domain Controllers, not personal workstations, jump hosts, web servers, etc. This can significantly reduce the impact of an attack and cut down potential attack paths should a host be compromised. This would ensure that Domain Admin account passwords are not left in memory on hosts throughout the environment.

\subsection{Periodically Auditing and Removing Stale Users and Objects}

It is important for an organization to periodically audit Active Directory and remove or disable any unused accounts. For example, there may be a privileged service account that was created eight years ago with a very weak password that was never changed, and the account is no longer in use. Even if the password policy had since been changed to be more resistant to attacks such as password spraying, an account such as this may be a quick and easy foothold or method for lateral movement or privilege escalation within the domain.

\subsection{Auditing Permissions and Access}

Organizations should also periodically perform access control audits to ensure that users only have the level of access required for their day-to-day work. It is important to audit local admin rights, the number of Domain Admins (do we really need 30 of them?), and Enterprise Admins to limit the attack surface, file share access, user rights (i.e., membership in certain privileged security groups), and more.

\subsection{Audit Policies and Logging}

Visibility into the domain is a must. An organization can achieve this through robust logging and then using rules to detect anomalous activity (such as many failed login attempts that could be indicative of a password spraying attack) or indicators that a Kerberoasting attack is being attempted. These can also be used to detect Active Directory enumeration. It is worth familiarizing ourselves with Microsoft's Audit Policy Recommendations to help detect compromise.

\subsection{Using Restricted Groups}

Restricted Groups allow for administrators to configure group membership via Group Policy. They can be used for a number of reasons, such as controlling membership in the local administrator's group on all hosts in the domain by restricting it to just the local Administrator account and Domain Admins and controlling membership in the highly privileged Enterprise Admins and Schema Admins groups and other key administrative groups.

\subsection{Limiting Server Roles}

It is important not to install additional roles on sensitive hosts, such as installing the Internet Information Server (IIS) role on a Domain Controller. This would increase the attack surface of the Domain Controller, and this type of role should be installed on a separate standalone web server. Some other examples would be not hosting web applications on an Exchange mail server and separating web servers and database servers out to different hosts. This type of role separation can help to reduce the impact of a successful attack.

\subsection{Limiting Local Admin and RDP Rights}

Organizations should tightly control which users have local admin rights on which computers. As stated above, this can be achieved using Restricted Groups. I have seen too many organizations with the entire Domain Users group with local admin rights on one or more hosts. This would allow an attacker that compromises ANY account (even a very low privileged one) to access that host as a local admin and potentially obtain sensitive data or steal high privileged domain account credentials from memory if another user is logged in. The same goes for Remote Desktop (RDP) rights. If many users can RDP to one or many machines, this increases the risk of sensitive data exposure or potential privilege escalation attacks, leading to further compromise.

\subsection{SID filtering}
\label{ad:security:sid-filtering}

According to Microsoft, the {\bf security boundary in Active Directory is the forest, not the domain}. The forest defines the boundaries of trust and controls access to resources within the forest.

Users cannot access resources in other forests unless a trust relationship has been established between the forests.

\href{https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html}{SSID filtering} plays an important role in the security boundary by making sure "only SIDs from the trusted domain will be accepted for authorization data returned during authentication. SIDs from other domains will be removed" (\verb+netdom+ cmdlet output). By default, SID filtering is disabled for intra-forest trusts, and enabled for inter-forest trusts. 

Section \href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280}{4.1.2.2 of MS-PAC]} specifies what is filtered and when. There are three important things to remember from this documentation:
\begin{itemize}
    \item if SID filtering is fully enabled, all SIDs that differ from the trusted domain will be filtered out
    \item even if it's enabled, a few SIDs will (almost) never be filtered: "Enterprise Domain Controllers" (S-1-5-9) SID and those described by the \href{https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/f2ef15b6-1e9b-48b5-bf0b-019f061d41c8#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4}{trusted domain object (TDO)} ,as well as seven well-known SIDs 
    \item Cross-forest trusts are more stringently filtered than external trusts, meaning that in External trusts, SID filtering only filters out RID < 1000.
\end{itemize}

To hunderstand how it works read \href{https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/}{Active Directory forest trusts part 1 - How does SID filtering work?}
