\section{Kerberos delegation}
\label{windows:authentication:kerberos:delegation}
{\bf Delegation allows a service to access another service on behalf
of the user}

\subsection{Delegation principle}

A web server allows a user to access his personal folder, hosted on a file
server. We are in the following situation :
\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/knowledge/images/webfsuser.png}
  \caption{web fs user}
  \label{fig:webfsuser}
\end{figure}
The web server is front-end, and it’s this web server that will fetch the
information instead of the user on the file server in order to display the
content of a file, for example.

However, the web server does not know what belongs to the user on the file
server. It is not his role to unpack the user’s PAC to make a specific demand
to the file server. This is where the delegation comes in.

This mechanism allows the web server to {\bf impersonate} the user, and to
authenticate on the user’s behalf to the file serve.

from the file server’s point of view, it is the user who makes the request. The
file server will be able to read and check user’s rightsr, then send back the
information to which this account has access.

\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/knowledge/images/impersonation.png}
  \caption{Impersonation}
  \label{fig:impersonation}
\end{figure}

The ability to relay credentials can be given to an {\bf account with at least
one SPN attribute set}. It could be a computer account or a service account.

Note that account with \verb+NOT_DELEGATED (0x100000)+ could not be impersonated

there are three ways to authorize a computer or service account to impersonate
a user in order to communicate with one or more other service(s).

\subsection{Unconstrained Delegation}
With Unconstrained Delegation, the server or the service account that is
granted this right is able to impersonate a user to authenticate to {\bf any
services on any host}.

\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/knowledge/images/unconstrained_delegation_schema.png}
  \caption{Unconstrained delegation}
  \label{fig:unconstrained_delegation_schema}
\end{figure}

Unconstrained delegation account have the \verb+TRUSTED_FOR_DELEGATION (0x80000)+ bit set in the UAC
\begin{verbatim}
Set-ADAccountControl -Identity TestgMSA$ ` 
    -TrustedForDelegation $true `
    -TrustedToAuthForDelegation $false

Set-ADServiceAccount -Identity TestgMSA$ ` 
    -Clear 'msDS-AllowedToDelegateTo'
\end{verbatim}




\subsection{Constrained Delegation}
If a computer or a service account has the Constrained Delegation flag set, a
list of authorized services shall be associated to this flag (\verb+msDS-AllowedToDelegateTo+). 

\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/knowledge/images/constrained_delegation_schema.png}
  \caption{Constrained delegation}
  \label{fig:constrained_delegation_schema}
\end{figure}

There are two cases:
\begin{itemize}
  \item constrained delegation {\bf with protocol transition}: the account is allowed to impersonate an account that did not authenticate with kerberos
  \item constrained delegation {\bf without protocol transition}: the account is not allowed to impersonate an account that did not authenticate with kerberos
\end{itemize}


\subsubsection{With Protocol Transition}
\begin{verbatim}
Set-ADAccountControl -Identity TestgMSA$ ` 
    -TrustedForDelegation $false `
    -TrustedToAuthForDelegation $true


Set-ADComputer -Identity TestgMSA$ `
  -Add @{'msDS-AllowedToDelegateTo'=@('<spn>')}
\end{verbatim}

\subsubsection{Without Protocol Transition}
\begin{verbatim}
Set-ADAccountControl -Identity TestgMSA$ ` 
    -TrustedForDelegation $false `
    -TrustedToAuthForDelegation $false
  
  
Set-ADComputer -Identity TestgMSA$ `
    -Add @{'msDS-AllowedToDelegateTo'=@('<spn>')}
  \end{verbatim}
  

\subsection{Resource Based Delegation}
In resource based Kerberos delegation, computers (resources) specify who they
trust and who can delegate authentications to them.

This is similar to the basic constrained delegation but instead of giving
permissions to an object to impersonate any user against a service.
Resource-based Constrain Delegation sets in the object who is able to
impersonate any user against it.

Thus, the diagram is as follows :
\begin{figure}[!ht]
  \includegraphics[width=\linewidth]{ad/knowledge/images/resource_based_constrained_delegation_schema.png}
  \caption{iRessource Based delegation}
  \label{fig:resource_based_constrained_delegation_schema}
\end{figure}
The responsibility is shifted, it’s at the level of the resource that receives
the delegated authentications that the information of whether or not the
delegation is accepted is found.

In other words, it’s the end resource that says “I allow this list of accounts
 to authenticate to me on behalf of someone else”.

In this case, the constrained object will have an attribute called
\verb+msDS-AllowedToActOnBehalfOfOtherIdentity+ with the name of the user that
can impersonate any other user against it.

Another important difference from this Constrained Delegation to the other
delegations is that any user with write permissions over a machine account
(\verb+GenericAll/GenericWrite/WriteDacl/WriteProperty/+\ldots) can set the
\verb+msDS-AllowedToActOnBehalfOfOtherIdentity+ (In the other forms of
Delegation you needed domain admin privs).

\begin{verbatim}
Set-ADComputer $target -PrincipalsAllowedToDelegateToAccount $source
\end{verbatim}

{\bf An important observation is that every resource can configure resource-based constrained delegation for itself.}

\subsection{Technical details}
see~\ref{kerberos:delegation}

\subsection{Conclusion}

To sum up, there are three types of delegation:
\begin{itemize}
    \item 
    Unconstrained delegation: the client sends a copy of his TGT to a service, and that service uses it to impersonate the client to any other service. Only an administrator can set this option on an account.
    \item 
    Constrained delegation: A list of resources is set on the service that wishes to delegate authentication. If protocol transition is allowed, then the service can pretend to be anyone when accessing resources in its list. In any case, only an administrator can set this option.
    \item 
    Resource-based Constraint Delegation: The final resource has a list of trusted accounts. All accounts in this list can delegate authentication when accessing the resource. Resources can modify this list as they wish, they don’t need an administrator to update it.
\end{itemize}


