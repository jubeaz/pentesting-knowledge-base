\section{ADCS}
\label{windows:adcs:intro}

\subsection{LDAP referencement}

under container \verb+CN=Public Key Services,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>+
\begin{itemize}
    \item \verb+Certification Authorities+: Each
CA is represented as an AD object inside the container where the
\verb+objectClass+ is set to \verb+certificationAuthority+ and the
\verb+cACertificate+ property contains the bytes of the CA’s certificate.
    \item \verb+Enrollment Services+: Enterprise CA has an AD object with the
following attributes: 
        \begin{itemize}
            \item An \verb+objectClass+ attribute to
            \verb+pKIEnrollmentService+
            \item A \verb+cACertificate+ attribute containing the bytes of the CA’s certificate
            \item A \verb+dNSHostName+ property sets the DNS host of the CA
            \item A \verb+certificateTemplates+ field defining the enabled
                certificate templates. Certificate templates are a “blueprint”
                of settings that the CA uses when creating a certificate.
        \end{itemize}
    \item The \verb+NTAuthCertificates+ AD object defines CA certificates that
        enable authentication to AD. This object has an \verb+objectClass+ of
        \verb+certificationAuthority+ and the object’s \verb+cACertificate+
        property defines an array of trusted CA certificates. Client
        applications can authenticate to AD using a certificate only if one the
        CAs defined by the \verb+NTAuthCertificates+ object has signed the
        authenticating client’s certificate.
    \item The \verb+AIA+ (Authority Information Access) container holds the AD
        objects of intermediate and cross CAs. Like the Certification
        Authorities container, each CA is represented as an AD object in the
        AIA container where the \verb+objectClass+ attribute is set to
        \verb+certificationAuthority+ and the \verb+cACertificate+ property
        contains the bytes of the CA’s certificate. 
\end{itemize}

\subsection{Enrollment}

\subsubsection{Process}
At a high level, during enrollment clients:
\begin{enumerate}
    \item first find an Enterprise CA based on the objects in the Enrollment Services container.
    \item generate a public-private key pair and place the public key in a
        certificate signing request (CSR) message along with other details such
        as the subject of the certificate and the certificate template name. 
    \item  sign the CSR with their private key and send the CSR to an Enterprise CA server.
    \item The CA server checks if the client can request certificates. 
    \item If so, it determines if it will issue a certificate by looking up the
        certificate template AD object specified in the CSR. 
    \item The CA will check if the certificate template AD object’s permissions
        allow the authenticating account to obtain a certificate.
    \item If so, the CA generates a certificate using the “blueprint” settings
        defined by the certificate template (e.g., EKUs, cryptography settings,
        and issuance requirements) and using the other information supplied in
        the CSR if allowed by the certificate’s template settings. 
    \item The CA signs the certificate using its private key and then returns
        it to the client.
\end{enumerate}

\subsubsection{Rights and Protocols}
AD CS defines enrollment rights - which principals can request a certificate –
using two security descriptors: 
\begin{itemize}
    \item one on the certificate template AD object
    \item another on the Enterprise CA itself uperseding any enrollment rights
        defined by certificate templates. Security registry value in the key\\
\verb+\\<CA>\HKLM\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<CA NAME>+
on the CA server.
\end{itemize}

For certificate templates, the following ACEs in a template’s DACL can result
in a principal having enrollment rights:
\begin{itemize}
    \item The ACE grants a principal the Certificate-Enrollment extended right
        (\verb+GHT_DS_CONTROL_ACCESS+)
    \item The ACE grants a principal the Certificate-AutoEnrollment extended
        right (\verb+IGHT_DS_CONTROL_ACCESS+)
    \item An ACE grants a principal all ExtendedRights
        (\verb+RIGHT_DS_CONTROL_ACCESS+)
    \item An ACE grants a principal FullControl/GenericAll
\end{itemize}

\subsection{Protocols}

A client can request a certificate in different ways depending on the AD CS
environment’s configuration:
\begin{enumerate}
    \item Using the Windows Client Certificate Enrollment Protocol (MS-WCCE), a
        set of Distributed Component Object Model (DCOM) interfaces that
        interact with various AD CS features including enrollment. The DCOM
        server is enabled on all AD CS servers by default and is the most
        common method by which we have seen clients request certificates.
    \item Via the ICertPassage Remote Protocol53 (MS-ICPR), a remote procedure
        call (RPC) protocol can operate over named pipes or TCP/IP

    \item Accessing the certificate enrollment web interface
        (\verb+http://<ADCSSERVER>/certsrv)+/. To use this, the ADCS server
        needs to have the Certificate Authority Web Enrollment role installed.
    \item. Interacting with a certificate enrollment service (CES). To use
        this, a server needs to have the Certificate Enrollment Web Service
        role installed. Once enabled, a user can access the web service at
        \verb+https://<CESSERVER>/<CANAME>_CES_Kerberos/service.svc+ to request
        certificates. This service works in tandem with a certificate
        enrollment policy (CEP) service (installed via the Certificate
        Enrollment Policy Web Service role), which clients use to list
        certificate templates at the URL
        \verb+https://<CEPSERVER>/ADPolicyProvider_CEP_Kerberos/service.svc+.  
    \item Using the network device enrollment service. To use this, a server needs to have the
Network Device Enrollment Service56 role installed, which allows clients (namely network
devices) to obtain certificates via the Simple Certificate Enrollment Protocol
        (SCEP).  Once enabled, an administrator can obtain a one-time password
        (OTP) from the URL \verb+http://<NDESSERVER>/CertSrv/mscep_admin/+. The
        administrator can then provide the OTP to a network device and the
        device will use the SCEP to request a certificate using the URL
        \verb+http://NDESSERVER/CertSrv/mscep/+.
\end{enumerate}

\subsubsection{Issuance Requirements}
there two certificate template settings we have seen used to control
certificate enrollment. These are known as issuance requirements:
\begin{itemize}
    \item CA certificate manager approval (\verb+msPKI-Enrollment-Flag+): puts
        all certificate requests based on the template into the pending state
    \item "number of authorized signatures" and the "Application policy": The
former controls the number of signatures required in the CSR for the CA to
accept it. The latter defines the EKU OIDs that that the CSR signing
certificate must have. 
\end{itemize}

A common use for these settings is for {\bf enrollment agents}

\subsubsection{Enrollment agent}
s an AD CS term given to an entity that can request certificates on behalf of
another user.

To do so, the CA must issue the enrollment agent account a certificate
containing at least the Certificate Request Agent EKU (OID
1.3.6.1.4.1.311.20.2.1). Once issued, the enrollment agent can then sign CSRs
and request certificates on behalf of other users. The CA will issue the
enrollment agent a certificate as another user only under the following
non-comprehensive set of conditions:
\begin{itemize}
    \item The Windows user authenticating to the CA has enrollment rights to
        the target certificate template.
    \item If the certificate template’s schema version is 1, the CA will require signing certificates to have the Certificate Request Agent OID before issuing the certificate. 
    \item If the certificate template’s schema version is 2 he template must set
        the “This number of authorized signatures” setting and the specified
        number of enrollment agents must sign the CSR AND the template’s
        “Application policy” issuance restriction must be set to “Certificate
        Request Agent”.
\end{itemize}

Enrollment Agent certificates are potentially very powerful. As MS-CRTD states:
\begin{verbatim}
Because an Enrollment Agent is allowed to specify certificates to be issued to
any subject, it can bypass corporate security policy. As a result,
administrators need to be especially careful when allowing subjects to enroll
for Enrollment Agent certificates.
\end{verbatim}

Enterprise CAs can place restrictions on enrollment agents at the CA level.

The users who are allowed to obtain an enrollment agent certificate, the templates in which enrollment agents are permitted to enroll, and the accounts on behalf of which the enrollment agent may act can be constrained by enterprise CAs. This is achieved by opening the \verb+certscr.msc+ snap-in, right-clicking on the CA, clicking Properties, and then navigating to the “Enrollment Agents” tab.


\subsection{Certificate Templates and EKU}

Object identifiers (OIDs) that describe how the certificate will be used. Also
known as Enhanced Key Usage in Microsoft parlance. 

The \verb+pKIExtendedKeyUsage+ attribute on an AD certificate template object contains an array
of OIDs enabled in the template. These EKU OIDs affect what the certificate can
be used for. Following OIDs can enable certificate
authentication:

\begin{verbatim}
Client Authentication               1.3.6.1.5.5.7.3.2
PKINIT Client Authentication*       1.3.6.1.5.2.3.4
Smart Card Logon                    1.3.6.1.4.1.311.20.2.2
Any Purpose                         2.5.29.37.0
SubCA                               (no EKUs)
\end{verbatim}



 Whether a SAN can be specified by the requester is indicated in the certificate template's AD object through the \verb+mspki-certificate-name-flag+ property. This property is a bitmask, and the presence of the \verb+CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT+ flag permits the specification of the SAN by the requester

\subsection{Subject Alternative Names and Authentication}

By default, during certificate-based
authentication, one way AD maps certificates to user accounts based on a UPN
specified in the SAN. If an attacker can specify an arbitrary SAN when
requesting a certificate that has an EKU enabling client authentication, and
the CA creates and signs a certificate using the attacker- supplied SAN, the
attacker {\bf can become any user in the domain}. 

Various AD CS misconfigurations can allow unprivileged users to supply an
arbitrary SAN in a certificate enrollment, resulting in domain escalation
scenarios.

\subsection{Certificate Authentication}
AD supports certificate authentication over two protocols by default: Kerberos
and Secure Channel (Schannel)


\subsubsection{Kerberos Authentication and the NTAuthCertificates Container}
For Kerberos, the technical specification “[MS-PKCA]: Public Key Cryptography
for Initial Authentication (PKINIT) in Kerberos Protocol” defines the
authentication process.

see~\ref{ref:kerberos:pkinit}

\subsubsection{Secure Channel (Schannel) Authentication}
Schannel is the security support provider (SSP) Windows leverages when
establishing TLS/SSL connections. 

Schannel supports client authentication, enabling a remote server to verify the
identity of the connecting user. 

It accomplishes this using PKI, with certificates being the primary credential.
During the TLS handshake, the server requests a certificate from the client for
authentication. The client, having previously been issued a client
authentication certificate from a CA the server trusts, sends its certificate
to the server. The server then validates the certificate is correct and grants
the user access assuming everything is okay.

When an account authenticates to AD using a certificate, the DC needs to somehow map the
certificate credential to an AD account. Schannel:
\begin{itemize}
    \item  first attempts to map the credential to a user account use
        Kerberos’s S4U2Self functionality.
    \item  If that is unsuccessful, it will attempt to map the certificate to a
        user account using the certificate’s SAN extension.
\end{itemize}

By default, not many protocols in AD environments support AD authentication via
Schannel out of the box. WinRM, RDP, and IIS all support client authentication
using Schannel, but it requires additional configuration, and in some cases –
like WinRM – does not integrate with Active Directory. One protocol that does
commonly work is LDAPS


\subsubsection{Certificate Mapping}

Certificate mapping involves associating issued certificates with their respective subjects. In simple terms, when a user requests a certificate for themselves, the mapping enables the identification of the issued certificate as belonging to that specific user and not to another.

In response to CVE-2022–26923 (known as Certifried), Microsoft has implemented a new security extension for issued certificates, along with two registry keys to properly handle certificate mapping.
\begin{itemize}
    \item 
    The \verb+szOID_NTDS_CA_SECURITY_EXT+ certificate extension contains the objectSid  of the requester
    \item 
        The \verb+StrongCertificateBindingEnforcement+ registry key (\verb+HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc+) is used for Kerberos implicit mapping
    \item 
        The \verb+CertificateMappingMethods+ registry key (\verb+HKLM\System\CurrentControlSet\Control\SecurityProviders\Schannel\+) is used for Schannel implicit mapping
\end{itemize}

According to Microsoft, starting on April 2023 the "Disabled mode" of the two registry keys will not be taken into count and only the "Compatibility" and "Full Enforcement" mode will be valid.

Mapping a certificate to an object can be done explicitly or implicitly:
\begin{itemize}
    \item 
        For explicit mapping, the \verb+altSecurityIdentities+ attribute of the account must contains the identifier of the certificate. This way, for authentication the certificate must be signed by a trusted CA and match the \verb+altSecurityIdentities+ value
    \item
        For implicit mapping, this is the information contained in the certificate's SAN that are used to map with the DNS or the UPN field
\end{itemize}


{\bf Kerberos mapping}
During Kerberos authentication, the certificate mapping process will call the \verb+StrongCertificateBindingEnforcement+ registry key. This key can be equal to three values:
\begin{itemize}
    \item 
    0: no strong certificate mapping is realised. The \verb+szOID_NTDS_CA_SECURITY_EXT+ extension is not check and the authentication behavior is similar to what was done before the patch. This is the "Disabled mode"
    \item 
    1: default value after the patch. The KDC checks if the explicit certificate mapping is present (strong mapping). If yes, the authentication is allowed; if no, it checks if the certificate security extension is present and validate it. If it is not present, the authentication can be allowed if the user account predates the certificate. This is the "Compatibility mode"
    \item 
    2: the KDC checks if the explicit certificate mapping is present (strong mapping). If yes, the authentication is allowed; if no, it checks if the certificate security extension is present and validate it. If it is not present, the authentication is refused. This is the "Full Enforcement mode"
\end{itemize}

If the \verb+StrongCertificateBindingEnforcement+ registry key value is:
\begin{itemize}
    \item 0:
        \begin{itemize}
            \item 
                if the certificate contains a UPN value the KDC will first attempt to map the certificate to a user with a matching \verb+userPrincipalName+ value. If no validation can be performed, the KDC will search for an account with a matching \verb+sAMAccountName+ property. If none can be found, it will retry with a \$ at the end of the username. Therefore, a certificate with a UPN can be mapped to a machine account.
            \item 
                If the registry key value is 0 and the certificate contains a \verb+DNS+ value  the KDC splits the username into two parts: the user and the domain. The domain part is validated against the Active Directory domain, and the user part is validated by adding a \$ at the end and searching for an account with a corresponding \verb+sAMAccountName+.
        \end{itemize}
    \item  1 or 2, the \verb+szOID_NTDS_CA_SECURITY_EXT+ security extension will be used to map the account using its \verb+objectSid+. If the registry key is set to 1 and no security extension is present, the mapping behavior is similar to a registry key value of 0.
\end{itemize}


{\bf Schannel mapping}

The \verb+CertificateMappingMethods+ registry key can have a combination of the following values:
\begin{itemize}
    \item 
    $0x0001$: Subject/issuer explicit mapping
    \item 
    $0x0002$: Issuer explicit mapping
    \item 
    $0x0004$: SAN implicit mapping
    \item 
    $0x0008$: S4USelf implicit Kerberos mapping
    \item 
    $0x0010$: S4USelf explicit Kerberos mapping
\end{itemize}

The current default value is $0x18$ ($0x8$ and $0x10$). Schannel doesn't directly support the \verb+szOID_NTDS_CA_SECURITY_EXT+ security extension, but it can utilize it by "converting" the Schannel certificate mapping to a Kerberos certificate mapping using S4USelf. The mapping process will then be performed as explained in the Kerberos mapping section.

If any certificate authentication issues arise in an Active Directory environment, Microsoft has officially recommended setting the \verb+CertificateMappingMethods+ value to $0x1f$ (the old value).
