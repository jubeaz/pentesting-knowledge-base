\section{Trusts}
\label{active-directory:trust}


\href{https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/}{Active Directory Spotlight: Trusts — Part 2. Operational Guidance}

\subsection{Introduction}

A trust relationship (also called a trust) is a logical relationship established between domains to allow authentication and authorization to shared resources. The authentication process verifies the identity of the user, and the authorization process determines what the user is permitted to do on a computer system or network. Once a user requesting access to a resource computer in another domain has been authenticated by the resource domain, the resource computer compares the user’s credentials to the permissions assigned within its security descriptor to help determine the user’s level of authorization to that resource. A security descriptor contains access control lists (ACLs) that identify the users and groups that are assigned or denied access permissions on a resource.

In its simplest form, a trust acts as a technological drawbridge, by either allowing or disallowing authentication traffic to flow between two or more domains. When a trust relationship is created between two domains, traffic is allowed over the bridge, permitting the sharing of resources between them, as shown in the following illustration.

An Active Directory (AD) Forest is the security and administrative boundary for
objects and entities.
\href{https://social.technet.microsoft.com/wiki/contents/articles/50969.active-directory-forest-trust-attention-points.aspx}{trust}
is used to establish \verb+forest-forest+ or \verb+domain-domain+
authentication, allowing users to access resources in (or administer)  another
domain outside of the domain their account resides in. A trust  creates a link
between the authentication systems of two domains.

Often, domain trusts are set up improperly and provide unintended  attack
paths. Also, trusts set up for ease of use may not be reviewed  later for
potential security implications. Mergers and acquisitions can  result in
bidirectional trusts with acquired companies, unknowingly  introducing risk
into the acquiring company's environment. It is not  uncommon to be able to perform an attack such as Kerberoasting against a  domain outside the principal domain and obtain a user that has  administrative access within the principal domain.

\subsection{Trusted Domain Object}
Each domain or forest trust within an organization is represented by a Trusted Domain Object (TDO) stored in the System container within its domain.

\begin{itemize}
    \item domain trust TDO store:
        \begin{itemize}
            \item  DNS domain name,
            \item domain SID
            \item trust type
            \item trst transitivity
            \item the reciprocal domain name
        \end{itemize}
    \item Forest trust TDOs store in addition (to identify all of the trusted namespaces from the partner forest)
        \begin{itemize}
            \item domain tree names
            \item UPN suffixes
            \item SPN suffixes
            \item SID namespaces
        \end{itemize}
\end{itemize}


\begin{itemize}
    \item 
        All domains in a forest have knowledge of the trust relationships that are in place throughout the forest
    \item 
        when two or more forests are joined together through forest trusts, the forest root domains in each forest have knowledge of the trust relationships that are in place throughout all of the domains in trusted forests
\end{itemize}

Both domains in a trust relationship share a password, which is stored in the TDO object in Active Directory. As part of the account maintenance process, every thirty days, the trusting domain controller changes the password stored in the TDO.

\href{https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e9a2d23c-c31e-4a6f-88a0-6646fdb51a3c}{trustAttributes} (convert int to hex in big endian format i.e 72 is 0x00000048)



\subsection{Trust Paths}
The direction that a trust is assigned determines the trust path used for authentication. A trust path is defined by the series of trust relationships that authentication requests must follow between domains.

Before a user can access a resource in another domain, the security system on domain controllers must determine whether the trusting domain has a trust relationship with the trusted domain. To determine this, the security system computes the trust path between a domain controller in the trusting domain and a domain controller in the trusted domain.


\subsection{Trust Flow}
The transitivity status of a trust depends on the trustAttributes flags of a TDO.

\begin{itemize}
    \item 
        If the \verb+TRUST_ATTRIBUTE_NON_TRANSITIVE (0x00000001)+ flag is set then the transitivity is disabled.
    \item 
        If the \verb+TRUST_ATTRIBUTE_WITHIN_FOREST (0x00000020)+ flag is set then the transitivity is enabled.
    \item 
        If the \verb+TRUST_ATTRIBUTE_FOREST_TRANSITIVE (0x00000008)+ flag is set then the transitivity is enabled.
\end{itemize}

    In any other case the transitivity is disabled.


\subsubsection{One-Way and Two-Way Trusts}

\subsubsection{Transitive and Nontransitive Trusts}

\subsection{Trust types}
To get started we can query the \verb+trustType+ attribute of the TDO, which holds one of the following values:
\begin{itemize}
    \item 
    \verb+0x00000001+: The trusted domain is a Windows domain not running Active Directory
    \item 
    \verb+0x00000002+: The trusted domain is a Windows domain running Active Directory
    \item 
    \verb+0x00000003+: The trusted domain is running a non-Windows, RFC4120-compliant Kerberos distribution
    \item 
    \verb+0x00000004+: Historical reference; this value is not used in Windows
\end{itemize}



\subsection{Trust Types (flavor)}
The types of domains included in the trust relationship affect the type of trust that is created.
\begin{itemize}
    \item Two types of trusts are created automatically when a new domain is added to a domain tree or forest root domain
        \begin{itemize}
            \item Parent-child trust
            \item Tree-root trust
        \end{itemize}
    \item Four other types of trusts can be manually created
\end{itemize}

\begin{figure}
  \includegraphics[width=\linewidth]{ad/knowledge/images/trusts.png}
  \caption{AD trusts}
  \label{fig:ad-trusts}
\end{figure}

\subsubsection{Parent-child trust}
whenever a new domain is created in a tree:
\begin{itemize}
    \item It can exist only between two domains in the same tree and namespace.
    \item The parent domain is always trusted by the child domain
    \item transitive and two-way (to allow the GC replication)
\end{itemize}

\subsubsection{Tree-root trust}
stablished when you add a new domain tree to a forest:
\begin{itemize}
    \item stablished only between the roots of two trees in the same forest
    \item transitive and two-way
\end{itemize}

\subsubsection{Shortcut (cross-link) Trusts}
A one-way or two-way transitive trusts between child domain to speed up authentication.


\subsubsection{External Trusts}
A trust relationship created between Active Directory domains that are in different forests.

{\bf External trusts provide access to resources in a domain outside of the forest that is not already joined by a forest trust}

An external trust relationship has the following characteristics:
\begin{itemize}
    \item 
    It is nontransitive.

    \item 
    It must be established manually in each direction to create a two-way external trust relationship. 
    \item 
    It enforces SID filter quarantining by default. External trusts created from the trusting domain use SID filter quarantining to verify that incoming authentication requests made from security principals in the trusted domain contain only SIDs of security principals in the trusted domain. SID filter quarantining ensures that any misuse of the SID history attribute on security principals (including inetOrgPerson) in the trusted forest cannot pose a threat to the integrity of the trusting forest.
\end{itemize}

When a trust is established between a domain in a forest and a domain outside of that forest, security principals from the external domain can access resources in the internal domain. Active Directory creates a {\bf foreign security principal object} in the internal domain to represent each security principal from the trusted external domain. These foreign security principals can become members of domain local groups in the internal domain. Directory objects for foreign security principals are created by Active Directory and should not be manually modified. You can view foreign security principal objects from Active Directory Users and Computers by enabling advanced features.


\subsubsection{(cross-)Forest Trusts}
a transitive trust between one forest root domain and another forest root domain. Forest trusts also enforce SID filtering


\subsubsection{Realm (MIT) Trusts}
A trust relationship can be established with a non-Windows Kerberos realm

\subsection{Overview of Authentication Referral Processing}
This section describes the processes and interactions that occur as resources are accessed across trusts and authentication referrals are evaluated.

When a request for authentication is referred to a domain, the domain controller in that domain must determine whether a trust relationship exists with the domain from which the request comes, as well as the direction of the trust and whether the trust is transitive or nontransitive, before it authenticates the user to access resources in the domain. 

The authentication process that occurs between trusted domains varies according to the authentication protocol in use.


\subsubsection{Kerberos V5 Referral Processing}
If the client uses Kerberos V5 for authentication, it requests a ticket to the server in the target domain from a domain controller in its account domain

If the target domain is different from the current domain, the KDC follows a logical process to determine whether an authentication request can be referred:
\begin{itemize}
    \item If the current domain is trusted directly by the domain of the server that is being requested
        \begin{itemize}
            \item send the client a referral to the requested domain
        \end{itemize}
    \item else if  a transitive trust relationship exist between the current domain and the next domain on the trust path
        \begin{itemize}
            \item send the client a referral to the next domain on the trust path
        \end{itemize}
    \item else
        \begin{itemize}
            \item send the client a logon-denied message
        \end{itemize}
\end{itemize}

an {\bf referal ticket} is a TGS that includes a {\bf inter-realm TGT} which is a TGT encrypted/signed with the inter-realm trust key that the domains previously exchanged, instead of the first domain’s krbtgt account.

The foreign domain then verifies/decrypts the TGT included in the referral by decrypting it with the previously negotiated inter-realm trust key, and goes about the rest of the normal Kerberos process.


{\bf Processing of Authentication Requests Over Domain Trusts}:


{\bf Processing of Authentication Requests Over Forest Trusts}:


\subsubsection{NTLM Referral Processing}

the initial request for authentication goes directly from the client to the resource server in the target domain. 

This server creates a challenge to which the client responds.

The server then sends the user’s response to a domain controller in its computer account domain.

This domain controller checks the user account against its security accounts database. If the account does not exist in the database, the domain controller determines whether to perform pass-through authentication, forward the request, or deny the request by using the following logic:

\begin{itemize}
    \item If the current domain have a direct trust relationship with the user’s domain
        \begin{itemize}
            \item the domain controller sends the credentials of the client to a domain controller in the user’s domain for pass-through authentication
        \end{itemize}
    \item else if the current domain have a transitive trust relationship with the user’s domain
        \begin{itemize}
            \item pass the authentication request on to the next domain in the trust path. This domain controller repeats the process by checking the user’s credentials against its own security accounts database
        \end{itemize}
    \item else
        \begin{itemize}
            \item send the client a logon-denied message
        \end{itemize}
\end{itemize}

{\bf  to be able to abuse SIDHistory for NTLM auth need to modify SIDHistory off the account on source domain}

\subsubsection{Other Authentication Protocol Referral Processing}


\subsection{Network Ports used by Trusts}

see~\href{https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc773178(v=ws.10)?redirectedfrom=MSDN#network-ports-used-by-trusts}{Network Ports used by Trusts}

\subsection{Trust Security}

\subsubsection{Trust Authentication}
Trust authentication defines how explicit the authentication and access to the trusting domain will be.

There are three scopes of trust authentication:
\begin{itemize}
    \item 
        selective authentication: Allows only specific users in the trusted domain to access resources in the trusting domain. This is the most secure type of trust because it allows administrators to tightly control access to resources in the trusted domain. In order to allow a "trusted user" to access a "trusting resource", the resource's DACL must include an ACE in which the trusted user has the "\verb+Allowed-To-Authenticate+" extended right (GUID: \verb+68b1d179-0d15-4d4f-ab71-46152e79a7bc+).

    \item 
        domain-wide authentication: Allows unrestricted authentication from the trusted domain's principals to the trusting domain's resources. This is more secure than forest-wide authentication because it only allows users in a specific (trusted) domain to access resources in another (trusting)..
    \item 
        forest-wide authentication: Allows unrestricted authentication from the trusted forest's principals to the trusting forest's resources. This is the least secure level, it completely opens one forest to another (authentication-wise though, not access-wise). This level is specific to intra-forest trusts.
\end{itemize}

If the trust relationship:
\begin{itemize}
    \item within a forest boundary: \verb+TRUST_ATTRIBUTE_WITHIN_FOREST (0x00000020)+, then {\bf Forest-Wide Authentication will always be used}
    \item crosses a forest boundary:
        \begin{itemize}
            \item \verb+TRUST_ATTRIBUTE_CROSS_ORGANIZATION (0x00000010)+ set then {\bf Selective Authentication} is used
            \item \verb+TRUST_ATTRIBUTE_FOREST_TRANSITIVE+ then {\bf Forest-Wide Authentication} will be used
        \end{itemize}
\end{itemize}

Trust authentication is configured on external and forest trusts.


\subsubsection{SID filtering}
\label{ad:security:sid-filtering}

\begin{itemize}
    \item \href{https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/}{Active Directory forest trusts part 1 - How does SID filtering work?}
    \item \href{https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e9a2d23c-c31e-4a6f-88a0-6646fdb51a3c?redirectedfrom=MSDN}{trustAttributes}
    \item \href{https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280}{SID Filtering and Claims Transformation}
    \item \href{https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/}{Active Directory forest trusts part 2 - Trust transitivity and finding a trust bypass}
\end{itemize}

According to Microsoft, the {\bf security boundary in Active Directory is the forest, not the domain}. The forest defines the boundaries of trust and controls access to resources within the forest.


\href{https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html}{SID filtering} plays an important role in the security boundary by making sure "only SIDs from the trusted domain will be accepted for authorization data returned during authentication. SIDs from other domains will be removed" (\verb+netdom+ cmdlet output).


If \verb+TRUST_ATTRIBUTE_QUARANTINED_DOMAIN+: 
\begin{itemize}
    \item is set (\verb+0x00000004+): then only SIDs from the trusted domain are allowed (all others are filtered). 
    \item else the SIDs that are filtered depend on the Trust Flavor and various trustAttributes flags.
\end{itemize}


\begin{figure}
  \includegraphics[width=\linewidth]{ad/knowledge/images/default-sidfiltering.png}
  \caption{Default SIDFiltering}
  \label{fig:trust-default-sidfiltering}
\end{figure}

{\bf By default, SID filtering is disabled for intra-forest trusts, and enabled for inter-forest trusts.} 

Of course the TDO trustAttributes flags can be changed (on each side), in which case you want to have a look at the table below:


\begin{figure}
  \includegraphics[width=\linewidth]{ad/knowledge/images/custom-sidfiltering.png}
  \caption{Custom SIDFiltering}
  \label{fig:trust-custom-sidfiltering}
\end{figure}

Section \href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280}{4.1.2.2 of MS-PAC]} specifies what is filtered and when. There are three important things to remember from this documentation:
\begin{itemize}
    \item if SID filtering is fully enabled, all SIDs that differ from the trusted domain will be filtered out
    \item even if it's enabled, a few SIDs will (almost) never be filtered: "Enterprise Domain Controllers" (S-1-5-9) SID and those described by the \href{https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/f2ef15b6-1e9b-48b5-bf0b-019f061d41c8#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4}{trusted domain object (TDO)} ,as well as seven well-known SIDs 
    \item Cross-forest trusts are more stringently filtered than external trusts, meaning that in External trusts, SID filtering only filters out RID < 1000.
\end{itemize}

To hunderstand how it works read \href{https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/}{Active Directory forest trusts part 1 - How does SID filtering work?}


{\bf if a trust is labled \verb+FOREST_TRANSITIVE | TREAT_AS_EXTERNAL+ it means it has enabled sidhistory since external are non transitive}

\subsection{SID history}
The {\bf SID history} is a property of a user or group object that allows the object to retain its SID when it is migrated from one domain to another as part of a domain consolidation or restructuring. When an object is migrated to a new domain, it is assigned a new SID in the target domain. The SID history allows the object to retain its original SID, so that access to resources in the source domain is not lost.

{\bf SID history is not a feature that can be toggled on or off per say.}


{\bf TGT delegation}

Kerberos unconstrained delegations could be abused across trusts to take control over any resource of the trusting domain, including the domain controller, as long as the trusted domain is compromised. This relies on the delegation of TGT across trusts, which can be disabled.

If TGT delegation is disabled in a trust, attackers won't be able to escalate from one domain to another by abusing unconstrained delegation. On a side note, the other types of delegations are not affected by this as they don't rely on the delegation of tickets, but on S4U extensions instead.

The TGT delegation status of a trust depends on the trustAttributes flags of a TDO.
\begin{itemize}
    \item 
        If the \verb+TRUST_ATTRIBUTE_CROSS_ORGANIZATION_NO_TGT_DELEGATION (0x00000200)+ flag is set, then TGT Delegation is disabled.
    \item 
        If the \verb+TRUST_ATTRIBUTE_QUARANTINED_DOMAIN (0x00000004)+ flag is set, then TGT Delegation is disabled.
    \item 
        If the \verb+TRUST_ATTRIBUTE_CROSS_ORGANIZATION_ENABLE_TGT_DELEGATION (0x00000800)+ flag is set, then TGT Delegation is enabled.
    \item 
        If the \verb+TRUST_ATTRIBUTE_WITHIN_FOREST (0x00000020)+ flag is set, then TGT Delegation is enabled.
\end{itemize}



\subsection{PAM trust}

\href{https://learn.microsoft.com/fr-fr/microsoft-identity-manager/pam/privileged-identity-management-for-active-directory-domain-services}{Privileged Access Management (PAM)} facilitates the administration of an existing User/Production Forest by leveraging a Bastion Forest, also referred to as an Administrative Forest. This setup involves establishing a one-way PAM trust between the {\bf Bastion Forest} and the existing {\bf User Forest}. Within this architecture, users in the Bastion Forest can be associated with privileged groups such as Domain Admins and Enterprise Admins in the user forest, all without necessitating modifications to group memberships or Access Control Lists (ACLs).

The mechanism behind this approach relies on the creation of {\bf Shadow security principals} within the Bastion Forest. These shadow principals are mapped to Security Identifiers for high-privilege groups in the user forest. By adding users from the Bastion Forest as members of these shadow security principals, they inherit the associated privileges without direct alterations to group memberships or ACL configurations. This strategic implementation allows for centralized management of privileged access while maintaining security and minimizing the risk of unauthorized access.

\subsubsection{Shadow Principals}
A {\bf shadow principal} refers to a security principal (such as a user, group, or computer account) that exists in a trusted domain but appears as if it also exists in the local domain.

When a trust is established between two domains, security principals from one domain can access resources in the other domain. However, while the security principals are authenticated in the trusted domain, they might not have an actual presence (e.g., user accounts) in the trusting domain. In such cases, shadow principals are created in the trusting domain to represent these security principals from the trusted domain.

Once the trust is in place, the next step involves creating a shadow principal object within the bastion forest. This shadow principal object is configured to contain the Enterprise Admins Security Identifier (SID) from the user forests. Shadow Principals reside in a special container \verb+CN=Shadow Principal Configuration+ in the Configuration container on bastion forest.

Steps to configure Shadow Principals in bastion forest:
\begin{itemize}
    \item Obtain the Enterprise Admins or Domain Admins SID of User forest
    \item Create a Shadow Principal in Bastion forest with the obtained SID of User forest
    \item Make a user from Bastion forest member of the created Shadow Principal
\end{itemize}

With this configuration, the user from Bastion forest who is a member of the s{\bf hadow principal} in the bastion forest can now access the user forest as an administrator. This user, who is a member of the {\bf shadow principal}, is typically known as a {\bf shadow admin}.


\begin{verbatim}
# Get the SID for the Enterprise Admins group of the user forest
$ShadowPrincipalSid = (Get-ADGroup -Identity 'Enterprise Admins' `
    -Properties ObjectSID -Server eulogistics.corp).ObjectSID

# Container location
$Container = 'CN=Shadow Principal Configuration,CN=Services,CN=Configuration,DC=controlcenter,DC=corp'

# Create the Shadow principal
New-ADObject -Type msDS-ShadowPrincipal -Name "Tom" `
    -Path $Container -OtherAttributes @{'msDS-ShadowPrincipalSid'= $ShadowPrincipalSid}

# We can add a user from bastion forest to an existing bastion forest's shadow security principal container named Tom
Set-ADObject -Identity "CN=Tom,CN=Shadow Principal Configuration,CN=Services,CN=Configuration,DC=controlcenter,DC=corp" `
    -Add @{'member'="CN=Administrator,CN=Users,DC=controlcenter,DC=corp"} -Verbose
\end{verbatim}


\begin{verbatim}
bloodyAD --host 10.1.0.4 -u john.doe -p 'Password123!' -d bloody add groupMember \
    'CN=forest-ShadowEnterpriseAdmin,CN=Shadow Principal Configuration,CN=Services,CN=Configuration,DC=domain,DC=local'
    Administrator
\end{verbatim}
