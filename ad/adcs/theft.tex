\section{Theft attacks}

\subsection{THEFT1: Exporting Certificates Using the Crypto APIs}

\subsubsection{CertStealer (windows)}

\href{https://github.com/TheWover/CertStealer}{CertStealer}

\subsubsection{Mimikatz}

If the private key is non-exportable, CAPI and CNG will not allow extraction of
non-exportable certificates. Mimikatz’s \verb+crypto::capi+ and
\verb+crypto::cng+ commands can patch the CAPI and CNG to allow exportation of
private keys. \verb+crypto::capi+ patches CAPI in the current process whereas
\verb+crypto::cng+ requires patching lsass.exe’s memory

\begin{verbatim}
crypto::capi
crypto::certificates /export
\end{verbatim}


\subsection{THEFT2: User Certificate Theft via DPAPI}
Windows stores certificate private keys using DPAPI.

Windows stores user :
\begin{itemize}
    \item certificates in the registry:
        \begin{itemize}
            \item \verb+HKEY_CURRENT_USER\SOFTWARE\Microsoft\SystemCertificates+
            \item or \verb+%APPDATA%\Microsoft\SystemCertificates\My\Certificates\+
        \end{itemize}
    \item private key:
        \begin{itemize}
            \item \verb+%APPDATA%\Microsoft\Crypto\RSA\User SID\+ for
            \verb+CAPI+ keys
        \item \verb+%APPDATA%\Microsoft\Crypto\Keys\+ for CNG keys
        \end{itemize}
\end{itemize}

To obtain a certificate and its associated private key, one needs to:
\begin{enumerate}
    \item Identify which certificate one wants to steal and extract the key
        store name
    \item Find the DPAPI masterkey needed to decrypt the associated private key
    \item Obtain the plaintext DPAPI masterkey and use it to decrypt the
        private key
\end{enumerate}

\subsubsection{Mimikatz}
\begin{verbatim}
\end{verbatim}

\subsubsection{SharpDPAPI}
To simplify masterkey file and private key file decryption, SharpDPAPI’s
\verb+certificates+ command can be used with the \verb+/pvk+, \verb+/mkfile+,
\verb+/password+, or \verb+{GUID}:KEY+ arguments to decrypt the private keys
and associated certificates, outputting a .pem text file

\begin{verbatim}
openssl pkcs12 -in cert.pem -keyex 
    -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
\end{verbatim}

\subsection{THEFT3: Machine Certificate Theft via DPAPI}
\subsection{THEFT4: Finding Certificates Files}
\subsection{THEFT5: NTLM Creds via PKINIT}
