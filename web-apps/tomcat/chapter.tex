\chapter{Tomcat}
\href{https://tomcat.apache.org/}{Apache Tomcat} is an open-source web server
that hosts applications written in Java. Tomcat was initially designed to run
Java Servlets and Java Server Pages (JSP) scripts. However, its popularity
increased in Java-based frameworks and is now widely used by frameworks such as
Spring and tools such as Gradle. 



\section{Discovery/Footprinting}


Tomcat servers {\bf can be identified by the Server header in the HTTP
response}. If
the server is operating behind a reverse proxy, requesting an invalid page
should reveal the server and version

Custom error pages may be in use that do not leak this version information. In
this case, another method of detecting a Tomcat server and version is through
the \verb+/docs+ page.

\begin{verbatim}
 bin
 conf
    catalina.policy
    catalina.properties
    context.xml
    tomcat-users.xml
    tomcat-users.xsd
    web.xml
 lib
 logs
 temp
 webapps
    manager
       images
       META-INF
       WEB-INF
          web.xml
    ROOT
       WEB-INF
 work
    Catalina
        localhost
\end{verbatim}

The \verb+bin+ folder stores scripts and binaries needed to start and run a
Tomcat server. The \verb+conf+ folder stores various configuration files used
by Tomcat. The \verb+tomcat-users.xml+ file stores user credentials and their
assigned roles. The \verb+lib+ folder holds the various JAR files needed for
the correct functioning of Tomcat. The \verb+logs+ and \verb+temp+ folders
store temporary log files. The \verb+webapps+ folder is the default webroot of
Tomcat and hosts all the applications. The work folder acts as a cache and is
used to store data during runtime.

Each folder inside \verb+webapps+ is expected to have the following structure.

\begin{verbatim}
webapps/customapp
    images
    index.jsp
    META-INF
        context.xml
    status.xsd
    WEB-INF
        jsp
            admin.jsp
        web.xml
        lib
             jdbc_drivers.jar
        classes
            AdminServlet.class
\end{verbatim}

The most important file among these is \verb+WEB-INF/web.xml+, which is known
as the deployment descriptor. This file stores information about the routes
used by the application and the classes handling these routes. All compiled
classes used by the application should be stored in the \verb+WEB-INF/classes+
folder. These classes might contain important business logic as well as
sensitive information. Any vulnerability in these files can lead to total
compromise of the website. The \verb+lib+ folder stores the libraries needed by
that particular application. The \verb+jsp+ folder stores
\href{https://en.wikipedia.org/wiki/Jakarta_Server_Pages}{Jakarta Server Pages
(JSP)}, formerly known as \verb+JavaServer Pages+, which can be compared to PHP
files on an Apache server.

\section{Enumeration}
 look for the \verb+/manager+ and the \verb+/host-manager+ page with tool like
 gobuster~\ref{tool:gobuster} or dirbuster~\ref{tool:dirbuster}. 

 We may be able to either log in to one of these using weak credentials such as
 \verb+tomcat:tomcat+, \verb+admin:admin+,\ldots

 \section{Tomcat Manager - Login Brute Force}

 use \verb+auxiliary/scanner/http/tomcat_mgr_login+ of metasploit


 \section{Tomcat Manager - WAR File Upload}

 Many Tomcat installations provide a GUI interface to manage the application.
 This interface is available at \verb+/manager/html+ by default, which only
 users assigned the \verb+manager-gui+ role are allowed to access.

 Craft a \verb+war+ (Web Application Archive) reverse shell
 (\verb+java/jsp_shell_reverse_tcp+) payload with msfvenom~\ref{tool:msfvenom} 


 The \verb+multi/http/tomcat_mgr_upload+ Metasploit module can be used to
 automate the process.

 \section{Ghostcat: LFI}
 All Tomcat versions before 9.0.31, 8.5.51, and 7.0.100 were vulnerable to
 \href{https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi}{ghostcat}

 \begin{verbatim}
 python2.7 tomcat-ajp.lfi.py URL -p 80 -f WEB-INF/web.xml
 \end{verbatim}


 \section{CVE-2019-0232}

 find a cgi \verb+.bat file+
 \begin{verbatim}
 ffuf -w
 /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt
 -v -u http://IP:8080/cgi/FUZZ.bat
 \end{verbatim}

 the use msf
