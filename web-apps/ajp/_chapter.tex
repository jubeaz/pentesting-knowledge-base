\chapter{AJP Proxy}
AJP (or JK) is a wire protocol. It is an optimized version of the HTTP protocol
to allow a standalone web server such as Apache to talk to Tomcat.
Historically, Apache has been much faster than Tomcat at serving static
content. The idea is to let Apache serve the static content when possible but
proxy the request to Tomcat for Tomcat-related content.

With AJP proxy ports (8009 TCP) during penetration tests it might allow to
access the "hidden" Apache Tomcat Manager behind it. Although AJP-Proxy is a
binary protocol, it is possible to configure a Nginx or Apache webserver with
AJP modules to interact with it and access the underlying application. This
way, it allows to discover administrative panels, applications, and websites
that would be otherwise inaccessible.


\subsection{Nginx reverse proxy}

Compile Nginx source code with the
\href{https://github.com/dvershinin/nginx_ajp_module}{ajp module} and configure it to point
the AJP Port.


\begin{verbatim}
wget https://nginx.org/download/nginx-1.21.3.tar.gz
tar -xzvf nginx-1.21.3.tar.gz
git clone https://github.com/dvershinin/nginx_ajp_module.git
cd nginx-1.21.3
sudo apt install libpcre3-dev
./configure --add-module=`pwd`/../nginx_ajp_module \
    --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx  \
    --modules-path=/usr/lib/nginx/modules
make
sudo make install
nginx -V
\end{verbatim}


Comment out the entire \verb+server+ block and append the following lines
inside the \verb+http+ block in \verb+/etc/nginx/conf/nginx.conf+.

\begin{verbatim}
upstream tomcats {
	server <TARGET_SERVER>:8009;
	keepalive 10;
	}
server {
	listen 80;
	location / {
		ajp_keep_conn on;
		ajp_pass tomcats;
	}
}
\end{verbatim}

Start Nginx and check if everything is working correctly by issuing a cURL
request 
\begin{verbatim}
sudo nginx
curl http://127.0.0.1:80
\end{verbatim}



\subsection{Apache reverse proxy}

\begin{itemize}
    \item Install the libapache2-mod-jk package
    \item Enable the module
    \item Create the configuration file pointing to the target AJP-Proxy port
\end{itemize}


\begin{verbatim}
sudo apt install libapache2-mod-jk
sudo a2enmod proxy_ajp
sudo a2enmod proxy_http
export TARGET="<TARGET_IP>"

echo -n """<Proxy *>
Order allow,deny
Allow from all
</Proxy>
ProxyPass / ajp://$TARGET:8009/
ProxyPassReverse / ajp://$TARGET:8009/""" | 
    sudo tee /etc/apache2/sites-available/ajp-proxy.conf


sudo ln -s /etc/apache2/sites-available/ajp-proxy.conf \ 
    /etc/apache2/sites-enabled/ajp-proxy.conf
sudo systemctl start apache2

curl http://127.0.0.1
\end{verbatim}

