\chapter{Discovery (TA0007)}
\begin{tabularx}{\linewidth}{|l|l|X|}
    \hline
ID &	Name &	Description \\
    \hline
T1087 &	Account &	\\
    \hline
T1010 &	Application Window &	listing of open application windows to
discover how the system is used.
information collected by a keylogger.\\
    \hline
T1217 &	Browser Bookmark &	\\
    \hline
T1580 & Cloud Infrastructure &\\
    \hline
T1538 &	Cloud Service Dashboard &\\
    \hline
T1526 &	Cloud Service &\\
    \hline
T1619 &	Cloud Storage Object &\\
    \hline
T1613 &	Container and Resource & \\  
    \hline
T1622 &	Debugger Evasion& \\ 
    \hline
T1482 &	Domain Trust & \\  
    \hline
T1083 &	File and Directory & \\ 
    \hline
T1615 &	Group Policy & \\  
    \hline
T1046 &	Network Service & \\ 
    \hline
T1135 &	Network Share & \\  
    \hline
T1040 &	Network Sniffing & \\ 
    \hline
T1201 &	Password Policy & \\ 
    \hline
T1120 &	Peripheral Device & \\ 
    \hline
T1057 &	Process & \\ 
    \hline
T1012 &	Query Registry & gather information about the system, configuration,
and installed software\\ 
    \hline
T1018 &	Remote System & \\
    \hline
T1518 &	Software & \\ 
    \hline
T1082 &	System Information & \\ 
    \hline
T1614 &	System Location & \\ 
    \hline
T1016 &	System Network Configuration & \\
    \hline
T1049 &	System Network Connections & \\
    \hline
T1033 &	System Owner/User & \\
    \hline
T1007 &	System Service & \\
    \hline
T1124 &	System Time & \\
    \hline
T1497 &	Virtualization/Sandbox Evasion& \\
\hline
\end{tabularx}

\input{windows/discovery/system}
\input{windows/discovery/account}
\input{windows/discovery/network}
\input{windows/discovery/security}
\input{windows/discovery/registry}

\section{Process (T1057) and services (T1007) Discovery}
See~\ref{windows_knowlege:services_and_processes}


\subsection{Process}
Looking at running processes provide a better idea of what applications are
currently running on the system. Being able to spot standard processes/services
quickly will help speed up enumeration and enable to hone in on non-standard
processes/services, which may open up a privilege escalation path. 

{\bf cmd}:
\begin{verbatim}
tasklist.exe /svc
tasklist.exe /FI "pid eq PID"
tasklist.exe /FI "pid eq PID" /V /FO List
wmic process where "ProcessID=PID" get /format:list
\end{verbatim}

or with \href{https://docs.microsoft.com/en-us/powershell/scripting/samples/managing-processes-with-process-cmdlets?view=powershell-7.2}{Process} 

{\bf Powershell}:
\begin{verbatim}
Get-Process | ft id, name
Get-Process -Name NAME | fl *
Get-Process -Id ID | fl *
Get-WmiObject Win32_Process -Filter "ProcessId='2300'"
\end{verbatim}

\subsection{scheduled tasks}

{\bf cmd}:
\begin{verbatim}
schtasks.exe /query /fo LIST /v
\end{verbatim}

{\bf PowerShell}:
\begin{verbatim}
Get-ScheduledTask | select TaskName,State
\end{verbatim}

By default, we can only see tasks created by our user and default scheduled
tasks that every Windows operating system has. Unfortunately, we cannot list
out scheduled tasks created by other users (such as admins) because they are
stored in \verb+C:\Windows\System32\Tasks+, which standard users do not have
read access to.


\subsection{Services}


{\bf cmd}:

\begin{verbatim}
psservice.exe 
sc.exe query
sc.exe query type=service
wmic service where name="usosvc" list full
\end{verbatim}

\href{https://docs.microsoft.com/en-us/powershell/scripting/samples/managing-services?view=powershell-7.2}{services}
cmdlet.

{\bf Powershell}:
\begin{verbatim}
Get-WmiObject Win32_Service -Filter "ProcessId='2112'" |fl *
Get-Service
Get-Service NAME |fl *
Get-Service | Where {$_.Status -eq 'Running'}
\end{verbatim}

\subsubsection{Permission discovery}

\href{https://www.winhelponline.com/blog/view-edit-service-permissions-windows/}
{\bf cmd}:
\begin{verbatim}
# query a service
sc.exe qc NAME


sc.exe //hostname or ip

sc stop NAME

# requiere elevated privileges
sc config wuauserv binPath=C:\Winbows\Perfectlylegitprogram.exe

# Displays a service's security descriptor, using the 
# Security Descriptor Definition Language (SDDL)
sc sdshow NAME

accesschk -c NAME -l -accepteula

psservice.exe security schedule

SetACL.exe -on "schedule" -ot srv -actn list
\end{verbatim}

{\bf powershell}: 
\begin{verbatim}
Get-ChildItem -Path HKLM:\System\CurrentControlSet\Services
Get-ACL -Path HKLM:\System\CurrentControlSet\Services\wuauserv | Format-List
\end{verbatim}

no built-in powershell cmdlet. See this \href{https://rohnspowershellblog.wordpress.com/2013/03/19/viewing-service-acls/}{blog
post}

\begin{verbatim}
Invoke-WebRequest -URI 'http://IP/Get-serviceACL.ps1' -Outfile PATH/

"SERVICE_NAME" | Get-ServiceAcl | select -ExpandProperty Acces
\end{verbatim}


\subsection{Communication discovery}
\href{https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/netstat}{netstat}
(\verb+netstat -ano+) command displays active TCP and UDP connections which
provide a better idea of what services are listening on which port(s) both
locally and accessible to the outside. There may be vulnerable services only
accessible to the local host hat we can exploit to escalate privileges.

The main thing to look for with Active Network Connections are entries
listening on loopback addresses (127.0.0.1 and ::1) that are not listening on
the IP Address or broadcast (0.0.0.0, ::/0). The reason for this
is network sockets on localhost are often insecure due to the thought that
"they aren't accessible to the network." For example the local socket listening
on port 14147, used for FileZilla's administrative interface, can be used to
extract FTP passwords in addition to creating an FTP Share at  as the FileZilla
Server user (potentially Administrator).

\href{https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist}{pipelist}
(pipelist.exe /accepteula) from the Sysinternals suite or \verb+Get-childItem \\.\pipe\+ will allow to enumerate instances
of named pipes.

\href{https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk}{Accesschk}
can be used to enumerate the permissions assigned to a specific named pipe by
reviewing the Discretionary Access List (DACL), which shows who has the
permissions to modify, write, read, or execute a resource. 

\verb+accesschk.exe /accepteula \\.\Pipe\lsass -v+

\section{Misc}
\subsection{writable directories}

\href{https://gist.github.com/olafhbnathaartong/e1f4daaa30276b3ce09eeea411c94532}{UserWritableLocations.ps1}

\begin{verbatim}
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\System32\spool\drivers\color
C:\Windows\System32\spool\printers
C:\Windows\System32\spool\servers
C:\Windows\tracing
C:\Windows\Temp
C:\Users\Public
C:\Windows\Tasks
C:\Windows\System32\tasks
C:\Windows\SysWOW64\tasks
C:\Windows\System32\tasks_migrated\microsoft\windows\pls\system
C:\Windows\SysWOW64\tasks\microsoft\windows\pls\system
C:\Windows\debug\wia
C:\Windows\registration\crmlog
C:\Windows\System32\com\dmp
C:\Windows\SysWOW64\com\dmp
C:\Windows\System32\fxstmp
C:\Windows\SysWOW64\fxstmp
\end{verbatim}



