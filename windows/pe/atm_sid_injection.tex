
\subsection{SID-History injection (T1134.005)}
\label{mitre:t1134.005}

The \href{https://attack.mitre.org/techniques/T1134/005/}{sIDHistory injection}
attack consist in injecting harvested or well-known SID values (administrator
SID) inside the sIDHistory of a controlled account since the SIDs of the
sIDHistory are added to the \emph{acces token}~\ref{win:access-token}


If the
SID of a Domain Admin account is added to the SID History attribute of this
account, then this account will be able to perform
\emph{DCSync}~\ref{kerberos:DCSync} and create a \emph{Golden
Ticket}~\ref{kerberos:golden-ticker} or a Kerberos ticket-granting ticket (TGT)
which will allow for us to authenticate as any account in the domain of our
choosing for further persistence.


 If the \emph{sIDHistory} of a controled user in a child domain is set 
 to  \emph{Enterprise Admins group} (which only exists in the parent domain),
 the user is treated as a member of this group, which allows for administrative
 access to the entire forest. 

 Leverage the \emph{SIDHistory} to grant an
 account (or  non-existent account) \emph{Enterprise Admin} rights by modifying this
 attribute to contain the \emph{SID for the Enterprise Admins group}, will give
 full access to the parent domain without actually being part of the group.

This type of attack will only work when \emph{SIF
filtering}~\ref{ad:security:sid-filtering} is not set.

\subsubsection{On windows}
The requierements To perform this attack after compromising a child domain,
are:
\begin{itemize}
    \item  The KRBTGT hash for the child domain (using
        mimikatz~\ref{tool:mimikatz:DCSync} on \verb+DOMAIN\krbtgt+)
    \item  The SID for the child domain (\verb+Get-DomainSID+ command)
    \item  The name of a target user in the child domain (does not need to
        exist!)  for exemple \verb+hacker+ 
    \item  The FQDN of the child domain.
    \item  The SID of the Enterprise Admins group of the root domain (using
            \verb+Get-ADGroup+~\ref{tool:wlol:ad:get-ADGroup} or
            \verb+Get-DomainGroup+~\ref{tool:powerview} on identity
        \verb+"Enterprise Admins"+)
\end{itemize}


Using Mimikatz~\ref{tool:mimikatz:sidhistory} or Rubeus~\ref{tool:rubeus:sidhistory}
and the data listed above, it is possible to create a
Golden Ticket to access all resources within the parent domain.

to check that the ticket works : \verb+ls \\TARGET\c$\SOME\PATH+

\subsubsection{From Linux}

To get the requiered informations :
\begin{itemize}
    \item the KRBTGT hash for the child domain:
        \verb+secretsdump.py+~\ref{tool:impacket:secretsdump}
    \item the SIDS: \verb+lookupsid.py+~\ref{tool:impacket:lookupsid}
\end{itemize}


The ticket can be forged with \verb+ticketer.py+~\ref{tool:impacket:tickerter}
and the access validated with \verb+psexec.py+~\ref{tool:impacket:psexec}

There is also a full automated script \verb+raiseChild.py+~\ref{tool:impacket:raiseChild}


