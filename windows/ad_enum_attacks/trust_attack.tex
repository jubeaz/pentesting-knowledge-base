\section{Trusts attacks}

See~\ref{active-directory:trust}

\subsection{Trust enumeration}

tools:
\begin{itemize}
    \item LOL~\ref{tool:wlol:ad:get-ADTrust}
    \item PowerView~\ref{tool:powerview:Get-DomainTrust}
    \item BloodHound~\ref{tool:bloodhound} with \verb+Map Domain Trusts+
        analysis.
\end{itemize}

\subsection{Child - Parent trust Attack}

\subsubsection{sIDHistory injection}
The \href{https://attack.mitre.org/techniques/T1134/005/}{sIDHistory injection}
attack consist in injecting harvested or well-known SID values (administrator
SID) inside the sIDHistory of a controlled account since the SIDs of the
sIDHistory are added to the \emph{acces token}~\ref{win:access-token}


If the
SID of a Domain Admin account is added to the SID History attribute of this
account, then this account will be able to perform
\emph{DCSync}~\ref{kerberos:DCSync} and create a \emph{Golden
Ticket}~\ref{kerberos:golden-ticker} or a Kerberos ticket-granting ticket (TGT)
which will allow for us to authenticate as any account in the domain of our
choosing for further persistence.


 If the \emph{sIDHistory} of a controled user in a child domain is set 
 to  \emph{Enterprise Admins group} (which only exists in the parent domain),
 the user is treated as a member of this group, which allows for administrative
 access to the entire forest. 

 Leverage the \emph{SIDHistory} to grant an
 account (or  non-existent account) \emph{Enterprise Admin} rights by modifying this
 attribute to contain the \emph{SID for the Enterprise Admins group}, will give
 full access to the parent domain without actually being part of the group.

This type of attack will only work when \emph{SIF
filtering}~\ref{ad:security:sid-filtering} is not set.

\subsubsection{On windows}
The requierements To perform this attack after compromising a child domain,
are:
\begin{itemize}
    \item  The KRBTGT hash for the child domain (using
        mimikatz~\ref{tool:mimikatz:DCSync} on \verb+DOMAIN\krbtgt+)
    \item  The SID for the child domain (\verb+Get-DomainSID+ command)
    \item  The name of a target user in the child domain (does not need to
        exist!)  for exemple \verb+hacker+ 
    \item  The FQDN of the child domain.
    \item  The SID of the Enterprise Admins group of the root domain (using
            \verb+Get-ADGroup+~\ref{tool:wlol:ad:get-ADGroup} or
            \verb+Get-DomainGroup+~\ref{tool:powerview} on identity
        \verb+"Enterprise Admins"+)
\end{itemize}


Using Mimikatz~\ref{tool:mimikatz:sidhistory} or Rubeus~\ref{tool:rubeus:sidhistory}
and the data listed above, it is possible to create a
Golden Ticket to access all resources within the parent domain.

to check that the ticket works : \verb+ls \\TARGET\c$\SOME\PATH+

\subsubsection{From windows}

To get the requiered informations :
\begin{itemize}
    \item the KRBTGT hash for the child domain:
        \verb+secretsdump.py+~\ref{tool:impacket:secretsdump}
    \item the SIDS: \verb+lookupsid.py+~\ref{tool:impacket:lookupsid}
\end{itemize}


The ticket can be forged with \verb+ticketer.py+~\ref{tool:impacket:tickerter}
and the access validated with \verb+psexec.py+~\ref{tool:impacket:psexec}

There is also a full automated script \verb+raiseChild.py+~\ref{tool:impacket:raiseChild}

\subsection{Windows Cross-Forest trust abuse}

\subsubsection{Cross-Forest Kerberoasting}

Kerberos attacks such as Kerberoasting and ASREPRoasting can be performed
across trusts, depending on the trust direction. In a domain with either an
inbound or bidirectional domain/forest trust, various attacks to gain a
foothold. Sometimes privilege scalation is not possible in the current domain,
but instead it is possible to obtain a Kerberos ticket and crack a hash for an
administrative user in another domain that has Domain/Enterprise Admin
privileges in both domains.

use of the \verb+-SPN+ on \verb+Get-DomainUser+~\ref{tool:powerview:enum}
Then a kerberoast~\ref{kerberos:kerberoasting} can be performed on the trusted
domain.

\subsubsection{Admin Password Re-Use  and Group Membership}
In a situation of a  bidirectional forest trust managed by admins from the same
company. When the Domain A is controlled and a cleartext passwords or NT hashes
for either the built-in Administrator account or an account that is part of the
Enterprise Admins or Domain Admins group in Domain A is available and Domain B
has a highly privileged account with the same name. It is worth checking for
password reuse across the two forests in this situation. 

For example, Domain A would have a user named \verb+adm_bob.smith+ in the
Domain Admins group, and Domain B had a user named \verb+bsmith_admin+.
Sometimes, the user would be using the same password in the two domains, and
owning Domain A instantly gave me full admin rights to Domain B.

Somtimes users or admins from Domain A as members of a group in Domain B. Only
\emph{Domain Local Groups} allow security principals from outside its forest.
Somtimes a Domain Admin or Enterprise Admin from Domain A as a member of the
built-in Administrators group in Domain B in a bidirectional forest trust
relationship. Taking over this admin user in Domain A, we would gain full administrative access to Domain B based on group membership.

\verb+Get-DomainForeignGroupMember+~\ref{tool:powerview:enum} allow to
enumerate groups with users that do not belong to the domain, also known as
foreign group membership. 


\subsubsection{Cross Forest SID History Abuse}

SID History can also be abused across a forest trust. If a user is migrated
from one forest to another and SID Filtering is not enabled, it becomes
possible to add a SID from the other forest, and this SID will be added to the
user's token when authenticating across the trust. If the SID of an account
with administrative privileges in Forest A is added to the SID history
attribute of an account in Forest B, assuming they can authenticate across the
forest, then this account will have administrative privileges when accessing
resources in the partner forest.

\begin{figure}
  \includegraphics[width=\linewidth]{windows/ad_enum_attacks/images/cross-forest-sid-history.png}
  \caption{Cross forest AD trust SIDHistory}
  \label{fig:cross-forest-sid-history}
\end{figure}

In the previous diagram, \verb+jjones+ user being migrated
from the \verb+INLANEFREIGHT.LOCAL+ domain to the \verb+CORP.LOCAL+ domain in a different
forest. If SID filtering is not enabled when this migration is made and the
user has administrative privileges (or any type of interesting rights such as
ACE entries, access to shares, etc.) in the \verb+INLANEFREIGHT.LOCAL+ domain,
then they will retain their administrative rights/access in
\verb+INLANEFREIGHT.LOCAL+ while being a member of the new domain,
\verb+CORP.LOCAL+ in the second forest.


\subsection{Linux Cross-Forest trust abuse}
\subsubsection{Cross-Forest Kerberoasting}
From time to time, see users or admins from one domain as members of a group in
another domain. Since only i\emph{Domain Local Groups} allow users from outside their forest, it is not uncommon to see a highly privileged user from Domain A as a member of the built-in administrators group in domain B when dealing with a bidirectional forest trust relationship.


To enumerate \verb+GeUserSPNs+~\ref{tool:impacket:GetUserSPNs} with
credentials for a user that can authenticate into the other domain and specify
the \verb+-target-domain+. the flag \verb+-request+ (plus \verb+-outputfile+)
provide the TGS.

\subsubsection{Hunting Foreign Group Membership with Bloodhound-python}

using \verb+bloodhound-python+~\ref{tool:bloodhound-ingestor} it is possible to
enumerate several domains.

After loading the two data set, the \emph{Users with Foreign Domain Group
Membership} under the \emph{Analysis} tab and select the source domain  can be run.


