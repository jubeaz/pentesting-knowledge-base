\section{Misc Misconfigs}

\subsection{Exchange Related Group Membership}
A default installation of Microsoft Exchange within an AD environment (with no
split-administration model) opens up many attack vectors, as Exchange is often
granted considerable privileges within the domain (via users, groups, and
ACLs). The group \emph{Exchange Windows Permissions} is not listed as a
protected group, but members are granted the ability to write a DACL to the
domain object. This can be leveraged to give a user \verb+DCSyn+ privileges. An
attacker can add accounts to this group by leveraging a DACL misconfiguration
(possible) or by leveraging a compromised account that is a member of the
Account Operators group. It is common to find user accounts and even computers
as members of this group. Power users and support staff in remote offices are
often added to this group, allowing them to reset passwords. This
\href{https://github.com/gdedrouas/Exchange-AD-Privesc}{GitHub repo} details a
few techniques for leveraging Exchange for escalating privileges in an AD
environment.

The Exchange group \emph{Organization Management} is another extremely powerful
group (the "Domain Admins" of Exchange) and can access the mailboxes of all
domain users. It is not uncommon for sysadmins to be members of this group.
This group also has full control of the OU called \emph{Microsoft Exchange
Security Groups}, which contains the group \emph{Exchange Windows Permissions}.

Compromise an Exchange server, will often lead to Domain Admin privileges.
Additionally, dumping credentials in memory from an Exchange server will
produce 10s if not 100s of cleartext credentials or NTLM hashes. This is often
due to users logging in to Outlook Web Access (OWA) and Exchange caching their
credentials in memory after a successful login.

\subsection{PrivExchange}

The \emph{PrivExchange} attack results from a flaw in the Exchange Server
\emph{PushSubscription} feature, which allows any domain user with a mailbox to
force the Exchange server to authenticate to any host provided by the client
over HTTP.

The Exchange service runs as SYSTEM and is over-privileged by default (i.e.,
has WriteDacl privileges on the domain pre-2019 Cumulative Update). This flaw
can be leveraged to relay to LDAP and dump the domain NTDS database. If relay
cannot be done to LDAP, this can be leveraged to relay and authenticate to
other hosts within the domain. This attack will take you directly to Domain
Admin with any authenticated domain user account.

\subsection{Printer Bug}


The Printer Bug is a flaw in the MS-RPRN protocol (Print System Remote
Protocol). This protocol defines the communication of print job processing and
print system management between a client and a print server. To leverage this
flaw, any domain user can connect to the spool's named pipe with the
\verb+RpcOpenPrinter+ method and use the
\verb+RpcRemoteFindFirstPrinterChangeNotificationEx+ method, and force the
server to authenticate to any host provided by the client over SMB.

The spooler service runs as SYSTEM and is installed by default in Windows
servers running Desktop Experience. This attack can be leveraged to relay to
LDAP and grant attacker account \verb+DCSync+ privileges to retrieve all password
hashes from AD.

The attack can also be used to relay LDAP authentication and grant
\emph{Resource-Based Constrained Delegation (RBCD)}~\ref{kerberos:RBCD}
privileges for the victim to a computer account under control, thus giving
privileges to authenticate as any user on the victim's computer. This attack
can be leveraged to compromise a Domain Controller in a partner domain/forest,
provided having administrative access to a Domain Controller in the first
forest/domain already, and the trust allows TGT delegation, which is not by
default anymore.

tools such as the \verb+Get-SpoolStatus+module from this
\href{https://github.com/cube0x0/Security-Assessment}{tool} can be used  to
check for machines vulnerable to the MS-PRN Printer Bug. This flaw can be used
to compromise a host in another forest that has Unconstrained Delegation
enabled, such as a domain controller. It can help to attack across forest
trusts once we have compromised one forest.

\subsection{MS14-068}
This was a flaw in the Kerberos protocol, which could be leveraged along with
standard domain user credentials to elevate privileges to Domain Admin. A
Kerberos ticket contains information about a user, including the account name,
ID, and group membership in the Privilege Attribute Certificate (PAC). The PAC
is signed by the KDC using secret keys to validate that the PAC has not been
tampered with after creation.

The vulnerability allowed a forged PAC to be accepted by the KDC as legitimate.
This can be leveraged to create a fake PAC, presenting a user as a member of
the Domain Administrators or other privileged group. It can be exploited with
tools such as the
\href{https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek}{Python
Kerberos Exploitation Kit (PyKEK)} or the Impacket toolkit~\ref{tool:impacket}.
The only defense against this attack is patching.

\subsection{Sniffing LDAP Credentials}
Many applications and printers store LDAP credentials in their web admin
console to connect to the domain. These consoles are often left with weak or
default passwords. Sometimes, these credentials can be viewed in cleartext.
Other times, the application has a \emph{test connection} function that can be
used to gather credentials by changing the LDAP IP address to that of attack
host and setting up a netcat~\ref{tool:netcat} listener on LDAP port 389. When
the device attempts to test the LDAP connection, it will send the credentials
to the machine, often in cleartext. Accounts used for LDAP connections are
often privileged, but if not, this could serve as an initial foothold in the
domain. Other times, a full LDAP server is required to pull off this attack, as
detailed in this \href{https://grimhacker.com/2018/03/09/just-a-printer/}{post}.

\subsection{Enumerating DNS Records}
By default, all users can list the child objects of a DNS zone in an AD
environment. By default, querying DNS records using LDAP does not return all
results. So by using the
\href{https://github.com/dirkjanm/adidnsdump}{adidnsdump tool}, it is possible
to resolve all records in the zone and potentially find something useful. The
background and more in-depth explanation of this tool and technique can be
found in this
\href{https://dirkjanm.io/getting-in-the-zone-dumping-active-directory-dns-with-adidnsdump/}{post}.

\begin{verbatim}
adidnsdump -u DOMAIN\\SAMAN ldap://IP -r
\end{verbatim}

\subsection{Password in Description Field}

\begin{verbatim}
Get-DomainUser * | 
    Select-Object samaccountname,description |
    Where-Object {$_.Description -ne $null}
\end{verbatim}


\subsection{PASSWD NOTREQD Field}
It is possible to come across domain accounts with the
\href{https://ldapwiki.com/wiki/PASSWD_NOTREQD}{passwd\_notreqd} field set in
the userAccountControl attribute. If this is set, the user is not subject to
the current password policy length, meaning they could have a shorter password
or no password at all (if empty passwords are allowed in the domain). A
password may be set as blank intentionally It is worth enumerating accounts
with this flag set and testing each to see if no password is required.

\begin{verbatim}
Get-DomainUser -UACFilter PASSWD_NOTREQD | 
    Select-Object samaccountname,useraccountcontrol
\end{verbatim}

\subsection{Credentials in SMB Shares and SYSVOL Scripts}
The \verb+SYSVOL+ share can be a treasure trove of data, especially in large
organizations. We may find many different batch, VBScript, and PowerShell
scripts within the scripts directory, which is readable by all authenticated
users in the domain. It is worth digging around this directory to hunt for
passwords stored in scripts. 



\subsection{ASREPRoasting}

See~\ref{kerberos:asrepraosting}

\subsection{Group Policy Object (GPO) Abuse}
Gaining rights over a Group Policy Object via an ACL misconfiguration, could
used to lateral movement, privilege escalation, and even domain compromise and as a persistence mechanism within the domain. 

GPO misconfigurations can be abused to perform the following attacks:
\begin{itemize}
    \item  Adding additional rights to a user (such as \verb+SeDebugPrivilege+,
        \verb+SeTakeOwnershipPrivilege+, or \verb+SeImpersonatePrivilege+)
    \item  Adding a local admin user to one or more hosts
    \item  Creating an immediate scheduled task to perform any number of actions
\end{itemize}

GPO may be enumerated using powershell~\ref{tool:wlol:ad:get-GPO} or by many tools such as PowerView~\ref{tool:powerview:Get-DomainGPO}
 and BloodHound,
\href{https://github.com/Group3r/Group3r}{group3r},
\href{https://github.com/sense-of-security/ADRecon}{ADRecon},
\href{https://www.pingcastle.com/}{PingCastle}.

To check ACL right on GPO, pipe the enumerate object on \verb+Get-ObjectAcl+ or
\verb+Get-ACL+ and pipe on \verb+Where-Object+ checking if
\verb+SecurityIdentifier+ is equal to an \verb+SID+ controlled.

iTool such as
\href{https://github.com/FSecureLABS/SharpGPOAbuse}{SharpGPOAbuse} can be used
to take advantage of GPO misconfiguration by performing actions such as adding
a control user to the local admins group on one of the affected hosts, creating
an immediate scheduled task on one of the hosts to give us a reverse shell, or
configure a malicious computer startup script to provide  a reverse shell or
similar. Care must be taken When using a tool like this because commands can be run that affect every computer within the OU that the GPO is linked to.

