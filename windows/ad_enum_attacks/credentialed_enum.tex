\section{Credentialed Enumeration}

\href{https://wadcoms.github.io/}{WADComs project} is an interactive cheat
sheet for many of the tools needed. It's hugely helpful to get exact command syntax or are trying out a tool for the first time.

\subsection{Security controls enumeration}
After gaining a foothold, this access is used to get a feeling for the defensive state of the hosts, enumerate the domain further, and, if necessary, work at "living off the land" by using tools that exist natively on the hosts.

It is important to understand the security controls in place in an organization as the products in use can affect the tools use for our enumeration, as well as exploitation and post-exploitation. 

Understanding the protections will help inform decisions regarding tool usage
and assist us in planning the course of action by either avoiding or modifying certain tools. 

Some organizations have more stringent protections than others, and some do not apply security controls equally throughout. There may be policies applied to certain machines that can make enumeration more difficult that are not applied on other machines.

\subsubsection{Microsoft Defender}

See\ref{windowd_knowledge:fundamentals:security:defender}

\href{https://docs.microsoft.com/en-us/powershell/module/defender/get-mpcomputerstatus?view=windowsserver2022-ps&viewFallbackFrom=win10-ps}{Get-MpComputerStatus}

\begin{verbatim}
Get-MpComputerStatus
\end{verbatim}

\subsubsection{AppLocker}
See~\ref{windowd_knowledge:fundamentals:security:applocker}


\begin{verbatim}
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
\end{verbatim}

Organizations often focus on blocking the PowerShell.exe executable, but forget about the other PowerShell executable locations such as 

\verb+%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe+ or
\verb+PowerShell_ISE.exe+

Sometimes, there are  more stringent AppLocker policies that require more creativity to bypass.

\subsubsection{PowerShell Constrained Language Mode}

PowerShell
\href{https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/}{Constrained
Language Mode} locks down many of the features needed to use PowerShell
effectively, such as blocking COM objects, only allowing approved \verb+.NET+ types, XAML-based workflows, PowerShell classes, and more. 

We can quickly enumerate whether we are in Full Language Mode or Constrained Language Mode.

\begin{verbatim}
$ExecutionContext.SessionState.LanguageMode
\end{verbatim}

\subsubsection{LAPS}

see~\ref{windows_knowledge:ad:security:laps}.

Aim:  enumerate what domain users can read the LAPS password set for machines
 with LAPS installed and what machines do not have LAPS installed. 

The \href{https://github.com/leoloobeek/LAPSToolkit}{LAPSToolkit} greatly
 facilitates this with several functions:
 \begin{itemize}
    \item {\bf \verb+Find-LAPSDelegatedGroups+}: parse \verb+ExtendedRights+ for all computers with LAPS enabled.  This will show groups specifically delegated to read LAPS passwords, which are often users in protected groups. An account that has joined a computer to a domain receives All Extended Rights over that host, and this right gives the account the ability to read passwords. 
    \item {\bf \verb+Find-AdmPwdExtendedRights+} checks the rights on each computer
        with LAPS enabled for any groups with read access and users with "All
        Extended Rights."  (can read LAPS passwords and may be less protected).
    \item {\bf \verb+Get-LAPSComputers+}  search for computers that have
            LAPS enabled when passwords expire, and even the randomized
        passwords in cleartext if our user has access.
\end{itemize}

\href{https://akijosberryblog.wordpress.com/2019/01/01/malicious-use-of-microsoft-laps/}{Abusing
LAPS}

\subsection{Domain Enumeration}
\subsubsection{From Linux}
The aim here is to enumerate the domain to find misconfigurations. Tools to
use:
\begin{itemize}
    \item crackmapexec~\ref{tool:crackmapexec}: Domain Users, Domain groups, Logged on
        users, shares, domain admins, priviledge users
    \item SMBMap\ref{tool:smbmap}: shares
    \item rpcclient~\ref{tool:rpcclient}: Domain Users, Domain groups, Logged on
        users, computers, gpo, shares, domain admins, priviledge users
    \item psexec.py~\ref{tool:impacket:psexec} (Impacker): 
    \item wmiexec.py~\ref{tool:impacket:wmiexec} (Impacker): 
    \item getUserSPN.py~\ref{tool:impacket:wmiexec} (Impacker): from nothing to
        hashes
    \item windapsearch~\ref{tool:windapsearch}: Users, Domain groups,
        computers, gpo, domain admins,SPN\ldots
    \item Bloodhound~\ref{tool:bloodhound} and~\ref{tool:bloodhound-ingestor} 
\end{itemize}

\subsubsection{From Windows}

\begin{itemize}
    \item ActiveDirectory PowerShell module~\ref{tool:adpsmodule}
    \item PowerView~\ref{tool:powerview}
    \item Snaffler~\ref{tool:snaffler}
    \item Bloodhound~\ref{tool:bloodhound} and~\ref{tool:sharphound} 
\end{itemize}

\subsubsection{Living Off the Land}
See~\ref{tool:wlol}



