

\section{Stack Canarie}
\url{https://en.wikipedia.org/wiki/Buffer_overflow_protection#Canaries}

Stack canaries or security cookies are tell-tale values added to binaries
during compilation to protect critical stack values like the Return Pointer
against buffer overflow attacks. If an incorrect canary is detected during
certain stages of the execution flow, such as right before a return (RET), the
program will be terminated. Their presence makes exploitation of such
vulnerabilities more difficult. But not impossible.

Stack canaries will be checked for their value just before the return to the
calling function, which is the moment at which the attacker will gain control
over the instruction pointer as their overwritten value for the return pointer
is loaded into the instruction pointer.

\subsection{Types of canaries}

Many buffer overflow vulnerabilities are caused by string operations such as
\verb+gets()+, \verb+strcpy(+), \verb+read()+. Strings in C are commonly
terminated using a single NULL byte (\verb+0x00+). An attacker would not be able
to use such a byte in their payload through a string operation to reconstruct
the canary. The \verb+0x0a+ byte represents a line feed, commonly also
terminating string operations. \verb+0xff+ corresponds to an End Of File (EOF),
terminating certain string operations as well.

The most common types and how they offer protection.
\begin{itemize}
    \item {\bf Null canary}: the simplest for the compiler programmer to
        implement.  It places 4 NULL bytes just before the SFP and RP. As this
        is a predictable value, an attacker may still be able to bypass the
        canary. The \verb+read()+ function, which is vulnerable to buffer
        overflows, does allow NULL bytes to be written.
    \item {\bf Terminator canary}: introduces two more hex values that attempt
        to terminate string operations, \verb+0x0a+ and \verb+0xff+. These
        values are again predictable, and can be bypassed with relative ease
        under the right conditions.
    \item {\bf Random canary}:  usually consists of a NULL byte followed by 3
        random bytes. The NULL byte would attempt to terminate string
        operations, while the 3 random bytes will make the canary less
        predictable to the attacker.
    \item {\bf Random XOR canary}: like the random canary, except it will be
        XORâ€™ed against a non-static value in the program (usually the Base
        Pointer EBP). As operating systems nowadays run with Address Space
        Layout Randomization (ASLR) activated, EBP will not be static across
        runs of the program. This adds an extra layer of randomization to the
        cookie, making it hard to predict this value.
    \item {\bf  64-bit canary} 
    \item {\bf Custom canary}
\end{itemize}

\subsection{Anatomy of a canaray}
\begin{verbatim}
 6b2:   64 48 8b 04 25 28 00    mov    rax,QWORD PTR fs:0x28
 ...SNIP...
 6d8:   48 8b 45 f8             mov    rax,QWORD PTR [rbp-0x8]
 6dc:   64 48 33 04 25 28 00    xor    rax,QWORD PTR fs:0x28
 6e3:   00 00
 6e5:   74 05                   je     6ec <func+0x42>
 6e7:   e8 84 fe ff ff          call   570 <__stack_chk_fail@plt>
 6ec:   c9                      leave
 6ed:   c3                      ret
\end{verbatim}
