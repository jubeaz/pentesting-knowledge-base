\section{Protocols}
While Windows operating systems use a variety of protocols to communicate, Active Directory specifically requires Lightweight Directory Access Protocol (LDAP), Microsoft's version of Kerberos, DNS for authentication and communication, and MSRPC.
\subsection{Kerberos}
See dedicated chapter~\ref{windows:authentication:kerberos}


\subsection{DNS}

\subsubsection{Service records}
AD maintains a database of services running on the network in the form of
\emph{service records} (\verb+SRV+). These service records allow clients in an AD environment to locate services that they need, such as a file server, printer, or Domain Controller.


Dynamic DNS is used to make changes in the DNS database automatically should a system's IP address change.

When a client joins the network, it locates the Domain Controller by sending a query to the DNS service, retrieving an SRV record from the DNS database, and transmitting the Domain Controller's hostname to the client.

\subsection{LDAP}
Active Directory supports Lightweight Directory Access Protocol (LDAP) for
directory lookups. LDAP is the language that applications use to communicate with other servers that provide directory services. 

LDAP uses port 389, and LDAP over SSL (LDAPS) communicates over port 636.

An LDAP session begins by first connecting to an LDAP server, also known as a Directory System Agent. The Domain Controller in AD actively listens for LDAP requests, such as security authentication requests.

\subsubsection{AD LDAP Authentication}

LDAP is set up to authenticate credentials against AD using a \emph{BIND}
operation to set the authentication state for an LDAP session. There are two
types of LDAP authentication :
\begin{enumerate}
    \item \emph{Simple Authentication}: This includes anonymous authentication, unauthenticated authentication, and username/password authentication. Simple authentication means that a username and password create a BIND request to authenticate to the LDAP server.

    \item \emph{SASL Authentication}: The Simple Authentication and Security Layer (SASL) framework uses other authentication services, such as Kerberos, to bind to the LDAP server and then uses this authentication service (Kerberos in this example) to authenticate to LDAP. The LDAP server uses the LDAP protocol to send an LDAP message to the authorization service, which initiates a series of challenge/response messages resulting in either successful or unsuccessful authentication. SASL can provide additional security due to the separation of authentication methods from application protocols.
\end{enumerate}

LDAP authentication messages are sent in cleartext by default so anyone can sniff out LDAP messages on the internal network. It is recommended to use TLS encryption or similar to safeguard this information in transit.

\subsection{MSRPC}
Windows systems use MSRPC to  access systems in Active Directory using four key RPC interfaces.

\begin{tabularx}{\linewidth}{|l|X|}
    \hline
Interface Name & Description \\
    \hline
lsarpc & A set of RPC calls to the Local Security Authority (LSA) system which
manages the local security policy on a computer, controls the audit policy, and
provides interactive authentication services. LSARPC is used to perform
management on domain security policies. \\
    \hline
netlogon & Netlogon is a Windows process used to authenticate users and other
services in the domain environment. It is a service that continuously runs in
the background. \\
    \hline
samr & Remote SAM (samr) provides management functionality for the domain
account database, storing information about users and groups. IT administrators
use the protocol to manage users, groups, and computers by enabling admins to
create, read, update, and delete information about security principles.
Attackers (and pentesters) can use the samr protocol to perform reconnaissance
about the internal domain using tools such as BloodHound to visually map out
the AD network and create "attack paths" to illustrate visually how
administrative access or full domain compromise could be achieved.
Organizations can protect against this type of reconnaissance by changing a
Windows registry key to only allow administrators to perform remote SAM queries
since, by default, all authenticated domain users can make these queries to
gather a considerable amount of information about the AD domain. \\
    \hline
drsuapi & drsuapi is the Microsoft API that implements the Directory
Replication Service (DRS) Remote Protocol which is used to perform
replication-related tasks across Domain Controllers in a multi-DC environment.
Attackers can utilize drsuapi to create a copy of the Active Directory domain
database (\gls{win:NTDS.DIT}) file to retrieve password hashes for all accounts in the
domain, which can then be used to perform Pass-the-Hash attacks to access more
systems or cracked offline using a tool such as Hashcat to obtain the cleartext
password to log in to systems using remote management protocols such as Remote
Desktop (RDP) and WinRM. \\
    \hline
\end{tabularx}

\subsection{NTLM}
 Active Directory uses several other authentication methods which can be used
 (and abused) by applications and services in AD.

 (See dedicated)
