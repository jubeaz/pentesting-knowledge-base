

\section{Powershell}

\subsection{list logs and providers}
\begin{verbatim}
Get-WinEvent -ListLog * |
    Select-Object LogName, RecordCount, IsClassicLog, IsEnabled, LogMode, LogType |
    Format-Table -AutoSize


Get-WinEvent -ListProvider * |
    Format-Table -AutoSize
\end{verbatim}

\subsection{Events of a log}

\begin{verbatim}
Get-WinEvent -LogName 'System' -MaxEvents 50 |
    Select-Object TimeCreated, ID, ProviderName, LevelDisplayName, Message |
    Format-Table -AutoSize
\end{verbatim}

\verb+-Oldest -MaxEvents 30+

\verb+-Path 'c:\...'+ intead of \verb+-LogName+ for exported

\subsection{Filtering}
\subsubsection{with FilterHashtable}
\begin{verbatim}
 Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-Sysmon/Operational'; ID=1,3} |
    Select-Object TimeCreated, ID, ProviderName, LevelDisplayName, Message |
    Format-Table -AutoSize

Get-WinEvent -FilterHashtable @{Path='C:\...\aaaa.evtx'; ID=1,3} |
    Select-Object TimeCreated, ID, ProviderName, LevelDisplayName, Message |
    Format-Table -AutoSize
\end{verbatim}

\begin{verbatim}
$startDate = (Get-Date -Year 2023 -Month 5 -Day 28).Date
$endDate   = (Get-Date -Year 2023 -Month 6 -Day 3).Date
Get-WinEvent -FilterHashtable @{LogName=...; StartTime=$startDate; EndTime=$endDate}...
\end{verbatim}



\subsubsection{with FilterHashtable and XML}

\begin{verbatim}
$Query = @"
<QueryList>
	<Query Id="0">
		<Select Path="Microsoft-Windows-Sysmon/Operational">*[System[(EventID=7)]] and *[EventData[Data='mscoree.dll']] or *[EventData[Data='clr.dll']]
		</Select>
	</Query>
</QueryList>
"@
    
Get-WinEvent -FilterXml $Query | ForEach-Object {Write-Host $_.Message `n}
\end{verbatim}

\subsubsection{with FilterXPath}
\begin{verbatim}
Get-WinEvent -LogName 'Microsoft-Windows-Sysmon/Operational' 
    -FilterXPath "*[EventData[Data[@Name='Image']='C:\Windows\System32\reg.exe']] 
            and *[EventData[Data[@Name='CommandLine']='`"C:\Windows\system32\reg.exe`" ADD HKCU\Software\Sysinternals /v EulaAccepted /t REG_DWORD /d 1 /f']]" |
    Select-Object TimeCreated, ID, ProviderName, LevelDisplayName, Message | Format-Table -AutoSize

Get-WinEvent -LogName 'Microsoft-Windows-Sysmon/Operational' 
    -FilterXPath "*[System[EventID=3] and EventData[Data[@Name='DestinationIp']='52.113.194.132']]"


\end{verbatim}


\subsubsection{based on property values}

\begin{verbatim}
Get-WinEvent 
    -FilterHashtable @{LogName='Microsoft-Windows-Sysmon/Operational'; ID=1} 
    -MaxEvents 1 |
    Select-Object -Property *


Get-WinEvent 
    -FilterHashtable @{LogName='Microsoft-Windows-Sysmon/Operational'; ID=1} |
    Where-Object {$_.Properties[21].Value -like "*-enc*"} |
    Format-List
\end{verbatim}


\subsection{Properties}

\begin{verbatim}
| Select-Object -Property *
\end{verbatim}
