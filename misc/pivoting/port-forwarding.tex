\section{Redirecting (forwarding) port}

\begin{itemize}
    \item attacker (IP\_A)
    \item pivot (IP\_P) : the computer compromized 
    \item targer (IP\_T): computer reachable only though the pivot
\end{itemize}


\subsection{Firewall Port forwaring}
These actions are performed on the pivot.

\subsubsection{Windows netsh}
Firewall rule
\begin{verbatim}
# Allow inbound traffic flow on port 4444/TCP
netsh advfirewall firewall add rule 
    name="Allow L_PORT" dir=in action=allow protocol=TCP localport=L_PORT
\end{verbatim}

Port forward:
\begin{verbatim}
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=L_PORT \
    connectaddress=IP connectport=PORT
\end{verbatim}

clean:
\begin{verbatim}
netsh advfirewall firewall delete rule 
    name="Allow 4444" protocol=TCP localport=4444
netsh interface portproxy show v4tov4
\end{verbatim}

netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0 listenport=8443

for incoming (nmap\ldots)
\begin{verbatim}
netsh interface portproxy add v4tov4 listenaddress=IP_P listenport=L_PORT \
    connectaddress=IP_T connectport=T_PORT
\end{verbatim}

\subsubsection{Linux }

\begin{verbatim}
 iptables -t nat -A PREROUTING -p tcp --dport 4445 -j DNAT --to-destination target:445
 \end{verbatim}

\subsection{socat}

\begin{verbatim}
 socat.exe tcp-listen:4445,fork tcp-connect:IP_T:445
socat -v tcp-listen:8079,reuseaddr tcp-connect:IP_T:9090
\end{verbatim}


\subsection{ssh Local port forwarding}
ssh creates tunnels making it possible to use a connection repeatedly by forwarding a new network connection inside an already established one. Important: both the server and the client can act as a link performing port forwarding.

If an SSH server is running on the victim PC (regardless of its OS), port
forwarding is performed as follows on the attacker machine:
\begin{verbatim}
 ssh -N user@pivot -L 4445:target:445
\end{verbatim}
\subsection{Remote port forwarding}
The only difference between remote port forwarding and local port forwarding is that the procedure is performed from the SSH server. Accordingly, the forwarding direction is opposite to the established SSH connection.

Remote port forwarding is a useful solution  to establish an exfiltration
channel from the pivot via the attacker (for instance, to install the required
packages by downloading them on a compromised host isolated from the Internet
via a proxy). But in most situations, remote port forwarding is used if there
is no SSH server on the pivot  PC or the port is being filtered. In that case,
you can still forward the port from the attacker PC â€“ but at the initiative of
the pivot.

\subsection{ Tunnel as http proxy with ncat}

ncat can be setup as an http proxy which can be used similar to a socks proxy. Just run the ncat proxy on the target machine, and update the local proxychains config to use an http proxy.

Unfortunately, ncat is almost never going to be installed by default on a target machine, unless someone has also installed nmap there.
\subsubsection{Target machine - setup ncat listener}
\begin{verbatim}
ncat -vv --listen 3128 --proxy-type http
\end{verbatim}
\subsubsection{attacker machine}
\begin{verbatim}
tail /etc/proxychains.conf -n 3
# defaults set to "tor"
#socks4 	127.0.0.1 9050
http 172.21.0.3  3128 # 172.21.0.3 is the IP of my ssh machine

proxychains nmap -sT -P0 -p8080,9001 172.20.0.2
\end{verbatim}

