\section{Metasploit}
\label{tool:metasploit}
\subsection*{Introduction}

\begin{itemize}
    \item modules: are actual exploit proof-of-concepts that have already been
        developed and tested in the wild and integrated within the framework
        and split into separate categories:
        \begin{itemize}
            \item {\emph Auxiliary}: Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.
            \item {\emph Encoders}: Ensure that payloads are intact to their destination.
            \item {\emph Exploits}: Defined as modules that exploit a vulnerability that will allow for the payload delivery.
            \item {\emph NOPs}: Keep the payload sizes consistent across exploit attempts.
            \item {\emph Payloads}: Code runs remotely and calls back to the attacker machine to establish a connection (or shell).
            \item {\emph Plugins}: Additional scripts can be integrated within an assessment with msfconsole and coexist.
            \item {\emph Post}: Wide array of modules to gather information, pivot deeper, etc.
        \end{itemize}
    \item plugins: Plugins offer the pentester more flexibility when using the
        msfconsole since they can easily be manually or automatically loaded as
        needed to provide extra functionality and automation during our
        assessment.
    \item scripts: Meterpreter functionality and other useful scripts
    \item tools: Command-line utilities that can be called directly from the
        \verb+msfconsole+
\end{itemize}



\subsection{Config}
\begin{verbatim}
more ~/.msf4/msfconsole.rc
setg VERBOSE true
\end{verbatim}



\subsection*{Database}
\subsubsection*{Setup}

\begin{verbatim}
sudo systemctl start postgresql
sudo msfdb init
sudo msfdb status
sudo msfdb run
msfdb reinit
\end{verbatim}

\subsubsection*{Options}
\begin{verbatim}
help database
workspace
workspace -a <NANME>

db_import <NMAP_XML_FILE>
db_export -h

hosts -h
services -h
creds -h
loot -h

\end{verbatim}

\subsection*{Modules}

\begin{verbatim}
healp search
search <LIST OF WORDS>
earch type:exploit platform:windows cve:2021 rank:excellent microsoft
use <i>
info
show payloads
show options
show advanced
show missing
show evasion
run
\end{verbatim}

\subsection*{Payloads}
A staged payload is, simply put, an exploitation process that is modularized
and functionally separated to help segregate the different functions it
accomplishes into different code blocks, each completing its objective
individually but working on chaining the attack together. This will ultimately
grant an attacker remote access to the target machine if all the stages work
correctly.

The scope of this payload, as with any others, besides granting shell access to
the target system, is to be as compact and inconspicuous as possible to aid
with the Antivirus (AV) / Intrusion Prevention System (IPS) evasion as much as
possible.

Stage0 of a staged payload represents the initial shellcode sent over the
network to the target machine's vulnerable service, which has the sole purpose
of initializing a connection back to the attacker machine. This is what is
known as a reverse connection. As a Metasploit user, we will meet these under
the common names \verb+reverse_tcp+, \verb+reverse_https+, and \verb+bind_tcp+

The {\bf Meterpreter payload} is a specific type of multi-faceted payload that uses
DLL injection to ensure the connection to the victim host is stable, hard to
detect by simple checks, and persistent across reboots or system changes.
Meterpreter resides completely in the memory of the remote host and leaves no
traces on the hard drive, making it very difficult to detect with conventional
forensic techniques. In addition, scripts and plugins can be loaded and
unloaded dynamically as required.

Once the Meterpreter payload is executed, a new session is created, which
spawns up the Meterpreter interface. It is very similar to the msfconsole
interface, but all available commands are aimed at the target system, which the
payload has "infected." It offers a plethora of useful commands, varying from
keystroke capture, password hash collection, microphone tapping, and
screenshotting to impersonating process security tokens. We will delve into
more detail about Meterpreter in a later section.

Using Meterpreter, we can also load in different Plugins to assist with our
assessment.

\begin{verbatim}
show payloads
grep meterpreter grep reverse_tcp show payloads

show options
show payloads
set payload <no.>
\end{verbatim}

\subsection{Encoders}
 Encoders have assisted with making payloads compatible with different
 processor architectures while at the same time helping with antivirus evasion.
 They are also needed to remove hexadecimal opcodes known as bad characters
 from the payload. Not only that but encoding the payload in different formats
 could help with the AV detection as mentioned above. However, the use of
 encoders strictly for AV evasion has diminished over time, as IPS/IDS
 manufacturers have improved how their protection software deals with
 signatures in malware and viruses. Shikata Ga Nai (SGN) is one of the most
 utilized Encoding schemes today because it is so hard to detect that payloads
 encoded through its mechanism are not universally undetectable anymore. 

 Encoded payload can be checked on \href{https://virustotal.com}{VirusTotal}

 \begin{verbatim}
 set payload X
 show encoders
 set encoders
 \end{verbatim}

\subsection*{Plugins}
The use of plugins makes a pentester's life even easier, bringing the
functionality of well-known software into the msfconsole.
 \begin{verbatim}
  ls metasploit-framework/plugins
  load PLUGIN_NAME
  help
 \end{verbatim}

 TO install a plugin just copy the \verb+.rb+ file into \verb+plugins+
 directory.

 popular plugins: 
 \begin{tabular}{lll}
     nMap & NexPose & Nessus \\
     Mimikatz & stdapi & railgun \\
     priv & incognito & darkoperators's \\
\end{tabular}

\subsection*{Mixins}
The Metasploit Framework is written in Ruby, an object-oriented programming
language. This plays a big part in what makes msfconsole excellent to use.
Mixins are one of those features that, when implemented, offer a large amount
of flexibility to both the creator of the script and the user.

Mixins are classes that act as methods for use by other classes without having
to be the parent class of those other classes. Thus, it would be deemed
inappropriate to call it inheritance but rather inclusion. They are mainly used
when we:
\begin{itemize}
    \item 
    Want to provide a lot of optional features for a class.
    \item 
    Want to use one particular feature for a multitude of classes.
\end{itemize}
he concept of Mixins is implemented using the word include, to which we pass
the name of the module as a parameter. We can read more about mixins
\href{https://en.wikibooks.org/wiki/Metasploit/UsingMixins}{here}.


\subsection*{Session}
\begin{verbatim}
[CTRL] + [Z] or background (meperpreter)

sessions
sessions -i SESSION_ID
\end{verbatim}

Some modules (usually {\emph post modules}  can be applyed to a session \verb+show option+

\subsection*{Jobs}

\begin{verbatim}
jobs -h
exploit -j # run exploit as a job
jobs -l
\end{verbatim}

\subsection*{Meterpreter}
The {\emph Meterpreter Payload} is a specific type of multi-faceted, extensible
Payload that uses {\emph DLL injection} to ensure the connection to the victim host is stable and difficult to detect using simple checks and can be configured to be persistent across reboots or system changes. Furthermore, Meterpreter resides entirely in the memory of the remote host and leaves no traces on the hard drive, making it difficult to detect with conventional forensic techniques.

The purpose of Meterpreter is to specifically improve post-exploitation
procedures. It can help us find various privilege escalation techniques, AV
evasion techniques, further vulnerability research, provide persistent access,
pivot, \ldots

For some interesting reading:
\begin{itemize}
        \item
            \href{https://blog.rapid7.com/2015/03/25/stageless-meterpreter-payloads/}{Meterpreter
            stageless payloads}
        \item
            \href{https://www.blackhillsinfosec.com/modifying-metasploit-x64-template-for-av-evasion}{modifying
            Metasploit templates for evasion}.
\end{itemize}


When the exploit is completed, the following events occur:

\begin{itemize}
        \item
    The target executes the initial stager. This is usually a bind, reverse,
    findtag, passivex, etc.
        \item
    The stager loads the DLL prefixed with Reflective. The Reflective stub
    handles the loading/injection of the DLL.
        \item
    The Meterpreter core initializes, establishes an AES-encrypted link over
    the socket, and sends a GET. Metasploit receives this GET and configures
    the client.
        \item
    Lastly, Meterpreter loads extensions. It will always loads \verb+tdapi+ and
    load \verb+priv+ if the module gives administrative rights. All of these
    extensions are loaded over AES encryption.
\end{itemize}

Whenever the Meterpreter Payload is sent and run on the target system, we receive a Meterpreter shell.

\begin{verbatim}
load kiwi
\end{verbatim}

run
\href{https://github.com/rapid7/metasploit-framework/tree/master/scripts/meterpreter}{meterpreter
scripts} such as duplicate\ldots

\begin{verbatim}
run SCRIPT
\end{verbatim}

see full list of scripts with description
\href{https://gist.github.com/gahan9/174acb78f73c3ae6ac3d0796b8f84965}{here}

\subsubsection*{Solving stdapi\_sys\_config\_getuid: Operation failed: Access is denied}

When this happens list the running processes with ps and select one owned by
the network authority account (the whoami command still works after spawning a
shell with shell) and migrate to it, this will fix the issue. If this action
isnâ€™t performed virtually every privilege escalation exploit will fail

\subsubsection*{File search}
\begin{verbatim}
run file_collector -d "c:\\" -r -f *.txt|*flag*
\end{verbatim}

\subsubsection*{sysinfo}
\subsubsection*{getsystem}

\subsection{modules}

\subsubsection*{local exploit suggester}

\begin{verbatim}
search local_exploit_suggester

post/multi/recon/local_exploit_suggester
set session i
run
\end{verbatim}

\subsubsection*{multi handler}


{\bf \verb+use exploit/multi/handler+ is a listener that allow to receive a
manually launhed reverse shell}. Set payload (according to expected connection
like \verb+linux/x86/meterpreter/reverse_tcp+) lhost and lport

\begin{verbatim}
use multi/handler
set payload windows/meterpreter/reverse_tcp
set exitonsession false
set lhost
set lport

run -j
\end{verbatim}


\subsection*{Importing Modules}
\href{https://www.exploit-db.com/}{ExploitDB} allow to search (tag ) metasploit
or using searchsploit (\verb+searchsploit -t STRING --exclude=".py"+

copy the \verb+.rb+ in the appropriate directory.
\begin{verbatim}
msfconsole -m /usr/share/metasploit-framework/modules/
OR
loadpath /usr/share/metasploit-framework/modules/ 
reload_all
\end{verbatim}

\subsection*{Firewall and IDS/IPS evasion}

\subsubsection*{Encoder}

\subsubsection*{Archives}
\begin{enumerate}
    \item generate the payload
    \item archive the payload (\verb+rar+) remove the extension
\end{enumerate}

can be archived several times

\subsubsection*{Packer}
executable compression process where the payload is packed together with an executable program and with the decompression code in one single file

A list of popular packer software: UPX packer, The Enigma Protector, MPRESS,
Morphine, \ldots



\subsubsection*{Exploit Coding}

\subsubsection*{Recompiling Meterpreter from Source Code}


\subsection*{links}

\subsection*{Options}

\subsection*{links}
\url{https://www.offensive-security.com/metasploit-unleashed/}
