\section{Active Directory}
\label{tool:wlol:ad}

\verb+Import-Module activedirectory+

\subsection*{Create a secure String to store a password}

create a
\href{https://docs.microsoft.com/en-us/dotnet/api/system.security.securestring?view=net-6.0}{SecureString
object}  which represents the password 
\begin{verbatim}
 $SecPasswd = ConvertTo-SecureString '<PASSWORD>' -AsPlainText -Force
\end{verbatim}

\subsection*{Impersonate an account}
impersonnate a
user with
\href{https://docs.microsoft.com/en-us/dotnet/api/system.management.automation.pscredential?view=powershellsdk-7.0.0}{PSCredential
object}.

\begin{verbatim}
 $SecPasswd = ConvertTo-SecureString '<PASSWORD>' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('DOMAIN\SAMAN', $SecPasswd)
\end{verbatim}

\subsection*{Get-ADGroup}
\label{tool:wlol:ad:get-ADGroup}

List the member of a group
\begin{verbatim}
Get-ADGroup -Identity "GROUP_NAME" -Properties * | Select -ExpandProperty Members

Get-ADGroup -Identity "GROUP_NAME" -Properties * | Select MemberName


Get-ADGroup -Filter * | Select MemberName
\end{verbatim}

Other parameter :
\begin{itemize}
    \item \verb+-Server FQDN+
\end{itemize}

Some interresting groups:
\begin{itemize}
    \item \verb+"Protected Users"+~\ref{windows_knowledge:ad:security:protected-users-group}
\end{itemize}

\subsection*{Get-ADGroupMember}
\label{tool:wlol:ad:get-ADGroupMember}
\begin{verbatim}
Get-ADGroupMember -Identity "GROUP_NAME" -Recursive
\end{verbatim}

\subsection*{Get-Acl}
\label{tool:wlol:ad:get-ACL}

\begin{verbatim}
Get-Acl "DC=DOMAIN,DC=..." `
    ? { ($_.ObjectAceType -match 'Replication-Get')} | 
    ? { $_.SecurityIdentifier -match $sid } |
    select AceQualifier, ObjectDN, ActiveDirectoryRights,
    SecurityIdentifier,ObjectAceType |
    fl
\end{verbatim}

\subsection*{Get-ADObject}
\label{tool:wlol:ad:get-ADObject}

\begin{verbatim}
$guid= "00299570-246d-11d0-a768-00aa006e0529"
Get-ADObject -SearchBase `
    "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" `
    -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |
    Select Name,DisplayName,DistinguishedName,rightsGuid |
    ? {$_.rightsGuid -eq $guid} |
    fl
\end{verbatim}


\subsection*{Get-ADUser}
\label{tool:wlol:ad:get-ADUser}
Creating a List of Domain Users
\begin{verbatim}
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName `
    > ad_users.txt
\end{verbatim}

Some usefull filters:
\begin{itemize}
    \item SPN:\\ 
    \verb+(ServicePrincipalName -ne "$null"} -Properties) ServicePrincipalName+
    \item no kerberos pre-authentication:\\ 
        \verb+('userAccountControl -band 4194304') -Properties userAccountControl+
    \item reversible password encryption:\\ 
    \verb+('userAccountControl -band 128') -Properties userAccountControl+
\end{itemize}

A Useful foreach Loop:

foreach line, and use the Get-Acl cmdlet to retrieve ACL information for each
domain user by feeding each line of the \verb+ad_users.txt+ file to the Get-ADUser cmdlet. 

then select just the Access property, which will give the information about access rights.

Finally, we set the IdentityReference property to the user controled.

\begin{verbatim}
foreach($line in `
   [System.IO.File]::ReadLines("c:\PATH\TO\ad_users.txt")) { 
        get-acl  "AD:\$(Get-ADUser $line)" |
        Select-Object Path -ExpandProperty Access |
        Where-Object { $_.IdentityReference -match 'DOMAIN\SAMAN' } 
    }
\end{verbatim}


\subsection*{Display Security Descriptor Definition Language (SDDL)} 
Make
\href{https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-definition-language}{Security
Descriptor Definition Language (SDDL)} readable with
\href{https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/convertfrom-sddlstring?view=powershell-7.2}{ConvertFrom-SddlString
cmdlet}

\begin{verbatim}
ConvertFrom-SddlString "<SSDL_STRING>" 
ConvertFrom-SddlString "<SSDL_STRING>" | Select -ExpandProperty DiscretionaryAcl
\end{verbatim}


\subsection*{Get-ADTrust}
\label{tool:wlol:ad:get-ADTrust}

\begin{verbatim}
Get-ADTrust -Filter *
\end{verbatim}

Properties :
\begin{itemize}
    \item \verb+ForestTransitive+: true for \emph{Forest} or \emph{external}
        trust
    \item \verb+IntraForest+: for \emph{Parent-Child}
\end{itemize}
